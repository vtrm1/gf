<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sal√£o - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-body: #f7f1e8;
      --bg-card: #fffaf3;
      --bg-sidebar: #f0e2cf;
      --accent-gold: #d4af37;
      --accent-gold-dark: #b38f1f;
      --text-main: #4b3c2f;
      --text-muted: #8a7a69;
      --border-soft: #e3d3c0;
      --danger: #d9534f;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #fff8ee 0, #f7f1e8 40%, #f3e9dc 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      background: var(--accent-gold);
      color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    button:hover {
      background: var(--accent-gold-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    button.secondary {
      background: transparent;
      color: var(--accent-gold-dark);
      border: 1px solid var(--accent-gold);
      box-shadow: none;
    }

    button.secondary:hover {
      background: rgba(212, 175, 55, 0.08);
    }

    .segmented {
      display: inline-flex;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 999px;
      padding: 0.15rem;
      gap: 0.15rem;
    }

    .segmented button {
      background: transparent;
      color: var(--accent-gold-dark);
      box-shadow: none;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.85rem;
    }

    .segmented button.active {
      background: #fffaf3;
      border-color: rgba(212, 175, 55, 0.6);
      color: var(--text-main);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .segmented.compact button {
      padding: 0.3rem 0.65rem;
      font-size: 0.8rem;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(212, 175, 55, 0.1);
      color: var(--accent-gold-dark);
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #f0e2cf 0%, #e7d5c0 100%);
      border-right: 1px solid var(--border-soft);
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff7e0, #d4af37);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }

    .sidebar button.nav {
      width: 100%;
      justify-content: flex-start;
      border-radius: 999px;
      padding: 0.55rem 0.9rem;
      font-size: 0.85rem;
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid transparent;
    }

    .sidebar button.nav.active {
      background: rgba(212, 175, 55, 0.18);
      border-color: rgba(212, 175, 55, 0.7);
      color: var(--accent-gold-dark);
    }

    .sidebar button.nav:hover {
      background: rgba(212, 175, 55, 0.12);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .content {
      flex: 1;
      padding: 1.5rem 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .topbar h1 {
      font-size: 1.3rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 1rem 1.1rem;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.9);
    }

    .card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
      color: var(--text-muted);
    }

    .card .value {
      font-size: 1.3rem;
      font-weight: 600;
      margin-top: 0.1rem;
    }

    .subtext {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 0.75rem;
      background: rgba(255,255,255,0.8);
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .section-title h2 {
      font-size: 1rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.4rem;
      font-size: 0.85rem;
    }

    .table th, .table td {
      text-align: left;
      padding: 0.5rem 0.4rem;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .table th {
      font-weight: 500;
      color: var(--text-muted);
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(0,0,0,0.04);
    }

    .badge.status-plan { background: rgba(212, 175, 55, 0.1); color: var(--accent-gold-dark); }
    .badge.status-progress { background: rgba(46, 204, 113, 0.12); color: #1e824c; }
    .badge.status-paid { background: rgba(52, 152, 219, 0.12); color: #1f6fa5; }

    .investment-groups { display: flex; flex-direction: column; gap: 0.9rem; }
    .investment-group { border: 1px solid var(--border-soft); border-radius: 14px; padding: 0.6rem; background: #fffdf9; box-shadow: 0 8px 18px rgba(0,0,0,0.04); }
    .investment-group-head { display: flex; justify-content: space-between; align-items: center; gap: 0.6rem; margin-bottom: 0.35rem; flex-wrap: wrap; }
    .investment-table { width: 100%; border-collapse: collapse; }
    .investment-table th, .investment-table td { padding: 0.55rem 0.35rem; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.03); }
    .investment-table th { color: var(--text-muted); font-weight: 500; font-size: 0.8rem; }
    .investment-main { display: flex; flex-direction: column; gap: 0.15rem; }
    .investment-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 0.35rem; flex-wrap: wrap; align-items: center; }
    .investment-actions { display: inline-flex; gap: 0.3rem; flex-wrap: wrap; }
    .pill.soft { background: rgba(0,0,0,0.04); color: var(--text-muted); }

    .calendar-year {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.9rem;
      margin-top: 0.5rem;
    }

    .month-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 0.7rem 0.8rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.9);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s ease;
    }

    .month-card.active {
      border-color: rgba(212, 175, 55, 0.6);
      box-shadow: 0 4px 16px rgba(212, 175, 55, 0.12);
    }

    .month-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.2rem;
    }

    .month-name {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .month-stat {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .month-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      overflow: hidden;
      margin-top: 0.3rem;
    }

    .month-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #f7de9e, #d4af37);
      width: 40%;
    }

    .mini-calendar {
      margin-top: 0.5rem;
      border: 1px dashed rgba(0,0,0,0.06);
      border-radius: 12px;
      padding: 0.5rem;
      background: rgba(255,255,255,0.6);
    }

    .month-visual-toggle {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .month-visual-toggle select {
      padding: 0.35rem 0.55rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #fff;
      font-size: 0.9rem;
    }

    .full-month-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.35rem;
      margin-top: 0.65rem;
      background: #fff;
      padding: 0.75rem;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 14px rgba(0,0,0,0.05);
    }

    .full-month-calendar .weekday {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
    }

    .full-month-calendar .month-day {
      height: 80px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(180deg, #fffaf3 0%, #fff 100%);
      padding: 0.4rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 0.9rem;
      position: relative;
    }

    .full-month-calendar .month-day.has-booking {
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.35);
    }

    .full-month-calendar .month-day .day-number {
      font-weight: 600;
    }

    .full-month-calendar .month-day .day-badge {
      align-self: flex-start;
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      background: rgba(212, 175, 55, 0.12);
      color: var(--accent-gold-dark);
    }

    .mini-weekdays,
    .mini-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      font-size: 0.7rem;
      text-align: center;
    }

    .mini-weekdays span {
      color: var(--text-muted);
      font-weight: 600;
    }

    .mini-day {
      padding: 0.35rem 0;
      border-radius: 10px;
      background: rgba(0,0,0,0.02);
      position: relative;
    }

    .mini-day.empty {
      background: transparent;
    }

    .mini-day.has-booking {
      border: 1px solid rgba(212, 175, 55, 0.8);
      background: rgba(212, 175, 55, 0.08);
      font-weight: 700;
      color: var(--accent-gold-dark);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15) inset;
    }

    .mini-day .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--appt-color, var(--accent-gold));
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
    }

    .month-footnote {
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .inventory-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 0.3rem;
      flex-wrap: wrap;
    }

    .inventory-tabs {
      display: inline-flex;
      background: rgba(212, 175, 55, 0.12);
      border-radius: 14px;
      padding: 0.2rem;
      gap: 0.2rem;
    }

    .inventory-tab {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 0.45rem 0.9rem;
      font-weight: 600;
      box-shadow: none;
    }

    .inventory-tab.active {
      background: #fffaf3;
      color: var(--text-main);
      border-color: rgba(212, 175, 55, 0.4);
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .inventory-list {
      margin-top: 0.6rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .inventory-card {
      position: relative;
      background: var(--bg-card);
      border-radius: 18px;
      padding: 1rem 1rem 0.9rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    .inventory-badge {
      position: absolute;
      top: 0.8rem;
      right: 0.9rem;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(0,0,0,0.04);
      color: var(--text-muted);
    }

    .inventory-badge.low {
      background: rgba(217, 83, 79, 0.08);
      color: var(--danger);
    }

    .inventory-card-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .inventory-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-top: 0.1rem;
    }

    .inventory-progress {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      overflow: hidden;
    }

    .inventory-progress .fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #f6e3b8, #d4af37);
      width: 70%;
    }

    .inventory-visibility {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .inventory-toggle {
      padding: 0.25rem 0.65rem;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(0,0,0,0.04);
      color: var(--text-muted);
      box-shadow: none;
      font-size: 0.78rem;
    }

    .inventory-toggle.active {
      background: rgba(212, 175, 55, 0.12);
      color: var(--accent-gold-dark);
      border-color: rgba(212, 175, 55, 0.35);
    }

    .inventory-foot {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
    }

    .quantity-actions {
      display: inline-flex;
      gap: 0.35rem;
    }

    .quantity-actions button {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .inventory-actions-icons {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
    }

    .icon-button {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      color: var(--text-muted);
      box-shadow: none;
      border: 1px solid rgba(0,0,0,0.04);
      font-size: 0.95rem;
    }

    .icon-button.danger {
      color: var(--danger);
    }

    .inventory-tabpanel {
      margin-top: 0.4rem;
    }

    .inventory-empty {
      padding: 0.8rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .inventory-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 10;
    }

    .inventory-modal .card {
      max-width: 520px;
      width: 100%;
      padding: 1.2rem 1.3rem;
    }

    .inventory-modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.8rem;
    }

    .inventory-modal .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.6rem;
      margin-top: 0.4rem;
    }

    .inventory-modal input {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.9);
    }

    .dialog-layer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 10;
    }

    .dialog-card {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 14px 38px rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.9);
      padding: 1.05rem 1.2rem;
      max-width: 540px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    .dialog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 0.6rem;
    }

    .dialog-card label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .dialog-card input,
    .dialog-card select,
    .dialog-card textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.95);
    }

    .dialog-card textarea {
      min-height: 60px;
      resize: vertical;
    }

    .dialog-card .disabled {
      opacity: 0.6;
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.2rem;
    }

    .section-caption {
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .settings-block {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1rem 1.1rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .block-header h3 {
      margin-bottom: 0.25rem;
    }

    .block-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .collab-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      border: 1px solid rgba(0,0,0,0.03);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,250,243,0.9));
    }

    .collab-row {
      display: grid;
      grid-template-columns: 1.3fr 1.6fr 1fr;
      gap: 0.8rem;
      padding: 0.7rem 0.9rem;
      align-items: center;
    }

    .collab-row + .collab-row {
      border-top: 1px solid var(--border-soft);
    }

    .collab-id {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      min-width: 0;
    }

    .collab-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      background: linear-gradient(135deg, #e5c676, #b58c25);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      flex-shrink: 0;
    }

    .collab-info strong {
      font-size: 0.95rem;
    }

    .collab-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .collab-meta .tagline {
      color: var(--text-main);
      font-weight: 500;
    }

    .collab-permissions {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      color: var(--text-muted);
      font-size: 0.82rem;
    }

    .collab-actions {
      display: flex;
      gap: 0.3rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .ghost-btn {
      border-radius: 10px;
      padding: 0.35rem 0.55rem;
      background: rgba(212,175,55,0.08);
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(212,175,55,0.18);
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      height: 32px;
    }

    .ghost-btn.secondary {
      background: rgba(0,0,0,0.02);
      border-color: rgba(0,0,0,0.06);
      color: var(--text-muted);
    }

    .ghost-btn:hover {
      transform: translateY(-1px);
      background: rgba(212,175,55,0.14);
    }

    .ghost-btn.secondary:hover {
      background: rgba(0,0,0,0.05);
    }

    .clients-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .clients-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .clients-search {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.55rem;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.92);
      min-width: 240px;
    }

    .clients-search input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .clients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
      margin-top: 0.4rem;
    }

    .client-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 0.85rem 0.95rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      position: relative;
    }

    .client-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .client-meta {
      color: var(--text-muted);
      font-size: 0.88rem;
      line-height: 1.3;
    }

    .client-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.35rem;
    }

    .client-actions .secondary {
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      border-radius: 10px;
    }

    .client-actions .icon-mini {
      padding: 0.3rem 0.6rem;
      font-size: 0.78rem;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }

    .client-pill {
      background: rgba(212,175,55,0.12);
      color: var(--text-main);
      border-radius: 10px;
      padding: 0.2rem 0.55rem;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      width: fit-content;
    }

    .client-card a {
      color: var(--accent-gold-dark);
      text-decoration: none;
      font-weight: 600;
    }

    .client-card a:hover {
      text-decoration: underline;
    }

    .agenda-appointments {
      margin-top: 0.8rem;
      display: grid;
      gap: 0.6rem;
    }

    .appointment-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 0.85rem 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem 1rem;
      align-items: center;
      position: relative;
    }

    .appointment-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      bottom: 12px;
      width: 5px;
      border-radius: 12px;
      background: var(--accent-gold);
      opacity: 0.9;
    }

    .appointment-meta {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .appointment-title {
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .appointment-subtext {
      color: var(--text-muted);
      font-size: 0.88rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .appointment-actions {
      display: flex;
      gap: 0.35rem;
      align-items: center;
      justify-content: flex-end;
    }

    .appointment-pill {
      background: rgba(0,0,0,0.03);
      color: var(--text-main);
      padding: 0.2rem 0.55rem;
      border-radius: 10px;
      font-size: 0.82rem;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .floating-cta {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 0.7rem 1rem;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.14);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: linear-gradient(135deg, #d4af37, #b58c25);
      color: white;
      z-index: 8;
    }

    .floating-cta.secondary {
      background: rgba(0,0,0,0.08);
      color: var(--text-main);
      border: 1px solid var(--border-soft);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }

    @media (min-width: 900px) {
      .floating-cta { display: none; }
    }

    @media (max-width: 899px) {
      .floating-cta { display: inline-flex; }
    }

    .client-detail-tabs {
      display: inline-flex;
      gap: 0.3rem;
      background: rgba(212,175,55,0.1);
      padding: 0.2rem;
      border-radius: 12px;
      margin: 0.4rem 0;
    }

    .client-detail-tabs button {
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border-radius: 10px;
      padding: 0.35rem 0.7rem;
      font-size: 0.85rem;
      border: 1px solid transparent;
    }

    .client-detail-tabs button.active {
      background: #fffaf3;
      border-color: rgba(212,175,55,0.5);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .client-detail-section {
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      margin-top: 0.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .client-detail-section h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .client-detail-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .badge-soft {
      display: inline-flex;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .inline-actions {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .kiosk-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 1.25rem 1.5rem 1.5rem;
      background: radial-gradient(circle at 10% 20%, #fff7e6, #f0e7d8);
      border-radius: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }

    .kiosk-grid {
      display: grid;
      grid-template-columns: 1.8fr 1.1fr;
      gap: 1.1rem;
      margin-top: 1rem;
    }

    .kiosk-section-title {
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }

    .kiosk-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.7rem;
    }

    .kiosk-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.85rem 0.9rem;
      text-align: left;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
      position: relative;
      overflow: hidden;
    }

    .kiosk-card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .kiosk-price {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.35rem;
    }

    .kiosk-icon {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: 1.3rem;
      background: radial-gradient(circle at 30% 30%, #fff3d4, #f1d9a0);
      margin-bottom: 0.35rem;
    }

    .kiosk-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .kiosk-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.09), transparent 50%);
      pointer-events: none;
    }

    .kiosk-cart {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 1rem 1.1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      max-height: 520px;
    }

    .kiosk-cart-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 0.3rem;
    }

    .kiosk-cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.45rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
      font-size: 0.85rem;
    }

    .kiosk-cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      font-weight: 600;
    }

    .kiosk-hero {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .kiosk-steps {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.35rem;
    }

    .kiosk-pill {
      background: rgba(0,0,0,0.04);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .login-mode-toggle {
      display: flex;
      gap: 0.4rem;
      margin: 0.6rem 0;
      flex-wrap: wrap;
    }

    .login-tab {
      border-radius: 14px;
      padding: 0.5rem 0.9rem;
      background: rgba(0,0,0,0.03);
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
    }

    .login-tab.active {
      background: rgba(212, 175, 55, 0.15);
      color: var(--accent-gold-dark);
      border-color: rgba(212, 175, 55, 0.5);
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.15);
    }

    .agenda-filter-select {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      padding: 0.35rem 0.6rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .agenda-filter-select label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0;
    }

    .agenda-filter-select select {
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--accent-gold-dark);
      outline: none;
    }

    .collab-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .collab-form input {
      width: 100%;
      padding: 0.55rem 0.6rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.8);
    }

    .collab-form small {
      grid-column: 1 / -1;
      color: var(--text-muted);
    }

    .login-screen {
      max-width: 420px;
      margin: 4rem auto;
      background: var(--bg-card);
      border-radius: 22px;
      padding: 1.5rem 1.7rem 1.3rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
    }

    .login-screen h1 {
      font-size: 1.4rem;
      margin-bottom: 0.3rem;
    }

    .login-screen p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }

    .role-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
      font-size: 0.75rem;
      margin-top: 0.2rem;
      color: var(--text-muted);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.9rem;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 900px) {
      .app-shell {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        padding: 0.75rem 1rem;
        overflow-x: auto;
      }
      .sidebar-nav {
        flex-direction: row;
        flex: 1;
        margin-top: 0;
      }
      .sidebar-footer {
        display: none;
      }
      .content {
        padding: 1rem;
      }
      .kiosk-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN / SELE√á√ÉO DE PAPEL (SIMULA√á√ÉO) -->
<section id="login-screen" class="login-screen">
  <h1 id="login-title">Sal√£o Glecie ‚Ä¢ Painel</h1>
  <p id="login-subtitle">Escolha como deseja acessar o sistema. Depois voc√™ pode trocar isso por login real com Firebase.</p>

  <div class="login-mode-toggle">
    <div class="login-tab active" id="tab-ceo" onclick="switchLoginMode('ceo')">Sou a CEO</div>
    <div class="login-tab" id="tab-colab" onclick="switchLoginMode('colab')">Sou colaboradora</div>
  </div>

  <div class="card" id="login-ceo-card" style="margin-top:0.4rem;">
    <h3>Acesso principal (dona do espa√ßo)</h3>
    <p class="subtext">Controle total: agenda, estoque, financeiro e comiss√µes.</p>
    <button style="margin-top:0.5rem;" onclick="setRole('ceo')">Entrar como CEO</button>
  </div>

  <div class="card hidden" id="login-colab-card" style="margin-top:0.4rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;flex-wrap:wrap;">
      <div>
        <h3>Login dedicado da colaboradora</h3>
        <p class="subtext">Tela enxuta: apenas o login desta colaboradora e o acesso ao tablet.</p>
      </div>
      <div class="chip">Criado pela CEO</div>
    </div>
    <div class="collab-form">
      <div>
        <label class="subtext">Usu√°rio</label>
        <input id="collab-login-username" placeholder="ex: camila" />
      </div>
      <div>
        <label class="subtext">Senha</label>
        <input id="collab-login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div>
        <label class="subtext">Dispositivo</label>
        <input id="collab-login-device" placeholder="Tablet da recep√ß√£o" />
      </div>
      <small>Use o usu√°rio e senha criados na Configura√ß√£o &gt; Colaboradoras.</small>
    </div>
    <button style="margin-top:0.5rem;" onclick="loginCollaboratorAccount()">Entrar como colaboradora</button>
  </div>

  <div class="card" style="margin-top:0.8rem;">
    <h3>Tablet do cliente (Kiosk)</h3>
    <p class="subtext">Tela fixa para o cliente registrar consuma√ß√£o e o servi√ßo.</p>
    <button style="margin-top:0.5rem;" class="secondary" onclick="setRole('kiosk')">
      Acessar modo tablet
    </button>
    <div class="chip">Ideal para ficar aberto em tela cheia no sal√£o</div>
  </div>

  <p class="hint">
    ‚öôÔ∏è <strong>Depois</strong>, aqui voc√™ troca por autentica√ß√£o Firebase (email/senha, etc.)
  </p>
</section>

<!-- SHELL PRINCIPAL (CEO / COLAB) -->
<div id="app-shell" class="app-shell hidden">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle"></div>
      <div>
        <div style="font-size:0.9rem;font-weight:600;">Sal√£o Glecie</div>
        <div id="sidebar-role-label" style="font-size:0.75rem;color:var(--text-muted);">
          ‚Äî
        </div>
      </div>
    </div>

    <div class="sidebar-nav" id="sidebar-nav">
      <!-- Bot√µes injectados via JS conforme papel -->
    </div>

    <div class="sidebar-footer">
      v0.1 ‚Ä¢ painel personalizado<br>
      Feito para nail designer.
      <div style="margin-top:0.35rem;">
        <button class="secondary" style="padding:0.3rem 0.7rem;font-size:0.7rem;" onclick="backToLogin()">
          Trocar acesso
        </button>
      </div>
    </div>
  </aside>

  <main class="content">
    <header class="topbar">
      <div>
        <h1 id="page-title">Dashboard</h1>
        <div class="tag" id="page-subtitle">Vis√£o geral do sal√£o</div>
      </div>
      <div style="display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap;">
        <div class="month-visual-toggle">
          <label class="subtext">Filtro mensal</label>
          <select id="dashboard-month-filter" onchange="setDashboardMonth(this.value)"></select>
        </div>
        <button class="secondary" onclick="openKioskFromDashboard()">Abrir modo tablet</button>
      </div>
    </header>

    <!-- P√°ginas da CEO -->
    <section id="page-ceo-dashboard" class="page-ceo">
      <div class="card-grid">
        <div class="card">
          <h3>Faturamento do m√™s</h3>
          <div class="value" id="dashboard-revenue">R$ 0,00</div>
          <div class="subtext" id="dashboard-revenue-delta">--</div>
        </div>
        <div class="card">
          <h3>Comiss√£o colaboradora</h3>
          <div class="value" id="dashboard-commission">R$ 0,00</div>
          <div class="subtext" id="dashboard-commission-delta">--</div>
        </div>
        <div class="card">
          <h3>Consumo vendido</h3>
          <div class="value" id="dashboard-consumption">R$ 0,00</div>
          <div class="subtext" id="dashboard-consumption-delta">--</div>
        </div>
        <div class="card">
          <h3>Alertas de estoque</h3>
          <div class="value" id="dashboard-stock-alerts">0</div>
          <div class="subtext" id="dashboard-stock-alerts-desc">Nenhum alerta</div>
        </div>
        <div class="card">
          <h3>Investimentos do m√™s</h3>
          <div class="value" id="dashboard-invest-month">R$ 0,00</div>
          <div class="subtext" id="dashboard-invest-month-desc">Planejados para o m√™s selecionado</div>
        </div>
        <div class="card">
          <h3>Parcelas pagas</h3>
          <div class="value" id="dashboard-invest-paid">R$ 0,00</div>
          <div class="subtext" id="dashboard-invest-paid-desc">Pagamentos registrados no m√™s</div>
        </div>
        <div class="card">
          <h3>Planejado para pr√≥ximos meses</h3>
          <div class="value" id="dashboard-invest-future">R$ 0,00</div>
          <div class="subtext" id="dashboard-invest-future-desc">Investimentos agendados para frente</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Pr√≥ximos hor√°rios</h2>
        <button class="secondary" onclick="navigatePage('ceo', 'agenda')">Abrir agenda</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Hor√°rio</th>
            <th>Cliente</th>
            <th>Profissional</th>
            <th>Servi√ßo</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>14:00</td>
            <td>Maria Souza</td>
            <td>Glecie</td>
            <td>Manuten√ß√£o fibra</td>
            <td><span class="badge">Confirmado</span></td>
          </tr>
          <tr>
            <td>16:00</td>
            <td>Ana Paula</td>
            <td>Colaboradora</td>
            <td>Alongamento</td>
            <td><span class="badge">Confirmado</span></td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-ceo-agenda" class="page-ceo hidden">
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <h2 style="margin:0;">Agenda</h2>
          <div class="segmented">
            <button id="agenda-toggle-year" class="active" onclick="setAgendaView('year')">Vis√£o anual</button>
            <button id="agenda-toggle-month" onclick="setAgendaView('month')">M√™s a m√™s</button>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">2025</span>
            <span class="pill">CEO + Colab</span>
          </div>
          <div class="agenda-filter-select">
            <label>Profissional</label>
            <select id="agenda-prof-filter" onchange="setAgendaProfessionalFilter(this.value, 'ceo')"></select>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
      </div>
      <div id="agenda-view-year">
        <div class="calendar-year" id="year-calendar">
          <!-- Meses preenchidos via JS -->
        </div>
      </div>

      <div id="agenda-view-month" class="hidden">
        <div class="month-visual-toggle" style="margin-bottom:0.4rem;">
          <label class="subtext">Selecione o m√™s</label>
          <select id="agenda-month-selector" onchange="setSelectedMonth(parseInt(this.value))"></select>
          <div class="tag">Toque nos dias com atendimento para abrir detalhes</div>
        </div>
        <div class="full-month-calendar" id="agenda-month-calendar"></div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2 id="selected-month-title">Agenda do m√™s</h2>
        <div class="pill-row" id="selected-month-tags"></div>
      </div>
      <div class="card" style="margin-top:0.2rem;">
        <table class="table" style="margin:0;">
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servi√ßo</th>
              <th>Profissional</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="agenda-month-summary">
            <!-- Populado via JS mock -->
          </tbody>
        </table>
      </div>

      <button class="floating-cta" onclick="openAppointmentModal()">
        ‚úö Novo agendamento
      </button>
    </section>

    <section id="page-ceo-inventory" class="page-ceo hidden">
      <div class="inventory-header">
        <div class="inventory-tabs">
          <button id="inventory-tab-btn-polish" class="inventory-tab active" onclick="switchInventoryTab('polish')">Esmaltes</button>
          <button id="inventory-tab-btn-fridge" class="inventory-tab" onclick="switchInventoryTab('fridge')">Geladeira</button>
        </div>
      </div>

      <div id="inventory-panel-polish" class="inventory-tabpanel">
        <div class="section-title">
          <h2>Esmaltes</h2>
          <button onclick="openInventoryModal('polish')">Adicionar</button>
        </div>
        <div class="inventory-list" id="inventory-polish-list">
          <!-- Itens via JS mock -->
        </div>
      </div>

      <div id="inventory-panel-fridge" class="inventory-tabpanel hidden">
        <div class="section-title">
          <h2>Geladeira</h2>
          <button onclick="openInventoryModal('fridge')">Adicionar</button>
        </div>
        <div class="inventory-list" id="inventory-fridge-list">
          <!-- Itens via JS mock -->
        </div>
      </div>
    </section>

    <div id="inventory-modal" class="inventory-modal hidden">
      <div class="card">
        <div class="section-title" style="margin-top:0;">
          <h2 id="inventory-modal-title">Adicionar item</h2>
          <button class="secondary" onclick="closeInventoryModal()">Fechar</button>
        </div>

        <div id="inventory-modal-polish" class="modal-grid">
          <div>
            <label class="subtext">Nome</label>
            <input id="new-polish-name" placeholder="Ex: Nude cl√°ssico" />
          </div>
          <div>
            <label class="subtext">Marca</label>
            <input id="new-polish-brand" placeholder="Marca" />
          </div>
          <div>
            <label class="subtext">Volume total (ml)</label>
            <input id="new-polish-total" type="number" placeholder="Ex: 50" />
          </div>
          <div>
            <label class="subtext">Volume atual (ml)</label>
            <input id="new-polish-current" type="number" placeholder="Ex: 30" />
          </div>
        </div>

        <div id="inventory-modal-fridge" class="modal-grid hidden">
          <div>
            <label class="subtext">Item</label>
            <input id="new-fridge-name" placeholder="Ex: √Ågua com g√°s" />
          </div>
          <div>
            <label class="subtext">Pre√ßo de venda</label>
            <input id="new-fridge-price" type="number" placeholder="Ex: 6" />
          </div>
          <div>
            <label class="subtext">Quantidade</label>
            <input id="new-fridge-stock" type="number" placeholder="Ex: 12" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="secondary" onclick="closeInventoryModal()">Cancelar</button>
          <button id="inventory-modal-save" onclick="submitInventoryForm()">Salvar</button>
        </div>
      </div>
    </div>

    <section id="page-ceo-investments" class="page-ceo hidden">
      <div class="section-title">
        <div>
          <h2>Investimentos do sal√£o</h2>
          <div class="pill-row">
            <span class="pill">Planejamento</span>
            <span class="pill">Compras e reformas</span>
          </div>
        </div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
          <div class="segmented compact">
            <button id="invest-filter-all" class="active" onclick="setInvestmentFilter('Todos')">Todos</button>
            <button id="invest-filter-plan" onclick="setInvestmentFilter('Planejado')">Planejamento</button>
            <button id="invest-filter-progress" onclick="setInvestmentFilter('Em andamento')">Em andamento</button>
            <button id="invest-filter-paid" onclick="setInvestmentFilter('Pago')">Pagos</button>
          </div>
          <button class="secondary" onclick="openInvestmentModal()">Adicionar investimento</button>
        </div>
      </div>

      <div class="card">
        <div class="table-head" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
          <div>
            <div class="subtext">Organize por status e acompanhe parcelas</div>
            <div class="tag">Valor total, parcelas e m√™s de refer√™ncia</div>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">Planejado</span>
            <span class="pill">Em andamento</span>
            <span class="pill">Pago</span>
          </div>
        </div>
        <div id="investment-groups" class="investment-groups"></div>
      </div>
    </section>

    <section id="page-ceo-finance" class="page-ceo hidden">
      <div class="section-title">
        <h2>Resumo financeiro</h2>
        <div class="pill-row">
          <span class="pill">M√™s atual</span>
          <span class="pill">Servi√ßos + consumo</span>
        </div>
      </div>

      <div class="card-grid">
        <div class="card">
          <h3>Receita bruta</h3>
          <div class="value">R$ 15.800</div>
          <div class="subtext">Inclui servi√ßos e bebidas</div>
        </div>
        <div class="card">
          <h3>Custos (produtos)</h3>
          <div class="value">R$ 3.100</div>
          <div class="subtext">Baseado no consumo estimado de esmaltes e itens</div>
        </div>
        <div class="card">
          <h3>Lucro estimado</h3>
          <div class="value">R$ 12.700</div>
          <div class="subtext">Antes de outras despesas fixas</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Vendas por tipo</h2>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Quantidade</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Servi√ßos</td>
            <td>120</td>
            <td>R$ 13.200</td>
          </tr>
          <tr>
            <td>Consumo (geladeira)</td>
            <td>64</td>
            <td>R$ 2.600</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-ceo-clients" class="page-ceo hidden">
      <div class="section-title">
        <h2>Clientes</h2>
        <div class="pill-row">
          <span class="pill">Vis√£o geral</span>
          <span class="pill">CEO v√™ todas</span>
        </div>
      </div>
      <div class="settings-block">
        <div class="clients-header">
          <div class="clients-actions">
            <button class="ghost-btn" onclick="openClientModal()">+ Adicionar cliente</button>
            <div class="clients-search">
              <span>üîç</span>
              <input id="client-search-ceo" placeholder="Buscar por nome ou telefone" oninput="renderClients('ceo')" />
            </div>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
        <div id="clients-grid-ceo" class="clients-grid"></div>
      </div>
    </section>

    <section id="page-ceo-settings" class="page-ceo hidden">
      <div class="section-title">
        <h2>Configura√ß√µes do sal√£o</h2>
      </div>
      <div class="settings-block">
        <div class="block-header">
          <div>
            <h3>Colaboradoras</h3>
            <div class="section-caption">Lista compacta para gerenciar permiss√µes, comiss√£o e logins dedicados.</div>
          </div>
          <div class="block-actions">
            <button class="ghost-btn secondary" onclick="openCollabAddModal()">+ Colaboradora</button>
            <button class="ghost-btn" onclick="openDedicatedLoginModal()">üîë Criar login dedicado</button>
            <button class="ghost-btn secondary" onclick="alert('Importa√ß√£o mockada')">‚§ì Importar</button>
          </div>
        </div>
        <div id="collaborators-list" class="collab-list"></div>
      </div>

      <div class="settings-block" style="margin-top:1rem;">
        <div class="block-header">
          <div>
            <h3>Servi√ßos</h3>
            <div class="section-caption">Valores utilizados no app e no tablet, com edi√ß√£o via modal.</div>
          </div>
          <div class="block-actions">
            <button class="ghost-btn" onclick="openServiceAddModal()">‚ûï Adicionar servi√ßo</button>
            <button class="ghost-btn secondary" onclick="openServiceEditModal()">‚úèÔ∏è Editar valores</button>
          </div>
        </div>
        <table class="table" style="margin-top:0.2rem;">
          <thead>
            <tr>
              <th>Servi√ßo</th>
              <th>Dura√ß√£o</th>
              <th>Pre√ßo</th>
            </tr>
          </thead>
          <tbody id="services-table"></tbody>
        </table>
      </div>
    </section>

    <div id="login-dedicated-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Criar login dedicado</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('login-dedicated-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome da colaboradora</label>
            <input id="new-colab-name" placeholder="Ex: Camila" />
          </div>
          <div>
            <label>Usu√°rio</label>
            <input id="new-colab-username" placeholder="Ex: camila" />
          </div>
          <div>
            <label>Senha inicial</label>
            <input id="new-colab-password" placeholder="Ex: 123" />
          </div>
          <div>
            <label>Permiss√µes</label>
            <input id="new-colab-permissions" placeholder="Agenda compartilhada, comiss√µes" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('login-dedicated-modal')">Cancelar</button>
          <button onclick="createCollaboratorAccount()">Gerar usu√°rio e senha</button>
        </div>
        <div class="section-caption">A colaboradora ver√° apenas o pr√≥prio login e o acesso ao tablet.</div>
      </div>
    </div>

    <div id="add-collab-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Adicionar colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('add-collab-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome</label>
            <input id="add-collab-name" placeholder="Ex: Camilia" />
          </div>
          <div>
            <label>Cargo</label>
            <input id="add-collab-role" placeholder="Ex: Colaboradora" />
          </div>
          <div>
            <label>Comiss√£o</label>
            <input id="add-collab-commission" placeholder="Ex: 40% servi√ßos" />
          </div>
          <div>
            <label>Login</label>
            <input id="add-collab-login" placeholder="Usu√°rio opcional" />
          </div>
          <div style="grid-column:1 / span 2;">
            <label>Permiss√µes (resumo)</label>
            <input id="add-collab-permissions" placeholder="Agenda, estoque, comiss√µes" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('add-collab-modal')">Cancelar</button>
          <button onclick="saveNewCollaborator()">Salvar colaboradora</button>
        </div>
      </div>
    </div>

    <div id="edit-collab-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Editar colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('edit-collab-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome</label>
            <input id="edit-collab-name" />
          </div>
          <div>
            <label>Cargo</label>
            <input id="edit-collab-role" />
          </div>
          <div>
            <label>Login</label>
            <input id="edit-collab-login" placeholder="Usu√°rio" />
          </div>
          <div>
            <label>Permiss√µes</label>
            <div style="display:flex;flex-direction:column;gap:0.3rem;padding:0.4rem 0;">
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-agenda" /> Agenda
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-estoque" /> Estoque
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-comissao" /> Comiss√£o
              </label>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('edit-collab-modal')">Cancelar</button>
          <button onclick="saveCollaboratorProfile()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="commission-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Comiss√£o</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('commission-modal')">Fechar</button>
        </div>
        <div>
          <label>Percentual de comiss√£o</label>
          <input id="commission-value" type="number" min="0" max="100" step="1" placeholder="Ex: 40" />
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('commission-modal')">Cancelar</button>
          <button onclick="saveCommission()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="collab-status-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Status da colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('collab-status-modal')">Fechar</button>
        </div>
        <p class="subtext" id="collab-status-text">Gerencie ativa√ß√£o ou remo√ß√£o.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="removeCollaborator()" style="color:var(--danger);border-color:var(--danger);">Remover colaboradora</button>
          <div style="display:flex;gap:0.4rem;">
            <button class="secondary" onclick="closeDialog('collab-status-modal')">Cancelar</button>
            <button onclick="confirmDeactivateCollaborator()" id="collab-status-toggle">Desativar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="service-add-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Adicionar servi√ßo</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('service-add-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Servi√ßo</label>
            <input id="add-service-name" placeholder="Ex: Spa m√£os" />
          </div>
          <div>
            <label>Dura√ß√£o</label>
            <input id="add-service-duration" placeholder="Ex: 40min" />
          </div>
          <div>
            <label>Pre√ßo</label>
            <input id="add-service-price" type="number" placeholder="Ex: 80" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('service-add-modal')">Cancelar</button>
          <button onclick="saveNewService()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="service-edit-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Editar valores</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('service-edit-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Servi√ßo</label>
            <select id="edit-service-select" onchange="prefillServiceFields()"></select>
          </div>
          <div>
            <label>Dura√ß√£o</label>
            <input id="edit-service-duration" placeholder="Ex: 1h30" />
          </div>
          <div>
            <label>Pre√ßo</label>
            <input id="edit-service-price" type="number" placeholder="Ex: 120" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('service-edit-modal')">Cancelar</button>
          <button onclick="saveServiceEdit()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="investment-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:720px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;">
          <div>
            <h3 id="investment-modal-title">Adicionar investimento</h3>
            <div class="subtext">Preencha valores, parcelas e m√™s de refer√™ncia</div>
          </div>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('investment-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <input type="hidden" id="investment-id" />
          <div>
            <label>T√≠tulo</label>
            <input id="investment-title" placeholder="Ex: Reforma recep√ß√£o" />
          </div>
          <div>
            <label>Categoria</label>
            <input id="investment-category" placeholder="Equipamento, obra, melhoria" />
          </div>
          <div>
            <label>M√™s de refer√™ncia</label>
            <input id="investment-month" type="month" />
          </div>
          <div>
            <label>Valor total</label>
            <input id="investment-amount" type="number" placeholder="500" />
          </div>
          <div>
            <label>Parcelado?</label>
            <select id="investment-parceled" onchange="toggleParcelFields()">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
          </div>
          <div>
            <label>N√∫mero de parcelas</label>
            <input id="investment-installments" type="number" min="1" placeholder="1" />
          </div>
          <div>
            <label>Valor de cada parcela</label>
            <input id="investment-installment-value" type="number" placeholder="0" />
          </div>
          <div>
            <label>Data da primeira parcela</label>
            <input id="investment-first-date" type="date" />
          </div>
          <div>
            <label>Parcela atual</label>
            <input id="investment-current-installment" type="number" min="0" placeholder="0" />
          </div>
          <div>
            <label>Status</label>
            <select id="investment-status">
              <option value="Planejado">Planejado</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Pago">Pago</option>
            </select>
          </div>
          <div>
            <label>Observa√ß√µes</label>
            <textarea id="investment-notes" placeholder="Materiais, cronograma ou fornecedor"></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('investment-modal')">Cancelar</button>
          <button id="investment-modal-save" onclick="saveInvestment()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="investment-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover investimento</h3>
        <p class="subtext" id="investment-remove-text">Confirme para remover o investimento selecionado.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('investment-remove-modal')">Cancelar</button>
          <button onclick="confirmRemoveInvestment()" style="background:var(--danger);">Remover</button>
        </div>
      </div>
    </div>

    <div id="client-form-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 id="client-form-title">Adicionar cliente</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('client-form-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <input type="hidden" id="client-id" />
          <div>
            <label>Nome completo</label>
            <input id="client-name" placeholder="Ex: Maria Souza" />
          </div>
          <div>
            <label>Telefone</label>
            <input id="client-phone" placeholder="55999999999" />
          </div>
          <div>
            <label>Instagram</label>
            <input id="client-instagram" placeholder="@cliente" />
          </div>
          <div>
            <label>Data de anivers√°rio</label>
            <input id="client-birthday" type="date" />
          </div>
          <div>
            <label>Prefer√™ncia de cor</label>
            <input id="client-pref-color" placeholder="Nude, vermelho" />
          </div>
          <div>
            <label>Formato de unha</label>
            <input id="client-pref-shape" placeholder="Quadrada, amendoada" />
          </div>
          <div>
            <label>Tipo de alongamento</label>
            <input id="client-pref-extension" placeholder="Fibra, gel" />
          </div>
          <div>
            <label>Alergias</label>
            <input id="client-allergies" placeholder="Produtos ou materiais" />
          </div>
          <div>
            <label>Observa√ß√µes</label>
            <textarea id="client-notes" placeholder="Prefer√™ncias, observa√ß√µes gerais"></textarea>
          </div>
          <div>
            <label>Respons√°vel</label>
            <select id="client-responsible"></select>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('client-form-modal')">Cancelar</button>
          <button id="client-form-save" onclick="saveClient()">Salvar cliente</button>
        </div>
      </div>
    </div>

    <div id="client-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover cliente</h3>
        <p class="subtext" id="client-remove-text">Confirme para remover a cliente e cancelar seus agendamentos futuros.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('client-remove-modal')">Cancelar</button>
          <button onclick="confirmRemoveClient()" style="background:var(--danger);">Remover</button>
        </div>
      </div>
    </div>

    <div id="client-detail-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:720px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;flex-wrap:wrap;">
          <div>
            <h3 id="client-detail-name">Ficha da cliente</h3>
            <div class="subtext" id="client-detail-phone"></div>
          </div>
          <div class="inline-actions">
            <button class="secondary" onclick="openAppointmentModal(currentClientDetailId)">Agendar novamente</button>
            <button class="ghost-btn" onclick="closeDialog('client-detail-modal')">Fechar</button>
          </div>
        </div>
        <div class="client-detail-tabs">
          <button id="tab-detail-data" class="active" onclick="switchClientTab('data')">Dados pessoais</button>
          <button id="tab-detail-history" onclick="switchClientTab('history')">Hist√≥rico de servi√ßos</button>
          <button id="tab-detail-consume" onclick="switchClientTab('consume')">Consumos</button>
          <button id="tab-detail-future" onclick="switchClientTab('future')">Agendamentos futuros</button>
        </div>
        <div id="client-detail-content"></div>
      </div>
    </div>

    <div id="appointment-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:640px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 id="appointment-modal-title">Novo agendamento</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('appointment-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Cliente</label>
            <input id="appointment-client" list="clients-datalist" placeholder="Buscar ou digitar cliente" oninput="bindClientFromInput()" />
            <input type="hidden" id="appointment-client-id" />
            <datalist id="clients-datalist"></datalist>
          </div>
          <div>
            <label>Profissional</label>
            <select id="appointment-professional"></select>
          </div>
          <div>
            <label>Servi√ßo</label>
            <select id="appointment-service"></select>
          </div>
          <div>
            <label>Data</label>
            <input id="appointment-date" type="date" />
          </div>
          <div>
            <label>Hor√°rio</label>
            <input id="appointment-time" type="time" />
          </div>
          <div>
            <label>Observa√ß√µes</label>
            <textarea id="appointment-notes" placeholder="Prefer√™ncias, recados"></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('appointment-modal')">Cancelar</button>
          <button id="appointment-submit-btn" onclick="saveAppointment()">Salvar e gerar WhatsApp</button>
        </div>
      </div>
    </div>

    <div id="day-appointments-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:620px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
          <div>
            <h3 id="day-appointments-title" style="margin:0;">Agendamentos do dia</h3>
            <div class="subtext" id="day-appointments-caption">Hor√°rios e profissionais do dia selecionado</div>
          </div>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('day-appointments-modal')">Fechar</button>
        </div>

        <div id="day-appointments-list" class="agenda-appointments" style="margin:0.75rem 0 0.25rem 0;"></div>

        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('day-appointments-modal')">Voltar</button>
          <button onclick="openAppointmentModal(null, null, dayModalDate)">Novo agendamento para este dia</button>
        </div>
      </div>
    </div>

    <div id="appointment-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover agendamento</h3>
        <p class="subtext">Confirme para remover este hor√°rio e atualizar a agenda.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('appointment-remove-modal')">Cancelar</button>
          <button style="background:var(--danger);" onclick="confirmRemoveAppointment()">Remover</button>
        </div>
      </div>
    </div>

    <!-- P√°ginas da COLABORADORA -->
    <section id="page-colab-dashboard" class="page-colab hidden">
      <div class="card-grid">
        <div class="card">
          <h3>Comiss√£o no m√™s</h3>
          <div class="value">R$ 3.250</div>
          <div class="subtext">Baseada nos servi√ßos realizados</div>
        </div>
        <div class="card">
          <h3>Atendimentos hoje</h3>
          <div class="value">6</div>
          <div class="subtext">3 manh√£ ‚Ä¢ 3 tarde</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Pr√≥ximos hor√°rios</h2>
        <button class="secondary" onclick="navigatePage('colab', 'agenda')">Ver agenda completa</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Hor√°rio</th>
            <th>Cliente</th>
            <th>Servi√ßo</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>14:00</td>
            <td>Maria Souza</td>
            <td>Manuten√ß√£o</td>
            <td><span class="badge">Confirmado</span></td>
          </tr>
          <tr>
            <td>16:00</td>
            <td>Ana Paula</td>
            <td>Alongamento</td>
            <td><span class="badge">Confirmado</span></td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-colab-agenda" class="page-colab hidden">
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <h2 style="margin:0;">Agenda compartilhada</h2>
          <div class="segmented">
            <button id="agenda-toggle-year-colab" class="active" onclick="setAgendaView('year','colab')">Vis√£o anual</button>
            <button id="agenda-toggle-month-colab" onclick="setAgendaView('month','colab')">M√™s a m√™s</button>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">2025</span>
            <span class="pill">CEO + Colab</span>
          </div>
          <div class="agenda-filter-select">
            <label>Profissional</label>
            <select id="agenda-prof-filter-colab" onchange="setAgendaProfessionalFilter(this.value, 'colab')"></select>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
      </div>
      <div id="agenda-view-year-colab">
        <div class="calendar-year" id="year-calendar-colab"></div>
      </div>

      <div id="agenda-view-month-colab" class="hidden">
        <div class="month-visual-toggle" style="margin-bottom:0.4rem;">
          <label class="subtext">Selecione o m√™s</label>
          <select id="agenda-month-selector-colab" onchange="setSelectedMonth(parseInt(this.value), 'colab')"></select>
          <div class="tag">Toque nos dias com atendimento para abrir detalhes</div>
        </div>
        <div class="full-month-calendar" id="agenda-month-calendar-colab"></div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2 id="selected-month-title-colab">Agenda do m√™s</h2>
        <div class="pill-row" id="selected-month-tags-colab"></div>
      </div>
      <div class="card" style="margin-top:0.2rem;">
        <table class="table" style="margin:0;">
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servi√ßo</th>
              <th>Profissional</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="agenda-month-summary-colab"></tbody>
        </table>
      </div>

      <button class="floating-cta secondary" onclick="openAppointmentModal()">
        ‚úö Novo agendamento
      </button>
    </section>

    <section id="page-colab-commission" class="page-colab hidden">
      <div class="section-title">
        <h2>Minhas comiss√µes</h2>
        <div class="pill-row">
          <span class="pill">M√™s atual</span>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Servi√ßo</th>
            <th>Valor servi√ßo</th>
            <th>Comiss√£o</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>02/12</td>
            <td>Manuten√ß√£o fibra</td>
            <td>R$ 120</td>
            <td>R$ 48</td>
          </tr>
          <tr>
            <td>03/12</td>
            <td>Alongamento</td>
            <td>R$ 180</td>
            <td>R$ 72</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-colab-clients" class="page-colab hidden">
      <div class="section-title">
        <h2>Clientes</h2>
        <div class="pill-row">
          <span class="pill">Voc√™ v√™ apenas seus contatos</span>
        </div>
      </div>
      <div class="settings-block">
        <div class="clients-header">
          <div class="clients-actions">
            <button class="ghost-btn" onclick="openClientModal()">+ Adicionar cliente</button>
            <div class="clients-search">
              <span>üîç</span>
              <input id="client-search-colab" placeholder="Buscar por nome ou telefone" oninput="renderClients('colab')" />
            </div>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
        <div id="clients-grid-colab" class="clients-grid"></div>
      </div>
    </section>

  </main>
</div>

<!-- TELA KIOSK (CLIENTE) -->
<section id="kiosk-screen" class="hidden">
  <div class="kiosk-wrapper">
    <div class="kiosk-hero">
      <div>
        <h1 style="font-size:1.4rem;">Consumo & Servi√ßo</h1>
        <div class="tag" style="margin-top:0.2rem;">Selecione o que voc√™ est√° consumindo agora</div>
        <div class="kiosk-steps">
          <span class="kiosk-pill">1Ô∏è‚É£ Escolha a bebida</span>
          <span class="kiosk-pill">2Ô∏è‚É£ Marque o servi√ßo</span>
          <span class="kiosk-pill">3Ô∏è‚É£ Confirme e avisa a profissional</span>
        </div>
      </div>
      <button class="secondary" onclick="backToLogin()">Sair do modo tablet</button>
    </div>

    <div class="kiosk-grid">
      <div>
        <h2 class="kiosk-section-title">Bebidas e consuma√ß√£o</h2>
        <div class="kiosk-items" id="kiosk-drinks">
          <!-- Itens via JS -->
        </div>

        <h2 class="kiosk-section-title" style="margin-top:0.8rem;">Servi√ßo que estou fazendo</h2>
        <div class="kiosk-items" id="kiosk-services">
          <!-- Servi√ßos via JS -->
        </div>
      </div>

      <div class="kiosk-cart">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="font-size:1rem;">Seu carrinho</h2>
          <button class="secondary" style="font-size:0.75rem;padding:0.3rem 0.7rem;" onclick="clearCart()">
            Limpar
          </button>
        </div>
        <div class="kiosk-cart-list" id="kiosk-cart-list">
          <!-- itens carrinho -->
        </div>
        <div class="kiosk-cart-total">
          <span>Total estimado</span>
          <span id="kiosk-cart-total">R$ 0,00</span>
        </div>
        <button style="margin-top:0.5rem;width:100%;" onclick="sendOrder()">
          Finalizar e avisar a profissional
        </button>
        <div class="hint">
          Depois voc√™ paga normalmente no caixa. Este registro ajuda o sal√£o a controlar estoque e comiss√£o.
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // -----------------------------
  // ESTADO GLOBAL (simples)
  // -----------------------------
  let currentRole = null; // 'ceo' | 'colab' | 'kiosk'
  let currentPageCEO = 'dashboard';
  let currentPageColab = 'dashboard';
  let loginMode = 'ceo';
  let currentColabAccount = null;
  let currentInventoryTab = 'polish';
  let currentEditingCollabIndex = null;
  let currentCommissionIndex = null;
  let currentCollabStatusIndex = null;
  let currentEditingServiceId = null;
  let currentClientDetailId = null;
  let activeClientTab = 'data';
  let appointmentPrefillClient = null;
  let appointmentPrefillDate = null;
  let appointmentPrefillTime = null;
  let appointmentOpenedFromDayModal = false;
  let appointmentFormMode = 'add';
  let appointmentEditingId = null;
  let pendingRemoveAppointmentId = null;
  let dayModalDate = null;
  let dayModalScope = 'ceo';
  let agendaProfessionalFilter = 'all';
  let agendaProfessionalFilterColab = 'all';

  const calendarYear = 2025;
  const monthNamesFull = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  const monthNamesShort = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  const baseYearDetailed = monthNamesFull.map((fullName, idx) => ({
    monthIndex: idx,
    month: monthNamesShort[idx],
    fullName,
    tags: []
  }));
  let mockYearDetailed = JSON.parse(JSON.stringify(baseYearDetailed));
  let selectedMonthIndex = new Date().getMonth();
  let selectedMonthIndexColab = new Date().getMonth();
  let agendaViewMode = 'year';
  let agendaViewModeColab = 'year';
  let selectedDashboardMonth = new Date().getMonth();

  let mockPolish = [
    { name: 'Nude Elegante', brand: 'Marca X', current: 30, total: 50, low: false },
    { name: 'Vermelho Cl√°ssico', brand: 'Marca Y', current: 10, total: 50, low: true },
    { name: 'Top Coat Brilho', brand: 'Marca Z', current: 12, total: 30, low: true }
  ];

  let mockFridge = [
    { id: 'fridge-coca', name: 'Coca lata', stock: 8, price: 7, low: false, paused: false },
    { id: 'fridge-energetico', name: 'Energ√©tico', stock: 3, price: 10, low: true, paused: false },
    { id: 'fridge-agua', name: '√Ågua sem g√°s', stock: 15, price: 4, low: false, paused: false }
  ];

  let inventoryFormMode = 'add';
  let inventoryEditingType = 'polish';
  let inventoryEditingIndex = null;

  const monthlyDashboardStats = [
    { monthIndex: 0, revenue: 12340, commission: 3250, consumption: 640, alerts: 3, alertsDesc: 'Esmalte nude, top coat, energ√©tico', delta: '+18% contra Dez' },
    { monthIndex: 1, revenue: 11000, commission: 2980, consumption: 520, alerts: 2, alertsDesc: 'Energ√©tico, Coca', delta: '+5% contra Jan' },
    { monthIndex: 2, revenue: 14000, commission: 3650, consumption: 700, alerts: 1, alertsDesc: 'Top coat', delta: '+12% contra Fev' },
    { monthIndex: 3, revenue: 11800, commission: 3100, consumption: 590, alerts: 2, alertsDesc: 'Esmalte vermelho, √°gua', delta: '-8% contra Mar' },
    { monthIndex: 4, revenue: 15000, commission: 4020, consumption: 780, alerts: 1, alertsDesc: 'Top coat', delta: '+9% contra Abr' },
    { monthIndex: 5, revenue: 9800, commission: 2500, consumption: 420, alerts: 3, alertsDesc: 'Esmalte nude, energ√©tico, √°gua', delta: '-15% contra Mai' },
    { monthIndex: 6, revenue: 16000, commission: 4300, consumption: 820, alerts: 2, alertsDesc: 'Top coat, Coca', delta: '+18% contra Jun' },
    { monthIndex: 7, revenue: 15800, commission: 4260, consumption: 790, alerts: 2, alertsDesc: 'Top coat, √°gua', delta: '-1% contra Jul' },
    { monthIndex: 8, revenue: 12000, commission: 3200, consumption: 580, alerts: 2, alertsDesc: 'Esmalte nude, energ√©tico', delta: '-5% contra Ago' },
    { monthIndex: 9, revenue: 13000, commission: 3350, consumption: 610, alerts: 1, alertsDesc: '√Ågua', delta: '+3% contra Set' },
    { monthIndex: 10, revenue: 17500, commission: 4700, consumption: 900, alerts: 2, alertsDesc: 'Top coat, energ√©tico', delta: '+12% contra Out' },
    { monthIndex: 11, revenue: 19000, commission: 5100, consumption: 980, alerts: 3, alertsDesc: 'Esmalte nude, top coat, energ√©tico', delta: '+8% contra Nov' }
  ];

  let investments = [
    {
      id: 'inv-1',
      title: 'Poltrona reclin√°vel',
      category: 'Equipamento',
      valorTotal: 850,
      valorParcela: 850,
      parcelasTotais: 1,
      parcelaAtual: 0,
      mesReferencia: `${new Date().getFullYear()}-01`,
      status: 'Planejado',
      parcelado: false,
      firstParcelDate: `${new Date().getFullYear()}-01-10`,
      observacoes: 'Conforto na recep√ß√£o',
      createdAt: `${new Date().toISOString()}`,
      updatedAt: `${new Date().toISOString()}`,
      lastPaymentAt: null
    },
    {
      id: 'inv-2',
      title: 'Reforma da recep√ß√£o',
      category: 'Obra',
      valorTotal: 2500,
      valorParcela: 500,
      parcelasTotais: 5,
      parcelaAtual: 2,
      mesReferencia: `${new Date().getFullYear()}-02`,
      status: 'Em andamento',
      parcelado: true,
      firstParcelDate: `${new Date().getFullYear()}-02-05`,
      observacoes: 'Dividido em 5x com fornecedor',
      createdAt: `${new Date().toISOString()}`,
      updatedAt: `${new Date().toISOString()}`,
      lastPaymentAt: `${new Date().getFullYear()}-02-05T12:00:00Z`
    },
    {
      id: 'inv-3',
      title: 'Kit ilumina√ß√£o',
      category: 'Melhoria',
      valorTotal: 600,
      valorParcela: 200,
      parcelasTotais: 3,
      parcelaAtual: 3,
      mesReferencia: `${new Date().getFullYear()}-03`,
      status: 'Pago',
      parcelado: true,
      firstParcelDate: `${new Date().getFullYear()}-03-01`,
      observacoes: 'Upgrade de ring lights',
      createdAt: `${new Date().toISOString()}`,
      updatedAt: `${new Date().toISOString()}`,
      lastPaymentAt: `${new Date().getFullYear()}-05-01T12:00:00Z`
    }
  ];

  const collaborators = [
    { id: 'glecie', name: 'Glecie', role: 'CEO', commission: 'Recebe total', permissions: 'Agenda, estoque, financeiro', color: '#d4af37', username: 'glecie', active: true },
    { id: 'camila', name: 'Camila', role: 'Colaboradora', commission: '40% servi√ßos', permissions: 'Agenda compartilhada, comiss√µes', color: '#f3c06b', username: 'camila', active: true },
    { id: 'laura', name: 'Laura', role: 'Colaboradora', commission: '35% servi√ßos', permissions: 'Agenda pr√≥pria, estoque consulta', color: '#b58c25', username: 'laura', active: true }
  ];

  let collaboratorAccounts = [
    { name: 'Camila', username: 'camila', password: '123', permissions: 'Agenda compartilhada, comiss√µes', device: 'Tablet da recep√ß√£o' },
    { name: 'Laura', username: 'laura', password: '456', permissions: 'Agenda pr√≥pria, estoque consulta', device: 'Tablet manicure' },
  ];

  let clients = [
    {
      id: 'cli-maria',
      name: 'Maria Souza',
      phone: '55999900001',
      instagram: '@maria',
      birthday: '1995-04-12',
      prefColor: 'Nude cl√°ssico',
      prefShape: 'Quadrada',
      prefExtension: 'Fibra',
      allergies: 'Nenhuma',
      responsible: 'Glecie',
      lastService: 'Manuten√ß√£o fibra',
      lastDate: '12/04',
      owners: ['Glecie'],
      notes: 'Prefere nude cl√°ssico',
      extra: 'Instagram @maria',
      history: ['Alongamento inicial 10/01', 'Manuten√ß√£o fibra 12/04'],
      consume: ['√Ågua sem g√°s', 'Suco verde'],
      future: [{ date: '2025-05-10', time: '15:00', service: 'Manuten√ß√£o fibra', serviceName: 'Manuten√ß√£o fibra', professional: 'Glecie', professionalName: 'Glecie', professionalId: 'glecie' }],
      nextAppointment: { date: '2025-05-10', time: '15:00', service: 'Manuten√ß√£o fibra', serviceName: 'Manuten√ß√£o fibra' }
    },
    {
      id: 'cli-ana',
      name: 'Ana Paula',
      phone: '55999900002',
      instagram: '@anap',
      birthday: '1992-08-02',
      prefColor: 'Ros√©',
      prefShape: 'Amendoada',
      prefExtension: 'Fibra',
      allergies: 'Alergia a acetona forte',
      responsible: 'Camila',
      lastService: 'Spa m√£os',
      lastDate: '02/04',
      owners: ['Camila'],
      notes: 'Alergia a acetona forte',
      extra: 'Indicada por Laura',
      history: ['Spa m√£os 02/04'],
      consume: ['Energ√©tico', '√Ågua com g√°s'],
      future: [{ date: '2025-04-22', time: '14:30', service: 'Spa m√£os', serviceName: 'Spa m√£os', professional: 'Camila', professionalName: 'Camila', professionalId: 'camila' }],
      nextAppointment: { date: '2025-04-22', time: '14:30', service: 'Spa m√£os', serviceName: 'Spa m√£os' }
    },
    {
      id: 'cli-luisa',
      name: 'Lu√≠sa Martins',
      phone: '55999900003',
      instagram: '@luisam',
      birthday: '1994-03-28',
      prefColor: 'Vermelho',
      prefShape: 'Quadrada',
      prefExtension: 'Gel',
      allergies: 'Nenhuma',
      responsible: 'Laura',
      lastService: 'Alongamento novo',
      lastDate: '28/03',
      owners: ['Laura'],
      notes: 'Gosta de formatos mais quadrados',
      extra: '',
      history: ['Alongamento novo 28/03'],
      consume: ['Coca lata'],
      future: [{ date: '2025-05-02', time: '10:00', service: 'Manuten√ß√£o alongamento', serviceName: 'Manuten√ß√£o alongamento', professional: 'Laura', professionalName: 'Laura', professionalId: 'laura' }],
      nextAppointment: { date: '2025-05-02', time: '10:00', service: 'Manuten√ß√£o alongamento', serviceName: 'Manuten√ß√£o alongamento' }
    }
  ];

  let currentClientEditingId = null;
  let pendingRemoveClientId = null;

  let appointments = [
    {
      id: 'appt-1',
      clientId: 'cli-maria',
      clientName: 'Maria Souza',
      professionalId: 'glecie',
      professionalName: 'Glecie',
      professional: 'Glecie',
      serviceId: 'manutencao',
      serviceName: 'Manuten√ß√£o fibra',
      service: 'Manuten√ß√£o fibra',
      date: '2025-05-10',
      time: '15:00',
      status: 'scheduled',
      notes: 'Rever cut√≠cula',
      createdAt: '2025-03-15T10:00:00Z',
      updatedAt: '2025-03-15T10:00:00Z'
    },
    {
      id: 'appt-2',
      clientId: 'cli-ana',
      clientName: 'Ana Paula',
      professionalId: 'camila',
      professionalName: 'Camila',
      professional: 'Camila',
      serviceId: 'spa-maos',
      serviceName: 'Spa m√£os',
      service: 'Spa m√£os',
      date: '2025-04-22',
      time: '14:30',
      status: 'scheduled',
      notes: 'Chega 10min antes',
      createdAt: '2025-03-10T09:00:00Z',
      updatedAt: '2025-03-10T09:00:00Z'
    },
    {
      id: 'appt-3',
      clientId: 'cli-luisa',
      clientName: 'Lu√≠sa Martins',
      professionalId: 'laura',
      professionalName: 'Laura',
      professional: 'Laura',
      serviceId: 'manutencao-alongamento',
      serviceName: 'Manuten√ß√£o alongamento',
      service: 'Manuten√ß√£o alongamento',
      date: '2025-05-02',
      time: '10:00',
      status: 'scheduled',
      notes: 'Prefere formato quadrado',
      createdAt: '2025-03-05T12:00:00Z',
      updatedAt: '2025-03-05T12:00:00Z'
    }
  ];

  function formatCurrency(value) {
    return 'R$ ' + Number(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }

  function formatDateLabel(dateStr) {
    if (!dateStr) return 'data a combinar';
    const [y, m, d] = dateStr.split('-');
    if (!y || !m || !d) return dateStr;
    return `${d}/${m}/${y}`;
  }

  function slugify(value = '') {
    return value
      .toString()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      || 'ref';
  }

  function findCollaboratorByIdOrName(value) {
    if (!value) return null;
    const lowered = value.toLowerCase();
    return collaborators.find(c => c.id === lowered || c.username === lowered || c.name.toLowerCase() === lowered) || null;
  }

  function findServiceByIdOrName(value) {
    if (!value) return null;
    const lowered = value.toLowerCase();
    return kioskServices.find(s => s.id === lowered || s.name.toLowerCase() === lowered) || null;
  }

  function getProfessionalKey(appt) {
    return (appt.professionalId || slugify(appt.professionalName || appt.professional || ''))?.toLowerCase();
  }

  function buildWhatsAppLink(client, payload = {}) {
    const number = (client.phone || '').replace(/\D/g, '') || '55';
    const appt = payload.appointment || client.nextAppointment || {};
    const service = payload.service || appt.serviceName || appt.service || client.lastService || 'seu atendimento';
    const dateLabel = payload.dateLabel || (appt.date ? formatDateLabel(appt.date) : (client.lastDate || 'data a combinar'));
    const time = payload.time || appt.time || 'hor√°rio a combinar';
    const text = `Ol√°, tudo bem? Seu agendamento para ${service} est√° confirmado para o dia ${dateLabel} √†s ${time}. Qualquer ajuste necess√°rio, estou √† disposi√ß√£o.`;
    return `https://wa.me/${number}?text=${encodeURIComponent(text)}`;
  }

  function setupMonthSelects() {
    const agendaSelect = document.getElementById('agenda-month-selector');
    const agendaSelectColab = document.getElementById('agenda-month-selector-colab');
    const dashSelect = document.getElementById('dashboard-month-filter');
    const fillSelect = (selectEl) => {
      if (selectEl && selectEl.options.length === 0) {
        baseYearDetailed.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.monthIndex;
          opt.textContent = m.fullName;
          selectEl.appendChild(opt);
        });
      }
    };
    fillSelect(agendaSelect);
    fillSelect(agendaSelectColab);
    if (dashSelect && dashSelect.options.length === 0) {
      monthNamesFull.forEach((name, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = name;
        dashSelect.appendChild(opt);
      });
    }
    if (dashSelect) dashSelect.value = selectedDashboardMonth;
    if (agendaSelect) agendaSelect.value = selectedMonthIndex;
    if (agendaSelectColab) agendaSelectColab.value = selectedMonthIndexColab;
  }

  let kioskDrinks = [];

  let kioskServices = [
    { id: 'manutencao', name: 'Manuten√ß√£o fibra', duration: '1h30', price: 120, icon: 'üíÖ' },
    { id: 'alongamento', name: 'Alongamento novo', duration: '2h', price: 180, icon: '‚ú®' },
    { id: 'spa-maos', name: 'Spa m√£os', duration: '50min', price: 90, icon: 'üß¥' },
    { id: 'esmalta', name: 'Esmalta√ß√£o simples', duration: '40min', price: 50, icon: 'üé®' },
  ];

  function normalizeAppointmentsData() {
    appointments = appointments.map(appt => {
      const fallbackClientId = appt.clientId || (appt.clientName ? `cli-${slugify(appt.clientName)}` : `cli-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`);
      let client = clients.find(c => c.id === fallbackClientId);
      if (!client) {
        client = {
          id: fallbackClientId,
          name: appt.clientName || appt.client || 'Cliente',
          phone: appt.phone || '55',
          owners: [],
          responsible: '',
          history: [],
          consume: [],
          future: [],
          nextAppointment: {}
        };
        clients.push(client);
      }

      const service = findServiceByIdOrName(appt.serviceId || appt.serviceName || appt.service);
      const professional = findCollaboratorByIdOrName(appt.professionalId || appt.professionalName || appt.professional);
      const professionalName = professional?.name || appt.professionalName || appt.professional || 'Equipe';
      const professionalId = professional?.id || slugify(professionalName);
      const serviceName = service?.name || appt.serviceName || appt.service || 'Servi√ßo';
      const serviceId = service?.id || slugify(serviceName);
      const status = appt.status || 'scheduled';
      const createdAt = appt.createdAt || new Date().toISOString();
      const updatedAt = appt.updatedAt || createdAt;
      const time = appt.time || '00:00';
      const normalizedId = appt.id || `appt-${Date.now()}-${Math.random().toString(16).slice(2, 7)}`;

      client.name = client.name || appt.clientName || 'Cliente';
      client.owners = client.owners || [];
      if (professionalName && !client.owners.includes(professionalName)) client.owners.push(professionalName);
      if (!client.responsible) client.responsible = professionalName;

      return {
        ...appt,
        id: normalizedId,
        clientId: client.id,
        clientName: client.name,
        professionalId,
        professionalName,
        professional: professionalName,
        serviceId,
        serviceName,
        service: serviceName,
        status,
        date: appt.date,
        time,
        notes: appt.notes || '',
        createdAt,
        updatedAt
      };
    });
  }

  let cart = [];

  // -----------------------------
  // TROCA DE PAPEL / TELAS
  // -----------------------------
  function setRole(role, account = null) {
    currentRole = role;
    if (role === 'colab') {
      currentColabAccount = account;
      agendaProfessionalFilterColab = account?.id || slugify(account?.name || '') || 'all';
    } else {
      currentColabAccount = null;
      agendaProfessionalFilterColab = 'all';
    }
    if (role === 'ceo') agendaProfessionalFilter = 'all';

    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('kiosk-screen').classList.add('hidden');

    if (role === 'ceo' || role === 'colab') {
      document.getElementById('app-shell').classList.remove('hidden');
      setupSidebar(role);
      updateRoleLabel(role);
      updateVisiblePage();
    } else if (role === 'kiosk') {
      document.getElementById('kiosk-screen').classList.remove('hidden');
      renderKiosk();
    }
  }

  function backToLogin() {
    currentRole = null;
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('kiosk-screen').classList.add('hidden');
    switchLoginMode(loginMode);
  }

  function openKioskFromDashboard() {
    setRole('kiosk');
  }

  function switchLoginMode(mode) {
    loginMode = mode;
    const ceoCard = document.getElementById('login-ceo-card');
    const colabCard = document.getElementById('login-colab-card');
    const tabCeo = document.getElementById('tab-ceo');
    const tabColab = document.getElementById('tab-colab');
    const title = document.getElementById('login-title');
    const subtitle = document.getElementById('login-subtitle');

    if (!ceoCard || !colabCard) return;

    const isCeo = mode === 'ceo';
    ceoCard.classList.toggle('hidden', !isCeo);
    colabCard.classList.toggle('hidden', isCeo);
    tabCeo.classList.toggle('active', isCeo);
    tabColab.classList.toggle('active', !isCeo);
    title.textContent = isCeo ? 'Sal√£o Glecie ‚Ä¢ Painel' : 'Login exclusivo da colaboradora';
    subtitle.textContent = isCeo
      ? 'Escolha como deseja acessar o sistema. Depois voc√™ pode trocar isso por login real com Firebase.'
      : 'Use apenas o usu√°rio e senha que a CEO criou para voc√™. Aqui n√£o aparece a op√ß√£o de entrar como CEO.';
  }

  function openCollaboratorLogin(username) {
    const account = collaboratorAccounts.find(acc => acc.username === username);
    backToLogin();
    switchLoginMode('colab');
    if (account) {
      document.getElementById('collab-login-username').value = account.username;
      document.getElementById('collab-login-password').value = account.password;
      document.getElementById('collab-login-device').value = account.device || '';
    }
  }

  function loginCollaboratorAccount() {
    const username = document.getElementById('collab-login-username').value.trim();
    const password = document.getElementById('collab-login-password').value.trim();
    const device = document.getElementById('collab-login-device').value.trim();
    const account = collaboratorAccounts.find(acc => acc.username === username && acc.password === password);
    if (!account) {
      alert('Usu√°rio ou senha inv√°lidos. Confira o login entregue pela CEO.');
      return;
    }
    currentColabAccount = { ...account, device };
    setRole('colab', currentColabAccount);
  }

  function createCollaboratorAccount() {
    const name = document.getElementById('new-colab-name').value.trim();
    const username = document.getElementById('new-colab-username').value.trim();
    const password = document.getElementById('new-colab-password').value.trim();
    const permissions = document.getElementById('new-colab-permissions').value.trim();

    if (!name || !username || !password) {
      alert('Preencha nome, usu√°rio e senha para criar o acesso.');
      return;
    }

    collaboratorAccounts.push({ name, username, password, permissions, device: 'Tablet dedicado' });
    collaborators.push({ name, username, role: 'Colaboradora', commission: '40% servi√ßos', permissions: permissions || 'Agenda compartilhada, comiss√µes', color: '#f1c76d' });

    renderCollaborators();
    document.getElementById('new-colab-name').value = '';
    document.getElementById('new-colab-username').value = '';
    document.getElementById('new-colab-password').value = '';
    document.getElementById('new-colab-permissions').value = '';
    closeDialog('login-dedicated-modal');
    alert(`Login criado para ${name}. Usu√°rio: ${username} | Senha: ${password}`);
  }

  function openDedicatedLoginModal(name = '') {
    document.getElementById('new-colab-name').value = name || '';
    document.getElementById('new-colab-username').value = name ? name.toLowerCase() : '';
    document.getElementById('new-colab-password').value = '';
    document.getElementById('new-colab-permissions').value = '';
    openDialog('login-dedicated-modal');
  }

  function openCollabAddModal() {
    document.getElementById('add-collab-name').value = '';
    document.getElementById('add-collab-role').value = 'Colaboradora';
    document.getElementById('add-collab-commission').value = '40% servi√ßos';
    document.getElementById('add-collab-login').value = '';
    document.getElementById('add-collab-permissions').value = 'Agenda compartilhada, comiss√µes';
    openDialog('add-collab-modal');
  }

  function saveNewCollaborator() {
    const name = document.getElementById('add-collab-name').value.trim();
    const role = document.getElementById('add-collab-role').value.trim() || 'Colaboradora';
    const commission = document.getElementById('add-collab-commission').value.trim() || '40% servi√ßos';
    const username = document.getElementById('add-collab-login').value.trim();
    const permissions = document.getElementById('add-collab-permissions').value.trim() || 'Agenda compartilhada, comiss√µes';
    if (!name) return;
    const palette = ['#f1c76d', '#d4af37', '#f3c06b', '#b58c25'];
    const color = palette[Math.floor(Math.random() * palette.length)];
    collaborators.push({ name, role, commission, permissions, username, color, active: true });
    if (username) {
      collaboratorAccounts.push({ name, username, password: '123', permissions, device: 'Tablet dedicado' });
    }
    renderCollaborators();
    closeDialog('add-collab-modal');
  }

  function openEditCollab(index) {
    currentEditingCollabIndex = index;
    const col = collaborators[index];
    document.getElementById('edit-collab-name').value = col.name;
    document.getElementById('edit-collab-role').value = col.role;
    document.getElementById('edit-collab-login').value = col.username || '';
    document.getElementById('perm-agenda').checked = col.permissions?.toLowerCase().includes('agenda');
    document.getElementById('perm-estoque').checked = col.permissions?.toLowerCase().includes('estoque');
    document.getElementById('perm-comissao').checked = col.permissions?.toLowerCase().includes('comiss√£o') || col.permissions?.toLowerCase().includes('comissao');
    openDialog('edit-collab-modal');
  }

  function saveCollaboratorProfile() {
    if (currentEditingCollabIndex === null) return;
    const name = document.getElementById('edit-collab-name').value.trim();
    const role = document.getElementById('edit-collab-role').value.trim();
    const username = document.getElementById('edit-collab-login').value.trim();
    const permissions = [
      document.getElementById('perm-agenda').checked ? 'Agenda' : null,
      document.getElementById('perm-estoque').checked ? 'Estoque' : null,
      document.getElementById('perm-comissao').checked ? 'Comiss√£o' : null,
    ].filter(Boolean).join(', ');
    const updated = { ...collaborators[currentEditingCollabIndex], name: name || collaborators[currentEditingCollabIndex].name, role: role || 'Colaboradora', username, permissions: permissions || 'Permiss√µes ajustadas no perfil' };
    collaborators[currentEditingCollabIndex] = updated;
    const accountIdx = collaboratorAccounts.findIndex(acc => acc.name === updated.name || acc.username === updated.username);
    if (accountIdx >= 0) {
      collaboratorAccounts[accountIdx] = { ...collaboratorAccounts[accountIdx], name: updated.name, username: updated.username, permissions: updated.permissions };
    }
    renderCollaborators();
    closeDialog('edit-collab-modal');
  }

  function openCommissionModal(index) {
    currentCommissionIndex = index;
    const value = parseInt(collaborators[index].commission, 10) || 0;
    document.getElementById('commission-value').value = value;
    openDialog('commission-modal');
  }

  function saveCommission() {
    if (currentCommissionIndex === null) return;
    const value = parseInt(document.getElementById('commission-value').value, 10) || 0;
    collaborators[currentCommissionIndex].commission = `${value}% servi√ßos`;
    renderCollaborators();
    closeDialog('commission-modal');
  }

  function openCollabStatusModal(index, wantsRemove = false) {
    currentCollabStatusIndex = index;
    const col = collaborators[index];
    const toggleBtn = document.getElementById('collab-status-toggle');
    const textEl = document.getElementById('collab-status-text');
    if (toggleBtn) toggleBtn.textContent = col.active ? 'Desativar' : 'Reativar';
    if (textEl) textEl.textContent = `${col.name} ‚Ä¢ ${col.role}`;
    const removeBtn = document.querySelector('#collab-status-modal button[onclick="removeCollaborator()"]');
    if (removeBtn) removeBtn.dataset.triggerRemove = wantsRemove ? 'true' : 'false';
    openDialog('collab-status-modal');
    if (wantsRemove && removeBtn) removeBtn.focus();
  }

  function confirmDeactivateCollaborator() {
    if (currentCollabStatusIndex === null) return;
    collaborators[currentCollabStatusIndex].active = !collaborators[currentCollabStatusIndex].active;
    renderCollaborators();
    closeDialog('collab-status-modal');
    currentCollabStatusIndex = null;
  }

  function removeCollaborator() {
    if (currentCollabStatusIndex === null) return;
    const removed = collaborators.splice(currentCollabStatusIndex, 1)[0];
    collaboratorAccounts = collaboratorAccounts.filter(acc => acc.name !== removed.name && acc.username !== removed.username);
    renderCollaborators();
    closeDialog('collab-status-modal');
    currentCollabStatusIndex = null;
  }

  function openClientModal(mode = 'add', clientId = null) {
    const isEdit = mode === 'edit';
    currentClientEditingId = isEdit ? clientId : null;
    const client = isEdit ? clients.find(c => c.id === clientId) : null;
    const title = document.getElementById('client-form-title');
    const save = document.getElementById('client-form-save');
    const fields = {
      id: document.getElementById('client-id'),
      name: document.getElementById('client-name'),
      phone: document.getElementById('client-phone'),
      instagram: document.getElementById('client-instagram'),
      birthday: document.getElementById('client-birthday'),
      prefColor: document.getElementById('client-pref-color'),
      prefShape: document.getElementById('client-pref-shape'),
      prefExtension: document.getElementById('client-pref-extension'),
      allergies: document.getElementById('client-allergies'),
      notes: document.getElementById('client-notes'),
      responsible: document.getElementById('client-responsible')
    };

    if (fields.responsible) {
      fields.responsible.innerHTML = '';
      collaborators.forEach(col => {
        const opt = document.createElement('option');
        opt.value = col.name;
        opt.textContent = col.name;
        fields.responsible.appendChild(opt);
      });
    }

    if (title) title.textContent = isEdit ? 'Editar cliente' : 'Adicionar cliente';
    if (save) save.textContent = isEdit ? 'Salvar altera√ß√µes' : 'Salvar cliente';

    if (fields.id) fields.id.value = client?.id || '';
    if (fields.name) fields.name.value = client?.name || '';
    if (fields.phone) fields.phone.value = client?.phone || '';
    if (fields.instagram) fields.instagram.value = client?.instagram || '';
    if (fields.birthday) fields.birthday.value = client?.birthday || '';
    if (fields.prefColor) fields.prefColor.value = client?.prefColor || '';
    if (fields.prefShape) fields.prefShape.value = client?.prefShape || '';
    if (fields.prefExtension) fields.prefExtension.value = client?.prefExtension || '';
    if (fields.allergies) fields.allergies.value = client?.allergies || '';
    if (fields.notes) fields.notes.value = client?.notes || '';
    if (fields.responsible) fields.responsible.value = client?.responsible || (currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : collaborators[0].name);

    openDialog('client-form-modal');
  }

  function saveClient() {
    const name = document.getElementById('client-name').value.trim();
    const phone = document.getElementById('client-phone').value.trim();
    if (!name || !phone) return;
    const instagram = document.getElementById('client-instagram').value.trim();
    const birthday = document.getElementById('client-birthday').value;
    const prefColor = document.getElementById('client-pref-color').value.trim();
    const prefShape = document.getElementById('client-pref-shape').value.trim();
    const prefExtension = document.getElementById('client-pref-extension').value.trim();
    const allergies = document.getElementById('client-allergies').value.trim();
    const notes = document.getElementById('client-notes').value.trim();
    const responsible = document.getElementById('client-responsible').value;
    const existingId = document.getElementById('client-id').value || currentClientEditingId;
    const owner = responsible || (currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : 'Glecie');

    if (existingId) {
      const target = clients.find(c => c.id === existingId);
      if (target) {
        Object.assign(target, {
          name,
          phone,
          instagram,
          birthday,
          prefColor,
          prefShape,
          prefExtension,
          allergies,
          notes,
          responsible: owner
        });
        if (!target.owners.includes(owner)) target.owners.push(owner);
      }
    } else {
      const newClient = {
        id: `cli-${Date.now()}`,
        name,
        phone,
        instagram,
        birthday,
        prefColor,
        prefShape,
        prefExtension,
        allergies,
        responsible: owner,
        lastService: 'Novo cadastro',
        lastDate: '',
        owners: [owner],
        notes,
        extra: '',
        history: [],
        consume: [],
        future: [],
        nextAppointment: {}
      };
      clients.push(newClient);
    }

    renderClients('ceo');
    renderClients('colab');
    closeDialog('client-form-modal');
    currentClientEditingId = null;
  }

  function openClientDetails(id) {
    currentClientDetailId = id;
    activeClientTab = 'data';
    const client = clients.find(c => c.id === id);
    const nameEl = document.getElementById('client-detail-name');
    const phoneEl = document.getElementById('client-detail-phone');
    if (nameEl) nameEl.textContent = client?.name || 'Cliente';
    if (phoneEl && client) phoneEl.innerHTML = `<a href="${buildWhatsAppLink(client)}" target="_blank" rel="noopener">${client.phone}</a>`;
    document.querySelectorAll('.client-detail-tabs button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-detail-data').classList.add('active');
    renderClientDetailTab();
    openDialog('client-detail-modal');
  }

  function switchClientTab(tab) {
    activeClientTab = tab;
    document.querySelectorAll('.client-detail-tabs button').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(`tab-detail-${tab}`);
    if (btn) btn.classList.add('active');
    renderClientDetailTab();
  }

  function renderClientDetailTab() {
    const container = document.getElementById('client-detail-content');
    if (!container) return;
    const client = clients.find(c => c.id === currentClientDetailId);
    if (!client) return;
    if (activeClientTab === 'data') {
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Informa√ß√µes</h4>
          <div class="client-detail-list">
            <span>Telefone: <a href="${buildWhatsAppLink(client)}" target="_blank" rel="noopener">${client.phone}</a></span>
            <span>Instagram: ${client.instagram || '‚Äî'}</span>
            <span>Anivers√°rio: ${client.birthday || '‚Äî'}</span>
            <span>Prefer√™ncias: ${client.prefColor || '‚Äî'} ‚Ä¢ ${client.prefShape || '‚Äî'} ‚Ä¢ ${client.prefExtension || '‚Äî'}</span>
            <span>Alergias: ${client.allergies || '‚Äî'}</span>
            <span>Respons√°vel: ${client.responsible || (client.owners || ['Equipe'])[0]}</span>
            <span>Observa√ß√µes: ${client.notes || '‚Äî'}</span>
            <span>Extras: ${client.extra || '‚Äî'}</span>
            <span>√öltimo servi√ßo: ${client.lastService || '‚Äî'} ${client.lastDate ? '(' + client.lastDate + ')' : ''}</span>
          </div>
        </div>
      `;
    }

    if (activeClientTab === 'history') {
      const hist = (client.history || []).map(h => `<li>${h}</li>`).join('') || '<li>Sem hist√≥rico</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Hist√≥rico de servi√ßos</h4>
          <ul class="client-detail-list">${hist}</ul>
        </div>
      `;
    }

    if (activeClientTab === 'consume') {
      const cons = (client.consume || []).map(h => `<li>${h}</li>`).join('') || '<li>Sem consumos</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Consumos no sal√£o</h4>
          <ul class="client-detail-list">${cons}</ul>
        </div>
      `;
    }

    if (activeClientTab === 'future') {
      const fut = (client.future || []).map(f => `<li>${formatDateLabel(f.date)} ‚Ä¢ ${f.time} ‚Ä¢ ${f.serviceName || f.service} (${f.professionalName || f.professional || 'Equipe'})</li>`).join('') || '<li>Nenhum agendamento futuro</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Pr√≥ximos hor√°rios</h4>
          <ul class="client-detail-list">${fut}</ul>
          <button class="secondary" style="align-self:flex-start;" onclick="openAppointmentModal('${client.id}')">Agendar novamente</button>
        </div>
      `;
    }
  }

  function openRemoveClientModal(id) {
    pendingRemoveClientId = id;
    const client = clients.find(c => c.id === id);
    const text = document.getElementById('client-remove-text');
    if (text && client) text.textContent = `Remover ${client.name} e cancelar agendamentos futuros?`;
    openDialog('client-remove-modal');
  }

  function isFutureDate(dateStr) {
    if (!dateStr) return false;
    const today = new Date();
    const d = new Date(`${dateStr}T00:00:00`);
    return d >= new Date(today.getFullYear(), today.getMonth(), today.getDate());
  }

  function confirmRemoveClient() {
    if (!pendingRemoveClientId) return;
    const index = clients.findIndex(c => c.id === pendingRemoveClientId);
    if (index >= 0) clients.splice(index, 1);
    appointments = appointments.filter(a => !(a.clientId === pendingRemoveClientId && isFutureDate(a.date)));
    refreshAgendaFromAppointments();
    closeDialog('client-detail-modal');
    closeDialog('client-remove-modal');
    renderClients('ceo');
    renderClients('colab');
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');
    pendingRemoveClientId = null;
  }

  function rebuildClientAppointments(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    const related = appointments
      .filter(a => a.clientId === clientId && a.status !== 'canceled')
      .sort((a, b) => new Date(`${a.date}T${a.time || '00:00'}`) - new Date(`${b.date}T${b.time || '00:00'}`));

    const today = new Date();
    const future = related.filter(r => new Date(`${r.date}T${r.time || '00:00'}`) >= today);
    const owners = new Set(client.owners || []);
    related.forEach(r => { if (r.professionalName) owners.add(r.professionalName); });
    client.owners = Array.from(owners);
    client.future = future.map(r => ({ date: r.date, time: r.time, service: r.serviceName || r.service, professional: r.professionalName || r.professional }));
    client.nextAppointment = future[0]
      ? { date: future[0].date, time: future[0].time, service: future[0].serviceName || future[0].service }
      : {};
    const lastDone = [...related].filter(r => new Date(`${r.date}T${r.time || '00:00'}`) <= today).pop();
    if (lastDone) {
      client.lastService = lastDone.serviceName || lastDone.service;
      client.lastDate = formatDateLabel(lastDone.date);
    }
    if (!lastDone && future[0]) {
      client.lastService = future[0].serviceName || future[0].service;
      client.lastDate = formatDateLabel(future[0].date);
    }
    client.responsible = future[0]?.professionalName || lastDone?.professionalName || client.responsible;
  }

  function bindClientFromInput() {
    const input = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const match = clients.find(c => c.name.toLowerCase() === (input.value || '').toLowerCase());
    hidden.value = match ? match.id : '';
  }

  function renderDayAppointmentsModal() {
    const list = document.getElementById('day-appointments-list');
    const caption = document.getElementById('day-appointments-caption');
    if (!list || !dayModalDate) return;
    list.innerHTML = '';
    const scope = dayModalScope || 'ceo';
    const items = getAppointmentsForScope(scope)
      .filter(a => a.date === dayModalDate && a.status !== 'canceled')
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (caption) caption.textContent = `Hor√°rios do dia ${formatDateLabel(dayModalDate)}`;

    if (!items.length) {
      list.innerHTML = '<div class="subtext">Nenhum agendamento para este dia.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const row = document.createElement('div');
      row.className = 'appointment-card';
      row.style.setProperty('--appt-color', color);
      row.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title" style="font-size:1rem;">
            ${appt.time || '--:--'} ‚Ä¢ ${appt.serviceName || appt.service}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${client ? client.name : appt.clientName || 'Cliente'}</span>
            <span>${appt.status === 'done' ? 'Conclu√≠do' : 'Agendado'}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')">‚úé Editar</button>
          <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')">üóë Cancelar</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  function openDayAppointmentsModal(dateStr, scope = 'ceo') {
    dayModalDate = dateStr;
    dayModalScope = scope;
    const title = document.getElementById('day-appointments-title');
    if (title) title.textContent = `Agendamentos de ${formatDateLabel(dateStr)}`;
    renderDayAppointmentsModal();
    openDialog('day-appointments-modal');
  }

  function openAppointmentModal(clientId = null, appointmentId = null, presetDate = null, presetTime = null) {
    appointmentFormMode = appointmentId ? 'edit' : 'add';
    appointmentEditingId = appointmentId;
    appointmentPrefillClient = clientId;
    appointmentPrefillDate = presetDate;
    appointmentPrefillTime = presetTime;
    appointmentOpenedFromDayModal = Boolean(!appointmentId && presetDate && presetDate === dayModalDate);
    const client = clients.find(c => c.id === clientId);
    const editing = appointmentId ? appointments.find(a => a.id === appointmentId) : null;
    const modalTitle = document.getElementById('appointment-modal-title');
    const submitBtn = document.getElementById('appointment-submit-btn');
    const clientInput = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const profSelect = document.getElementById('appointment-professional');
    const serviceSelect = document.getElementById('appointment-service');
    const dateInput = document.getElementById('appointment-date');
    const timeInput = document.getElementById('appointment-time');
    const notes = document.getElementById('appointment-notes');

    if (modalTitle) modalTitle.textContent = appointmentFormMode === 'edit' ? 'Editar agendamento' : 'Novo agendamento';
    if (submitBtn) submitBtn.textContent = appointmentFormMode === 'edit' ? 'Atualizar e gerar WhatsApp' : 'Salvar e gerar WhatsApp';

    const baseClient = editing ? clients.find(c => c.id === editing.clientId) : client;

    if (clientInput) clientInput.value = baseClient ? baseClient.name : '';
    if (hidden) hidden.value = baseClient ? baseClient.id : '';
    if (notes) notes.value = editing ? (editing.notes || '') : '';
    const defaultDate = editing ? editing.date : (appointmentPrefillDate || baseClient?.nextAppointment?.date || '');
    const defaultTime = editing ? editing.time : (appointmentPrefillTime || baseClient?.nextAppointment?.time || '');
    if (dateInput) dateInput.value = defaultDate;
    if (timeInput) timeInput.value = defaultTime;

    if (profSelect) {
      profSelect.innerHTML = '';
      collaborators.forEach(col => {
        const opt = document.createElement('option');
        opt.value = col.id || slugify(col.name);
        opt.textContent = col.name;
        profSelect.appendChild(opt);
      });
      if (baseClient?.responsible) profSelect.value = baseClient.responsible.toLowerCase();
      if (currentRole === 'colab' && currentColabAccount) {
        profSelect.value = currentColabAccount.id || slugify(currentColabAccount.name);
      }
      if (editing && (editing.professionalId || editing.professional)) {
        profSelect.value = editing.professionalId || slugify(editing.professional);
      }
    }

    if (serviceSelect) {
      serviceSelect.innerHTML = '';
      const services = [...kioskServices];
      const editingServiceId = editing?.serviceId || editing?.service;
      if (editingServiceId && !services.some(s => s.id === editingServiceId || s.name === editing.service)) {
        services.push({ id: editingServiceId, name: editing?.serviceName || editing?.service || 'Servi√ßo' });
      }
      services.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.name}${s.price ? ' ‚Ä¢ R$ ' + s.price : ''}`;
        serviceSelect.appendChild(opt);
      });
      serviceSelect.value = editing?.serviceId || editing?.service || services[0]?.id || '';
    }

    renderClientsDatalist();
    openDialog('appointment-modal');
    appointmentPrefillDate = null;
    appointmentPrefillTime = null;
  }

  function saveAppointment() {
    const clientInput = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const professionalValue = document.getElementById('appointment-professional').value;
    const serviceValue = document.getElementById('appointment-service').value;
    const date = document.getElementById('appointment-date').value;
    const time = document.getElementById('appointment-time').value;
    const notes = document.getElementById('appointment-notes').value;

    const isEditing = appointmentFormMode === 'edit';
    const editingAppt = isEditing ? appointments.find(a => a.id === appointmentEditingId) : null;
    const professional = findCollaboratorByIdOrName(professionalValue) || { name: professionalValue, id: slugify(professionalValue) };
    const service = findServiceByIdOrName(serviceValue) || { name: serviceValue, id: slugify(serviceValue) };
    let client = clients.find(c => c.id === hidden.value) || clients.find(c => c.name.toLowerCase() === (clientInput.value || '').toLowerCase());
    if (!client) {
      client = {
        id: `cli-${Date.now()}`,
        name: clientInput.value,
        phone: '55',
        lastService: service.name,
        lastDate: formatDateLabel(date),
        instagram: '',
        birthday: '',
        prefColor: '',
        prefShape: '',
        prefExtension: '',
        allergies: '',
        responsible: professional.name,
        owners: [currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : professional.name || 'Glecie'],
        notes: '',
        extra: '',
        history: [],
        consume: [],
        future: [],
        nextAppointment: {}
      };
      clients.push(client);
    }

    client.owners = client.owners || [];
    if (professional.name && !client.owners.includes(professional.name)) client.owners.push(professional.name);
    client.responsible = professional.name || client.responsible;

    const status = isEditing ? (editingAppt?.status || 'scheduled') : 'scheduled';
    const baseCreatedAt = isEditing ? (editingAppt?.createdAt || new Date().toISOString()) : new Date().toISOString();
    const appointmentPayload = {
      clientId: client.id,
      clientName: client.name,
      professionalId: professional.id,
      professionalName: professional.name,
      professional: professional.name,
      serviceId: service.id,
      serviceName: service.name,
      service: service.name,
      date,
      time,
      notes,
      status
    };

    if (appointmentFormMode === 'edit' && appointmentEditingId) {
      const appt = appointments.find(a => a.id === appointmentEditingId);
      if (appt) {
        const previousClientId = appt.clientId;
        Object.assign(appt, appointmentPayload, {
          status,
          updatedAt: new Date().toISOString(),
          createdAt: appt.createdAt || baseCreatedAt
        });
        if (previousClientId && previousClientId !== client.id) rebuildClientAppointments(previousClientId);
      }
    } else {
      appointments.push({
        id: `appt-${Date.now()}-${Math.random().toString(16).slice(2, 7)}`,
        createdAt: baseCreatedAt,
        updatedAt: baseCreatedAt,
        ...appointmentPayload,
        status
      });
    }

    rebuildClientAppointments(client.id);
    refreshAgendaFromAppointments();

    renderClients('ceo');
    renderClients('colab');
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    if (currentClientDetailId === client.id) renderClientDetailTab();
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');

    closeDialog('appointment-modal');
    if (appointmentOpenedFromDayModal) {
      closeDialog('day-appointments-modal');
    }
    const link = buildWhatsAppLink(client, { appointment: { date, time, serviceName: service.name, service: service.name } });
    if (!isEditing) window.open(link, '_blank');

    appointmentFormMode = 'add';
    appointmentEditingId = null;
    appointmentOpenedFromDayModal = false;
  }

  function openDialog(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.remove('hidden');
  }

  function closeDialog(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.add('hidden');
  }

  function updateRoleLabel(role) {
    const el = document.getElementById('sidebar-role-label');
    if (role === 'ceo') el.textContent = 'Acesso CEO (total)';
    if (role === 'colab') {
      const label = currentColabAccount ? `${currentColabAccount.name} (colab)` : 'Colaboradora (comiss√£o)';
      el.textContent = label;
    }
  }

  function setupSidebar(role) {
    const nav = document.getElementById('sidebar-nav');
    nav.innerHTML = '';

      if (role === 'ceo') {
        const items = [
          { id: 'dashboard', label: 'Dashboard' },
          { id: 'agenda', label: 'Agenda' },
          { id: 'clients', label: 'Clientes' },
          { id: 'inventory', label: 'Estoque' },
          { id: 'investments', label: 'Investimentos' },
          { id: 'finance', label: 'Financeiro' },
          { id: 'settings', label: 'Configura√ß√µes' },
        ];
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav';
        btn.textContent = item.label;
        btn.dataset.page = item.id;
        btn.onclick = () => navigatePage('ceo', item.id);
        nav.appendChild(btn);
      });
      highlightSidebarActive('ceo', currentPageCEO);
    }

    if (role === 'colab') {
      const items = [
        { id: 'dashboard', label: 'Dashboard' },
        { id: 'agenda', label: 'Agenda' },
        { id: 'clients', label: 'Clientes' },
        { id: 'commission', label: 'Minhas comiss√µes' },
      ];
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav';
        btn.textContent = item.label;
        btn.dataset.page = item.id;
        btn.onclick = () => navigatePage('colab', item.id);
        nav.appendChild(btn);
      });
      highlightSidebarActive('colab', currentPageColab);
    }
  }

  function highlightSidebarActive(role, pageId) {
    const nav = document.getElementById('sidebar-nav');
    const buttons = nav.querySelectorAll('button.nav');
    buttons.forEach(btn => {
      if (btn.dataset.page === pageId) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    const titleMapCEO = {
      dashboard: ['Dashboard', 'Vis√£o geral do sal√£o'],
      agenda: ['Agenda', 'Vis√£o anual e mensal'],
      inventory: ['Estoque', 'Esmaltes e geladeira'],
      investments: ['Investimentos', 'Compras, reformas e melhorias'],
      finance: ['Financeiro', 'Resumo de receitas e custos'],
      clients: ['Clientes', 'Busca, fichas e agendamentos'],
      settings: ['Configura√ß√µes', 'Servi√ßos, comiss√£o, etc.']
    };

    const titleMapColab = {
      dashboard: ['Dashboard', 'Resumo do seu dia'],
      agenda: ['Agenda', 'Sua agenda + CEO'],
      clients: ['Clientes', 'Somente os seus contatos'],
      commission: ['Minhas comiss√µes', 'Detalhamento por servi√ßo']
    };

    const titleEl = document.getElementById('page-title');
    const subtitleEl = document.getElementById('page-subtitle');

    if (role === 'ceo') {
      const arr = titleMapCEO[pageId] || ['Dashboard', 'Vis√£o geral do sal√£o'];
      titleEl.textContent = arr[0];
      subtitleEl.textContent = arr[1];
    } else if (role === 'colab') {
      const arr = titleMapColab[pageId] || ['Dashboard', 'Resumo do seu dia'];
      titleEl.textContent = arr[0];
      subtitleEl.textContent = arr[1];
    }
  }

  function navigatePage(role, pageId) {
    if (role === 'ceo') currentPageCEO = pageId;
    if (role === 'colab') currentPageColab = pageId;
    updateVisiblePage();
    highlightSidebarActive(role, pageId);
  }

  function updateVisiblePage() {
    const ceoPages = document.querySelectorAll('.page-ceo');
    const colabPages = document.querySelectorAll('.page-colab');

    ceoPages.forEach(p => p.classList.add('hidden'));
    colabPages.forEach(p => p.classList.add('hidden'));

    if (currentRole === 'ceo') {
      const id = `page-ceo-${currentPageCEO}`;
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      renderCeoContent();
    }

    if (currentRole === 'colab') {
      const id = `page-colab-${currentPageColab}`;
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      renderColabContent();
    }
  }

  // -----------------------------
  // RENDERIZA√á√ÉO DE CONTE√öDO CEO
  // -----------------------------

  function setDashboardMonth(value) {
    selectedDashboardMonth = parseInt(value, 10) || 0;
    renderDashboardCards();
  }

  function computeInvestmentDashboardStats(monthIndex) {
    const currentYear = new Date().getFullYear();
    const target = new Date(currentYear, monthIndex, 1);
    let totalMes = 0;
    let parcelasPagasMes = 0;
    let futurosPlanejados = 0;
    let futurosQuantidade = 0;

    investments.forEach(inv => {
      const ref = inv.mesReferencia ? inv.mesReferencia.split('-') : null;
      const refDate = ref ? new Date(parseInt(ref[0], 10), parseInt(ref[1], 10) - 1, 1) : null;
      const total = inv.valorTotal ?? inv.amount ?? 0;
      const parcela = inv.valorParcela || (total / (inv.parcelasTotais || 1));
      if (refDate && refDate.getMonth() === target.getMonth() && refDate.getFullYear() === target.getFullYear()) {
        totalMes += total;
      }

      if (refDate && (refDate > target)) {
        futurosPlanejados += total;
        futurosQuantidade += 1;
      }

      const paidDate = inv.lastPaymentAt ? new Date(inv.lastPaymentAt) : null;
      const paidMatches = paidDate
        ? (paidDate.getMonth() === target.getMonth() && paidDate.getFullYear() === target.getFullYear())
        : (inv.status === 'Pago' && refDate && refDate.getMonth() === target.getMonth() && refDate.getFullYear() === target.getFullYear());
      if (paidMatches) {
        parcelasPagasMes += parcela;
      }
    });

    return { totalMes, parcelasPagasMes, futurosPlanejados, futurosQuantidade };
  }

  function renderDashboardCards() {
    const stats = monthlyDashboardStats.find(s => s.monthIndex === selectedDashboardMonth) || monthlyDashboardStats[0];
    const revenueEl = document.getElementById('dashboard-revenue');
    const revenueDelta = document.getElementById('dashboard-revenue-delta');
    const commEl = document.getElementById('dashboard-commission');
    const commDelta = document.getElementById('dashboard-commission-delta');
    const consEl = document.getElementById('dashboard-consumption');
    const consDelta = document.getElementById('dashboard-consumption-delta');
    const alertEl = document.getElementById('dashboard-stock-alerts');
    const alertDesc = document.getElementById('dashboard-stock-alerts-desc');
    const monthLabel = monthNamesFull[stats.monthIndex];

    if (revenueEl) revenueEl.textContent = formatCurrency(stats.revenue);
    if (revenueDelta) revenueDelta.textContent = `${stats.delta} ‚Ä¢ ${monthLabel}`;
    if (commEl) commEl.textContent = formatCurrency(stats.commission);
    if (commDelta) commDelta.textContent = `Comiss√£o prevista em ${monthLabel}`;
    if (consEl) consEl.textContent = formatCurrency(stats.consumption);
    if (consDelta) consDelta.textContent = 'Geladeira e consumo interno';
    if (alertEl) alertEl.textContent = `${stats.alerts} itens`;
    if (alertDesc) alertDesc.textContent = stats.alertsDesc;

    const invStats = computeInvestmentDashboardStats(selectedDashboardMonth);
    const invMonth = document.getElementById('dashboard-invest-month');
    const invMonthDesc = document.getElementById('dashboard-invest-month-desc');
    const invPaid = document.getElementById('dashboard-invest-paid');
    const invPaidDesc = document.getElementById('dashboard-invest-paid-desc');
    const invFuture = document.getElementById('dashboard-invest-future');
    const invFutureDesc = document.getElementById('dashboard-invest-future-desc');

    if (invMonth) invMonth.textContent = formatCurrency(invStats.totalMes);
    if (invMonthDesc) invMonthDesc.textContent = `Investimentos com refer√™ncia em ${monthLabel}`;
    if (invPaid) invPaid.textContent = formatCurrency(invStats.parcelasPagasMes);
    if (invPaidDesc) invPaidDesc.textContent = `Pagamentos registrados em ${monthLabel}`;
    if (invFuture) invFuture.textContent = formatCurrency(invStats.futurosPlanejados);
    if (invFutureDesc) invFutureDesc.textContent = `${invStats.futurosQuantidade} planejado(s) para os pr√≥ximos meses`;
  }

  function filterClientsByRole(scope) {
    if (scope === 'ceo') return clients;
    const colabName = currentColabAccount?.name || 'colab';
    const colabId = currentColabAccount?.id || '';
    const owned = c => (c.owners || []).some(o => o.toLowerCase() === colabName.toLowerCase());
    const responsible = c => (c.responsible || '').toLowerCase() === colabName.toLowerCase() || (c.responsible || '').toLowerCase() === colabId.toLowerCase();
    const viaAppointments = c => appointments.some(a => a.clientId === c.id && ((a.professionalName || '').toLowerCase() === colabName.toLowerCase() || (a.professionalId || '').toLowerCase() === colabId.toLowerCase()));
    const viaFuture = c => (c.future || []).some(f => (f.professionalName || f.professional || '').toLowerCase() === colabName.toLowerCase());
    return clients.filter(c => owned(c) || responsible(c) || viaAppointments(c) || viaFuture(c));
  }

  function renderClients(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'clients-grid-ceo' : 'clients-grid-colab');
    const searchEl = document.getElementById(scope === 'ceo' ? 'client-search-ceo' : 'client-search-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const search = (searchEl?.value || '').toLowerCase();
    const filtered = filterClientsByRole(scope)
      .filter(c => c.name.toLowerCase().includes(search) || (c.phone || '').includes(search));

    filtered.forEach(c => {
      const card = document.createElement('div');
      card.className = 'client-card';
      const badge = `<span class="badge-soft">${c.lastService || '‚Äî'}${c.lastDate ? ' ‚Ä¢ ' + c.lastDate : ''}</span>`;
      const whatsapp = buildWhatsAppLink(c);
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.4rem;">
          <div>
            <div class="client-name">${c.name}</div>
            <div class="client-meta">${badge}</div>
            <div class="client-meta">${c.prefColor ? 'Cor: ' + c.prefColor + ' ‚Ä¢ ' : ''}${c.prefShape ? 'Formato: ' + c.prefShape : ''}</div>
            <div class="client-meta">${c.notes || 'Sem observa√ß√µes'}</div>
          </div>
          <div class="client-pill">${c.nextAppointment?.time || '--:--'} ‚Ä¢ ${c.nextAppointment?.date ? formatDateLabel(c.nextAppointment.date) : 'agenda'}</div>
        </div>
        <div class="client-meta" style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
          <a href="${whatsapp}" target="_blank" rel="noopener">${c.phone}</a>
          ${c.instagram ? `<span class="badge-soft">${c.instagram}</span>` : ''}
          <span class="badge-soft">√öltimo: ${c.lastService || '‚Äî'}</span>
        </div>
        <div class="client-actions">
          <div class="inline-actions">
            <button class="secondary" onclick="openClientDetails('${c.id}')">Ver ficha</button>
            <button class="secondary" onclick="openAppointmentModal('${c.id}')">Agendar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openClientModal('edit','${c.id}')">‚úé Editar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openRemoveClientModal('${c.id}')">üóë Remover</button>
          </div>
          <span class="client-pill">${c.responsible || (c.owners || ['Respons√°vel'])[0]}</span>
        </div>
      `;
      listEl.appendChild(card);
    });

    if (!filtered.length) {
      listEl.innerHTML = '<div class="client-meta">Nenhuma cliente encontrada.</div>';
    }

    renderClientsDatalist();
  }

  function renderClientsDatalist() {
    const datalist = document.getElementById('clients-datalist');
    if (!datalist) return;
    datalist.innerHTML = '';
    clients.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.dataset.id = c.id;
      datalist.appendChild(opt);
    });
  }

  function setAgendaView(mode, scope = 'ceo') {
    if (scope === 'ceo') {
      agendaViewMode = mode;
    } else {
      agendaViewModeColab = mode;
    }
    const yearView = document.getElementById(scope === 'ceo' ? 'agenda-view-year' : 'agenda-view-year-colab');
    const monthView = document.getElementById(scope === 'ceo' ? 'agenda-view-month' : 'agenda-view-month-colab');
    const btnYear = document.getElementById(scope === 'ceo' ? 'agenda-toggle-year' : 'agenda-toggle-year-colab');
    const btnMonth = document.getElementById(scope === 'ceo' ? 'agenda-toggle-month' : 'agenda-toggle-month-colab');
    if (yearView && monthView) {
      yearView.classList.toggle('hidden', mode !== 'year');
      monthView.classList.toggle('hidden', mode !== 'month');
    }
    if (btnYear && btnMonth) {
      btnYear.classList.toggle('active', mode === 'year');
      btnMonth.classList.toggle('active', mode === 'month');
    }
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
    renderAgendaAppointments(scope);
    renderYearCalendar(scope);
  }

  function getProfessionalColor(name) {
    const match = collaborators.find(c => c.name.toLowerCase() === (name || '').toLowerCase());
    return match?.color || '#d4af37';
  }

  function getAppointmentsForScope(scope = 'ceo') {
    let list = appointments.filter(a => a.status !== 'canceled');
    if (scope === 'colab') {
      const colabName = (currentColabAccount?.name || '').toLowerCase();
      const colabId = (currentColabAccount?.id || '').toLowerCase();
      list = list.filter(a => (a.professionalName || '').toLowerCase() === colabName || (a.professionalId || '').toLowerCase() === colabId);
    }
    const activeFilter = scope === 'ceo' ? agendaProfessionalFilter : agendaProfessionalFilterColab;
    if (activeFilter && activeFilter !== 'all') {
      list = list.filter(a => getProfessionalKey(a) === activeFilter.toLowerCase() || (a.professionalName || '').toLowerCase() === activeFilter.toLowerCase());
    }
    return list;
  }

  function filterAppointmentsByScope(scope = 'ceo') {
    return getAppointmentsForScope(scope);
  }

  function setAgendaProfessionalFilter(value, scope = 'ceo') {
    if (scope === 'ceo') {
      agendaProfessionalFilter = value || 'all';
    } else {
      agendaProfessionalFilterColab = value || (currentColabAccount?.id || 'all');
    }
    renderYearCalendar(scope);
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
    renderAgendaAppointments(scope);
    renderDayAppointmentsModal();
  }

  function renderAgendaAppointments(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'agenda-appointments-list' : 'agenda-appointments-list-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const now = new Date();
    const items = filterAppointmentsByScope(scope)
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .filter(a => a.dateObj.toString() !== 'Invalid Date' && a.dateObj >= now)
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!items.length) {
      listEl.innerHTML = '<div class="subtext">Nenhum agendamento futuro.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const card = document.createElement('div');
      card.className = 'appointment-card';
      card.style.setProperty('--appt-color', color);
      card.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title">
            ${client ? client.name : (appt.clientName || 'Cliente')}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${formatDateLabel(appt.date)} ‚Ä¢ ${appt.time}</span>
            <span>Servi√ßo: ${appt.serviceName || appt.service}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')">‚úé Editar</button>
          <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')">üóë Remover</button>
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  function openRemoveAppointmentModal(id) {
    pendingRemoveAppointmentId = id;
    openDialog('appointment-remove-modal');
  }

  function confirmRemoveAppointment() {
    if (!pendingRemoveAppointmentId) return;
    const apptIndex = appointments.findIndex(a => a.id === pendingRemoveAppointmentId);
    if (apptIndex >= 0) {
      const appt = appointments[apptIndex];
      appointments.splice(apptIndex, 1);
      rebuildClientAppointments(appt.clientId);
    }
    pendingRemoveAppointmentId = null;
    refreshAgendaFromAppointments();
    renderClients('ceo');
    renderClients('colab');
    if (currentClientDetailId) renderClientDetailTab();
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');
    closeDialog('appointment-remove-modal');
  }

  function populateProfessionalFilters() {
    const ceoSelect = document.getElementById('agenda-prof-filter');
    const colabSelect = document.getElementById('agenda-prof-filter-colab');
    const optionList = [{ id: 'all', name: 'Todos' }, ...collaborators.map(c => ({ id: c.id || slugify(c.name), name: c.name }))];

    if (ceoSelect) {
      ceoSelect.innerHTML = '';
      optionList.forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.id;
        opt.textContent = optData.name;
        ceoSelect.appendChild(opt);
      });
      ceoSelect.value = agendaProfessionalFilter;
    }

    if (colabSelect) {
      colabSelect.innerHTML = '';
      const colabOptions = currentColabAccount ? [{ id: currentColabAccount.id || slugify(currentColabAccount.name), name: currentColabAccount.name }] : collaborators.map(c => ({ id: c.id || slugify(c.name), name: c.name }));
      colabOptions.forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.id;
        opt.textContent = optData.name;
        colabSelect.appendChild(opt);
      });
      colabSelect.value = agendaProfessionalFilterColab;
      if (!colabSelect.value && colabOptions[0]) colabSelect.value = colabOptions[0].id;
      colabSelect.disabled = true;
    }
  }

  function renderCeoContent() {
    setupMonthSelects();
    populateProfessionalFilters();
    renderDashboardCards();
    renderYearCalendar('ceo');
    setAgendaView(agendaViewMode, 'ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaAppointments('ceo');
    switchInventoryTab(currentInventoryTab);
    renderInventoryLists();
    renderCollaborators();
    renderServicesTable();
    renderInvestments();
    renderClients('ceo');
  }

  function renderColabContent() {
    setupMonthSelects();
    populateProfessionalFilters();
    renderYearCalendar('colab');
    setAgendaView(agendaViewModeColab, 'colab');
    renderAgendaMonthSummary('colab');
    renderAgendaAppointments('colab');
    renderClients('colab');
  }

  function renderYearCalendar(scope = 'ceo') {
    const container = document.getElementById(scope === 'ceo' ? 'year-calendar' : 'year-calendar-colab');
    if (!container) return;
    container.innerHTML = '';
    baseYearDetailed.forEach(m => {
      const monthData = buildMonthSnapshot(m.monthIndex, scope);
      const div = document.createElement('div');
      const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
      div.className = 'month-card' + (m.monthIndex === selected ? ' active' : '');

      const header = document.createElement('div');
      header.className = 'month-header';
      header.innerHTML = `
        <div class="month-name">${m.fullName}</div>
        <div class="month-stat">${monthData.bookings} atend.</div>
      `;

      const bar = document.createElement('div');
      bar.className = 'month-bar';
      bar.innerHTML = `<div class="month-bar-fill" style="width:${monthData.occupancy}%;"></div>`;

      const mini = document.createElement('div');
      mini.className = 'mini-calendar';
      mini.innerHTML = `
        <div class="mini-weekdays">
          <span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span><span>D</span>
        </div>
      `;

      const daysGrid = document.createElement('div');
      daysGrid.className = 'mini-days';
      const days = buildMonthDays(calendarYear, m.monthIndex, monthData.highlightDays);
      days.forEach(d => {
        const span = document.createElement('span');
        span.className = 'mini-day' + (d.hasBooking ? ' has-booking' : '') + (d.empty ? ' empty' : '');
        span.textContent = d.label;
        if (!d.empty) {
          span.onclick = () => openDayAppointmentsModal(`${calendarYear}-${String(m.monthIndex + 1).padStart(2, '0')}-${String(d.label).padStart(2, '0')}`, scope);
        }
        if (d.hasBooking) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          span.appendChild(dot);
        }
        daysGrid.appendChild(span);
      });
      mini.appendChild(daysGrid);

      const footnote = document.createElement('div');
      footnote.className = 'month-footnote';
      footnote.innerHTML = `
        <span>Ocupa√ß√£o: ${monthData.occupancy}%</span>
        <span class="tag">ver m√™s</span>
      `;

      div.appendChild(header);
      div.appendChild(bar);
      div.appendChild(mini);
      div.appendChild(footnote);
      div.onclick = () => setSelectedMonth(m.monthIndex, scope);
      container.appendChild(div);
    });
  }

  function renderAgendaMonthCalendar(scope = 'ceo') {
    const calendarEl = document.getElementById(scope === 'ceo' ? 'agenda-month-calendar' : 'agenda-month-calendar-colab');
    const selector = document.getElementById(scope === 'ceo' ? 'agenda-month-selector' : 'agenda-month-selector-colab');
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    if (selector) selector.value = selected;
    if (!calendarEl) return;
    calendarEl.innerHTML = '';
    const weekdays = ['S', 'T', 'Q', 'Q', 'S', 'S', 'D'];
    weekdays.forEach(day => {
      const w = document.createElement('div');
      w.className = 'weekday';
      w.textContent = day;
      calendarEl.appendChild(w);
    });
    const month = buildMonthSnapshot(selected, scope);
    const days = buildMonthDays(calendarYear, month.monthIndex, month.highlightDays);
    days.forEach(d => {
      const cell = document.createElement('div');
      if (d.empty) {
        cell.style.background = 'transparent';
        calendarEl.appendChild(cell);
        return;
      }
      const match = month.daysSummary.find(day => day.day.startsWith(String(d.label).padStart(2, '0')));
      const hasBooking = Boolean(match);
      cell.className = 'month-day' + (hasBooking ? ' has-booking' : '');
      const badgeText = hasBooking ? `${match.count} ag.` : 'Livre';
      cell.innerHTML = `
        <div class="day-number">${d.label}</div>
        <span class="day-badge" style="${hasBooking ? '' : 'background:transparent;color:var(--text-muted);'}">${badgeText}</span>
      `;
      cell.onclick = () => {
        openDayAppointmentsModal(`${calendarYear}-${String(month.monthIndex + 1).padStart(2, '0')}-${String(d.label).padStart(2, '0')}`, scope);
      };
      calendarEl.appendChild(cell);
    });
  }

  function renderAgendaMonthSummary(scope = 'ceo') {
    const tbody = document.getElementById(scope === 'ceo' ? 'agenda-month-summary' : 'agenda-month-summary-colab');
    if (!tbody) return;
    tbody.innerHTML = '';
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    const month = buildMonthSnapshot(selected, scope);
    const monthTitle = document.getElementById(scope === 'ceo' ? 'selected-month-title' : 'selected-month-title-colab');
    const tagContainer = document.getElementById(scope === 'ceo' ? 'selected-month-tags' : 'selected-month-tags-colab');
    if (monthTitle) monthTitle.textContent = `Agenda de ${month.fullName}`;
    if (tagContainer) {
      tagContainer.innerHTML = '';
      month.tags.forEach(t => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = t;
        tagContainer.appendChild(span);
      });
      if (!month.tags.length) {
        const total = document.createElement('span');
        total.className = 'pill';
        total.textContent = `${month.bookings} atend.`;
        tagContainer.appendChild(total);
      }
      const ocup = document.createElement('span');
      ocup.className = 'pill';
      ocup.textContent = `${month.occupancy}% ocupa√ß√£o`;
      tagContainer.appendChild(ocup);
    }
    const scopedAppointments = getAppointmentsForScope(scope)
      .filter(a => {
        if (!a.date) return false;
        const [year, month] = a.date.split('-').map(Number);
        if (!month) return false;
        if (!year) return month - 1 === selected;
        return month - 1 === selected && year === calendarYear;
      })
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!scopedAppointments.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="subtext">Nenhum agendamento neste m√™s.</td>`;
      tbody.appendChild(tr);
      return;
    }

    scopedAppointments.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const clientName = client ? client.name : (appt.clientName || 'Cliente');
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDateLabel(appt.date)}</td>
        <td>${appt.time || '--:--'}</td>
        <td>${clientName}</td>
        <td>${appt.serviceName || appt.service}</td>
        <td><span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span></td>
        <td>
          <div style="display:flex;gap:0.35rem;justify-content:flex-end;">
            <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')">‚úé Editar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')">üóë Remover</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function setSelectedMonth(index, scope = 'ceo') {
    if (scope === 'ceo') {
      selectedMonthIndex = index;
    } else {
      selectedMonthIndexColab = index;
    }
    renderYearCalendar(scope);
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
  }

  function buildMonthSnapshot(monthIndex, scope = 'ceo') {
    const base = baseYearDetailed[monthIndex] || { monthIndex, fullName: monthNamesFull[monthIndex] || '', month: monthNamesShort[monthIndex] || '', tags: [] };
    const scopedAppointments = getAppointmentsForScope(scope).filter(a => {
      if (!a.date) return false;
      const [year, month] = a.date.split('-').map(Number);
      if (!month) return false;
      if (!year) return month - 1 === monthIndex;
      return month - 1 === monthIndex && year === calendarYear;
    });

    const dayMap = {};
    scopedAppointments.forEach(appt => {
      const [, month, day] = (appt.date || '').split('-');
      const dayNum = parseInt(day, 10);
      if (!dayNum) return;
      if (!dayMap[dayNum]) dayMap[dayNum] = { count: 0, pros: '', highlight: '' };
      dayMap[dayNum].count += 1;
      dayMap[dayNum].pros = mergePros(dayMap[dayNum].pros, appt.professionalName || appt.professional || 'Equipe');
      dayMap[dayNum].highlight = appt.serviceName || appt.service || dayMap[dayNum].highlight || 'Agendado';
    });

    const highlightDays = Object.keys(dayMap).map(Number).sort((a, b) => a - b);
    const daysSummary = highlightDays.map(day => ({
      day: `${String(day).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')}`,
      count: dayMap[day].count,
      pros: dayMap[day].pros || 'Equipe',
      highlight: dayMap[day].highlight || 'Agendado'
    }));

    const daysInMonth = new Date(calendarYear, monthIndex + 1, 0).getDate();
    const occupancy = Math.round((highlightDays.length / daysInMonth) * 100) || 0;

    return { ...base, bookings: scopedAppointments.length, highlightDays, daysSummary, occupancy };
  }

  function buildMonthDays(year, monthIndex, highlightDays = []) {
    const result = [];
    const firstWeekday = new Date(year, monthIndex, 1).getDay(); // 0=domingo
    const offset = (firstWeekday + 6) % 7; // for√ßa a semana a come√ßar na segunda
    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
    for (let i = 0; i < offset; i++) {
      result.push({ empty: true, label: '' });
    }
    for (let d = 1; d <= daysInMonth; d++) {
      result.push({
        label: d,
        hasBooking: highlightDays.includes(d)
      });
    }
    return result;
  }

  function mergePros(existing, professional) {
    if (!existing) return professional || 'Equipe';
    if (!professional) return existing;
    const parts = existing.split('+').map(p => p.trim());
    if (parts.includes(professional)) return existing;
    return `${existing} + ${professional}`;
  }

  function addAppointmentToAgenda(dateStr, service, professional) {
    if (!dateStr) return;
    const [year, month, day] = dateStr.split('-').map(Number);
    if (!month || !day) return;
    const monthEntry = mockYearDetailed.find(m => m.monthIndex === (month - 1));
    if (!monthEntry) return;
    if (!monthEntry.highlightDays.includes(day)) monthEntry.highlightDays.push(day);
    const label = `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}`;
    const existing = monthEntry.daysSummary.find(d => d.day.startsWith(String(day).padStart(2, '0')));
    if (existing) {
      existing.count += 1;
      existing.highlight = service || existing.highlight;
      existing.pros = mergePros(existing.pros, professional);
    } else {
      monthEntry.daysSummary.push({ day: label, count: 1, pros: professional || 'Equipe', highlight: service || 'Agendado' });
    }
    monthEntry.bookings = (monthEntry.bookings || 0) + 1;
  }

  function refreshAgendaFromAppointments() {
    clients.forEach(c => rebuildClientAppointments(c.id));
    renderYearCalendar('ceo');
    renderYearCalendar('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthSummary('colab');
    renderDayAppointmentsModal();
  }

  function switchInventoryTab(tab) {
    currentInventoryTab = tab;
    const polishPanel = document.getElementById('inventory-panel-polish');
    const fridgePanel = document.getElementById('inventory-panel-fridge');
    const polishBtn = document.getElementById('inventory-tab-btn-polish');
    const fridgeBtn = document.getElementById('inventory-tab-btn-fridge');
    if (polishPanel && fridgePanel) {
      polishPanel.classList.toggle('hidden', tab !== 'polish');
      fridgePanel.classList.toggle('hidden', tab !== 'fridge');
    }
    if (polishBtn && fridgeBtn) {
      polishBtn.classList.toggle('active', tab === 'polish');
      fridgeBtn.classList.toggle('active', tab === 'fridge');
    }
  }

  function resetInventoryForm() {
    document.getElementById('new-polish-name').value = '';
    document.getElementById('new-polish-brand').value = '';
    document.getElementById('new-polish-total').value = '';
    document.getElementById('new-polish-current').value = '';
    document.getElementById('new-fridge-name').value = '';
    document.getElementById('new-fridge-price').value = '';
    document.getElementById('new-fridge-stock').value = '';
  }

  function openInventoryModal(type, mode = 'add', index = null) {
    inventoryFormMode = mode;
    inventoryEditingType = type;
    inventoryEditingIndex = index;
    const modal = document.getElementById('inventory-modal');
    const title = document.getElementById('inventory-modal-title');
    const save = document.getElementById('inventory-modal-save');
    const polishFields = document.getElementById('inventory-modal-polish');
    const fridgeFields = document.getElementById('inventory-modal-fridge');
    resetInventoryForm();
    const isEdit = mode === 'edit';
    if (isEdit && index !== null) {
      if (type === 'polish') {
        const item = mockPolish[index];
        if (item) {
          document.getElementById('new-polish-name').value = item.name;
          document.getElementById('new-polish-brand').value = item.brand;
          document.getElementById('new-polish-total').value = item.total;
          document.getElementById('new-polish-current').value = item.current;
        }
      } else {
        const item = mockFridge[index];
        if (item) {
          document.getElementById('new-fridge-name').value = item.name;
          document.getElementById('new-fridge-price').value = item.price;
          document.getElementById('new-fridge-stock').value = item.stock;
        }
      }
    }
    if (modal) modal.classList.remove('hidden');
    if (title) title.textContent = isEdit
      ? (type === 'polish' ? 'Editar esmalte' : 'Editar item da geladeira')
      : (type === 'polish' ? 'Adicionar esmalte' : 'Adicionar item da geladeira');
    if (save) {
      save.textContent = isEdit ? 'Salvar altera√ß√µes' : 'Salvar';
      save.onclick = submitInventoryForm;
    }
    if (polishFields && fridgeFields) {
      polishFields.classList.toggle('hidden', type !== 'polish');
      fridgeFields.classList.toggle('hidden', type !== 'fridge');
    }
  }

  function closeInventoryModal() {
    const modal = document.getElementById('inventory-modal');
    inventoryFormMode = 'add';
    inventoryEditingIndex = null;
    inventoryEditingType = 'polish';
    if (modal) modal.classList.add('hidden');
  }

  function getFridgeIcon(name) {
    const lower = name.toLowerCase();
    if (lower.includes('√°gua')) return 'üö∞';
    if (lower.includes('ener')) return '‚ö°';
    if (lower.includes('suco')) return 'üßÉ';
    return 'ü•§';
  }

  function renderInventoryLists() {
    const polishEl = document.getElementById('inventory-polish-list');
    const fridgeEl = document.getElementById('inventory-fridge-list');
    if (polishEl) {
      polishEl.innerHTML = '';
      mockPolish.forEach(p => {
        const pct = Math.round((p.current / p.total) * 100);
        const div = document.createElement('div');
        div.className = 'inventory-card';
        div.innerHTML = `
          <span class="inventory-badge ${p.low ? 'low' : ''}">${p.low ? 'Baixo estoque' : 'OK'}</span>
          <div>
            <div class="inventory-card-title">${p.name}</div>
            <div class="inventory-meta">${p.brand} ‚Ä¢ ${p.current} ml de ${p.total} ml</div>
          </div>
          <div class="inventory-progress">
            <div class="fill" style="width:${pct}%;"></div>
          </div>
          <div class="inventory-foot">
            <div class="quantity-actions">
              <button onclick="adjustPolish(${mockPolish.indexOf(p)}, -5)">‚àí</button>
              <button onclick="adjustPolish(${mockPolish.indexOf(p)}, 5)">+</button>
            </div>
            <div class="inventory-actions-icons">
              <button class="icon-button" onclick="editPolish(${mockPolish.indexOf(p)})">‚úé</button>
              <button class="icon-button danger" onclick="removePolish(${mockPolish.indexOf(p)})">üóë</button>
            </div>
          </div>
        `;
        polishEl.appendChild(div);
      });
      if (!mockPolish.length) {
        polishEl.innerHTML = '<div class="inventory-empty">Nenhum esmalte cadastrado.</div>';
      }
    }

    if (fridgeEl) {
      fridgeEl.innerHTML = '';
      mockFridge.forEach(f => {
        const emoji = getFridgeIcon(f.name);
        const stockPct = Math.min(100, Math.max(10, Math.round((f.stock / 20) * 100)));
        const div = document.createElement('div');
        div.className = 'inventory-card';
        div.innerHTML = `
          <span class="inventory-badge ${f.low ? 'low' : ''}">${f.low ? 'Baixo estoque' : 'OK'}</span>
          <div>
            <div class="inventory-card-title">${emoji} ${f.name}</div>
            <div class="inventory-meta">${f.stock} unidades ‚Ä¢ R$ ${f.price}</div>
          </div>
          <div class="inventory-visibility">
            <span>${f.paused ? 'Pausado no tablet' : 'Vis√≠vel no tablet'}</span>
            <button class="inventory-toggle ${f.paused ? '' : 'active'}" onclick="toggleFridgeVisibility(${mockFridge.indexOf(f)})">${f.paused ? 'Pausado' : 'Ativo'}</button>
          </div>
          <div class="inventory-progress">
            <div class="fill" style="width:${stockPct}%;"></div>
          </div>
          <div class="inventory-foot">
            <div class="quantity-actions">
              <button onclick="adjustFridge(${mockFridge.indexOf(f)}, -1)">‚àí</button>
              <button onclick="adjustFridge(${mockFridge.indexOf(f)}, 1)">+</button>
            </div>
            <div class="inventory-actions-icons">
              <button class="icon-button" onclick="editFridge(${mockFridge.indexOf(f)})">‚úé</button>
              <button class="icon-button danger" onclick="removeFridge(${mockFridge.indexOf(f)})">üóë</button>
            </div>
          </div>
        `;
        fridgeEl.appendChild(div);
      });
      if (!mockFridge.length) {
        fridgeEl.innerHTML = '<div class="inventory-empty">Nenhum item na geladeira.</div>';
      }
    }
  }

  function getPolishFormData() {
    const name = document.getElementById('new-polish-name').value.trim();
    const brand = document.getElementById('new-polish-brand').value.trim();
    const total = parseInt(document.getElementById('new-polish-total').value, 10) || 0;
    const current = parseInt(document.getElementById('new-polish-current').value, 10) || 0;
    if (!name || !brand || !total) {
      alert('Preencha nome, marca e volume total.');
      return null;
    }
    return { name, brand, total, current, low: current <= total * 0.2 };
  }

  function getFridgeFormData() {
    const name = document.getElementById('new-fridge-name').value.trim();
    const price = parseFloat(document.getElementById('new-fridge-price').value) || 0;
    const stock = parseInt(document.getElementById('new-fridge-stock').value, 10) || 0;
    if (!name || !price) {
      alert('Preencha o nome e pre√ßo do item.');
      return null;
    }
    return { name, price, stock, low: stock < 5 };
  }

  function submitInventoryForm() {
    if (inventoryEditingType === 'polish') {
      const data = getPolishFormData();
      if (!data) return;
      if (inventoryFormMode === 'edit' && inventoryEditingIndex !== null) {
        const existing = mockPolish[inventoryEditingIndex];
        mockPolish[inventoryEditingIndex] = { ...existing, ...data };
      } else {
        mockPolish.push(data);
      }
    } else {
      const data = getFridgeFormData();
      if (!data) return;
      if (inventoryFormMode === 'edit' && inventoryEditingIndex !== null) {
        const existing = mockFridge[inventoryEditingIndex];
        mockFridge[inventoryEditingIndex] = { ...existing, ...data, paused: existing.paused, id: existing.id };
      } else {
        const id = 'fridge-' + Date.now();
        mockFridge.push({ ...data, paused: false, id });
      }
    }
    renderInventoryLists();
    syncKioskFromInventory();
    closeInventoryModal();
  }

  function adjustPolish(index, delta) {
    mockPolish[index].current = Math.max(0, mockPolish[index].current + delta);
    mockPolish[index].low = mockPolish[index].current <= mockPolish[index].total * 0.2;
    renderInventoryLists();
  }

  function editPolish(index) {
    openInventoryModal('polish', 'edit', index);
  }

  function removePolish(index) {
    mockPolish.splice(index, 1);
    renderInventoryLists();
  }

  function adjustFridge(index, delta) {
    mockFridge[index].stock = Math.max(0, mockFridge[index].stock + delta);
    mockFridge[index].low = mockFridge[index].stock < 5;
    renderInventoryLists();
    syncKioskFromInventory();
  }

  function toggleFridgeVisibility(index) {
    mockFridge[index].paused = !mockFridge[index].paused;
    renderInventoryLists();
    syncKioskFromInventory();
  }

  function editFridge(index) {
    openInventoryModal('fridge', 'edit', index);
  }

  function removeFridge(index) {
    mockFridge.splice(index, 1);
    renderInventoryLists();
    syncKioskFromInventory();
  }

  function renderCollaborators() {
    const container = document.getElementById('collaborators-list');
    if (!container) return;
    container.innerHTML = '';
    collaborators.forEach((col, index) => {
      const row = document.createElement('div');
      row.className = 'collab-row';
      const permLine = col.permissions ? col.permissions.split(',').map(p => p.trim()).slice(0, 2).join(' ‚Ä¢ ') : 'Ajuste no modal';
      row.innerHTML = `
        <div class="collab-id">
          <div class="collab-avatar" style="background:${col.color}">${col.name[0]}</div>
          <div class="collab-info">
            <strong>${col.name}</strong>
            <div class="collab-meta">${col.role} ‚Ä¢ ${col.commission}</div>
            <div class="collab-meta">${col.active ? 'Ativa' : 'Desativada'}</div>
          </div>
        </div>
        <div class="collab-permissions">
          <span class="collab-meta tagline">${permLine}</span>
          <span class="collab-meta">Login: <strong>${col.username || 'definir no modal'}</strong></span>
          <span class="collab-meta">Permiss√µes detalhadas no modal</span>
        </div>
        <div class="collab-actions">
          <button class="ghost-btn secondary" onclick="openEditCollab(${index})" title="Editar">‚úèÔ∏è</button>
          <button class="ghost-btn" onclick="openCommissionModal(${index})" title="Comiss√£o">üí∞</button>
          <button class="ghost-btn secondary" onclick="openCollabStatusModal(${index})" title="Ativar/Desativar">üö´</button>
          <button class="ghost-btn secondary" onclick="openCollabStatusModal(${index}, true)" title="Remover">üóë</button>
          ${col.username ? `<button class="ghost-btn" onclick="openCollaboratorLogin('${col.username}')" title="Login dedicado">üîë</button>` : `<button class="ghost-btn" onclick="openDedicatedLoginModal('${col.name}')">üîë Criar login</button>`}
        </div>
      `;
      container.appendChild(row);
    });
  }

  let investmentFilter = 'Todos';
  let investmentEditingId = null;

  function setInvestmentFilter(value) {
    investmentFilter = value;
    const ids = {
      Todos: 'invest-filter-all',
      Planejado: 'invest-filter-plan',
      'Em andamento': 'invest-filter-progress',
      Pago: 'invest-filter-paid'
    };
    Object.entries(ids).forEach(([status, btnId]) => {
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.toggle('active', value === status);
    });
    renderInvestments();
  }

  function formatMonthRef(monthStr) {
    if (!monthStr) return '‚Äî';
    const [year, month] = monthStr.split('-');
    const idx = parseInt(month, 10) - 1;
    return `${monthNamesShort[idx] || month}/${year}`;
  }

  function investmentBadge(status) {
    const map = {
      Planejado: 'status-plan',
      'Em andamento': 'status-progress',
      Pago: 'status-paid'
    };
    return map[status] || '';
  }

  function openInvestmentModal(mode = 'add', id = null) {
    investmentEditingId = mode === 'edit' ? id : null;
    const modalTitle = document.getElementById('investment-modal-title');
    const saveBtn = document.getElementById('investment-modal-save');
    const inv = investments.find(i => i.id === id) || {};
    document.getElementById('investment-id').value = inv.id || '';
    document.getElementById('investment-title').value = inv.title || '';
    document.getElementById('investment-category').value = inv.category || inv.categoria || '';
    document.getElementById('investment-month').value = inv.mesReferencia || '';
    document.getElementById('investment-amount').value = inv.valorTotal || inv.amount || '';
    document.getElementById('investment-parceled').value = inv.parcelado ? 'sim' : 'nao';
    document.getElementById('investment-installments').value = inv.parcelasTotais || 1;
    document.getElementById('investment-installment-value').value = inv.valorParcela || '';
    document.getElementById('investment-first-date').value = inv.firstParcelDate || '';
    document.getElementById('investment-current-installment').value = inv.parcelaAtual || 0;
    document.getElementById('investment-status').value = inv.status || 'Planejado';
    document.getElementById('investment-notes').value = inv.observacoes || '';
    if (modalTitle) modalTitle.textContent = mode === 'edit' ? 'Editar investimento' : 'Adicionar investimento';
    if (saveBtn) saveBtn.textContent = mode === 'edit' ? 'Atualizar' : 'Salvar';
    toggleParcelFields();
    openDialog('investment-modal');
  }

  function toggleParcelFields() {
    const isParceled = document.getElementById('investment-parceled').value === 'sim';
    const installs = document.getElementById('investment-installments');
    const value = document.getElementById('investment-installment-value');
    const firstDate = document.getElementById('investment-first-date');
    [installs, value, firstDate].forEach(el => {
      if (!el) return;
      el.disabled = !isParceled;
      el.classList.toggle('disabled', !isParceled);
    });
  }

  function saveInvestment() {
    const id = document.getElementById('investment-id').value || `inv-${Date.now()}`;
    const title = document.getElementById('investment-title').value.trim();
    const category = document.getElementById('investment-category').value.trim() || 'Geral';
    const mesReferencia = document.getElementById('investment-month').value;
    const valorTotal = parseFloat(document.getElementById('investment-amount').value) || 0;
    const parcelado = document.getElementById('investment-parceled').value === 'sim';
    const parcelasTotais = parcelado ? (parseInt(document.getElementById('investment-installments').value, 10) || 1) : 1;
    const valorParcelaInput = parseFloat(document.getElementById('investment-installment-value').value);
    const valorParcela = parcelado ? (valorParcelaInput || (valorTotal / parcelasTotais)) : valorTotal;
    const firstParcelDate = document.getElementById('investment-first-date').value || '';
    const parcelaAtual = parseInt(document.getElementById('investment-current-installment').value, 10) || 0;
    const status = document.getElementById('investment-status').value || 'Planejado';
    const observacoes = document.getElementById('investment-notes').value || '';

    if (!title || !valorTotal) {
      alert('Preencha t√≠tulo e valor total');
      return;
    }

    const existing = investments.find(i => i.id === id);
    const now = new Date().toISOString();
    const parcelaAtualFinal = Math.min(parcelaAtual, parcelasTotais);
    let statusFinal = status;
    if (parcelaAtualFinal >= parcelasTotais) {
      statusFinal = 'Pago';
    } else if (parcelaAtualFinal > 0 && parcelasTotais > 1) {
      statusFinal = 'Em andamento';
    }

    const payload = {
      id,
      title,
      category,
      valorTotal,
      valorParcela,
      parcelasTotais,
      parcelaAtual: parcelaAtualFinal,
      mesReferencia,
      parcelado,
      firstParcelDate,
      observacoes,
      status: statusFinal,
      createdAt: existing?.createdAt || now,
      updatedAt: now,
      lastPaymentAt: existing?.lastPaymentAt || null
    };

    if (existing) {
      investments = investments.map(inv => inv.id === id ? { ...inv, ...payload } : inv);
    } else {
      investments.push(payload);
    }

    closeDialog('investment-modal');
    renderInvestments();
    renderDashboardCards();
  }

  function renderInvestments() {
    const container = document.getElementById('investment-groups');
    if (!container) return;
    container.innerHTML = '';
    const statusList = ['Planejado', 'Em andamento', 'Pago'];
    const filtered = investmentFilter === 'Todos' ? investments : investments.filter(inv => inv.status === investmentFilter);

    statusList
      .filter(status => investmentFilter === 'Todos' || status === investmentFilter)
      .forEach(status => {
        const groupItems = filtered
          .filter(inv => inv.status === status)
          .sort((a, b) => (a.mesReferencia || '').localeCompare(b.mesReferencia || ''));
        const group = document.createElement('div');
        group.className = 'investment-group';
        group.innerHTML = `
          <div class="investment-group-head">
            <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
              <strong>${status}</strong>
              <span class="badge ${investmentBadge(status)}">${groupItems.length} itens</span>
            </div>
            <div class="pill soft">Organiza√ß√£o por refer√™ncia mensal</div>
          </div>
          <table class="investment-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Categoria</th>
                <th>M√™s ref.</th>
                <th>Parcelas</th>
                <th>Valores</th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        `;
        const tbody = group.querySelector('tbody');
        groupItems.forEach(item => {
          const total = item.valorTotal ?? item.amount ?? 0;
          const parcelaTotal = item.parcelasTotais || 1;
          const current = item.parcelaAtual || 0;
          const parcLabel = parcelaTotal > 1 ? `${current}/${parcelaTotal}` : '√önica';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <div class="investment-main">
                <strong>${item.title}</strong>
                <div class="investment-meta">
                  <span>${item.observacoes || 'Sem observa√ß√µes'}</span>
                </div>
              </div>
            </td>
            <td><span class="badge-soft">${item.category || item.categoria || 'Geral'}</span></td>
            <td>${formatMonthRef(item.mesReferencia)}</td>
            <td>${parcLabel}</td>
            <td>
              <div class="investment-meta">
                <span>Total: <strong>${formatCurrency(total)}</strong></span>
                <span>Parcela: <strong>${formatCurrency(item.valorParcela || total)}</strong></span>
              </div>
            </td>
            <td><span class="badge ${investmentBadge(item.status)}">${item.status}</span></td>
            <td>
              <div class="investment-actions">
                <button class="ghost-btn" title="Editar" onclick="openInvestmentModal('edit', '${item.id}')">‚úèÔ∏è</button>
                <button class="ghost-btn secondary" title="Pr√≥xima parcela" onclick="advanceInvestment('${item.id}')">‚è≠</button>
                <button class="ghost-btn secondary" title="Marcar pago" onclick="markInvestmentPaid('${item.id}')">‚úîÔ∏è</button>
                <button class="ghost-btn secondary" style="color:var(--danger);border-color:var(--danger);" title="Remover" onclick="openInvestmentRemoveModal('${item.id}')">üóë</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
        container.appendChild(group);
      });
  }

  function advanceInvestment(id) {
    investments = investments.map(inv => {
      if (inv.id !== id) return inv;
      const next = Math.min((inv.parcelaAtual || 0) + 1, inv.parcelasTotais || 1);
      const status = next >= (inv.parcelasTotais || 1) ? 'Pago' : 'Em andamento';
      return { ...inv, parcelaAtual: next, status, lastPaymentAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
    });
    renderInvestments();
    renderDashboardCards();
  }

  function markInvestmentPaid(id) {
    investments = investments.map(inv => inv.id === id ? {
      ...inv,
      parcelaAtual: inv.parcelasTotais || 1,
      status: 'Pago',
      lastPaymentAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    } : inv);
    renderInvestments();
    renderDashboardCards();
  }

  function openInvestmentRemoveModal(id) {
    investmentEditingId = id;
    const inv = investments.find(i => i.id === id);
    const text = document.getElementById('investment-remove-text');
    if (text) text.textContent = `Remover "${inv?.title || 'investimento'}"?`; 
    openDialog('investment-remove-modal');
  }

  function confirmRemoveInvestment() {
    if (!investmentEditingId) return;
    investments = investments.filter(inv => inv.id !== investmentEditingId);
    investmentEditingId = null;
    closeDialog('investment-remove-modal');
    renderInvestments();
    renderDashboardCards();
  }

  function renderServicesTable() {
    const tbody = document.getElementById('services-table');
    if (!tbody) return;
    tbody.innerHTML = '';
    kioskServices.forEach(service => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${service.name}</td>
        <td>${service.duration || '-'}</td>
        <td>${formatCurrency(service.price)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openServiceAddModal() {
    document.getElementById('add-service-name').value = '';
    document.getElementById('add-service-duration').value = '';
    document.getElementById('add-service-price').value = '';
    openDialog('service-add-modal');
  }

  function saveNewService() {
    const name = document.getElementById('add-service-name').value.trim();
    const duration = document.getElementById('add-service-duration').value.trim();
    const price = parseFloat(document.getElementById('add-service-price').value) || 0;
    if (!name || !duration || !price) {
      alert('Preencha nome, dura√ß√£o e pre√ßo do servi√ßo.');
      return;
    }
    const id = `svc-${Date.now()}`;
    kioskServices.push({ id, name, duration, price, icon: '‚ú®' });
    renderServicesTable();
    renderKiosk();
    closeDialog('service-add-modal');
  }

  function openServiceEditModal() {
    const select = document.getElementById('edit-service-select');
    select.innerHTML = '';
    kioskServices.forEach(svc => {
      const opt = document.createElement('option');
      opt.value = svc.id;
      opt.textContent = svc.name;
      select.appendChild(opt);
    });
    currentEditingServiceId = kioskServices[0]?.id || null;
    select.value = currentEditingServiceId || '';
    prefillServiceFields();
    openDialog('service-edit-modal');
  }

  function prefillServiceFields() {
    const select = document.getElementById('edit-service-select');
    currentEditingServiceId = select.value;
    const svc = kioskServices.find(s => s.id === currentEditingServiceId);
    if (!svc) return;
    document.getElementById('edit-service-duration').value = svc.duration || '';
    document.getElementById('edit-service-price').value = svc.price || '';
  }

  function saveServiceEdit() {
    const svc = kioskServices.find(s => s.id === currentEditingServiceId);
    if (!svc) return;
    svc.duration = document.getElementById('edit-service-duration').value || svc.duration;
    svc.price = parseFloat(document.getElementById('edit-service-price').value) || svc.price;
    renderServicesTable();
    renderKiosk();
    closeDialog('service-edit-modal');
  }

  function syncKioskFromInventory() {
    kioskDrinks = mockFridge
      .filter(item => !item.paused)
      .map(item => ({ id: item.id, name: item.name, price: item.price, icon: getFridgeIcon(item.name) }));
    cart = cart.filter(entry => entry.type !== 'drink' || kioskDrinks.some(d => d.id === entry.id));
    renderKiosk();
  }

  // -----------------------------
  // KIOSK (CLIENTE) - CARRINHO
  // -----------------------------
  function renderKiosk() {
    const drinksEl = document.getElementById('kiosk-drinks');
    const servicesEl = document.getElementById('kiosk-services');
    if (drinksEl) {
      drinksEl.innerHTML = '';
      kioskDrinks.forEach(d => {
        const div = document.createElement('div');
        div.className = 'kiosk-card';
        div.innerHTML = `
          <div class="kiosk-icon">${d.icon || 'ü•§'}</div>
          <h3>${d.name}</h3>
          <div class="kiosk-price">R$ ${d.price}</div>
          <div class="kiosk-badge">Consumo imediato</div>
          <button style="margin-top:0.5rem;" onclick="addDrinkToCart('${d.id}')">Adicionar</button>
        `;
        drinksEl.appendChild(div);
      });
    }
    if (servicesEl) {
      servicesEl.innerHTML = '';
      kioskServices.forEach(s => {
        const div = document.createElement('div');
        div.className = 'kiosk-card';
        div.innerHTML = `
          <div class="kiosk-icon">${s.icon || 'üíÖ'}</div>
          <h3>${s.name}</h3>
          <div class="kiosk-price">R$ ${s.price}</div>
          <div class="kiosk-badge">Servi√ßo principal</div>
          <button style="margin-top:0.5rem;" onclick="selectService('${s.id}')">Selecionar</button>
        `;
        servicesEl.appendChild(div);
      });
    }
    renderCart();
  }

  function addDrinkToCart(drinkId) {
    const drink = kioskDrinks.find(d => d.id === drinkId);
    if (!drink) return;
    cart.push({ type: 'drink', id: drink.id, name: drink.name, price: drink.price });
    renderCart();
  }

  function selectService(serviceId) {
    const service = kioskServices.find(s => s.id === serviceId);
    if (!service) return;
    // Remove servi√ßos anteriores do carrinho
    cart = cart.filter(item => item.type !== 'service');
    cart.push({ type: 'service', id: service.id, name: service.name, price: service.price });
    renderCart();
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function clearCart() {
    cart = [];
    renderCart();
  }

  function calcTotalCart() {
    return cart.reduce((sum, item) => sum + item.price, 0);
  }

  function renderCart() {
    const listEl = document.getElementById('kiosk-cart-list');
    const totalEl = document.getElementById('kiosk-cart-total');
    if (!listEl || !totalEl) return;

    listEl.innerHTML = '';
    cart.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'kiosk-cart-item';
      const label = item.type === 'drink' ? 'Consumo' : 'Servi√ßo';
      div.innerHTML = `
        <div>
          <strong>${item.name}</strong>
          <div class="subtext" style="margin-top:0.1rem;">${label}</div>
        </div>
        <div style="text-align:right;">
          <div>R$ ${item.price}</div>
          <button class="secondary" style="padding:0.15rem 0.5rem;font-size:0.7rem;margin-top:0.15rem;"
            onclick="removeFromCart(${index})">
            Remover
          </button>
        </div>
      `;
      listEl.appendChild(div);
    });

    totalEl.textContent = 'R$ ' + calcTotalCart().toFixed(2).replace('.', ',');
  }

  function sendOrder() {
    if (cart.length === 0) {
      alert('Adicione pelo menos um item ao carrinho.');
      return;
    }

    // TODO: aqui voc√™ envia o cart para o Firestore:
    // - criar documento em "orders" com items, hor√°rio, etc.
    // - atualizar estoque (via Cloud Function)
    // Exemplo (pseudo):
    // await addDoc(collection(db, "orders"), { items: cart, createdAt: serverTimestamp(), ... })

    alert('Pedido registrado! A profissional ser√° avisada.');
    clearCart();
  }

  // Inicializa√ß√£o
  // (poderia detectar login real do Firebase aqui)
  normalizeAppointmentsData();
  refreshAgendaFromAppointments();
  syncKioskFromInventory();
  switchLoginMode('ceo');
</script>

</body>
</html>
