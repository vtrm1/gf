<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Studio Nails - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --pastel-green: #E3F4E1;
      --pastel-green-dark: #AACFA3;
      --btn-primary: #9bbf92;
      --btn-primary-hover: #87ad80;
      --btn-secondary-bg: #ffffff;
      --btn-secondary-hover: #e9f6e5;
      --btn-neutral-bg: var(--gray-2);
      --btn-neutral-text: #3b3b3b;
      --btn-edit-bg: #a9c4e5;
      --btn-edit-hover: #96b4db;
      --btn-entry-bg: #e6f6e4;
      --btn-entry-text: #3f6a46;
      --btn-exit-bg: #f6e7d6;
      --btn-exit-text: #7a5a2c;
      --btn-danger-bg: #f7b7b7;
      --btn-danger-hover: #f39c9c;
      --pastel-beige: #FFF7F3;
      --pastel-peach: #FCE9DD;
      --text-dark: #2F2F2F;

      --pastel-rose: #F4D9D2;
      --pastel-blue: #E8EEF4;

      --wood-1: #EEDFCB;
      --wood-2: #E4D4BD;
      --wood-3: #D9C7AC;
      --wood-4: #CBB79A;
      --wood-5: #B7A06A;
      --wood-6: #9F8958;
      --wood-7: #897447;

      --gray-1: #F2F2F2;
      --gray-2: #EAEAEA;
      --gray-3: #DCDCDC;
      --gray-4: #CFCFCF;

      --bg-body: linear-gradient(180deg, #F6E4D6 0%, #E6EFE6 60%, #E8EEF4 100%);
      --bg-card: var(--pastel-peach);
      --bg-card-alt: var(--pastel-blue);
      --bg-sidebar: var(--wood-1);
      --accent-gold: var(--wood-5);
      --accent-gold-dark: var(--wood-6);
      --accent-gold-deep: var(--wood-7);
      --accent-gold-rgb: 183, 160, 106;
      --text-main: var(--text-dark);
      --text-muted: #6f5d4c;
      --border-soft: var(--gray-3);
      --danger: #d9534f;
      --chart-pink: #F4D9D2;
      --chart-gold: #B7A06A;
      --chart-green: #E6EFE6;

      --tab-polish: #f4d9d2;
      --tab-polish-text: #7a5a50;
      --tab-fridge: #e6efe6;
      --tab-fridge-text: #3f6a46;
      --tab-maint: #e8eef4;
      --tab-maint-text: #4b617f;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Sora', sans-serif;
    }

    body {
      background: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      font-family: 'Sora', sans-serif;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    button {
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.55rem 1.35rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 999px;
      background: var(--btn-primary);
      color: #fff;
      white-space: nowrap;
      transition: all 0.2s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .btn-primary,
    button:not(.secondary):not(.btn-secondary):not(.nav) {
      background: var(--btn-primary);
      color: #fff;
    }

    button:hover,
    .btn-primary:hover {
      background: var(--btn-primary-hover);
      color: #fff;
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    button.secondary,
    .btn-secondary {
      background: var(--btn-secondary-bg);
      border: 1px solid var(--btn-primary);
      color: var(--btn-primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    button.secondary:hover,
    .btn-secondary:hover {
      background: var(--btn-secondary-hover);
      color: var(--btn-primary-hover);
      transform: translateY(-1px) scale(1.01);
    }

    .segmented {
      display: inline-flex;
      background: rgba(var(--accent-gold-rgb), 0.1);
      border-radius: 999px;
      padding: 0.15rem;
      gap: 0.15rem;
    }

    .segmented button {
      background: transparent;
      color: var(--accent-gold-dark);
      box-shadow: none;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.85rem;
    }

    .segmented button.active {
      background: var(--bg-card);
      border-color: rgba(var(--accent-gold-rgb), 0.6);
      color: var(--text-main);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .segmented.compact button {
      padding: 0.3rem 0.65rem;
      font-size: 0.8rem;
    }

    .tag,
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--pastel-peach);
      color: var(--text-dark);
      white-space: nowrap;
    }

    .tag.attention,
    .badge.attention {
      background: #fecaca;
      color: #b91c1c;
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, var(--bg-sidebar) 0%, var(--wood-3) 100%);
      border-right: 1px solid var(--border-soft);
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-collapsed .sidebar {
      display: none;
    }

    .sidebar-collapsed .content {
      padding: 1.25rem;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fffdf7, var(--accent-gold));
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }

    .sidebar button.nav {
      width: 100%;
      justify-content: flex-start;
      border-radius: 999px;
      padding: 0.55rem 0.9rem;
      font-size: 0.85rem;
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid transparent;
    }

    .sidebar button.nav.active {
      background: rgba(var(--accent-gold-rgb), 0.2);
      border-color: rgba(var(--accent-gold-rgb), 0.7);
      color: var(--accent-gold-dark);
    }

    .sidebar button.nav:hover {
      background: rgba(var(--accent-gold-rgb), 0.12);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .content {
      flex: 1;
      padding: 1.5rem 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.4rem;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .topbar h1 {
      font-size: 1.3rem;
    }

    .global-filter-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.8rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.06);
      flex-wrap: wrap;
    }

    .global-filter-bar .label {
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .global-filter-select {
      min-width: 180px;
      padding: 0.6rem 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-alt);
      color: var(--text-main);
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.04);
    }

    .global-filter-select:focus {
      outline: 1px solid rgba(var(--accent-gold-rgb),0.5);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 1rem 1.1rem;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.9);
    }

    .card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
      color: var(--accent-gold-deep);
    }

    .card .value {
      font-size: 1.3rem;
      font-weight: 600;
      margin-top: 0.1rem;
    }

    .subtext {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 0.75rem;
      background: rgba(255,255,255,0.8);
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .section-title h2 {
      font-size: 1rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.4rem;
      font-size: 0.85rem;
    }

    .table th, .table td {
      text-align: left;
      padding: 0.5rem 0.4rem;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .table th {
      font-weight: 500;
      color: var(--text-muted);
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(0,0,0,0.04);
    }

    .badge.status-plan { background: rgba(var(--accent-gold-rgb), 0.1); color: var(--accent-gold-dark); }
    .badge.status-progress { background: rgba(46, 204, 113, 0.12); color: #1e824c; }
    .badge.status-paid { background: rgba(52, 152, 219, 0.12); color: #1f6fa5; }

    .investment-controls { display: flex; flex-direction: column; gap: 0.75rem; }
    .filter-line { display: flex; justify-content: space-between; align-items: center; gap: 0.8rem; flex-wrap: wrap; }
    .filter-label { font-weight: 600; color: var(--text-main); display: block; margin-top: 0.15rem; }
    .month-dropdown { padding: 0.45rem 0.6rem; border-radius: 10px; border: 1px solid var(--border-soft); background: #fffbf4; min-width: 160px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.04); }
    .control-actions { display: flex; justify-content: space-between; align-items: center; gap: 0.65rem; flex-wrap: wrap; }
    .investment-groups { display: flex; flex-direction: column; gap: 0.75rem; }
    .investment-card { border: 1px solid var(--border-soft); border-radius: 14px; padding: 0.9rem 1rem; background: linear-gradient(180deg,#fffefb,#ffffff); box-shadow: 0 8px 16px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 0.55rem; }
    .investment-card-head { display: flex; justify-content: space-between; gap: 0.6rem; align-items: flex-start; }
    .investment-card-title { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap; }
    .investment-tag { background: rgba(0,0,0,0.03); border-radius: 10px; padding: 0.15rem 0.55rem; font-size: 0.78rem; color: var(--text-muted); }
    .investment-status { padding: 0.25rem 0.6rem; border-radius: 999px; font-weight: 700; font-size: 0.78rem; }
    .status-plan { background: rgba(var(--accent-gold-rgb), 0.12); color: var(--accent-gold-deep); }
    .status-progress { background: rgba(46, 204, 113, 0.12); color: #1e824c; }
    .status-paid { background: rgba(52, 152, 219, 0.12); color: #1f6fa5; }
    .investment-meta-line { display: flex; flex-wrap: wrap; gap: 0.8rem; color: var(--text-muted); font-size: 0.9rem; align-items: center; }
    .investment-meta-line strong { color: var(--text-main); }
    .investment-card-actions { display: flex; gap: 0.35rem; flex-wrap: wrap; justify-content: flex-start; }
    .investment-card-actions.compact { justify-content: flex-start; padding: 0; }
    .investment-actions { display: inline-flex; gap: 0.3rem; flex-wrap: wrap; align-items: center; }
    .investment-actions button { height: 34px; }
    .investment-note { color: var(--text-muted); font-size: 0.86rem; }
    .investment-history-list { display: flex; flex-direction: column; gap: 0.45rem; margin-top: 0.6rem; }
    .investment-history-item { padding: 0.55rem 0.65rem; border-radius: 12px; background: var(--bg-card); border: 1px solid var(--border-soft); box-shadow: 0 4px 12px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .investment-history-item .subtext { margin: 0; }
    .investment-toggle { background: transparent; color: var(--text-main); font-weight: 700; box-shadow: none; padding: 0.25rem 0; }

    @media (min-width: 801px) {
      .investment-card { flex-direction: row; align-items: center; justify-content: space-between; }
      .investment-card-body { display: flex; flex: 1; align-items: center; gap: 1rem; flex-wrap: wrap; }
      .investment-card-actions { justify-content: flex-end; min-width: 260px; }
      .investment-card-left { display: flex; flex-direction: column; gap: 0.35rem; min-width: 260px; }
      .investment-card-actions.compact { display: none; }
    }

    @media (max-width: 800px) {
      .investment-card { gap: 0.35rem; }
      .investment-card-body { display: none; }
      .investment-card.expanded .investment-card-body { display: flex; flex-direction: column; gap: 0.3rem; align-items: flex-start; }
      .investment-card-actions { width: 100%; }
      .investment-card-actions:not(.compact) { display: none; }
      .investment-card.expanded .investment-card-actions:not(.compact) { display: flex; }
    }

    .calendar-year {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.9rem;
      margin-top: 0.5rem;
    }

    .month-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 0.7rem 0.8rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.9);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s ease;
    }

    .month-card.active {
      border-color: rgba(var(--accent-gold-rgb), 0.6);
      box-shadow: 0 4px 16px rgba(var(--accent-gold-rgb), 0.12);
    }

    .month-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.2rem;
    }

    .month-name {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .month-stat {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .month-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      overflow: hidden;
      margin-top: 0.3rem;
    }

    .month-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--wood-2), var(--accent-gold));
      width: 40%;
    }

      .mini-calendar {
        margin-top: 0.5rem;
        border: 1px dashed rgba(0,0,0,0.06);
        border-radius: 12px;
        padding: 0.5rem;
        background: rgba(255,255,255,0.6);
      }

    @media (max-width: 768px) {
      .kiosk-icon-btn { display: none; }
    }

    .full-month-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.35rem;
      margin-top: 0.65rem;
      background: var(--bg-card-alt);
      padding: 0.75rem;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 14px rgba(0,0,0,0.05);
    }

    .full-month-calendar .weekday {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
    }

    .full-month-calendar .month-day {
      height: 80px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(180deg, var(--bg-card) 0%, #fff 100%);
      padding: 0.4rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 0.9rem;
      position: relative;
    }

    .full-month-calendar .month-day.has-booking {
      box-shadow: 0 0 0 2px rgba(var(--accent-gold-rgb), 0.35);
    }

    .full-month-calendar .month-day .day-number {
      font-weight: 600;
    }

    .full-month-calendar .month-day .day-badge {
      align-self: flex-start;
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      background: rgba(var(--accent-gold-rgb), 0.12);
      color: var(--accent-gold-dark);
    }

    .mini-weekdays,
    .mini-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      font-size: 0.7rem;
      text-align: center;
    }

    .mini-weekdays span {
      color: var(--text-muted);
      font-weight: 600;
    }

    .mini-day {
      padding: 0.35rem 0;
      border-radius: 10px;
      background: rgba(0,0,0,0.02);
      position: relative;
    }

    .mini-day.empty {
      background: transparent;
    }

    .mini-day.has-booking {
      border: 1px solid rgba(var(--accent-gold-rgb), 0.8);
      background: rgba(var(--accent-gold-rgb), 0.08);
      font-weight: 700;
      color: var(--accent-gold-dark);
      box-shadow: 0 0 0 2px rgba(var(--accent-gold-rgb), 0.15) inset;
    }

    .mini-day .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--appt-color, var(--accent-gold));
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
    }

    .month-footnote {
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .inventory-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 0.65rem;
      flex-wrap: wrap;
    }

    .inventory-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      width: 100%;
      margin-top: 0.25rem;
    }

    .inventory-actions button {
      padding: 0.4rem 1rem;
      font-size: 0.92rem;
    }

    .inventory-tabs {
      display: inline-flex;
      background: rgba(var(--accent-gold-rgb), 0.12);
      border-radius: 14px;
      padding: 0.2rem;
      gap: 0.2rem;
    }

    .inventory-tab {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 0.45rem 1rem;
      font-weight: 700;
      box-shadow: none;
      transition: all 0.18s ease;
    }

    .inventory-tab:hover {
      background: rgba(var(--accent-gold-rgb), 0.1);
    }

    .inventory-tab.active {
      color: var(--text-main);
      border-color: rgba(var(--accent-gold-rgb), 0.5);
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    }

    #inventory-tab-btn-polish {
      background: rgba(244, 217, 210, 0.4);
      color: var(--tab-polish-text);
    }

    #inventory-tab-btn-fridge {
      background: rgba(230, 239, 230, 0.45);
      color: var(--tab-fridge-text);
    }

    #inventory-tab-btn-maint {
      background: rgba(232, 238, 244, 0.5);
      color: var(--tab-maint-text);
    }

    #inventory-tab-btn-polish.active {
      background: rgba(244, 217, 210, 0.9);
      border-color: rgba(122, 90, 80, 0.45);
      box-shadow: 0 6px 14px rgba(122, 90, 80, 0.16);
    }

    #inventory-tab-btn-fridge.active {
      background: rgba(230, 239, 230, 0.95);
      border-color: rgba(63, 106, 70, 0.35);
      box-shadow: 0 6px 14px rgba(63, 106, 70, 0.14);
    }

    #inventory-tab-btn-maint.active {
      background: rgba(232, 238, 244, 0.95);
      border-color: rgba(75, 97, 127, 0.35);
      box-shadow: 0 6px 14px rgba(75, 97, 127, 0.14);
    }

    .inventory-list {
      margin-top: 0.6rem;
      display: grid;
      grid-template-columns: repeat(1, minmax(260px, 1fr));
      gap: 0.9rem;
    }

    @media (min-width: 900px) {
      .inventory-list { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    }

    @media (min-width: 1200px) {
      .inventory-list { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    .inventory-card {
      position: relative;
      background: var(--bg-card);
      border-radius: 14px;
      padding: 0.95rem 1rem 0.85rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.07);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      min-height: 140px;
    }

    .inventory-card .line-top {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .inventory-card .title-stack {
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
    }

    .inventory-badge {
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(var(--accent-gold-rgb), 0.08);
      color: var(--accent-gold-dark);
      border: 1px solid rgba(var(--accent-gold-rgb), 0.18);
    }

    .inventory-badge.low {
      background: rgba(217, 83, 79, 0.08);
      color: var(--danger);
      border-color: rgba(217, 83, 79, 0.2);
    }

    .inventory-badge.warn {
      background: rgba(255, 193, 7, 0.16);
      color: #8a5b00;
      border-color: rgba(255, 193, 7, 0.25);
    }

    .inventory-card-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: var(--text-main);
    }

    .inventory-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-top: 0.1rem;
    }

    .inventory-mini-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.4rem;
      font-size: 0.84rem;
      color: var(--text-muted);
    }

    .inventory-mini-meta span {
      display: inline-flex;
      align-items: center;
      gap: 0.32rem;
      padding: 0.35rem 0.5rem;
      background: rgba(0,0,0,0.02);
      border-radius: 10px;
      border: 1px solid var(--border-soft);
    }

    .inventory-progress {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      overflow: hidden;
    }

    .inventory-progress .fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--wood-2), var(--accent-gold));
      width: 70%;
    }

    .inventory-foot {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .inventory-actions-icons {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .inventory-actions-icons button {
      width: 36px;
      height: 32px;
      min-width: 32px;
      padding: 0.3rem;
      border-radius: 10px;
      background: var(--bg-soft);
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid var(--border-soft);
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0;
    }

    .inventory-tabpanel {
      margin-top: 0.4rem;
    }

    .inventory-empty {
      padding: 0.8rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .inventory-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 10;
    }

    .inventory-modal .card {
      max-width: 760px;
      width: 100%;
      padding: 1.25rem 1.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .inventory-modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.4rem;
      border-top: 1px solid var(--border-soft);
      padding-top: 0.6rem;
    }

    .inventory-modal .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem 0.9rem;
      margin-top: 0.35rem;
    }

    .inventory-modal input,
    .inventory-modal select,
    .inventory-modal textarea {
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.9);
    }

    .modal-section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-main);
      margin-top: 0.1rem;
    }

    .modal-section {
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      background: var(--bg-soft);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .inventory-templates {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 14px;
      padding: 0.85rem 1rem;
      margin: 0.6rem 0 0.9rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .inventory-templates .pill-row {
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.35rem;
    }

    .template-chip-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.45rem;
    }

    .template-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.55rem 0.65rem;
      border-radius: 12px;
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    .template-chip.esmaltes { border-color: rgba(122, 90, 80, 0.2); background: rgba(244, 217, 210, 0.35); }
    .template-chip.geladeira { border-color: rgba(63, 106, 70, 0.16); background: rgba(230, 239, 230, 0.4); }
    .template-chip.manutencao { border-color: rgba(75, 97, 127, 0.16); background: rgba(232, 238, 244, 0.45); }

    .template-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }

    .template-chip .icon {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: rgba(var(--accent-gold-rgb), 0.12);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      color: var(--accent-gold-dark);
    }

    .template-chip .meta {
      display: flex;
      flex-direction: column;
      gap: 0.08rem;
      font-size: 0.85rem;
      color: var(--text-main);
    }

    .template-chip .meta span {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      .inventory-list {
        grid-template-columns: 1fr;
      }
      .inventory-actions {
        justify-content: flex-start;
      }
      .inventory-actions button {
        padding: 0.38rem 0.85rem;
      }
      .inventory-card {
        padding: 0.85rem 0.9rem;
      }
      .inventory-actions-icons {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
    }

    .inventory-card .meta-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.3rem;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .inventory-card .history-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .inventory-card .pill-row {
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
      margin-top: 0.4rem;
    }

    .chart-card canvas {
      width: 100%;
      max-width: 320px;
      height: 200px;
    }

    .stock-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.65rem;
      margin: 0.35rem 0 0.5rem;
    }

    .summary-chip {
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      color: var(--text-main);
      box-shadow: 0 6px 14px rgba(0,0,0,0.05);
    }

    .summary-chip span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    button.danger {
      background: rgba(217,83,79,0.1);
      color: var(--danger);
      border-color: rgba(217,83,79,0.35);
    }

    .dialog-layer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
    }

    .dialog-layer.hidden {
      display: none !important;
    }

    .dialog-card {
      background: var(--pastel-beige);
      border-radius: 16px;
      box-shadow: 0 14px 38px rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.9);
      padding: 1.05rem 1.2rem;
      max-width: 540px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    .dialog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 0.6rem;
    }

    .dialog-card label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .dialog-card input,
    .dialog-card select,
    .dialog-card textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.95);
    }

    .dialog-card textarea {
      min-height: 60px;
      resize: vertical;
    }

    .dialog-card .disabled {
      opacity: 0.6;
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.2rem;
    }

    .section-caption {
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .settings-block {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1rem 1.1rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .block-header h3 {
      margin-bottom: 0.25rem;
    }

    .block-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .collab-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      border: 1px solid rgba(0,0,0,0.03);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,250,243,0.9));
    }

    .collab-row {
      display: grid;
      grid-template-columns: 1.3fr 1.6fr 1fr;
      gap: 0.8rem;
      padding: 0.7rem 0.9rem;
      align-items: center;
    }

    .collab-row + .collab-row {
      border-top: 1px solid var(--border-soft);
    }

    .collab-id {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      min-width: 0;
    }

    .collab-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      background: linear-gradient(135deg, var(--wood-2), var(--accent-gold-dark));
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      flex-shrink: 0;
    }

    .collab-info strong {
      font-size: 0.95rem;
    }

    .collab-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .collab-meta .tagline {
      color: var(--text-main);
      font-weight: 500;
    }

    .collab-permissions {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      color: var(--text-muted);
      font-size: 0.82rem;
    }

    .collab-actions {
      display: flex;
      gap: 0.3rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .ghost-btn {
      border-radius: 10px;
      padding: 0.35rem 0.55rem;
      background: rgba(var(--accent-gold-rgb),0.08);
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(var(--accent-gold-rgb),0.18);
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      height: 32px;
    }

    .ghost-btn.secondary {
      background: rgba(0,0,0,0.02);
      border-color: rgba(0,0,0,0.06);
      color: var(--text-muted);
    }

    .ghost-btn:hover {
      transform: translateY(-1px);
      background: rgba(var(--accent-gold-rgb),0.14);
    }

    .ghost-btn.secondary:hover {
      background: rgba(0,0,0,0.05);
    }

    .action-btn {
      padding: 0.3rem 0.65rem;
      height: 30px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      border: 1px solid transparent;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      white-space: nowrap;
      background: var(--btn-neutral-bg) !important;
      color: var(--btn-neutral-text) !important;
    }

    .action-btn.neutral {
      background: var(--btn-neutral-bg) !important;
      color: var(--btn-neutral-text) !important;
      border-color: rgba(0,0,0,0.06);
    }

    .action-btn.edit {
      background: var(--btn-edit-bg) !important;
      color: #fff !important;
      border-color: rgba(0,0,0,0.05);
    }

    .action-btn.entry {
      background: var(--btn-entry-bg) !important;
      color: var(--btn-entry-text) !important;
      border-color: rgba(63,106,70,0.25);
    }

    .action-btn.exit {
      background: var(--btn-exit-bg) !important;
      color: var(--btn-exit-text) !important;
      border-color: rgba(122,90,44,0.18);
    }

    .action-btn.danger {
      background: var(--btn-danger-bg) !important;
      color: #fff !important;
      border-color: rgba(0,0,0,0.05);
    }

    .action-btn:hover {
      transform: translateY(-1px);
    }

    .action-btn.edit:hover { background: var(--btn-edit-hover) !important; }
    .action-btn.entry:hover { filter: brightness(0.98); }
    .action-btn.exit:hover { filter: brightness(0.98); }
    .action-btn.danger:hover { background: var(--btn-danger-hover) !important; }

    .clients-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .clients-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .clients-search {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.55rem;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.92);
      min-width: 240px;
    }

    .clients-search input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .clients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
      margin-top: 0.4rem;
    }

    .client-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 0.85rem 0.95rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      position: relative;
    }

    .client-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .client-meta {
      color: var(--text-muted);
      font-size: 0.88rem;
      line-height: 1.3;
    }

    .client-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.35rem;
    }

    .client-actions .secondary {
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      border-radius: 10px;
    }

    .client-actions .icon-mini {
      padding: 0.3rem 0.6rem;
      font-size: 0.78rem;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }

    .client-pill {
      background: rgba(var(--accent-gold-rgb),0.12);
      color: var(--text-main);
      border-radius: 10px;
      padding: 0.2rem 0.55rem;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      width: fit-content;
    }

    .client-card a {
      color: var(--accent-gold-dark);
      text-decoration: none;
      font-weight: 600;
    }

    .client-card a:hover {
      text-decoration: underline;
    }

    .agenda-appointments {
      margin-top: 0.8rem;
      display: grid;
      gap: 0.6rem;
    }

    .appointment-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 0.85rem 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem 1rem;
      align-items: center;
      position: relative;
    }

    .appointment-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      bottom: 12px;
      width: 5px;
      border-radius: 12px;
      background: var(--accent-gold);
      opacity: 0.9;
    }

    .appointment-meta {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .appointment-title {
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .appointment-subtext {
      color: var(--text-muted);
      font-size: 0.88rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .appointment-actions {
      display: flex;
      gap: 0.35rem;
      align-items: center;
      justify-content: flex-end;
    }

    .appointment-pill {
      background: rgba(0,0,0,0.03);
      color: var(--text-main);
      padding: 0.2rem 0.55rem;
      border-radius: 10px;
      font-size: 0.82rem;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .client-detail-tabs {
      display: inline-flex;
      gap: 0.3rem;
      background: rgba(var(--accent-gold-rgb),0.1);
      padding: 0.2rem;
      border-radius: 12px;
      margin: 0.4rem 0;
    }

    .client-detail-tabs button {
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border-radius: 10px;
      padding: 0.35rem 0.7rem;
      font-size: 0.85rem;
      border: 1px solid transparent;
    }

    .client-detail-tabs button.active {
      background: var(--bg-card);
      border-color: rgba(var(--accent-gold-rgb),0.5);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .client-detail-section {
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      margin-top: 0.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .client-detail-section h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .client-detail-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .badge-soft {
      display: inline-flex;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .inline-actions {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .kiosk-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 1.25rem 1.5rem 1.5rem;
      background: radial-gradient(circle at 10% 20%, #fff7e6, #f0e7d8);
      border-radius: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }

    .kiosk-grid {
      display: grid;
      grid-template-columns: 1.8fr 1.1fr;
      gap: 1.1rem;
      margin-top: 1rem;
    }

    .kiosk-section-title {
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }

    .kiosk-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.7rem;
    }

    .kiosk-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.85rem 0.9rem;
      text-align: left;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
      position: relative;
      overflow: hidden;
    }

    .kiosk-card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .kiosk-price {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.35rem;
    }

    .kiosk-icon {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: 1.3rem;
      background: radial-gradient(circle at 30% 30%, #fff3d4, #f1d9a0);
      margin-bottom: 0.35rem;
    }

    .kiosk-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .kiosk-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.09), transparent 50%);
      pointer-events: none;
    }

    .kiosk-cart {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 1rem 1.1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      max-height: 520px;
    }

    .kiosk-cart-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 0.3rem;
    }

    .kiosk-cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.45rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
      font-size: 0.85rem;
    }

    .kiosk-cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      font-weight: 600;
    }

    .kiosk-hero {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .kiosk-steps {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.35rem;
    }

    .kiosk-pill {
      background: rgba(0,0,0,0.04);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .login-mode-toggle {
      display: flex;
      gap: 0.4rem;
      margin: 0.6rem 0;
      flex-wrap: wrap;
    }

    .login-tab {
      border-radius: 14px;
      padding: 0.5rem 0.9rem;
      background: rgba(0,0,0,0.03);
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
    }

    .login-tab.active {
      background: rgba(var(--accent-gold-rgb), 0.15);
      color: var(--accent-gold-dark);
      border-color: rgba(var(--accent-gold-rgb), 0.5);
      box-shadow: 0 2px 10px rgba(var(--accent-gold-rgb), 0.15);
    }

    .agenda-filter-select {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      padding: 0.35rem 0.6rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .agenda-filter-select label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0;
    }

    .agenda-filter-select select {
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--accent-gold-dark);
      outline: none;
    }

    .collab-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .collab-form input {
      width: 100%;
      padding: 0.55rem 0.6rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.8);
    }

    .collab-form small {
      grid-column: 1 / -1;
      color: var(--text-muted);
    }

    .login-screen {
      max-width: 420px;
      margin: 4rem auto;
      background: var(--bg-card);
      border-radius: 22px;
      padding: 1.5rem 1.7rem 1.3rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
    }

    .login-screen h1 {
      font-size: 1.4rem;
      margin-bottom: 0.3rem;
    }

    .login-screen p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }

    .role-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
      font-size: 0.75rem;
      margin-top: 0.2rem;
      color: var(--text-muted);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.9rem;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 900px) {
      .app-shell {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        padding: 0.75rem 1rem;
        overflow-x: auto;
      }
      .sidebar-nav {
        flex-direction: row;
        flex: 1;
        margin-top: 0;
      }
      .sidebar-footer {
        display: none;
      }
      .content {
        padding: 1rem;
      }
      .kiosk-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN / AUTENTICAÇÃO FIREBASE -->
<section id="login-screen" class="login-screen">
  <h1 id="login-title">Studio Nails • Painel</h1>
  <p id="login-subtitle">Acesse com seu e-mail ou usuário. O sistema identifica automaticamente seu perfil.</p>

  <div class="card" id="login-universal" style="margin-top:0.4rem;">
    <div class="collab-form">
      <div>
        <label class="subtext">Email ou usuário</label>
        <input id="login-identifier" placeholder="ex: camila ou camila@email.com" />
      </div>
      <div>
        <label class="subtext">Senha</label>
        <input id="login-password" type="password" placeholder="••••••" />
      </div>
    </div>
    <div style="display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:flex-start;margin-top:0.4rem;">
      <button onclick="handleEmailLogin()">Entrar</button>
      <button class="secondary" onclick="handleGoogleLogin()">Entrar com Google</button>
    </div>
  </div>

  <div class="card" style="margin-top:0.8rem;">
    <h3>Tablet do cliente (Kiosk)</h3>
    <p class="subtext">Tela fixa para o cliente registrar consumação e o serviço.</p>
    <button style="margin-top:0.5rem;" class="secondary" onclick="openKioskDirect()">
      Acessar modo tablet
    </button>
    <div class="chip">Ideal para ficar aberto em tela cheia no Studio</div>
  </div>
</section>

<!-- SHELL PRINCIPAL (CEO / COLAB) -->
<div id="app-shell" class="app-shell hidden">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle"></div>
      <div>
        <div style="font-size:0.9rem;font-weight:600;">Studio Nails</div>
        <div id="sidebar-role-label" style="font-size:0.75rem;color:var(--text-muted);">
          —
        </div>
      </div>
    </div>

    <div class="sidebar-nav" id="sidebar-nav">
      <!-- Botões injectados via JS conforme papel -->
    </div>

    <div class="sidebar-footer">
      v0.1 • painel personalizado<br>
      Feito para nail designer.
      <div style="margin-top:0.35rem;">
        <button class="secondary" style="padding:0.3rem 0.7rem;font-size:0.7rem;" onclick="backToLogin()">
          Trocar acesso
        </button>
      </div>
    </div>
  </aside>

  <main class="content">
    <header class="topbar flex flex-col gap-4 md:flex-row md:items-center md:justify-between bg-white/80 backdrop-blur rounded-2xl shadow-md p-5">
      <div class="space-y-1">
        <p class="text-sm text-slate-600">Visão rápida do Studio Nails</p>
        <h1 id="page-title" class="text-2xl font-semibold text-[color:var(--text-main)]">Dashboard – Visão Geral do Studio</h1>
        <div id="page-subtitle" class="text-sm text-slate-500">Visão geral do Studio Nails</div>
      </div>
      <div class="w-full md:w-72">
        <label class="text-sm font-medium text-slate-600 block mb-1">Filtro mensal</label>
        <select id="global-month-filter" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-sm focus:border-[var(--accent-gold)] focus:ring-[var(--accent-gold)]"></select>
      </div>
      <div class="topbar-actions flex items-center gap-2 justify-end w-full md:w-auto">
        <button id="sidebar-toggle-btn" class="secondary" onclick="toggleSidebar()">Ocultar menu</button>
      </div>
    </header>

    <!-- Páginas da CEO -->
    <section id="page-ceo-dashboard" class="page-ceo space-y-6">
      <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Faturamento do mês</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-green);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v12m-6-6h12" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-revenue">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-revenue-delta">--</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Comissão colaboradora</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-peach);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12l4-4m-4 4 4 4" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-commission">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-commission-delta">--</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Consumo vendido</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-blue);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12h16m0 0-4-4m4 4-4 4" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-consumption">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-consumption-delta">--</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Investimentos do mês</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-rose);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.5v15m-6-7.5h12" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-invest-month">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-invest-month-desc">Planejados para o mês selecionado</div>
        </div>
      </div>

      <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Parcelas pagas</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-green);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m5 13 4 4L19 7" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-invest-paid">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-invest-paid-desc">Pagamentos registrados no mês</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Planejado para próximos meses</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-peach);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l3 3" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-invest-future">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-invest-future-desc">Investimentos agendados para frente</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Itens em alerta</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-rose);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v4m0 4h.01M10.29 3.86 1.82 18a1 1 0 0 0 .86 1.5h18.64a1 1 0 0 0 .86-1.5L13.71 3.86a1 1 0 0 0-1.72 0Z" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-stock-alerts">0</div>
          <div class="text-sm text-slate-500" id="dashboard-stock-alerts-desc">Nenhum alerta</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Consumo no mês</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-blue);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7h16M4 12h10m-6 5h12" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-stock-consumption-month">0</div>
          <div class="text-sm text-slate-500">Atualizado pelo mês filtrado</div>
        </div>
      </div>

      <div id="dashboard-stock-card" class="rounded-3xl shadow-md p-6" style="background-color: var(--pastel-beige);">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold text-[color:var(--text-main)]">Estoque e Custos Operacionais</h2>
            <p class="text-sm text-slate-600">Custos, lucro da geladeira e alertas por categoria</p>
          </div>
          <div id="dashboard-stock-tags" class="flex flex-wrap gap-2 text-sm"></div>
        </div>
        <div id="dashboard-stock-totals" class="mt-3 flex flex-wrap gap-3 text-sm text-slate-700"></div>
        <div class="mt-4 grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Custo esmaltes</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-rose); color: var(--accent-gold-dark);">Categoria</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-esmaltes">R$ 0,00</div>
            <p class="text-xs text-slate-500">No mês filtrado</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Custo geladeira</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-peach); color: var(--accent-gold-dark);">Categoria</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-geladeira">R$ 0,00</div>
            <p class="text-xs text-slate-500">No mês filtrado</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Custo manutenção</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-blue); color: var(--accent-gold-dark);">Categoria</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-manutencao">R$ 0,00</div>
            <p class="text-xs text-slate-500">No mês filtrado</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Itens em alerta</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium bg-rose-100 text-rose-700">Atenção</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-low">0</div>
            <p class="text-xs text-slate-500">Previsão baixa ou pouca quantidade</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Lucro bruto geladeira</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-green); color: var(--accent-gold-dark);">Vendas</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-profit">R$ 0,00</div>
            <p class="text-xs text-slate-500">Com base no estoque atual</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Consumo no mês</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-peach); color: var(--accent-gold-dark);">Movimentação</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-consumption-month">0</div>
            <p class="text-xs text-slate-500">Saídas registradas</p>
          </div>
        </div>

        <div class="mt-4 grid gap-4 lg:grid-cols-2">
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-base font-semibold text-[color:var(--text-main)]">Distribuição de gastos</h4>
                <p class="text-xs text-slate-500">Gastos por categoria</p>
              </div>
            </div>
            <div class="h-72">
              <canvas id="stock-pie"></canvas>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-base font-semibold text-[color:var(--text-main)]">Evolução mensal</h4>
                <p class="text-xs text-slate-500">Últimos meses filtrados</p>
              </div>
            </div>
            <div class="h-72">
              <canvas id="stock-bars"></canvas>
            </div>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2" id="stock-indicators"></div>
      </div>

      <div class="bg-white rounded-2xl shadow-md p-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold text-[color:var(--text-main)]">Próximos horários</h2>
            <p class="text-sm text-slate-500">Acompanhe rapidamente os atendimentos mais próximos.</p>
          </div>
          <button class="secondary" onclick="navigatePage('ceo', 'agenda')">Abrir agenda</button>
        </div>
        <div class="mt-4 overflow-hidden rounded-xl border border-slate-100">
          <table class="w-full text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-4 py-3 text-left">Horário</th>
                <th class="px-4 py-3 text-left">Cliente</th>
                <th class="px-4 py-3 text-left">Profissional</th>
                <th class="px-4 py-3 text-left">Serviço</th>
                <th class="px-4 py-3 text-left">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <tr>
                <td colspan="5" class="px-4 py-4 text-center text-slate-500">Nenhum agendamento para exibir.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="page-ceo-agenda" class="page-ceo hidden">
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <h2 style="margin:0;">Agenda</h2>
          <div class="segmented">
            <button id="agenda-toggle-year" class="active" onclick="setAgendaView('year')">Visão anual</button>
            <button id="agenda-toggle-month" onclick="setAgendaView('month')">Mês a mês</button>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">2025</span>
            <span class="pill">CEO + Colab</span>
          </div>
          <div class="agenda-filter-select">
            <label>Profissional</label>
            <select id="agenda-prof-filter" onchange="setAgendaProfessionalFilter(this.value, 'ceo')"></select>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
      </div>
      <div id="agenda-view-year">
        <div class="calendar-year" id="year-calendar">
          <!-- Meses preenchidos via JS -->
        </div>
      </div>

      <div id="agenda-view-month" class="hidden">
        <div class="month-visual-toggle" style="margin-bottom:0.4rem;">
          <label class="subtext">Selecione o mês</label>
          <select id="agenda-month-selector" onchange="setSelectedMonth(parseInt(this.value))"></select>
          <div class="tag">Toque nos dias com atendimento para abrir detalhes</div>
        </div>
        <div class="full-month-calendar" id="agenda-month-calendar"></div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2 id="selected-month-title">Agenda do mês</h2>
        <div class="pill-row" id="selected-month-tags"></div>
      </div>
      <div class="card" style="margin-top:0.2rem;">
        <table class="table" style="margin:0;">
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Serviço</th>
              <th>Profissional</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="agenda-month-summary">
            <!-- Populado via JS mock -->
          </tbody>
        </table>
      </div>

    </section>

    <section id="page-ceo-inventory" class="page-ceo hidden">
      <div class="section-title" style="margin-top:0; align-items:flex-start;">
        <div>
          <h2>Estoque inteligente</h2>
          <div class="subtext">Controle visual por categorias e templates recorrentes</div>
        </div>
        <div class="inventory-actions">
          <button class="secondary" onclick="openTemplateManager()">Catálogo de produtos</button>
          <button onclick="openInventoryModal()">+ Adicionar item</button>
        </div>
      </div>

      <div class="inventory-header">
        <div class="inventory-tabs">
          <button id="inventory-tab-btn-polish" class="inventory-tab active" onclick="switchInventoryTab('esmaltes')">Esmaltes</button>
          <button id="inventory-tab-btn-fridge" class="inventory-tab" onclick="switchInventoryTab('geladeira')">Geladeira</button>
          <button id="inventory-tab-btn-maint" class="inventory-tab" onclick="switchInventoryTab('manutencao')">Manutenção</button>
        </div>
      </div>

      <div class="inventory-templates">
        <div class="subtext">Catálogo rápido por categoria</div>
        <div class="template-chip-row" id="inventory-template-chips"></div>
      </div>

      <div id="inventory-panel-esmaltes" class="inventory-tabpanel">
        <div class="section-title">
          <h2>Esmaltes</h2>
          <div class="pill-row" id="inventory-polish-metrics"></div>
        </div>
        <div class="inventory-list" id="inventory-polish-list"></div>
      </div>

      <div id="inventory-panel-geladeira" class="inventory-tabpanel hidden">
        <div class="section-title">
          <h2>Geladeira</h2>
          <div class="pill-row" id="inventory-fridge-metrics"></div>
        </div>
        <div class="inventory-list" id="inventory-fridge-list"></div>
      </div>

      <div id="inventory-panel-manutencao" class="inventory-tabpanel hidden">
        <div class="section-title">
          <h2>Studio / Manutenção</h2>
          <div class="pill-row" id="inventory-maintenance-metrics"></div>
        </div>
        <div class="inventory-list" id="inventory-maintenance-list"></div>
      </div>
    </section>

    <div id="inventory-modal" class="inventory-modal hidden">
      <div class="card">
        <div class="section-title" style="margin-top:0;">
          <h2 id="inventory-modal-title">Adicionar item</h2>
          <button class="secondary" onclick="closeInventoryModal()">Fechar</button>
        </div>

        <div class="modal-grid">
          <div class="modal-section">
            <div class="modal-section-title">Categoria & visibilidade</div>
            <label class="subtext">Categoria</label>
            <select id="inventory-category" onchange="handleInventoryDestinationChange(this.value)">
              <option value="esmaltes">Esmaltes</option>
              <option value="geladeira">Geladeira</option>
              <option value="manutencao">Manutenção</option>
            </select>
            <label class="subtext">Visibilidade no tablet</label>
            <select id="inventory-kiosk-flag">
              <option value="active">Colocar no consumo</option>
              <option value="paused">Manter oculto</option>
            </select>
            <div class="subtext">Sugestões se adaptam à categoria escolhida.</div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">Produtos recorrentes</div>
            <div class="subtext">Use templates ou edite-os rapidamente.</div>
            <div class="template-chip-row" id="inventory-template-row"></div>
          </div>
        </div>

        <div id="inventory-fields-esmaltes" class="modal-section">
          <div class="modal-section-title">Dados do item</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Nome</label>
              <input id="stock-polish-name" placeholder="Ex: Nude clássico" />
            </div>
            <div>
              <label class="subtext">Marca</label>
              <input id="stock-polish-brand" placeholder="Marca" />
            </div>
            <div>
              <label class="subtext">Volume total (ml)</label>
              <input id="stock-polish-total" type="number" min="0" />
            </div>
            <div>
              <label class="subtext">Volume atual (ml)</label>
              <input id="stock-polish-current" type="number" min="0" />
            </div>
          </div>
          <div class="modal-section-title">Configurações de consumo</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Custo total</label>
              <input id="stock-polish-cost" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Consumo estimado por uso (ml)</label>
              <input id="stock-polish-consumption" type="number" min="0" step="0.1" />
            </div>
            <div>
              <label class="subtext">Data da compra</label>
              <input id="stock-polish-date" type="date" />
            </div>
            <div>
              <label class="subtext">Previsão automática</label>
              <input id="stock-polish-forecast" disabled />
            </div>
          </div>
        </div>

        <div id="inventory-fields-geladeira" class="modal-section hidden">
          <div class="modal-section-title">Dados do item</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Nome</label>
              <input id="stock-fridge-name" placeholder="Ex: Água com gás" />
            </div>
            <div>
              <label class="subtext">Quantidade adicionada</label>
              <input id="stock-fridge-qty" type="number" min="0" />
            </div>
            <div>
              <label class="subtext">Custo total da compra</label>
              <input id="stock-fridge-cost" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Preço de venda</label>
              <input id="stock-fridge-price" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Data da compra</label>
              <input id="stock-fridge-date" type="date" />
            </div>
          </div>
        </div>

        <div id="inventory-fields-manutencao" class="modal-section hidden">
          <div class="modal-section-title">Dados do item</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Nome</label>
              <input id="stock-maint-name" placeholder="Ex: Papel higiênico" />
            </div>
            <div>
              <label class="subtext">Quantidade</label>
              <input id="stock-maint-qty" type="number" min="0" />
            </div>
            <div>
              <label class="subtext">Custo total da compra</label>
              <input id="stock-maint-cost" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Data da compra</label>
              <input id="stock-maint-date" type="date" />
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="secondary" onclick="closeInventoryModal()">Cancelar</button>
          <button id="inventory-modal-save" onclick="submitInventoryForm()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="template-modal" class="inventory-modal hidden">
      <div class="card">
        <div class="section-title" style="margin-top:0;">
          <h2 id="template-modal-title">Template de produto</h2>
          <button class="secondary" onclick="closeDialog('template-modal')">Fechar</button>
        </div>
        <div class="modal-grid">
          <div>
            <label class="subtext">Nome</label>
            <input id="template-name" />
          </div>
          <div>
            <label class="subtext">Categoria</label>
            <select id="template-category">
              <option value="esmaltes">Esmaltes</option>
              <option value="geladeira">Geladeira</option>
              <option value="manutencao">Manutenção</option>
            </select>
          </div>
          <div>
            <label class="subtext">Unidades por pack</label>
            <input id="template-pack" type="number" min="0" />
          </div>
          <div>
            <label class="subtext">Volume total (ml)</label>
            <input id="template-volume" type="number" min="0" />
          </div>
          <div>
            <label class="subtext">Volume por pack</label>
            <input id="template-volume-pack" type="number" min="0" />
          </div>
          <div>
            <label class="subtext">Frequência de uso</label>
            <input id="template-frequency" placeholder="Ex: diário" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="secondary" onclick="closeDialog('template-modal')">Cancelar</button>
          <button onclick="saveTemplate()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="stock-detail-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Detalhes do item</h3>
          <button class="secondary" onclick="closeDialog('stock-detail-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div><label>Item</label><div id="stock-detail-name" class="value" style="font-size:1rem;">—</div></div>
          <div><label>Categoria</label><div id="stock-detail-cat" class="subtext">—</div></div>
          <div><label>Última entrada</label><div id="stock-detail-entry" class="subtext">—</div></div>
          <div><label>Última saída</label><div id="stock-detail-exit" class="subtext">—</div></div>
          <div><label>Previsão</label><div id="stock-detail-forecast" class="subtext">—</div></div>
          <div><label>Custo/uso</label><div id="stock-detail-cost" class="subtext">—</div></div>
        </div>
      </div>
    </div>

    <div id="stock-exit-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Registrar saída</h3>
          <button class="secondary" onclick="closeDialog('stock-exit-modal')">Fechar</button>
        </div>
        <div>
          <label>Item</label>
          <div id="stock-exit-name" class="subtext">—</div>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Quantidade/volume</label>
            <input id="stock-exit-qty" type="number" min="0" />
          </div>
          <div>
            <label>Observações</label>
            <input id="stock-exit-notes" placeholder="Opcional" />
          </div>
        </div>
        <div class="dialog-actions" style="justify-content:flex-end;">
          <button class="secondary" onclick="closeDialog('stock-exit-modal')">Cancelar</button>
          <button onclick="confirmStockExit()">Registrar</button>
        </div>
      </div>
    </div>

    <div id="stock-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <h3>Remover item</h3>
        <p class="subtext">Essa ação removerá o item do estoque.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('stock-remove-modal')">Cancelar</button>
          <button class="danger" onclick="confirmRemoveStockItem()">Excluir</button>
        </div>
      </div>
    </div>

      <section id="page-ceo-investments" class="page-ceo hidden">
      <div class="card investment-controls">
        <div class="control-actions" style="justify-content: space-between; gap:1rem;">
          <div>
            <div class="subtext">Filtrando pelo mês selecionado acima</div>
            <div class="segmented compact">
              <button id="invest-filter-all" class="active" onclick="setInvestmentFilter('Todos')">Todos</button>
              <button id="invest-filter-plan" onclick="setInvestmentFilter('Planejado')">Planejado</button>
              <button id="invest-filter-progress" onclick="setInvestmentFilter('Em andamento')">Em andamento</button>
              <button id="invest-filter-paid" onclick="setInvestmentFilter('Pago')">Pago</button>
            </div>
          </div>
          <button class="secondary" onclick="openInvestmentModal()">+ Adicionar investimento</button>
        </div>
      </div>

      <div id="investment-groups" class="investment-groups"></div>
    </section>

    <section id="page-ceo-finance" class="page-ceo hidden">
      <div class="section-title">
        <h2>Resumo financeiro</h2>
        <div class="pill-row">
          <span class="pill">Mês atual</span>
          <span class="pill">Serviços + consumo</span>
        </div>
      </div>

      <div class="card-grid">
        <div class="card">
          <h3>Receita bruta</h3>
          <div class="value" id="finance-revenue">R$ 0,00</div>
          <div class="subtext">Inclui serviços e bebidas</div>
        </div>
        <div class="card">
          <h3>Custos (produtos)</h3>
          <div class="value" id="finance-costs">R$ 0,00</div>
          <div class="subtext">Baseado no consumo estimado de esmaltes e itens</div>
        </div>
        <div class="card">
          <h3>Lucro estimado</h3>
          <div class="value" id="finance-profit">R$ 0,00</div>
          <div class="subtext">Antes de outras despesas fixas</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Vendas por tipo</h2>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Quantidade</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Serviços</td>
            <td>120</td>
            <td>R$ 13.200</td>
          </tr>
          <tr>
            <td>Consumo (geladeira)</td>
            <td>64</td>
            <td>R$ 2.600</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-ceo-clients" class="page-ceo hidden">
      <div class="section-title">
        <h2>Clientes</h2>
        <div class="pill-row">
          <span class="pill">Visão geral</span>
          <span class="pill">CEO vê todas</span>
        </div>
      </div>
      <div class="settings-block">
        <div class="clients-header">
          <div class="clients-actions">
            <button class="ghost-btn" onclick="openClientModal()">+ Adicionar cliente</button>
            <div class="clients-search">
              <span>🔍</span>
              <input id="client-search-ceo" placeholder="Buscar por nome ou telefone" oninput="renderClients('ceo')" />
            </div>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
        <div id="clients-grid-ceo" class="clients-grid"></div>
      </div>
    </section>

    <section id="page-ceo-settings" class="page-ceo hidden">
      <div class="section-title">
        <h2>Configurações do Studio</h2>
      </div>
      <div class="settings-block">
        <div class="block-header">
          <div>
            <h3>Colaboradoras</h3>
            <div class="section-caption">Lista compacta para gerenciar permissões, comissão e logins dedicados.</div>
          </div>
          <div class="block-actions">
            <button class="ghost-btn secondary" onclick="openCollabAddModal()">+ Colaboradora</button>
            <button class="ghost-btn" onclick="openDedicatedLoginModal()">🔑 Criar login dedicado</button>
            <button class="ghost-btn secondary" onclick="alert('Importe seus dados reais a partir das integrações disponíveis.')">⤓ Importar</button>
          </div>
        </div>
        <div id="collaborators-list" class="collab-list"></div>
      </div>

      <div class="settings-block" style="margin-top:1rem;">
        <div class="block-header">
          <div>
            <h3>Serviços</h3>
            <div class="section-caption">Valores utilizados no app e no tablet, com edição via modal.</div>
          </div>
          <div class="block-actions">
            <button class="ghost-btn" onclick="openServiceAddModal()">➕ Adicionar serviço</button>
            <button class="ghost-btn secondary" onclick="openServiceEditModal()">✏️ Editar valores</button>
          </div>
        </div>
        <table class="table" style="margin-top:0.2rem;">
          <thead>
            <tr>
              <th>Serviço</th>
              <th>Duração</th>
              <th>Preço</th>
            </tr>
          </thead>
          <tbody id="services-table"></tbody>
        </table>
      </div>
    </section>

    <div id="login-dedicated-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Criar login dedicado</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('login-dedicated-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome da colaboradora</label>
            <input id="new-colab-name" placeholder="Ex: Camila" />
          </div>
          <div>
            <label>Usuário</label>
            <input id="new-colab-username" placeholder="Ex: camila" />
          </div>
          <div>
            <label>Senha inicial</label>
            <input id="new-colab-password" placeholder="Ex: 123" />
          </div>
          <div>
            <label>Permissões</label>
            <input id="new-colab-permissions" placeholder="Agenda compartilhada, comissões" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('login-dedicated-modal')">Cancelar</button>
          <button onclick="createCollaboratorAccount()">Gerar usuário e senha</button>
        </div>
        <div class="section-caption">A colaboradora verá apenas o próprio login e o acesso ao tablet.</div>
      </div>
    </div>

    <div id="add-collab-modal" class="dialog-layer hidden">
        <div class="dialog-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Adicionar colaboradora</h3>
            <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('add-collab-modal')">Fechar</button>
          </div>
          <div class="dialog-grid">
            <div>
              <label>Nome</label>
              <input id="add-collab-name" placeholder="Ex: Camilia" />
            </div>
            <div>
              <label>Cargo</label>
              <input id="add-collab-role" placeholder="Ex: Colaboradora" />
            </div>
            <div>
              <label>Email</label>
              <input id="add-collab-email" placeholder="Email corporativo" />
            </div>
            <div>
              <label>Usuário</label>
              <input id="add-collab-login" placeholder="Usuário opcional" />
            </div>
            <div>
              <label>Comissão</label>
              <input id="add-collab-commission" placeholder="Ex: 40% serviços" />
            </div>
            <div>
              <label>Senha inicial</label>
              <input id="add-collab-password" placeholder="Senha provisória" type="password" />
            </div>
            <div style="grid-column:1 / span 2; display:flex; gap:1rem; align-items:center;">
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="add-collab-perm-agenda" checked /> Agenda compartilhada
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="add-collab-perm-comissao" checked /> Comissões
              </label>
            </div>
          </div>
          <div class="dialog-actions">
            <button class="secondary" onclick="closeDialog('add-collab-modal')">Cancelar</button>
            <button onclick="saveNewCollaborator()">Salvar colaboradora</button>
        </div>
      </div>
    </div>

    <div id="edit-collab-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Editar colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('edit-collab-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome</label>
            <input id="edit-collab-name" />
          </div>
          <div>
            <label>Cargo</label>
            <input id="edit-collab-role" />
          </div>
          <div>
            <label>Login</label>
            <input id="edit-collab-login" placeholder="Usuário" />
          </div>
          <div>
            <label>Permissões</label>
            <div style="display:flex;flex-direction:column;gap:0.3rem;padding:0.4rem 0;">
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-agenda" /> Agenda
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-estoque" /> Estoque
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-comissao" /> Comissão
              </label>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('edit-collab-modal')">Cancelar</button>
          <button onclick="saveCollaboratorProfile()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="commission-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Comissão</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('commission-modal')">Fechar</button>
        </div>
        <div>
          <label>Percentual de comissão</label>
          <input id="commission-value" type="number" min="0" max="100" step="1" placeholder="Ex: 40" />
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('commission-modal')">Cancelar</button>
          <button onclick="saveCommission()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="collab-status-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Status da colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('collab-status-modal')">Fechar</button>
        </div>
        <p class="subtext" id="collab-status-text">Gerencie ativação ou remoção.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="removeCollaborator()" style="color:var(--danger);border-color:var(--danger);">Remover colaboradora</button>
          <div style="display:flex;gap:0.4rem;">
            <button class="secondary" onclick="closeDialog('collab-status-modal')">Cancelar</button>
            <button onclick="confirmDeactivateCollaborator()" id="collab-status-toggle">Desativar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="service-add-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Adicionar serviço</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('service-add-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Serviço</label>
            <input id="add-service-name" placeholder="Ex: Spa mãos" />
          </div>
          <div>
            <label>Duração</label>
            <input id="add-service-duration" placeholder="Ex: 40min" />
          </div>
          <div>
            <label>Preço</label>
            <input id="add-service-price" type="number" placeholder="Ex: 80" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('service-add-modal')">Cancelar</button>
          <button onclick="saveNewService()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="service-edit-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Editar valores</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('service-edit-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Serviço</label>
            <select id="edit-service-select" onchange="prefillServiceFields()"></select>
          </div>
          <div>
            <label>Duração</label>
            <input id="edit-service-duration" placeholder="Ex: 1h30" />
          </div>
          <div>
            <label>Preço</label>
            <input id="edit-service-price" type="number" placeholder="Ex: 120" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('service-edit-modal')">Cancelar</button>
          <button onclick="saveServiceEdit()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="investment-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:720px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;">
          <div>
            <h3 id="investment-modal-title">Adicionar investimento</h3>
            <div class="subtext">Preencha valores, parcelas e mês de referência</div>
          </div>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('investment-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <input type="hidden" id="investment-id" />
          <div>
            <label>Título</label>
            <input id="investment-title" placeholder="Ex: Reforma recepção" />
          </div>
          <div>
            <label>Categoria</label>
            <input id="investment-category" placeholder="Equipamento, obra, melhoria" />
          </div>
          <div>
            <label>Mês de referência</label>
            <input id="investment-month" type="month" />
          </div>
          <div>
            <label>Valor total</label>
            <input id="investment-amount" type="number" placeholder="500" />
          </div>
          <div>
            <label>Parcelado?</label>
            <select id="investment-parceled" onchange="toggleParcelFields()">
              <option value="nao">Não</option>
              <option value="sim">Sim</option>
            </select>
          </div>
          <div>
            <label>Número de parcelas</label>
            <input id="investment-installments" type="number" min="1" placeholder="1" />
          </div>
          <div>
            <label>Valor de cada parcela</label>
            <input id="investment-installment-value" type="number" placeholder="0" />
          </div>
          <div>
            <label>Status</label>
            <select id="investment-status">
              <option value="Planejado">Planejado</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Pago">Pago</option>
            </select>
          </div>
          <div>
            <label>Observações</label>
            <textarea id="investment-notes" placeholder="Materiais, cronograma ou fornecedor"></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('investment-modal')">Cancelar</button>
          <button id="investment-modal-save" onclick="saveInvestment()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="investment-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover investimento</h3>
        <p class="subtext" id="investment-remove-text">Confirme para remover o investimento selecionado.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('investment-remove-modal')">Cancelar</button>
          <button onclick="confirmRemoveInvestment()" style="background:var(--danger);">Remover</button>
        </div>
      </div>
    </div>

    <div id="investment-history-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:680px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;">
          <div>
            <h3>Histórico do investimento</h3>
            <div class="subtext">Pagamentos, alterações e observações registradas</div>
          </div>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('investment-history-modal')">Fechar</button>
        </div>
        <div id="investment-history-list" class="investment-history-list"></div>
      </div>
    </div>

    <div id="client-form-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 id="client-form-title">Adicionar cliente</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('client-form-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <input type="hidden" id="client-id" />
          <div>
            <label>Nome completo</label>
            <input id="client-name" placeholder="Ex: Maria Souza" />
          </div>
          <div>
            <label>Telefone</label>
            <input id="client-phone" placeholder="55999999999" />
          </div>
          <div>
            <label>Instagram</label>
            <input id="client-instagram" placeholder="@cliente" />
          </div>
          <div>
            <label>Data de aniversário</label>
            <input id="client-birthday" type="date" />
          </div>
          <div>
            <label>Preferência de cor</label>
            <input id="client-pref-color" placeholder="Nude, vermelho" />
          </div>
          <div>
            <label>Formato de unha</label>
            <input id="client-pref-shape" placeholder="Quadrada, amendoada" />
          </div>
          <div>
            <label>Tipo de alongamento</label>
            <input id="client-pref-extension" placeholder="Fibra, gel" />
          </div>
          <div>
            <label>Alergias</label>
            <input id="client-allergies" placeholder="Produtos ou materiais" />
          </div>
          <div>
            <label>Observações</label>
            <textarea id="client-notes" placeholder="Preferências, observações gerais"></textarea>
          </div>
          <div>
            <label>Responsável</label>
            <select id="client-responsible"></select>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('client-form-modal')">Cancelar</button>
          <button id="client-form-save" onclick="saveClient()">Salvar cliente</button>
        </div>
      </div>
    </div>

    <div id="client-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover cliente</h3>
        <p class="subtext" id="client-remove-text">Confirme para remover a cliente e cancelar seus agendamentos futuros.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('client-remove-modal')">Cancelar</button>
          <button onclick="confirmRemoveClient()" style="background:var(--danger);">Remover</button>
        </div>
      </div>
    </div>

    <div id="client-detail-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:720px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;flex-wrap:wrap;">
          <div>
            <h3 id="client-detail-name">Ficha da cliente</h3>
            <div class="subtext" id="client-detail-phone"></div>
          </div>
          <div class="inline-actions">
            <button class="secondary" onclick="openAppointmentModal(currentClientDetailId)">Agendar novamente</button>
            <button class="ghost-btn" onclick="closeDialog('client-detail-modal')">Fechar</button>
          </div>
        </div>
        <div class="client-detail-tabs">
          <button id="tab-detail-data" class="active" onclick="switchClientTab('data')">Dados pessoais</button>
          <button id="tab-detail-history" onclick="switchClientTab('history')">Histórico de serviços</button>
          <button id="tab-detail-consume" onclick="switchClientTab('consume')">Consumos</button>
          <button id="tab-detail-future" onclick="switchClientTab('future')">Agendamentos futuros</button>
        </div>
        <div id="client-detail-content"></div>
      </div>
    </div>

    <div id="appointment-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:640px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 id="appointment-modal-title">Novo agendamento</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('appointment-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Cliente</label>
            <input id="appointment-client" list="clients-datalist" placeholder="Buscar ou digitar cliente" oninput="bindClientFromInput()" />
            <input type="hidden" id="appointment-client-id" />
            <datalist id="clients-datalist"></datalist>
          </div>
          <div>
            <label>Profissional</label>
            <select id="appointment-professional"></select>
          </div>
          <div>
            <label>Serviço</label>
            <select id="appointment-service"></select>
          </div>
          <div>
            <label>Data</label>
            <input id="appointment-date" type="date" />
          </div>
          <div>
            <label>Horário</label>
            <input id="appointment-time" type="time" />
          </div>
          <div>
            <label>Observações</label>
            <textarea id="appointment-notes" placeholder="Preferências, recados"></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('appointment-modal')">Cancelar</button>
          <button id="appointment-submit-btn" onclick="saveAppointment()">Salvar e gerar WhatsApp</button>
        </div>
      </div>
    </div>

    <div id="modal-agendamentos" class="dialog-layer fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="dialog-card bg-[var(--pastel-beige)] p-6 rounded-2xl shadow-xl w-[90%] max-w-xl">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
          <div>
            <h3 id="day-appointments-title" style="margin:0;">Agendamentos do dia</h3>
            <div class="subtext" id="day-appointments-caption">Horários e profissionais do dia selecionado</div>
          </div>
          <button class="secondary" onclick="closeDialog('modal-agendamentos')">Fechar</button>
        </div>

        <div id="day-appointments-list" class="agenda-appointments" style="margin:0.75rem 0 0.25rem 0;"></div>

        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('modal-agendamentos')">Voltar</button>
          <button onclick="openAppointmentModal(null, null, dayModalDate); fecharModalAgendamentos();">Novo agendamento para este dia</button>
        </div>
      </div>
    </div>

    <div id="appointment-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover agendamento</h3>
        <p class="subtext">Confirme para remover este horário e atualizar a agenda.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('appointment-remove-modal')">Cancelar</button>
          <button style="background:var(--danger);" onclick="confirmRemoveAppointment()">Remover</button>
        </div>
      </div>
    </div>

    <!-- Páginas da COLABORADORA -->
    <section id="page-colab-dashboard" class="page-colab hidden">
      <div class="card-grid">
        <div class="card">
          <h3>Comissão no mês</h3>
          <div class="value">R$ 3.250</div>
          <div class="subtext">Baseada nos serviços realizados</div>
        </div>
        <div class="card">
          <h3>Atendimentos hoje</h3>
          <div class="value">6</div>
          <div class="subtext">3 manhã • 3 tarde</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Próximos horários</h2>
        <button class="secondary" onclick="navigatePage('colab', 'agenda')">Ver agenda completa</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Horário</th>
            <th>Cliente</th>
            <th>Serviço</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="subtext">Nenhum agendamento para exibir.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-colab-agenda" class="page-colab hidden">
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <h2 style="margin:0;">Agenda compartilhada</h2>
          <div class="segmented">
            <button id="agenda-toggle-year-colab" class="active" onclick="setAgendaView('year','colab')">Visão anual</button>
            <button id="agenda-toggle-month-colab" onclick="setAgendaView('month','colab')">Mês a mês</button>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">2025</span>
            <span class="pill">CEO + Colab</span>
          </div>
          <div class="agenda-filter-select">
            <label>Profissional</label>
            <select id="agenda-prof-filter-colab" onchange="setAgendaProfessionalFilter(this.value, 'colab')"></select>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
      </div>
      <div id="agenda-view-year-colab">
        <div class="calendar-year" id="year-calendar-colab"></div>
      </div>

      <div id="agenda-view-month-colab" class="hidden">
        <div class="month-visual-toggle" style="margin-bottom:0.4rem;">
          <label class="subtext">Selecione o mês</label>
          <select id="agenda-month-selector-colab" onchange="setSelectedMonth(parseInt(this.value), 'colab')"></select>
          <div class="tag">Toque nos dias com atendimento para abrir detalhes</div>
        </div>
        <div class="full-month-calendar" id="agenda-month-calendar-colab"></div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2 id="selected-month-title-colab">Agenda do mês</h2>
        <div class="pill-row" id="selected-month-tags-colab"></div>
      </div>
      <div class="card" style="margin-top:0.2rem;">
        <table class="table" style="margin:0;">
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Serviço</th>
              <th>Profissional</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="agenda-month-summary-colab"></tbody>
        </table>
      </div>

    </section>

    <section id="page-colab-commission" class="page-colab hidden">
      <div class="section-title">
        <h2>Minhas comissões</h2>
        <div class="pill-row">
          <span class="pill">Mês atual</span>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Serviço</th>
            <th>Valor serviço</th>
            <th>Comissão</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>02/12</td>
            <td>Manutenção fibra</td>
            <td>R$ 120</td>
            <td>R$ 48</td>
          </tr>
          <tr>
            <td>03/12</td>
            <td>Alongamento</td>
            <td>R$ 180</td>
            <td>R$ 72</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-colab-clients" class="page-colab hidden">
      <div class="section-title">
        <h2>Clientes</h2>
        <div class="pill-row">
          <span class="pill">Você vê apenas seus contatos</span>
        </div>
      </div>
      <div class="settings-block">
        <div class="clients-header">
          <div class="clients-actions">
            <button class="ghost-btn" onclick="openClientModal()">+ Adicionar cliente</button>
            <div class="clients-search">
              <span>🔍</span>
              <input id="client-search-colab" placeholder="Buscar por nome ou telefone" oninput="renderClients('colab')" />
            </div>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
        <div id="clients-grid-colab" class="clients-grid"></div>
      </div>
    </section>

  </main>
</div>

<!-- TELA KIOSK (CLIENTE) -->
<section id="kiosk-screen" class="hidden">
  <div class="kiosk-wrapper">
    <div class="kiosk-hero">
      <div>
        <h1 style="font-size:1.4rem;">Consumo & Serviço</h1>
        <div class="tag" style="margin-top:0.2rem;">Selecione o que você está consumindo agora</div>
        <div class="kiosk-steps">
          <span class="kiosk-pill">1️⃣ Escolha a bebida</span>
          <span class="kiosk-pill">2️⃣ Marque o serviço</span>
          <span class="kiosk-pill">3️⃣ Confirme e avisa a profissional</span>
        </div>
      </div>
      <button class="secondary" onclick="backToLogin()">Sair do modo tablet</button>
    </div>

    <div class="kiosk-grid">
      <div>
        <h2 class="kiosk-section-title">Bebidas e consumação</h2>
        <div class="kiosk-items" id="kiosk-drinks">
          <!-- Itens via JS -->
        </div>

        <h2 class="kiosk-section-title" style="margin-top:0.8rem;">Serviço que estou fazendo</h2>
        <div class="kiosk-items" id="kiosk-services">
          <!-- Serviços via JS -->
        </div>
      </div>

      <div class="kiosk-cart">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="font-size:1rem;">Seu carrinho</h2>
          <button class="secondary" style="font-size:0.75rem;padding:0.3rem 0.7rem;" onclick="clearCart()">
            Limpar
          </button>
        </div>
        <div class="kiosk-cart-list" id="kiosk-cart-list">
          <!-- itens carrinho -->
        </div>
        <div class="kiosk-cart-total">
          <span>Total estimado</span>
          <span id="kiosk-cart-total">R$ 0,00</span>
        </div>
        <button style="margin-top:0.5rem;width:100%;" onclick="sendOrder()">
          Finalizar e avisar a profissional
        </button>
        <div class="hint">
          Depois você paga normalmente no caixa. Este registro ajuda o Studio a controlar estoque e comissão.
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script>
  // -----------------------------
  // ESTADO GLOBAL (simples)
  // -----------------------------
  let currentRole = null; // 'ceo' | 'colab' | 'kiosk'
  let currentPageCEO = 'dashboard';
  let currentPageColab = 'dashboard';
  let appInitialized = false;
  let currentColabAccount = null;
  let currentInventoryTab = 'esmaltes';
  let currentEditingCollabIndex = null;
  let currentCommissionIndex = null;
  let currentCollabStatusIndex = null;
  let currentEditingServiceId = null;
  let currentClientDetailId = null;
  let activeClientTab = 'data';
  let appointmentPrefillClient = null;
  let appointmentPrefillDate = null;
  let appointmentPrefillTime = null;
  let appointmentOpenedFromDayModal = false;
  let appointmentFormMode = 'add';
  let appointmentEditingId = null;
  let pendingRemoveAppointmentId = null;
  let dayModalDate = null;
  let dayModalScope = 'ceo';
  let agendaProfessionalFilter = 'all';
  let agendaProfessionalFilterColab = 'all';

  const getCssVar = (key, fallback = '') => {
    const val = getComputedStyle(document.documentElement).getPropertyValue(key);
    return val ? val.trim() : fallback;
  };

  const firebaseConfig = {
    apiKey: "AIzaSyBje0Zy_NKLc8tMOIuR4wEc-qHW-9UJsGw",
    authDomain: "gleicef-naildesigner.firebaseapp.com",
    projectId: "gleicef-naildesigner",
    storageBucket: "gleicef-naildesigner.firebasestorage.app",
    messagingSenderId: "670848534218",
    appId: "1:670848534218:web:6cfb3046c1d1e3d5809633",
    measurementId: "G-7M3WX6GK18"
  };

  let firebaseApp = null;
  let firestore = null;
  let firebaseAuth = null;
  let currentUserDoc = null;
  let globalMonthUnsub = null;
  let authListenerAttached = false;

  const adminOverrides = {
    'mJ3hkcBr5kT83iTgJROR811X0WP2': {
      role: 'CEO',
      name: 'Gleice',
      permissions: { agenda: true, comissoes: true },
      status: 'active'
    }
  };

  const calendarYear = 2025;
  const monthNamesFull = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  const monthNamesShort = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  const baseYearDetailed = monthNamesFull.map((fullName, idx) => ({
    monthIndex: idx,
    month: monthNamesShort[idx],
    fullName,
    tags: []
  }));
  let selectedMonthIndex = new Date().getMonth();
  let selectedMonthIndexColab = new Date().getMonth();
  let agendaViewMode = 'year';
  let agendaViewModeColab = 'year';
  let selectedDashboardMonth = new Date().getMonth();
  let selectedDashboardYear = new Date().getFullYear();
  let selectedGlobalMonthKey = 'all';
  let sidebarCollapsed = false;

  let stockItems = [];
  let productTemplates = [];
  let stockHistories = {};
  const chartInstances = {};

  let inventoryFormMode = 'add';
  let inventoryEditingId = null;
  let currentInventoryCategory = 'esmaltes';
  let templateEditingId = null;
  let pendingRemoveStockId = null;
  let pendingExitStockId = null;

  const monthlyDashboardStats = [];

  const financialEntries = [];

  let investments = [];
  const investmentHistoryStore = {};

  const collaborators = [];

  let collaboratorAccounts = [];

  let clients = [];

  let currentClientEditingId = null;
  let pendingRemoveClientId = null;

  let appointments = [];

  function formatCurrency(value) {
    return 'R$ ' + Number(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }

  function formatDateLabel(dateStr) {
    if (!dateStr) return 'data a combinar';
    const [y, m, d] = dateStr.split('-');
    if (!y || !m || !d) return dateStr;
    return `${d}/${m}/${y}`;
  }

  function slugify(value = '') {
    return value
      .toString()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      || 'ref';
  }

  function findCollaboratorByIdOrName(value) {
    if (!value) return null;
    const lowered = value.toLowerCase();
    return collaborators.find(c => c.id === lowered || c.username === lowered || c.name.toLowerCase() === lowered) || null;
  }

  function findServiceByIdOrName(value) {
    if (!value) return null;
    const lowered = value.toLowerCase();
    return kioskServices.find(s => s.id === lowered || s.name.toLowerCase() === lowered) || null;
  }

  function getProfessionalKey(appt) {
    return (appt.professionalId || slugify(appt.professionalName || appt.professional || ''))?.toLowerCase();
  }

  function buildWhatsAppLink(client, payload = {}) {
    const number = (client.phone || '').replace(/\D/g, '') || '55';
    const appt = payload.appointment || client.nextAppointment || {};
    const service = payload.service || appt.serviceName || appt.service || client.lastService || 'seu atendimento';
    const dateLabel = payload.dateLabel || (appt.date ? formatDateLabel(appt.date) : (client.lastDate || 'data a combinar'));
    const time = payload.time || appt.time || 'horário a combinar';
    const text = `Olá, tudo bem? Seu agendamento para ${service} está confirmado para o dia ${dateLabel} às ${time}. Qualquer ajuste necessário, estou à disposição.`;
    return `https://wa.me/${number}?text=${encodeURIComponent(text)}`;
  }

  function setupMonthSelects() {
    const agendaSelect = document.getElementById('agenda-month-selector');
    const agendaSelectColab = document.getElementById('agenda-month-selector-colab');
    const fillSelect = (selectEl) => {
      if (selectEl && selectEl.options.length === 0) {
        baseYearDetailed.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.monthIndex;
          opt.textContent = m.fullName;
          selectEl.appendChild(opt);
        });
      }
    };
    fillSelect(agendaSelect);
    fillSelect(agendaSelectColab);
    if (agendaSelect) agendaSelect.value = selectedMonthIndex;
    if (agendaSelectColab) agendaSelectColab.value = selectedMonthIndexColab;
    updateGlobalMonthLabel();
  }

  let kioskDrinks = [];

  let kioskServices = [];

  function normalizeAppointmentsData() {
    appointments = appointments.map(appt => {
      const fallbackClientId = appt.clientId || (appt.clientName ? `cli-${slugify(appt.clientName)}` : `cli-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`);
      let client = clients.find(c => c.id === fallbackClientId);
      if (!client) {
        client = {
          id: fallbackClientId,
          name: appt.clientName || appt.client || 'Cliente',
          phone: appt.phone || '55',
          owners: [],
          responsible: '',
          history: [],
          consume: [],
          future: [],
          nextAppointment: {}
        };
        clients.push(client);
      }

      const service = findServiceByIdOrName(appt.serviceId || appt.serviceName || appt.service);
      const professional = findCollaboratorByIdOrName(appt.professionalId || appt.professionalName || appt.professional);
      const professionalName = professional?.name || appt.professionalName || appt.professional || 'Equipe';
      const professionalId = professional?.id || slugify(professionalName);
      const serviceName = service?.name || appt.serviceName || appt.service || 'Serviço';
      const serviceId = service?.id || slugify(serviceName);
      const status = appt.status || 'scheduled';
      const createdAt = appt.createdAt || new Date().toISOString();
      const updatedAt = appt.updatedAt || createdAt;
      const time = appt.time || '00:00';
      const normalizedId = appt.id || `appt-${Date.now()}-${Math.random().toString(16).slice(2, 7)}`;

      client.name = client.name || appt.clientName || 'Cliente';
      client.owners = client.owners || [];
      if (professionalName && !client.owners.includes(professionalName)) client.owners.push(professionalName);
      if (!client.responsible) client.responsible = professionalName;

      return {
        ...appt,
        id: normalizedId,
        clientId: client.id,
        clientName: client.name,
        professionalId,
        professionalName,
        professional: professionalName,
        serviceId,
        serviceName,
        service: serviceName,
        status,
        date: appt.date,
        time,
        notes: appt.notes || '',
        createdAt,
        updatedAt
      };
    });
  }

  let cart = [];

  // -----------------------------
  // AUTENTICAÇÃO E TROCA DE PAPEL
  // -----------------------------
  function openKioskDirect() {
    setRole('kiosk');
  }

  async function resolveLoginEmail(identifier) {
    if (!identifier) return null;
    if (identifier.includes('@')) return identifier;
    initFirebaseApp();
    if (!firestore) return null;
    const snap = await firestore
      .collection('users')
      .where('username', '==', identifier)
      .limit(1)
      .get()
      .catch(() => null);
    if (!snap || snap.empty) return null;
    const data = snap.docs[0].data();
    return data?.email || null;
  }

  async function fetchUserDoc(uid) {
    if (!uid || !firestore) return null;
    const docRef = firestore.collection('users').doc(uid);
    const doc = await docRef.get().catch(() => null);
    const override = adminOverrides[uid];

    if (doc?.exists) {
      const data = { id: uid, ...doc.data() };
      if (override && (data.role || '').toUpperCase() !== 'CEO') {
        const merged = { ...data, ...override };
        await docRef.set(merged, { merge: true });
        return merged;
      }
      return data;
    }

    if (override) {
      const defaultDoc = { ...override, createdAt: new Date().toISOString() };
      await docRef.set(defaultDoc, { merge: true });
      return { id: uid, ...defaultDoc };
    }

    return null;
  }

  function applyUserRole(userData) {
    currentUserDoc = userData;
    if (!appInitialized) {
      postLoginInit();
      appInitialized = true;
    }
    const role = (userData?.role || '').toUpperCase() === 'CEO' ? 'ceo' : 'colab';
    const account = role === 'colab' ? { id: userData.id, name: userData.name || userData.username } : null;
    setRole(role, account);
  }

  async function handleEmailLogin() {
    const identifier = document.getElementById('login-identifier').value.trim();
    const password = document.getElementById('login-password').value.trim();
    if (!identifier || !password) {
      alert('Informe usuário/email e senha.');
      return;
    }
    initFirebaseApp();
    const email = await resolveLoginEmail(identifier);
    if (!email) {
      alert('Não encontramos esse usuário/email.');
      return;
    }
    try {
      const cred = await firebaseAuth.signInWithEmailAndPassword(email, password);
      const userData = await fetchUserDoc(cred.user.uid);
      if (!userData) {
        alert('Conta sem perfil configurado no Firestore.');
        return;
      }
      applyUserRole(userData);
    } catch (err) {
      alert('Falha no login. Confira as credenciais.');
    }
  }

  async function handleGoogleLogin() {
    initFirebaseApp();
    if (!firebaseAuth) return;
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const cred = await firebaseAuth.signInWithPopup(provider);
      const data = await fetchUserDoc(cred.user.uid);
      if (!data || (data.role || '').toUpperCase() !== 'CEO') {
        await firebaseAuth.signOut();
        alert('Apenas CEO pode usar login Google.');
        return;
      }
      applyUserRole(data);
    } catch (err) {
      alert('Login Google cancelado ou inválido.');
    }
  }

  function postLoginInit() {
    initFirebaseApp();
    buildGlobalMonthOptions();
    listenGlobalMonth();
    subscribeCoreCollections();
    refreshMonthlyConsumers();
  }

  function attachAuthListener() {
    initFirebaseApp();
    if (!firebaseAuth || authListenerAttached) return;
    authListenerAttached = true;
    firebaseAuth.onAuthStateChanged(async (user) => {
      if (user) {
        const data = await fetchUserDoc(user.uid);
        if (data) {
          applyUserRole(data);
          document.getElementById('login-screen')?.classList.add('hidden');
          document.getElementById('app-shell')?.classList.remove('hidden');
        }
      }
    });
  }

  function subscribeCoreCollections() {
    if (!firestore) return;
    firestore.collection('investments').onSnapshot(snap => {
      investments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInvestments();
      renderDashboardCards();
      buildGlobalMonthOptions();
    });
    firestore.collection('financial').onSnapshot(snap => {
      const mapped = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      financialEntries.splice(0, financialEntries.length, ...mapped);
      renderFinance();
      renderDashboardCards();
      buildGlobalMonthOptions();
    });
    firestore.collection('productTemplates').onSnapshot(snap => {
      productTemplates = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInventoryTemplates();
    });
    firestore.collection('stock').onSnapshot(snap => {
      stockItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      stockItems.forEach(item => attachStockHistoryListener(item.id));
      renderInventory();
      renderDashboardCards();
      buildGlobalMonthOptions();
    });
  }

  // -----------------------------
  // TROCA DE PAPEL / TELAS
  // -----------------------------
  function setRole(role, account = null) {
    currentRole = role;
    if (role === 'colab') {
      currentColabAccount = account;
      agendaProfessionalFilterColab = account?.id || slugify(account?.name || '') || 'all';
    } else {
      currentColabAccount = null;
      agendaProfessionalFilterColab = 'all';
    }
    if (role === 'ceo') agendaProfessionalFilter = 'all';

    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('kiosk-screen').classList.add('hidden');

    if (role === 'ceo' || role === 'colab') {
      document.getElementById('app-shell').classList.remove('hidden');
      setupSidebar(role);
      updateRoleLabel(role);
      updateVisiblePage();
    } else if (role === 'kiosk') {
      document.getElementById('kiosk-screen').classList.remove('hidden');
      renderKiosk();
    }
  }

  function backToLogin() {
    currentRole = null;
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('kiosk-screen').classList.add('hidden');
  }

  function openKioskFromDashboard() {
    setRole('kiosk');
  }

  function openCollaboratorLogin(username) {
    backToLogin();
    const account = collaboratorAccounts.find(acc => acc.username === username);
    const idInput = document.getElementById('login-identifier');
    const passInput = document.getElementById('login-password');
    if (account && idInput && passInput) {
      idInput.value = account.username || account.email || '';
      passInput.value = account.password || '';
    }
  }

  function createCollaboratorAccount() {
    const name = document.getElementById('new-colab-name').value.trim();
    const username = document.getElementById('new-colab-username').value.trim();
    const password = document.getElementById('new-colab-password').value.trim();
    const permissions = document.getElementById('new-colab-permissions').value.trim();

    if (!name || !username || !password) {
      alert('Preencha nome, usuário e senha para criar o acesso.');
      return;
    }

    collaboratorAccounts.push({ name, username, password, permissions, device: 'Tablet dedicado' });
    collaborators.push({ name, username, role: 'Colaboradora', commission: '40% serviços', permissions: permissions || 'Agenda compartilhada, comissões', color: getCssVar('--chart-gold', '#B7A06A') });

    renderCollaborators();
    document.getElementById('new-colab-name').value = '';
    document.getElementById('new-colab-username').value = '';
    document.getElementById('new-colab-password').value = '';
    document.getElementById('new-colab-permissions').value = '';
    closeDialog('login-dedicated-modal');
    alert(`Login criado para ${name}. Usuário: ${username} | Senha: ${password}`);
  }

  function openDedicatedLoginModal(name = '') {
    document.getElementById('new-colab-name').value = name || '';
    document.getElementById('new-colab-username').value = name ? name.toLowerCase() : '';
    document.getElementById('new-colab-password').value = '';
    document.getElementById('new-colab-permissions').value = '';
    openDialog('login-dedicated-modal');
  }

  function openCollabAddModal() {
    document.getElementById('add-collab-name').value = '';
    document.getElementById('add-collab-role').value = 'Colaboradora';
    document.getElementById('add-collab-commission').value = '40% serviços';
    document.getElementById('add-collab-email').value = '';
    document.getElementById('add-collab-login').value = '';
    document.getElementById('add-collab-password').value = '';
    document.getElementById('add-collab-perm-agenda').checked = true;
    document.getElementById('add-collab-perm-comissao').checked = true;
    openDialog('add-collab-modal');
  }

  async function saveNewCollaborator() {
    const name = document.getElementById('add-collab-name').value.trim();
    const role = document.getElementById('add-collab-role').value.trim() || 'Colaboradora';
    const commission = document.getElementById('add-collab-commission').value.trim() || '40% serviços';
    const email = document.getElementById('add-collab-email').value.trim();
    const username = document.getElementById('add-collab-login').value.trim();
    const password = document.getElementById('add-collab-password').value.trim();
    const permAgenda = document.getElementById('add-collab-perm-agenda').checked;
    const permComissao = document.getElementById('add-collab-perm-comissao').checked;
    if (!name || !email || !password) {
      alert('Preencha nome, email e senha para criar a colaboradora.');
      return;
    }
    const palette = [
      getCssVar('--pastel-rose', '#F4D9D2'),
      getCssVar('--pastel-peach', '#F6E4D6'),
      getCssVar('--pastel-green', '#E6EFE6'),
      getCssVar('--chart-gold', '#B7A06A')
    ];
    const color = palette[Math.floor(Math.random() * palette.length)];
    const permissions = {
      agenda: permAgenda,
      comissoes: permComissao
    };
    const collaboratorDoc = {
      name,
      role: 'COLAB',
      commission,
      permissions,
      username,
      email,
      status: 'active',
      createdBy: currentUserDoc?.id || 'ceo',
      createdAt: new Date().toISOString(),
    };

    try {
      initFirebaseApp();
      if (firebaseAuth && firestore) {
        const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
        await firestore.collection('users').doc(cred.user.uid).set(collaboratorDoc, { merge: true });
        collaboratorAccounts.push({ name, username: username || email, password, permissions: 'Agenda compartilhada, comissões', device: 'Tablet dedicado', email, id: cred.user.uid });
        collaborators.push({ id: cred.user.uid, name, role, commission, permissions: 'Agenda compartilhada, comissões', username, color, active: true, email });
      }
    } catch (err) {
      collaborators.push({ name, role, commission, permissions: 'Agenda compartilhada, comissões', username, color, active: true, email });
      collaboratorAccounts.push({ name, username: username || email, password, permissions: 'Agenda compartilhada, comissões', device: 'Tablet dedicado', email });
    }

    renderCollaborators();
    closeDialog('add-collab-modal');
  }

  function openEditCollab(index) {
    currentEditingCollabIndex = index;
    const col = collaborators[index];
    document.getElementById('edit-collab-name').value = col.name;
    document.getElementById('edit-collab-role').value = col.role;
    document.getElementById('edit-collab-login').value = col.username || '';
    document.getElementById('perm-agenda').checked = col.permissions?.toLowerCase().includes('agenda');
    document.getElementById('perm-estoque').checked = col.permissions?.toLowerCase().includes('estoque');
    document.getElementById('perm-comissao').checked = col.permissions?.toLowerCase().includes('comissão') || col.permissions?.toLowerCase().includes('comissao');
    openDialog('edit-collab-modal');
  }

  function saveCollaboratorProfile() {
    if (currentEditingCollabIndex === null) return;
    const name = document.getElementById('edit-collab-name').value.trim();
    const role = document.getElementById('edit-collab-role').value.trim();
    const username = document.getElementById('edit-collab-login').value.trim();
    const permissions = [
      document.getElementById('perm-agenda').checked ? 'Agenda' : null,
      document.getElementById('perm-estoque').checked ? 'Estoque' : null,
      document.getElementById('perm-comissao').checked ? 'Comissão' : null,
    ].filter(Boolean).join(', ');
    const updated = { ...collaborators[currentEditingCollabIndex], name: name || collaborators[currentEditingCollabIndex].name, role: role || 'Colaboradora', username, permissions: permissions || 'Permissões ajustadas no perfil' };
    collaborators[currentEditingCollabIndex] = updated;
    const accountIdx = collaboratorAccounts.findIndex(acc => acc.name === updated.name || acc.username === updated.username);
    if (accountIdx >= 0) {
      collaboratorAccounts[accountIdx] = { ...collaboratorAccounts[accountIdx], name: updated.name, username: updated.username, permissions: updated.permissions };
    }
    renderCollaborators();
    closeDialog('edit-collab-modal');
  }

  function openCommissionModal(index) {
    currentCommissionIndex = index;
    const value = parseInt(collaborators[index].commission, 10) || 0;
    document.getElementById('commission-value').value = value;
    openDialog('commission-modal');
  }

  function saveCommission() {
    if (currentCommissionIndex === null) return;
    const value = parseInt(document.getElementById('commission-value').value, 10) || 0;
    collaborators[currentCommissionIndex].commission = `${value}% serviços`;
    renderCollaborators();
    closeDialog('commission-modal');
  }

  function openCollabStatusModal(index, wantsRemove = false) {
    currentCollabStatusIndex = index;
    const col = collaborators[index];
    const toggleBtn = document.getElementById('collab-status-toggle');
    const textEl = document.getElementById('collab-status-text');
    if (toggleBtn) toggleBtn.textContent = col.active ? 'Desativar' : 'Reativar';
    if (textEl) textEl.textContent = `${col.name} • ${col.role}`;
    const removeBtn = document.querySelector('#collab-status-modal button[onclick="removeCollaborator()"]');
    if (removeBtn) removeBtn.dataset.triggerRemove = wantsRemove ? 'true' : 'false';
    openDialog('collab-status-modal');
    if (wantsRemove && removeBtn) removeBtn.focus();
  }

  function confirmDeactivateCollaborator() {
    if (currentCollabStatusIndex === null) return;
    collaborators[currentCollabStatusIndex].active = !collaborators[currentCollabStatusIndex].active;
    renderCollaborators();
    closeDialog('collab-status-modal');
    currentCollabStatusIndex = null;
  }

  function removeCollaborator() {
    if (currentCollabStatusIndex === null) return;
    const removed = collaborators.splice(currentCollabStatusIndex, 1)[0];
    collaboratorAccounts = collaboratorAccounts.filter(acc => acc.name !== removed.name && acc.username !== removed.username);
    renderCollaborators();
    closeDialog('collab-status-modal');
    currentCollabStatusIndex = null;
  }

  function openClientModal(mode = 'add', clientId = null) {
    const isEdit = mode === 'edit';
    currentClientEditingId = isEdit ? clientId : null;
    const client = isEdit ? clients.find(c => c.id === clientId) : null;
    const title = document.getElementById('client-form-title');
    const save = document.getElementById('client-form-save');
    const fields = {
      id: document.getElementById('client-id'),
      name: document.getElementById('client-name'),
      phone: document.getElementById('client-phone'),
      instagram: document.getElementById('client-instagram'),
      birthday: document.getElementById('client-birthday'),
      prefColor: document.getElementById('client-pref-color'),
      prefShape: document.getElementById('client-pref-shape'),
      prefExtension: document.getElementById('client-pref-extension'),
      allergies: document.getElementById('client-allergies'),
      notes: document.getElementById('client-notes'),
      responsible: document.getElementById('client-responsible')
    };

    if (fields.responsible) {
      fields.responsible.innerHTML = '';
      if (!collaborators.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Defina um responsável';
        fields.responsible.appendChild(opt);
      } else {
        collaborators.forEach(col => {
          const opt = document.createElement('option');
          opt.value = col.name;
          opt.textContent = col.name;
          fields.responsible.appendChild(opt);
        });
      }
    }

    if (title) title.textContent = isEdit ? 'Editar cliente' : 'Adicionar cliente';
    if (save) save.textContent = isEdit ? 'Salvar alterações' : 'Salvar cliente';

    if (fields.id) fields.id.value = client?.id || '';
    if (fields.name) fields.name.value = client?.name || '';
    if (fields.phone) fields.phone.value = client?.phone || '';
    if (fields.instagram) fields.instagram.value = client?.instagram || '';
    if (fields.birthday) fields.birthday.value = client?.birthday || '';
    if (fields.prefColor) fields.prefColor.value = client?.prefColor || '';
    if (fields.prefShape) fields.prefShape.value = client?.prefShape || '';
    if (fields.prefExtension) fields.prefExtension.value = client?.prefExtension || '';
    if (fields.allergies) fields.allergies.value = client?.allergies || '';
    if (fields.notes) fields.notes.value = client?.notes || '';
    const responsibleFallback = currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : (collaborators[0]?.name || '');
    if (fields.responsible) fields.responsible.value = client?.responsible || responsibleFallback;

    openDialog('client-form-modal');
  }

  function saveClient() {
    const name = document.getElementById('client-name').value.trim();
    const phone = document.getElementById('client-phone').value.trim();
    if (!name || !phone) return;
    const instagram = document.getElementById('client-instagram').value.trim();
    const birthday = document.getElementById('client-birthday').value;
    const prefColor = document.getElementById('client-pref-color').value.trim();
    const prefShape = document.getElementById('client-pref-shape').value.trim();
    const prefExtension = document.getElementById('client-pref-extension').value.trim();
    const allergies = document.getElementById('client-allergies').value.trim();
    const notes = document.getElementById('client-notes').value.trim();
    const responsible = document.getElementById('client-responsible').value;
    const existingId = document.getElementById('client-id').value || currentClientEditingId;
    const owner = responsible || (currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : 'Glecie');

    if (existingId) {
      const target = clients.find(c => c.id === existingId);
      if (target) {
        Object.assign(target, {
          name,
          phone,
          instagram,
          birthday,
          prefColor,
          prefShape,
          prefExtension,
          allergies,
          notes,
          responsible: owner
        });
        if (!target.owners.includes(owner)) target.owners.push(owner);
      }
    } else {
      const newClient = {
        id: `cli-${Date.now()}`,
        name,
        phone,
        instagram,
        birthday,
        prefColor,
        prefShape,
        prefExtension,
        allergies,
        responsible: owner,
        lastService: 'Novo cadastro',
        lastDate: '',
        owners: [owner],
        notes,
        extra: '',
        history: [],
        consume: [],
        future: [],
        nextAppointment: {}
      };
      clients.push(newClient);
    }

    renderClients('ceo');
    renderClients('colab');
    closeDialog('client-form-modal');
    currentClientEditingId = null;
  }

  function openClientDetails(id) {
    currentClientDetailId = id;
    activeClientTab = 'data';
    const client = clients.find(c => c.id === id);
    const nameEl = document.getElementById('client-detail-name');
    const phoneEl = document.getElementById('client-detail-phone');
    if (nameEl) nameEl.textContent = client?.name || 'Cliente';
    if (phoneEl && client) phoneEl.innerHTML = `<a href="${buildWhatsAppLink(client)}" target="_blank" rel="noopener">${client.phone}</a>`;
    document.querySelectorAll('.client-detail-tabs button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-detail-data').classList.add('active');
    renderClientDetailTab();
    openDialog('client-detail-modal');
  }

  function switchClientTab(tab) {
    activeClientTab = tab;
    document.querySelectorAll('.client-detail-tabs button').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(`tab-detail-${tab}`);
    if (btn) btn.classList.add('active');
    renderClientDetailTab();
  }

  function renderClientDetailTab() {
    const container = document.getElementById('client-detail-content');
    if (!container) return;
    const client = clients.find(c => c.id === currentClientDetailId);
    if (!client) return;
    if (activeClientTab === 'data') {
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Informações</h4>
          <div class="client-detail-list">
            <span>Telefone: <a href="${buildWhatsAppLink(client)}" target="_blank" rel="noopener">${client.phone}</a></span>
            <span>Instagram: ${client.instagram || '—'}</span>
            <span>Aniversário: ${client.birthday || '—'}</span>
            <span>Preferências: ${client.prefColor || '—'} • ${client.prefShape || '—'} • ${client.prefExtension || '—'}</span>
            <span>Alergias: ${client.allergies || '—'}</span>
            <span>Responsável: ${client.responsible || (client.owners || ['Equipe'])[0]}</span>
            <span>Observações: ${client.notes || '—'}</span>
            <span>Extras: ${client.extra || '—'}</span>
            <span>Último serviço: ${client.lastService || '—'} ${client.lastDate ? '(' + client.lastDate + ')' : ''}</span>
          </div>
        </div>
      `;
    }

    if (activeClientTab === 'history') {
      const hist = (client.history || []).map(h => `<li>${h}</li>`).join('') || '<li>Sem histórico</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Histórico de serviços</h4>
          <ul class="client-detail-list">${hist}</ul>
        </div>
      `;
    }

    if (activeClientTab === 'consume') {
      const cons = (client.consume || []).map(h => `<li>${h}</li>`).join('') || '<li>Sem consumos</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Consumos no Studio</h4>
          <ul class="client-detail-list">${cons}</ul>
        </div>
      `;
    }

    if (activeClientTab === 'future') {
      const fut = (client.future || []).map(f => `<li>${formatDateLabel(f.date)} • ${f.time} • ${f.serviceName || f.service} (${f.professionalName || f.professional || 'Equipe'})</li>`).join('') || '<li>Nenhum agendamento futuro</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Próximos horários</h4>
          <ul class="client-detail-list">${fut}</ul>
          <button class="secondary" style="align-self:flex-start;" onclick="openAppointmentModal('${client.id}')">Agendar novamente</button>
        </div>
      `;
    }
  }

  function openRemoveClientModal(id) {
    pendingRemoveClientId = id;
    const client = clients.find(c => c.id === id);
    const text = document.getElementById('client-remove-text');
    if (text && client) text.textContent = `Remover ${client.name} e cancelar agendamentos futuros?`;
    openDialog('client-remove-modal');
  }

  function isFutureDate(dateStr) {
    if (!dateStr) return false;
    const today = new Date();
    const d = new Date(`${dateStr}T00:00:00`);
    return d >= new Date(today.getFullYear(), today.getMonth(), today.getDate());
  }

  function confirmRemoveClient() {
    if (!pendingRemoveClientId) return;
    const index = clients.findIndex(c => c.id === pendingRemoveClientId);
    if (index >= 0) clients.splice(index, 1);
    appointments = appointments.filter(a => !(a.clientId === pendingRemoveClientId && isFutureDate(a.date)));
    refreshAgendaFromAppointments();
    closeDialog('client-detail-modal');
    closeDialog('client-remove-modal');
    renderClients('ceo');
    renderClients('colab');
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');
    pendingRemoveClientId = null;
  }

  function rebuildClientAppointments(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    const related = appointments
      .filter(a => a.clientId === clientId && a.status !== 'canceled')
      .sort((a, b) => new Date(`${a.date}T${a.time || '00:00'}`) - new Date(`${b.date}T${b.time || '00:00'}`));

    const today = new Date();
    const future = related.filter(r => new Date(`${r.date}T${r.time || '00:00'}`) >= today);
    const owners = new Set(client.owners || []);
    related.forEach(r => { if (r.professionalName) owners.add(r.professionalName); });
    client.owners = Array.from(owners);
    client.future = future.map(r => ({ date: r.date, time: r.time, service: r.serviceName || r.service, professional: r.professionalName || r.professional }));
    client.nextAppointment = future[0]
      ? { date: future[0].date, time: future[0].time, service: future[0].serviceName || future[0].service }
      : {};
    const lastDone = [...related].filter(r => new Date(`${r.date}T${r.time || '00:00'}`) <= today).pop();
    if (lastDone) {
      client.lastService = lastDone.serviceName || lastDone.service;
      client.lastDate = formatDateLabel(lastDone.date);
    }
    if (!lastDone && future[0]) {
      client.lastService = future[0].serviceName || future[0].service;
      client.lastDate = formatDateLabel(future[0].date);
    }
    client.responsible = future[0]?.professionalName || lastDone?.professionalName || client.responsible;
  }

  function bindClientFromInput() {
    const input = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const match = clients.find(c => c.name.toLowerCase() === (input.value || '').toLowerCase());
    hidden.value = match ? match.id : '';
  }

  function renderDayAppointmentsModal() {
    const list = document.getElementById('day-appointments-list');
    const caption = document.getElementById('day-appointments-caption');
    if (!list || !dayModalDate) return;
    list.innerHTML = '';
    const scope = dayModalScope || 'ceo';
    const items = getAppointmentsForScope(scope)
      .filter(a => a.date === dayModalDate && a.status !== 'canceled')
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (caption) caption.textContent = `Horários do dia ${formatDateLabel(dayModalDate)}`;

    if (!items.length) {
      list.innerHTML = '<div class="subtext">Nenhum agendamento para este dia.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const row = document.createElement('div');
      row.className = 'appointment-card';
      row.style.setProperty('--appt-color', color);
      row.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title" style="font-size:1rem;">
            ${appt.time || '--:--'} • ${appt.serviceName || appt.service}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${client ? client.name : appt.clientName || 'Cliente'}</span>
            <span>${appt.status === 'done' ? 'Concluído' : 'Agendado'}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')">✎ Editar</button>
          <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')">🗑 Cancelar</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  function openDayAppointmentsModal(dateStr, scope = 'ceo') {
    dayModalDate = dateStr;
    dayModalScope = scope;
    const title = document.getElementById('day-appointments-title');
    if (title) title.textContent = `Agendamentos de ${formatDateLabel(dateStr)}`;
    renderDayAppointmentsModal();
    openDialog('modal-agendamentos');
  }

  function openAppointmentModal(clientId = null, appointmentId = null, presetDate = null, presetTime = null) {
    appointmentFormMode = appointmentId ? 'edit' : 'add';
    appointmentEditingId = appointmentId;
    appointmentPrefillClient = clientId;
    appointmentPrefillDate = presetDate;
    appointmentPrefillTime = presetTime;
    appointmentOpenedFromDayModal = Boolean(!appointmentId && presetDate && presetDate === dayModalDate);
    const client = clients.find(c => c.id === clientId);
    const editing = appointmentId ? appointments.find(a => a.id === appointmentId) : null;
    const modalTitle = document.getElementById('appointment-modal-title');
    const submitBtn = document.getElementById('appointment-submit-btn');
    const clientInput = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const profSelect = document.getElementById('appointment-professional');
    const serviceSelect = document.getElementById('appointment-service');
    const dateInput = document.getElementById('appointment-date');
    const timeInput = document.getElementById('appointment-time');
    const notes = document.getElementById('appointment-notes');

    if (modalTitle) modalTitle.textContent = appointmentFormMode === 'edit' ? 'Editar agendamento' : 'Novo agendamento';
    if (submitBtn) submitBtn.textContent = appointmentFormMode === 'edit' ? 'Atualizar e gerar WhatsApp' : 'Salvar e gerar WhatsApp';

    const baseClient = editing ? clients.find(c => c.id === editing.clientId) : client;

    if (clientInput) clientInput.value = baseClient ? baseClient.name : '';
    if (hidden) hidden.value = baseClient ? baseClient.id : '';
    if (notes) notes.value = editing ? (editing.notes || '') : '';
    const defaultDate = editing ? editing.date : (appointmentPrefillDate || baseClient?.nextAppointment?.date || '');
    const defaultTime = editing ? editing.time : (appointmentPrefillTime || baseClient?.nextAppointment?.time || '');
    if (dateInput) dateInput.value = defaultDate;
    if (timeInput) timeInput.value = defaultTime;

    if (profSelect) {
      profSelect.innerHTML = '';
      collaborators.forEach(col => {
        const opt = document.createElement('option');
        opt.value = col.id || slugify(col.name);
        opt.textContent = col.name;
        profSelect.appendChild(opt);
      });
      if (baseClient?.responsible) profSelect.value = baseClient.responsible.toLowerCase();
      if (currentRole === 'colab' && currentColabAccount) {
        profSelect.value = currentColabAccount.id || slugify(currentColabAccount.name);
      }
      if (editing && (editing.professionalId || editing.professional)) {
        profSelect.value = editing.professionalId || slugify(editing.professional);
      }
    }

    if (serviceSelect) {
      serviceSelect.innerHTML = '';
      const services = [...kioskServices];
      const editingServiceId = editing?.serviceId || editing?.service;
      if (editingServiceId && !services.some(s => s.id === editingServiceId || s.name === editing.service)) {
        services.push({ id: editingServiceId, name: editing?.serviceName || editing?.service || 'Serviço' });
      }
      services.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.name}${s.price ? ' • R$ ' + s.price : ''}`;
        serviceSelect.appendChild(opt);
      });
      serviceSelect.value = editing?.serviceId || editing?.service || services[0]?.id || '';
    }

    renderClientsDatalist();
    openDialog('appointment-modal');
    appointmentPrefillDate = null;
    appointmentPrefillTime = null;
  }

  function saveAppointment() {
    const clientInput = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const professionalValue = document.getElementById('appointment-professional').value;
    const serviceValue = document.getElementById('appointment-service').value;
    const date = document.getElementById('appointment-date').value;
    const time = document.getElementById('appointment-time').value;
    const notes = document.getElementById('appointment-notes').value;

    const isEditing = appointmentFormMode === 'edit';
    const editingAppt = isEditing ? appointments.find(a => a.id === appointmentEditingId) : null;
    const professional = findCollaboratorByIdOrName(professionalValue) || { name: professionalValue, id: slugify(professionalValue) };
    const service = findServiceByIdOrName(serviceValue) || { name: serviceValue, id: slugify(serviceValue) };
    let client = clients.find(c => c.id === hidden.value) || clients.find(c => c.name.toLowerCase() === (clientInput.value || '').toLowerCase());
    if (!client) {
      client = {
        id: `cli-${Date.now()}`,
        name: clientInput.value,
        phone: '55',
        lastService: service.name,
        lastDate: formatDateLabel(date),
        instagram: '',
        birthday: '',
        prefColor: '',
        prefShape: '',
        prefExtension: '',
        allergies: '',
        responsible: professional.name,
        owners: [currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : professional.name || 'Glecie'],
        notes: '',
        extra: '',
        history: [],
        consume: [],
        future: [],
        nextAppointment: {}
      };
      clients.push(client);
    }

    client.owners = client.owners || [];
    if (professional.name && !client.owners.includes(professional.name)) client.owners.push(professional.name);
    client.responsible = professional.name || client.responsible;

    const status = isEditing ? (editingAppt?.status || 'scheduled') : 'scheduled';
    const baseCreatedAt = isEditing ? (editingAppt?.createdAt || new Date().toISOString()) : new Date().toISOString();
    const appointmentPayload = {
      clientId: client.id,
      clientName: client.name,
      professionalId: professional.id,
      professionalName: professional.name,
      professional: professional.name,
      serviceId: service.id,
      serviceName: service.name,
      service: service.name,
      date,
      time,
      notes,
      status
    };

    if (appointmentFormMode === 'edit' && appointmentEditingId) {
      const appt = appointments.find(a => a.id === appointmentEditingId);
      if (appt) {
        const previousClientId = appt.clientId;
        Object.assign(appt, appointmentPayload, {
          status,
          updatedAt: new Date().toISOString(),
          createdAt: appt.createdAt || baseCreatedAt
        });
        if (previousClientId && previousClientId !== client.id) rebuildClientAppointments(previousClientId);
      }
    } else {
      appointments.push({
        id: `appt-${Date.now()}-${Math.random().toString(16).slice(2, 7)}`,
        createdAt: baseCreatedAt,
        updatedAt: baseCreatedAt,
        ...appointmentPayload,
        status
      });
    }

    rebuildClientAppointments(client.id);
    refreshAgendaFromAppointments();

    renderClients('ceo');
    renderClients('colab');
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    if (currentClientDetailId === client.id) renderClientDetailTab();
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');

    closeDialog('appointment-modal');
    if (appointmentOpenedFromDayModal) {
      closeDialog('modal-agendamentos');
    }
    const link = buildWhatsAppLink(client, { appointment: { date, time, serviceName: service.name, service: service.name } });
    if (!isEditing) window.open(link, '_blank');

    appointmentFormMode = 'add';
    appointmentEditingId = null;
    appointmentOpenedFromDayModal = false;
  }

  function openDialog(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    }
  }

  function closeDialog(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }
  }

  function fecharModalAgendamentos() {
    const modal = document.getElementById('modal-agendamentos');
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }
  }

  const primaryButtonClasses = ['px-5', 'py-2', 'rounded-full', 'bg-[var(--btn-primary)]', 'text-white', 'font-semibold', 'flex', 'items-center', 'justify-center', 'whitespace-nowrap', 'hover:bg-[var(--btn-primary-hover)]', 'hover:scale-[1.02]', 'transition-all', 'shadow-sm'];
  const secondaryButtonClasses = ['px-5', 'py-2', 'rounded-full', 'border', 'border-[var(--btn-primary)]', 'bg-[var(--btn-secondary-bg)]', 'text-[var(--btn-primary)]', 'font-medium', 'flex', 'items-center', 'justify-center', 'whitespace-nowrap', 'hover:bg-[var(--btn-secondary-hover)]', 'hover:text-[var(--btn-primary-hover)]', 'transition-all', 'shadow-sm'];

  function normalizeButtons() {
    document.querySelectorAll('button').forEach(btn => {
      const isSecondary = btn.classList.contains('secondary') || btn.dataset.variant === 'secondary' || btn.classList.contains('ghost-btn') || btn.classList.contains('nav');
      const classes = isSecondary ? secondaryButtonClasses : primaryButtonClasses;
      classes.forEach(cls => btn.classList.add(cls));
    });
  }

  const buttonObserver = new MutationObserver(() => normalizeButtons());

  function updateRoleLabel(role) {
    const el = document.getElementById('sidebar-role-label');
    if (role === 'ceo') el.textContent = 'Administradora Gleice';
    if (role === 'colab') {
      const label = currentColabAccount ? `${currentColabAccount.name} (profissional)` : 'Profissional (comissão)';
      el.textContent = label;
    }
  }

  function setupSidebar(role) {
    const nav = document.getElementById('sidebar-nav');
    nav.innerHTML = '';

      if (role === 'ceo') {
        const items = [
          { id: 'dashboard', label: 'Dashboard' },
          { id: 'agenda', label: 'Agenda' },
          { id: 'clients', label: 'Clientes' },
          { id: 'inventory', label: 'Estoque' },
          { id: 'investments', label: 'Investimentos' },
          { id: 'finance', label: 'Financeiro' },
          { id: 'settings', label: 'Configurações' },
        ];
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav';
        btn.textContent = item.label;
        btn.dataset.page = item.id;
        btn.onclick = () => navigatePage('ceo', item.id);
        nav.appendChild(btn);
      });
      const kioskBtn = document.createElement('button');
      kioskBtn.className = 'nav';
      kioskBtn.textContent = 'Modo Tablet';
      kioskBtn.onclick = () => setRole('kiosk');
      nav.appendChild(kioskBtn);
      highlightSidebarActive('ceo', currentPageCEO);
    }

    if (role === 'colab') {
      const items = [
        { id: 'dashboard', label: 'Dashboard' },
        { id: 'agenda', label: 'Agenda' },
        { id: 'clients', label: 'Clientes' },
        { id: 'commission', label: 'Minhas comissões' },
      ];
      items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'nav';
        btn.textContent = item.label;
        btn.dataset.page = item.id;
        btn.onclick = () => navigatePage('colab', item.id);
        nav.appendChild(btn);
      });
      const kioskBtn = document.createElement('button');
      kioskBtn.className = 'nav';
      kioskBtn.textContent = 'Modo Tablet';
      kioskBtn.onclick = () => setRole('kiosk');
      nav.appendChild(kioskBtn);
      highlightSidebarActive('colab', currentPageColab);
    }
  }

  function highlightSidebarActive(role, pageId) {
    const nav = document.getElementById('sidebar-nav');
    const buttons = nav.querySelectorAll('button.nav');
    buttons.forEach(btn => {
      if (btn.dataset.page === pageId) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    const titleMapCEO = {
      dashboard: ['Dashboard', 'Visão geral do Studio Nails'],
      agenda: ['Agenda', 'Visão anual e mensal'],
      inventory: ['Estoque', 'Esmaltes e geladeira'],
      investments: ['Investimentos', 'Compras, reformas e melhorias'],
      finance: ['Financeiro', 'Resumo de receitas e custos'],
      clients: ['Clientes', 'Busca, fichas e agendamentos'],
      settings: ['Configurações', 'Serviços, comissão, etc.']
    };

    const titleMapColab = {
      dashboard: ['Dashboard', 'Resumo do seu dia'],
      agenda: ['Agenda', 'Sua agenda + CEO'],
      clients: ['Clientes', 'Somente os seus contatos'],
      commission: ['Minhas comissões', 'Detalhamento por serviço']
    };

    const titleEl = document.getElementById('page-title');
    const subtitleEl = document.getElementById('page-subtitle');

    if (role === 'ceo') {
      const arr = titleMapCEO[pageId] || ['Dashboard', 'Visão geral do Studio Nails'];
      titleEl.textContent = arr[0];
      subtitleEl.textContent = arr[1];
    } else if (role === 'colab') {
      const arr = titleMapColab[pageId] || ['Dashboard', 'Resumo do seu dia'];
      titleEl.textContent = arr[0];
      subtitleEl.textContent = arr[1];
    }
  }

  function navigatePage(role, pageId) {
    if (role === 'ceo') currentPageCEO = pageId;
    if (role === 'colab') currentPageColab = pageId;
    updateVisiblePage();
    highlightSidebarActive(role, pageId);
  }

  function toggleSidebar() {
    sidebarCollapsed = !sidebarCollapsed;
    const shell = document.getElementById('app-shell');
    if (shell) shell.classList.toggle('sidebar-collapsed', sidebarCollapsed);
    const btn = document.getElementById('sidebar-toggle-btn');
    if (btn) btn.textContent = sidebarCollapsed ? 'Mostrar menu' : 'Ocultar menu';
  }

  function updateVisiblePage() {
    const ceoPages = document.querySelectorAll('.page-ceo');
    const colabPages = document.querySelectorAll('.page-colab');

    ceoPages.forEach(p => p.classList.add('hidden'));
    colabPages.forEach(p => p.classList.add('hidden'));

    if (currentRole === 'ceo') {
      const id = `page-ceo-${currentPageCEO}`;
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      renderCeoContent();
    }

    if (currentRole === 'colab') {
      const id = `page-colab-${currentPageColab}`;
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      renderColabContent();
    }
  }

  // -----------------------------
  // RENDERIZAÇÃO DE CONTEÚDO CEO
  // -----------------------------

  function updateGlobalMonthLabel() {
    const label = document.getElementById('global-month-label');
    if (label) label.textContent = formatMonthWithYear(getDashboardFilterTarget());
  }

  function refreshMonthlyConsumers() {
    updateGlobalMonthLabel();
    renderDashboardCards();
    renderInvestments();
    renderFinance();
    renderInventory();
  }

  function changeGlobalMonth(delta) {
    const pivot = new Date(selectedDashboardYear, selectedDashboardMonth + delta, 1);
    selectedDashboardMonth = pivot.getMonth();
    selectedDashboardYear = pivot.getFullYear();
    selectedGlobalMonthKey = `${selectedDashboardYear}-${String(selectedDashboardMonth + 1).padStart(2, '0')}`;
    persistGlobalMonth(selectedGlobalMonthKey);
    const select = document.getElementById('global-month-filter');
    if (select) select.value = selectedGlobalMonthKey;
    refreshMonthlyConsumers();
  }

  function setDashboardMonth(value, year = selectedDashboardYear) {
    selectedDashboardMonth = parseInt(value, 10) || 0;
    selectedDashboardYear = year || selectedDashboardYear;
    selectedGlobalMonthKey = `${selectedDashboardYear}-${String(selectedDashboardMonth + 1).padStart(2, '0')}`;
    persistGlobalMonth(selectedGlobalMonthKey);
    const select = document.getElementById('global-month-filter');
    if (select) select.value = selectedGlobalMonthKey;
    refreshMonthlyConsumers();
  }

  function computeInvestmentDashboardStats(target = getDashboardFilterTarget()) {
    const currentTarget = target || getDashboardFilterTarget();
    let totalMes = 0;
    let parcelasPagasMes = 0;
    let futurosPlanejados = 0;
    let futurosQuantidade = 0;

    investments.forEach(inv => {
      const ref = parseMonthRef(inv.mesReferencia);
      const active = isInvestmentActiveInMonth(inv, currentTarget);
      const monthlyValue = getInvestmentMonthlyValue(inv);

      if (active) {
        totalMes += monthlyValue;
        const payments = inv.payments || [];
        const paidThisMonth = payments.filter(p => p.monthIndex === currentTarget.monthIndex && p.year === currentTarget.year);
        parcelasPagasMes += paidThisMonth.reduce((acc, pay) => acc + (pay.amount || monthlyValue), 0);
      }

      if (ref && monthsDiff(ref, currentTarget) < 0) {
        futurosPlanejados += inv.valorTotal ?? inv.amount ?? 0;
        futurosQuantidade += 1;
      }
    });

    return { totalMes, parcelasPagasMes, futurosPlanejados, futurosQuantidade };
  }

  function computeStockTotals(target = getDashboardFilterTarget()) {
    const totals = { esmaltes: 0, geladeira: 0, manutencao: 0 };
    const filtered = selectedGlobalMonthKey === 'all'
      ? stockItems
      : stockItems.filter(item => matchesTargetMonth(item.dataCompra || item.addedAt || item.createdAt, target));
    filtered.forEach(item => {
      const cat = item.categoria || item.category;
      const cost = item.custoTotal || item.custoCompra || 0;
      if (totals[cat] != null) totals[cat] += cost;
    });
    return totals;
  }

  function drawPieChart(canvasId, dataMap) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const labels = Object.keys(dataMap);
    const data = Object.values(dataMap);
    const colors = [
      getCssVar('--chart-green', '#E6EFE6'),
      getCssVar('--chart-gold', '#B7A06A'),
      getCssVar('--chart-pink', '#F4D9D2')
    ];

    if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

    chartInstances[canvasId] = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [
          {
            data,
            backgroundColor: colors,
            borderWidth: 1,
            borderColor: '#fff',
            hoverOffset: 8
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'right',
            labels: { color: getCssVar('--text-main', '#2F2F2F') }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.75)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderWidth: 0
          }
        }
      }
    });
  }

  function drawBarChart(canvasId, series) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const labels = series.map(s => s.label);
    const data = series.map(s => s.value);

    if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

    chartInstances[canvasId] = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Custo',
            data,
            fill: true,
            tension: 0.35,
            borderColor: 'rgba(170, 207, 163, 1)',
            backgroundColor: 'rgba(227, 244, 225, 0.35)',
            pointBackgroundColor: 'rgba(170, 207, 163, 1)',
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: getCssVar('--text-main', '#2F2F2F') },
            grid: { display: false }
          },
          y: {
            ticks: { color: getCssVar('--text-main', '#2F2F2F') },
            grid: { color: 'rgba(0,0,0,0.05)' },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.75)',
            titleColor: '#fff',
            bodyColor: '#fff'
          }
        }
      }
    });
  }

  function renderDashboardCards() {
    const target = getDashboardFilterTarget();
    const revenueEl = document.getElementById('dashboard-revenue');
    const revenueDelta = document.getElementById('dashboard-revenue-delta');
    const commEl = document.getElementById('dashboard-commission');
    const commDelta = document.getElementById('dashboard-commission-delta');
    const consEl = document.getElementById('dashboard-consumption');
    const consDelta = document.getElementById('dashboard-consumption-delta');
    const alertEl = document.getElementById('dashboard-stock-alerts');
    const alertDesc = document.getElementById('dashboard-stock-alerts-desc');
    const targetLabel = target ? `${monthNamesFull[target.monthIndex]} ${target.year}` : '—';
    const filteredFin = selectedGlobalMonthKey === 'all'
      ? financialEntries
      : financialEntries.filter(e => matchesTargetMonth(e.date, target));
    const revenue = filteredFin.filter(f => f.type === 'receita').reduce((acc, cur) => acc + (cur.amount || 0), 0);
    const commission = filteredFin.filter(f => f.type === 'comissao').reduce((acc, cur) => acc + (cur.amount || 0), 0);
    const historyEntries = Object.values(stockHistories).flat();
    const consumption = selectedGlobalMonthKey === 'all'
      ? 0
      : historyEntries
          .filter(m => (m.tipo === 'saida' || m.tipo === 'baixa') && matchesTargetMonth(m.data, target))
          .reduce((acc, cur) => acc + (cur.quantity || cur.quantidade || cur.volume || 0), 0);
    const alertsCount = stockItems.filter(item => {
      const pct = item.volumeTotal_ml ? (item.volumeAtual_ml / item.volumeTotal_ml) : null;
      const low = (item.previsaoDuracaoDias && item.previsaoDuracaoDias < 15) || (pct != null && pct < 0.3) || (item.quantidade && item.quantidade <= (item.unidadesPorPack || item.quantidade) * 0.2);
      return low;
    }).length;
    const alertText = alertsCount > 0 ? 'Itens com estoque baixo' : 'Nenhum alerta de estoque';

    if (revenueEl) revenueEl.textContent = formatCurrency(revenue);
    if (revenueDelta) revenueDelta.textContent = targetLabel;
    if (commEl) commEl.textContent = formatCurrency(commission);
    if (commDelta) commDelta.textContent = commission ? `Comissões registradas em ${targetLabel}` : 'Sem comissões registradas';
    if (consEl) consEl.textContent = formatCurrency(consumption);
    if (consDelta) consDelta.textContent = 'Consumo filtrado pelo mês selecionado';
    if (alertEl) alertEl.textContent = `${alertsCount} itens`;
    if (alertDesc) alertDesc.textContent = alertText;

    const invStats = computeInvestmentDashboardStats(target);
    const invMonth = document.getElementById('dashboard-invest-month');
    const invMonthDesc = document.getElementById('dashboard-invest-month-desc');
    const invPaid = document.getElementById('dashboard-invest-paid');
    const invPaidDesc = document.getElementById('dashboard-invest-paid-desc');
    const invFuture = document.getElementById('dashboard-invest-future');
    const invFutureDesc = document.getElementById('dashboard-invest-future-desc');

    if (invMonth) invMonth.textContent = formatCurrency(invStats.totalMes);
    if (invMonthDesc) invMonthDesc.textContent = `Investimentos com referência em ${formatMonthWithYear(target)}`;
    if (invPaid) invPaid.textContent = formatCurrency(invStats.parcelasPagasMes);
    if (invPaidDesc) invPaidDesc.textContent = `Pagamentos registrados em ${formatMonthWithYear(target)}`;
    if (invFuture) invFuture.textContent = formatCurrency(invStats.futurosPlanejados);
    if (invFutureDesc) invFutureDesc.textContent = `${invStats.futurosQuantidade} planejado(s) para os próximos meses`;

    renderDashboardStockCard(target);
  }

  function renderDashboardStockCard(target = getDashboardFilterTarget()) {
    const card = document.getElementById('dashboard-stock-card');
    if (!card) return;
    const totals = computeStockTotals(target);
    const totalsEl = document.getElementById('dashboard-stock-totals');
    if (totalsEl) {
      totalsEl.innerHTML = `
        <span>Esmaltes: <strong>${formatCurrency(totals.esmaltes)}</strong></span>
        <span>Geladeira: <strong>${formatCurrency(totals.geladeira)}</strong></span>
        <span>Manutenção: <strong>${formatCurrency(totals.manutencao)}</strong></span>
      `;
    }
    const esmalteVal = document.getElementById('dashboard-stock-esmaltes');
    const gelVal = document.getElementById('dashboard-stock-geladeira');
    const manVal = document.getElementById('dashboard-stock-manutencao');
    if (esmalteVal) esmalteVal.textContent = formatCurrency(totals.esmaltes);
    if (gelVal) gelVal.textContent = formatCurrency(totals.geladeira);
    if (manVal) manVal.textContent = formatCurrency(totals.manutencao);
    const tags = document.getElementById('dashboard-stock-tags');
    if (tags) {
      tags.innerHTML = '';
      const lbl = document.createElement('span');
      lbl.className = 'pill';
      lbl.textContent = selectedGlobalMonthKey === 'all' ? 'Todos os meses' : formatMonthWithYear(target);
      tags.appendChild(lbl);
    }
    const pieData = { esmaltes: totals.esmaltes, geladeira: totals.geladeira, manutencao: totals.manutencao };
    drawPieChart('stock-pie', pieData);

    const monthMap = {};
    stockItems.forEach(item => {
      const key = monthKeyFromDate(item.dataCompra || item.addedAt || item.createdAt);
      if (!key) return;
      monthMap[key] = (monthMap[key] || 0) + (item.custoTotal || item.custoCompra || 0);
    });
    const sorted = Object.keys(monthMap).sort();
    const recent = sorted.slice(-6);
    const series = recent.map(key => {
      const [y, m] = key.split('-').map(v => parseInt(v, 10));
      return { label: `${String(m).padStart(2, '0')}/${y}`, value: monthMap[key] };
    });
    drawBarChart('stock-bars', series);

    const lowCount = stockItems.filter(item => {
      const pct = item.volumeTotal_ml ? (item.volumeAtual_ml / item.volumeTotal_ml) : null;
      return (item.previsaoDuracaoDias && item.previsaoDuracaoDias < 15) || (pct != null && pct < 0.3);
    }).length;
    const lowEl = document.getElementById('dashboard-stock-low');
    if (lowEl) lowEl.textContent = `${lowCount}`;
    const profitEl = document.getElementById('dashboard-stock-profit');
    const fridgeProfit = stockItems
      .filter(i => (i.categoria || i.category) === 'geladeira')
      .reduce((acc, cur) => acc + ((cur.precoVenda || 0) * (cur.quantidade || 0) - (cur.custoCompra || 0)), 0);
    if (profitEl) profitEl.textContent = formatCurrency(fridgeProfit);
    const historyEntries = Object.values(stockHistories).flat();
    const monthConsumption = selectedGlobalMonthKey === 'all'
      ? 0
      : historyEntries.filter(m => (m.tipo === 'saida' || m.tipo === 'baixa') && matchesTargetMonth(m.data, target))
          .reduce((acc, cur) => acc + (cur.quantity || cur.quantidade || cur.volume || 0), 0);
    const consEl = document.getElementById('dashboard-stock-consumption-month');
    if (consEl) consEl.textContent = `${monthConsumption}`;
    const fridgeLow = stockItems.filter(item => (item.categoria || item.category) === 'geladeira' && item.quantidade && item.quantidade <= (item.unidadesPorPack || item.quantidade) * 0.2).length;
    const indicators = document.getElementById('stock-indicators');
    if (indicators) {
      indicators.innerHTML = '';
      indicators.innerHTML = `
        <span class="pill">Baixo estoque: ${lowCount}</span>
        <span class="pill">Geladeira em alerta: ${fridgeLow}</span>
      `;
    }
  }

  function renderFinance() {
    const revenueEl = document.getElementById('finance-revenue');
    const costEl = document.getElementById('finance-costs');
    const profitEl = document.getElementById('finance-profit');
    const target = getDashboardFilterTarget();
    const filtered = selectedGlobalMonthKey === 'all' ? financialEntries : financialEntries.filter(e => matchesTargetMonth(e.date, target));
    const revenue = filtered.filter(f => f.type === 'receita').reduce((acc, cur) => acc + cur.amount, 0);
    const cost = filtered.filter(f => f.type === 'despesa').reduce((acc, cur) => acc + cur.amount, 0);
    if (revenueEl) revenueEl.textContent = formatCurrency(revenue);
    if (costEl) costEl.textContent = formatCurrency(cost);
    if (profitEl) profitEl.textContent = formatCurrency(revenue - cost);
  }

  function filterClientsByRole(scope) {
    if (scope === 'ceo') return clients;
    const colabName = currentColabAccount?.name || 'colab';
    const colabId = currentColabAccount?.id || '';
    const owned = c => (c.owners || []).some(o => o.toLowerCase() === colabName.toLowerCase());
    const responsible = c => (c.responsible || '').toLowerCase() === colabName.toLowerCase() || (c.responsible || '').toLowerCase() === colabId.toLowerCase();
    const viaAppointments = c => appointments.some(a => a.clientId === c.id && ((a.professionalName || '').toLowerCase() === colabName.toLowerCase() || (a.professionalId || '').toLowerCase() === colabId.toLowerCase()));
    const viaFuture = c => (c.future || []).some(f => (f.professionalName || f.professional || '').toLowerCase() === colabName.toLowerCase());
    return clients.filter(c => owned(c) || responsible(c) || viaAppointments(c) || viaFuture(c));
  }

  function renderClients(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'clients-grid-ceo' : 'clients-grid-colab');
    const searchEl = document.getElementById(scope === 'ceo' ? 'client-search-ceo' : 'client-search-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const search = (searchEl?.value || '').toLowerCase();
    const filtered = filterClientsByRole(scope)
      .filter(c => c.name.toLowerCase().includes(search) || (c.phone || '').includes(search));

    filtered.forEach(c => {
      const card = document.createElement('div');
      card.className = 'client-card';
      const badge = `<span class="badge-soft">${c.lastService || '—'}${c.lastDate ? ' • ' + c.lastDate : ''}</span>`;
      const whatsapp = buildWhatsAppLink(c);
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.4rem;">
          <div>
            <div class="client-name">${c.name}</div>
            <div class="client-meta">${badge}</div>
            <div class="client-meta">${c.prefColor ? 'Cor: ' + c.prefColor + ' • ' : ''}${c.prefShape ? 'Formato: ' + c.prefShape : ''}</div>
            <div class="client-meta">${c.notes || 'Sem observações'}</div>
          </div>
          <div class="client-pill">${c.nextAppointment?.time || '--:--'} • ${c.nextAppointment?.date ? formatDateLabel(c.nextAppointment.date) : 'agenda'}</div>
        </div>
        <div class="client-meta" style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
          <a href="${whatsapp}" target="_blank" rel="noopener">${c.phone}</a>
          ${c.instagram ? `<span class="badge-soft">${c.instagram}</span>` : ''}
          <span class="badge-soft">Último: ${c.lastService || '—'}</span>
        </div>
        <div class="client-actions">
          <div class="inline-actions">
            <button class="secondary" onclick="openClientDetails('${c.id}')">Ver ficha</button>
            <button class="secondary" onclick="openAppointmentModal('${c.id}')">Agendar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openClientModal('edit','${c.id}')">✎ Editar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openRemoveClientModal('${c.id}')">🗑 Remover</button>
          </div>
          <span class="client-pill">${c.responsible || (c.owners || ['Responsável'])[0]}</span>
        </div>
      `;
      listEl.appendChild(card);
    });

    if (!filtered.length) {
      listEl.innerHTML = '<div class="client-meta">Nenhuma cliente encontrada.</div>';
    }

    renderClientsDatalist();
  }

  function renderClientsDatalist() {
    const datalist = document.getElementById('clients-datalist');
    if (!datalist) return;
    datalist.innerHTML = '';
    clients.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.dataset.id = c.id;
      datalist.appendChild(opt);
    });
  }

  function setAgendaView(mode, scope = 'ceo') {
    if (scope === 'ceo') {
      agendaViewMode = mode;
    } else {
      agendaViewModeColab = mode;
    }
    const yearView = document.getElementById(scope === 'ceo' ? 'agenda-view-year' : 'agenda-view-year-colab');
    const monthView = document.getElementById(scope === 'ceo' ? 'agenda-view-month' : 'agenda-view-month-colab');
    const btnYear = document.getElementById(scope === 'ceo' ? 'agenda-toggle-year' : 'agenda-toggle-year-colab');
    const btnMonth = document.getElementById(scope === 'ceo' ? 'agenda-toggle-month' : 'agenda-toggle-month-colab');
    if (yearView && monthView) {
      yearView.classList.toggle('hidden', mode !== 'year');
      monthView.classList.toggle('hidden', mode !== 'month');
    }
    if (btnYear && btnMonth) {
      btnYear.classList.toggle('active', mode === 'year');
      btnMonth.classList.toggle('active', mode === 'month');
    }
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
    renderAgendaAppointments(scope);
    renderYearCalendar(scope);
  }

  function getProfessionalColor(name) {
    const match = collaborators.find(c => c.name.toLowerCase() === (name || '').toLowerCase());
    return match?.color || getCssVar('--chart-gold', '#B7A06A');
  }

  function getAppointmentsForScope(scope = 'ceo') {
    let list = appointments.filter(a => a.status !== 'canceled');
    if (scope === 'colab') {
      const colabName = (currentColabAccount?.name || '').toLowerCase();
      const colabId = (currentColabAccount?.id || '').toLowerCase();
      list = list.filter(a => (a.professionalName || '').toLowerCase() === colabName || (a.professionalId || '').toLowerCase() === colabId);
    }
    const activeFilter = scope === 'ceo' ? agendaProfessionalFilter : agendaProfessionalFilterColab;
    if (activeFilter && activeFilter !== 'all') {
      list = list.filter(a => getProfessionalKey(a) === activeFilter.toLowerCase() || (a.professionalName || '').toLowerCase() === activeFilter.toLowerCase());
    }
    return list;
  }

  function filterAppointmentsByScope(scope = 'ceo') {
    return getAppointmentsForScope(scope);
  }

  function setAgendaProfessionalFilter(value, scope = 'ceo') {
    if (scope === 'ceo') {
      agendaProfessionalFilter = value || 'all';
    } else {
      agendaProfessionalFilterColab = value || (currentColabAccount?.id || 'all');
    }
    renderYearCalendar(scope);
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
    renderAgendaAppointments(scope);
    renderDayAppointmentsModal();
  }

  function renderAgendaAppointments(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'agenda-appointments-list' : 'agenda-appointments-list-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const now = new Date();
    const items = filterAppointmentsByScope(scope)
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .filter(a => a.dateObj.toString() !== 'Invalid Date' && a.dateObj >= now)
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!items.length) {
      listEl.innerHTML = '<div class="subtext">Nenhum agendamento futuro.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const card = document.createElement('div');
      card.className = 'appointment-card';
      card.style.setProperty('--appt-color', color);
      card.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title">
            ${client ? client.name : (appt.clientName || 'Cliente')}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${formatDateLabel(appt.date)} • ${appt.time}</span>
            <span>Serviço: ${appt.serviceName || appt.service}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')">✎ Editar</button>
          <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')">🗑 Remover</button>
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  function openRemoveAppointmentModal(id) {
    pendingRemoveAppointmentId = id;
    openDialog('appointment-remove-modal');
  }

  function confirmRemoveAppointment() {
    if (!pendingRemoveAppointmentId) return;
    const apptIndex = appointments.findIndex(a => a.id === pendingRemoveAppointmentId);
    if (apptIndex >= 0) {
      const appt = appointments[apptIndex];
      appointments.splice(apptIndex, 1);
      rebuildClientAppointments(appt.clientId);
    }
    pendingRemoveAppointmentId = null;
    refreshAgendaFromAppointments();
    renderClients('ceo');
    renderClients('colab');
    if (currentClientDetailId) renderClientDetailTab();
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');
    closeDialog('appointment-remove-modal');
  }

  function populateProfessionalFilters() {
    const ceoSelect = document.getElementById('agenda-prof-filter');
    const colabSelect = document.getElementById('agenda-prof-filter-colab');
    const optionList = [{ id: 'all', name: 'Todos' }, ...collaborators.map(c => ({ id: c.id || slugify(c.name), name: c.name }))];

    if (ceoSelect) {
      ceoSelect.innerHTML = '';
      optionList.forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.id;
        opt.textContent = optData.name;
        ceoSelect.appendChild(opt);
      });
      ceoSelect.value = agendaProfessionalFilter;
    }

    if (colabSelect) {
      colabSelect.innerHTML = '';
      const colabOptions = currentColabAccount ? [{ id: currentColabAccount.id || slugify(currentColabAccount.name), name: currentColabAccount.name }] : collaborators.map(c => ({ id: c.id || slugify(c.name), name: c.name }));
      colabOptions.forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.id;
        opt.textContent = optData.name;
        colabSelect.appendChild(opt);
      });
      colabSelect.value = agendaProfessionalFilterColab;
      if (!colabSelect.value && colabOptions[0]) colabSelect.value = colabOptions[0].id;
      colabSelect.disabled = true;
    }
  }

  function renderCeoContent() {
    setupMonthSelects();
    populateProfessionalFilters();
    renderDashboardCards();
    renderYearCalendar('ceo');
    setAgendaView(agendaViewMode, 'ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaAppointments('ceo');
    switchInventoryTab(currentInventoryTab);
    renderInventory();
    renderCollaborators();
    renderServicesTable();
    renderInvestments();
    renderClients('ceo');
  }

  function renderColabContent() {
    setupMonthSelects();
    populateProfessionalFilters();
    renderYearCalendar('colab');
    setAgendaView(agendaViewModeColab, 'colab');
    renderAgendaMonthSummary('colab');
    renderAgendaAppointments('colab');
    renderClients('colab');
  }

  function renderYearCalendar(scope = 'ceo') {
    const container = document.getElementById(scope === 'ceo' ? 'year-calendar' : 'year-calendar-colab');
    if (!container) return;
    container.innerHTML = '';
    baseYearDetailed.forEach(m => {
      const monthData = buildMonthSnapshot(m.monthIndex, scope);
      const div = document.createElement('div');
      const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
      div.className = 'month-card' + (m.monthIndex === selected ? ' active' : '');

      const header = document.createElement('div');
      header.className = 'month-header';
      header.innerHTML = `
        <div class="month-name">${m.fullName}</div>
        <div class="month-stat">${monthData.bookings} atend.</div>
      `;

      const bar = document.createElement('div');
      bar.className = 'month-bar';
      bar.innerHTML = `<div class="month-bar-fill" style="width:${monthData.occupancy}%;"></div>`;

      const mini = document.createElement('div');
      mini.className = 'mini-calendar';
      mini.innerHTML = `
        <div class="mini-weekdays">
          <span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span><span>D</span>
        </div>
      `;

      const daysGrid = document.createElement('div');
      daysGrid.className = 'mini-days';
      const days = buildMonthDays(calendarYear, m.monthIndex, monthData.highlightDays);
      days.forEach(d => {
        const span = document.createElement('span');
        span.className = 'mini-day' + (d.hasBooking ? ' has-booking' : '') + (d.empty ? ' empty' : '');
        span.textContent = d.label;
        if (!d.empty) {
          span.onclick = () => openDayAppointmentsModal(`${calendarYear}-${String(m.monthIndex + 1).padStart(2, '0')}-${String(d.label).padStart(2, '0')}`, scope);
        }
        if (d.hasBooking) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          span.appendChild(dot);
        }
        daysGrid.appendChild(span);
      });
      mini.appendChild(daysGrid);

      const footnote = document.createElement('div');
      footnote.className = 'month-footnote';
      footnote.innerHTML = `
        <span>Ocupação: ${monthData.occupancy}%</span>
        <span class="tag">ver mês</span>
      `;

      div.appendChild(header);
      div.appendChild(bar);
      div.appendChild(mini);
      div.appendChild(footnote);
      div.onclick = () => setSelectedMonth(m.monthIndex, scope);
      container.appendChild(div);
    });
  }

  function renderAgendaMonthCalendar(scope = 'ceo') {
    const calendarEl = document.getElementById(scope === 'ceo' ? 'agenda-month-calendar' : 'agenda-month-calendar-colab');
    const selector = document.getElementById(scope === 'ceo' ? 'agenda-month-selector' : 'agenda-month-selector-colab');
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    if (selector) selector.value = selected;
    if (!calendarEl) return;
    calendarEl.innerHTML = '';
    const weekdays = ['S', 'T', 'Q', 'Q', 'S', 'S', 'D'];
    weekdays.forEach(day => {
      const w = document.createElement('div');
      w.className = 'weekday';
      w.textContent = day;
      calendarEl.appendChild(w);
    });
    const month = buildMonthSnapshot(selected, scope);
    const days = buildMonthDays(calendarYear, month.monthIndex, month.highlightDays);
    days.forEach(d => {
      const cell = document.createElement('div');
      if (d.empty) {
        cell.style.background = 'transparent';
        calendarEl.appendChild(cell);
        return;
      }
      const match = month.daysSummary.find(day => day.day.startsWith(String(d.label).padStart(2, '0')));
      const hasBooking = Boolean(match);
      cell.className = 'month-day' + (hasBooking ? ' has-booking' : '');
      const badgeText = hasBooking ? `${match.count} ag.` : 'Livre';
      cell.innerHTML = `
        <div class="day-number">${d.label}</div>
        <span class="day-badge" style="${hasBooking ? '' : 'background:transparent;color:var(--text-muted);'}">${badgeText}</span>
      `;
      cell.onclick = () => {
        openDayAppointmentsModal(`${calendarYear}-${String(month.monthIndex + 1).padStart(2, '0')}-${String(d.label).padStart(2, '0')}`, scope);
      };
      calendarEl.appendChild(cell);
    });
  }

  function renderAgendaMonthSummary(scope = 'ceo') {
    const tbody = document.getElementById(scope === 'ceo' ? 'agenda-month-summary' : 'agenda-month-summary-colab');
    if (!tbody) return;
    tbody.innerHTML = '';
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    const month = buildMonthSnapshot(selected, scope);
    const monthTitle = document.getElementById(scope === 'ceo' ? 'selected-month-title' : 'selected-month-title-colab');
    const tagContainer = document.getElementById(scope === 'ceo' ? 'selected-month-tags' : 'selected-month-tags-colab');
    if (monthTitle) monthTitle.textContent = `Agenda de ${month.fullName}`;
    if (tagContainer) {
      tagContainer.innerHTML = '';
      month.tags.forEach(t => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = t;
        tagContainer.appendChild(span);
      });
      if (!month.tags.length) {
        const total = document.createElement('span');
        total.className = 'pill';
        total.textContent = `${month.bookings} atend.`;
        tagContainer.appendChild(total);
      }
      const ocup = document.createElement('span');
      ocup.className = 'pill';
      ocup.textContent = `${month.occupancy}% ocupação`;
      tagContainer.appendChild(ocup);
    }
    const scopedAppointments = getAppointmentsForScope(scope)
      .filter(a => {
        if (!a.date) return false;
        const [year, month] = a.date.split('-').map(Number);
        if (!month) return false;
        if (!year) return month - 1 === selected;
        return month - 1 === selected && year === calendarYear;
      })
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!scopedAppointments.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="subtext">Nenhum agendamento neste mês.</td>`;
      tbody.appendChild(tr);
      return;
    }

    scopedAppointments.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const clientName = client ? client.name : (appt.clientName || 'Cliente');
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDateLabel(appt.date)}</td>
        <td>${appt.time || '--:--'}</td>
        <td>${clientName}</td>
        <td>${appt.serviceName || appt.service}</td>
        <td><span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span></td>
        <td>
          <div style="display:flex;gap:0.35rem;justify-content:flex-end;">
            <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')">✎ Editar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')">🗑 Remover</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function setSelectedMonth(index, scope = 'ceo') {
    if (scope === 'ceo') {
      selectedMonthIndex = index;
    } else {
      selectedMonthIndexColab = index;
    }
    renderYearCalendar(scope);
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
  }

  function buildMonthSnapshot(monthIndex, scope = 'ceo') {
    const base = baseYearDetailed[monthIndex] || { monthIndex, fullName: monthNamesFull[monthIndex] || '', month: monthNamesShort[monthIndex] || '', tags: [] };
    const scopedAppointments = getAppointmentsForScope(scope).filter(a => {
      if (!a.date) return false;
      const [year, month] = a.date.split('-').map(Number);
      if (!month) return false;
      if (!year) return month - 1 === monthIndex;
      return month - 1 === monthIndex && year === calendarYear;
    });

    const dayMap = {};
    scopedAppointments.forEach(appt => {
      const [, month, day] = (appt.date || '').split('-');
      const dayNum = parseInt(day, 10);
      if (!dayNum) return;
      if (!dayMap[dayNum]) dayMap[dayNum] = { count: 0, pros: '', highlight: '' };
      dayMap[dayNum].count += 1;
      dayMap[dayNum].pros = mergePros(dayMap[dayNum].pros, appt.professionalName || appt.professional || 'Equipe');
      dayMap[dayNum].highlight = appt.serviceName || appt.service || dayMap[dayNum].highlight || 'Agendado';
    });

    const highlightDays = Object.keys(dayMap).map(Number).sort((a, b) => a - b);
    const daysSummary = highlightDays.map(day => ({
      day: `${String(day).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')}`,
      count: dayMap[day].count,
      pros: dayMap[day].pros || 'Equipe',
      highlight: dayMap[day].highlight || 'Agendado'
    }));

    const daysInMonth = new Date(calendarYear, monthIndex + 1, 0).getDate();
    const occupancy = Math.round((highlightDays.length / daysInMonth) * 100) || 0;

    return { ...base, bookings: scopedAppointments.length, highlightDays, daysSummary, occupancy };
  }

  function buildMonthDays(year, monthIndex, highlightDays = []) {
    const result = [];
    const firstWeekday = new Date(year, monthIndex, 1).getDay(); // 0=domingo
    const offset = (firstWeekday + 6) % 7; // força a semana a começar na segunda
    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
    for (let i = 0; i < offset; i++) {
      result.push({ empty: true, label: '' });
    }
    for (let d = 1; d <= daysInMonth; d++) {
      result.push({
        label: d,
        hasBooking: highlightDays.includes(d)
      });
    }
    return result;
  }

  function mergePros(existing, professional) {
    if (!existing) return professional || 'Equipe';
    if (!professional) return existing;
    const parts = existing.split('+').map(p => p.trim());
    if (parts.includes(professional)) return existing;
    return `${existing} + ${professional}`;
  }

  function refreshAgendaFromAppointments() {
    clients.forEach(c => rebuildClientAppointments(c.id));
    renderYearCalendar('ceo');
    renderYearCalendar('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthSummary('colab');
    renderDayAppointmentsModal();
  }

  function switchInventoryTab(category) {
    currentInventoryCategory = category;
    currentInventoryTab = category;
    const panels = {
      esmaltes: 'inventory-panel-esmaltes',
      geladeira: 'inventory-panel-geladeira',
      manutencao: 'inventory-panel-manutencao'
    };
    const buttons = {
      esmaltes: 'inventory-tab-btn-polish',
      geladeira: 'inventory-tab-btn-fridge',
      manutencao: 'inventory-tab-btn-maint'
    };
    Object.entries(panels).forEach(([cat, id]) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden', cat !== category);
    });
    Object.entries(buttons).forEach(([cat, id]) => {
      const btn = document.getElementById(id);
      if (btn) btn.classList.toggle('active', cat === category);
    });
    const select = document.getElementById('inventory-category');
    if (select) select.value = category;
    renderInventoryTemplates();
  }

  function resetInventoryFields() {
    ['stock-polish-name','stock-polish-brand','stock-polish-total','stock-polish-current','stock-polish-cost','stock-polish-consumption','stock-polish-date','stock-polish-forecast','stock-fridge-name','stock-fridge-qty','stock-fridge-cost','stock-fridge-price','stock-fridge-date','stock-maint-name','stock-maint-qty','stock-maint-cost','stock-maint-date']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    const kiosk = document.getElementById('inventory-kiosk-flag');
    if (kiosk) kiosk.value = 'active';
  }

  function closeInventoryModal() {
    const modal = document.getElementById('inventory-modal');
    inventoryFormMode = 'add';
    inventoryEditingId = null;
    resetInventoryFields();
    if (modal) modal.classList.add('hidden');
  }

  function handleInventoryDestinationChange(value) {
    currentInventoryCategory = value;
    const select = document.getElementById('inventory-category');
    if (select) select.value = value;
    ['inventory-fields-esmaltes', 'inventory-fields-geladeira', 'inventory-fields-manutencao'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden', !id.includes(value));
    });
    renderInventoryTemplates();
    updatePolishForecast();
  }

  function updatePolishForecast() {
    const current = parseFloat(document.getElementById('stock-polish-current')?.value || '0');
    const consumption = parseFloat(document.getElementById('stock-polish-consumption')?.value || '0');
    const usesPerDay = 3;
    const forecast = consumption > 0 ? Math.round(current / (consumption * usesPerDay)) : 0;
    const forecastEl = document.getElementById('stock-polish-forecast');
    if (forecastEl) forecastEl.value = forecast ? `${forecast} dias` : '';
  }

  function applyInventoryTemplate(templateId) {
    const tmpl = productTemplates.find(t => t.id === templateId);
    if (!tmpl) return;
    currentInventoryCategory = tmpl.categoria || tmpl.category || currentInventoryCategory;
    handleInventoryDestinationChange(currentInventoryCategory);
    if (currentInventoryCategory === 'esmaltes') {
      document.getElementById('stock-polish-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('stock-polish-brand').value = tmpl.marca || 'Studio Nails';
      document.getElementById('stock-polish-total').value = tmpl.volumeTotal || tmpl.volumePorPack || '';
      document.getElementById('stock-polish-current').value = tmpl.volumeTotal || tmpl.volumePorPack || '';
    } else if (currentInventoryCategory === 'geladeira') {
      document.getElementById('stock-fridge-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('stock-fridge-qty').value = tmpl.unidadesPorPack || tmpl.volumePorPack || '';
    } else {
      document.getElementById('stock-maint-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('stock-maint-qty').value = tmpl.unidadesPorPack || '';
    }
    updatePolishForecast();
  }

  function stockIconFor(item) {
    const lower = (item?.nome || item?.name || '').toLowerCase();
    if (lower.includes('água') || lower.includes('agua')) return '🚰';
    if (lower.includes('café') || lower.includes('cafe')) return '☕';
    if (lower.includes('energy') || lower.includes('ener')) return '⚡';
    if (lower.includes('suco')) return '🧃';
    return '🥤';
  }

  function openInventoryModal(itemId = null) {
    inventoryFormMode = itemId ? 'edit' : 'add';
    inventoryEditingId = itemId;
    resetInventoryFields();
    const item = stockItems.find(i => i.id === itemId);
    const modal = document.getElementById('inventory-modal');
    const title = document.getElementById('inventory-modal-title');
    const kioskFlag = document.getElementById('inventory-kiosk-flag');
    const category = item?.categoria || item?.category || currentInventoryCategory;
    handleInventoryDestinationChange(category || 'esmaltes');
    if (title) title.textContent = item ? 'Editar item' : 'Adicionar item';
    if (kioskFlag) kioskFlag.value = item?.paused ? 'paused' : 'active';
    if (item && category === 'esmaltes') {
      document.getElementById('stock-polish-name').value = item.nome || '';
      document.getElementById('stock-polish-brand').value = item.marca || '';
      document.getElementById('stock-polish-total').value = item.volumeTotal_ml || '';
      document.getElementById('stock-polish-current').value = item.volumeAtual_ml || '';
      document.getElementById('stock-polish-cost').value = item.custoTotal || '';
      document.getElementById('stock-polish-consumption').value = item.consumoEstimadoPorUso || '';
      document.getElementById('stock-polish-date').value = item.dataCompra || '';
    }
    if (item && category === 'geladeira') {
      document.getElementById('stock-fridge-name').value = item.nome || '';
      document.getElementById('stock-fridge-qty').value = item.quantidade || '';
      document.getElementById('stock-fridge-cost').value = item.custoCompra || '';
      document.getElementById('stock-fridge-price').value = item.precoVenda || '';
      document.getElementById('stock-fridge-date').value = item.dataCompra || '';
    }
    if (item && category === 'manutencao') {
      document.getElementById('stock-maint-name').value = item.nome || '';
      document.getElementById('stock-maint-qty').value = item.quantidade || '';
      document.getElementById('stock-maint-cost').value = item.custoCompra || '';
      document.getElementById('stock-maint-date').value = item.dataCompra || '';
    }
    updatePolishForecast();
    ['stock-polish-current','stock-polish-consumption'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.oninput = updatePolishForecast;
    });
    if (modal) modal.classList.remove('hidden');
  }

  function renderInventoryTemplates() {
    const chips = document.getElementById('inventory-template-chips');
    const modalRow = document.getElementById('inventory-template-row');
    const filtered = productTemplates.filter(t => (t.categoria || t.category) === currentInventoryCategory);
    if (chips) {
      chips.innerHTML = '';
      if (!filtered.length) {
        chips.innerHTML = '<span class="subtext">Nenhum template salvo.</span>';
      } else {
        filtered.forEach(t => {
          const chip = document.createElement('div');
          chip.className = `template-chip ${currentInventoryCategory}`;
          chip.onclick = () => openTemplateManager(t.id);
          const icon = document.createElement('div');
          icon.className = 'icon';
          icon.textContent = currentInventoryCategory === 'geladeira' ? '🥤' : currentInventoryCategory === 'manutencao' ? '🧰' : '💅';
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.innerHTML = `<strong>${t.nome || t.name}</strong><span>${t.unidadesPorPack ? `${t.unidadesPorPack} por pack` : 'Template rápido'}</span>`;
          const quick = document.createElement('button');
          quick.className = 'secondary';
          quick.textContent = 'Usar';
          quick.style.padding = '0.35rem 0.6rem';
          quick.onclick = (ev) => { ev.stopPropagation(); applyInventoryTemplate(t.id); };
          chip.append(icon, meta, quick);
          chips.appendChild(chip);
        });
      }
    }
    if (modalRow) {
      modalRow.innerHTML = '';
      filtered.forEach(t => {
        const btn = document.createElement('div');
        btn.className = `template-chip ${currentInventoryCategory}`;
        btn.innerHTML = `<div class="icon">⭐</div><div class="meta"><strong>${t.nome || t.name}</strong><span>${t.unidadesPorPack ? t.unidadesPorPack + ' por pack' : 'Sugestão'}</span></div>`;
        btn.onclick = () => applyInventoryTemplate(t.id);
        modalRow.appendChild(btn);
      });
      if (!filtered.length) modalRow.innerHTML = '<span class="subtext">Nenhum produto recorrente.</span>';
    }
  }

  function buildStockHistoryInfo(itemId) {
    const list = stockHistories[itemId] || [];
    const lastEntry = list.find(h => h.tipo === 'entrada');
    const lastExit = list.find(h => h.tipo === 'saida' || h.tipo === 'baixa');
    return {
      lastEntry: lastEntry?.data || null,
      lastExit: lastExit?.data || null
    };
  }

  function attachStockHistoryListener(itemId) {
    if (!firestore || !itemId) return;
    firestore.collection('stock').doc(itemId).collection('history').orderBy('data', 'desc').limit(20).onSnapshot(snap => {
      stockHistories[itemId] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInventory();
    });
  }

  function renderInventory() {
    const target = getDashboardFilterTarget();
    const groups = {
      esmaltes: document.getElementById('inventory-polish-list'),
      geladeira: document.getElementById('inventory-fridge-list'),
      manutencao: document.getElementById('inventory-maintenance-list')
    };
    const metrics = {
      esmaltes: document.getElementById('inventory-polish-metrics'),
      geladeira: document.getElementById('inventory-fridge-metrics'),
      manutencao: document.getElementById('inventory-maintenance-metrics')
    };
    Object.entries(groups).forEach(([category, container]) => {
      if (!container) return;
      container.innerHTML = '';
      const scoped = stockItems.filter(i => (i.categoria || i.category) === category)
        .filter(i => selectedGlobalMonthKey === 'all' || matchesTargetMonth(i.dataCompra || i.addedAt, target));
      if (metrics[category]) {
        metrics[category].innerHTML = scoped.length ? `<span class="pill">${scoped.length} itens</span>` : '';
      }
      scoped.forEach(item => {
        const hist = buildStockHistoryInfo(item.id);
        const pct = item.volumeTotal_ml ? Math.round((item.volumeAtual_ml / item.volumeTotal_ml) * 100) : null;
        const badgeLow = item.previsaoDuracaoDias && item.previsaoDuracaoDias < 15;
        const warnFlag = item.previsaoDuracaoDias && item.previsaoDuracaoDias < 7;
        const lowFlag = badgeLow || (pct != null && pct < 30) || (item.quantidade && item.quantidade <= (item.unidadesPorPack || item.quantidade) * 0.2);
        const statusLabel = lowFlag ? 'Baixo' : warnFlag ? 'Expirando' : 'OK';
        const badgeClass = lowFlag ? 'low' : warnFlag ? 'warn' : '';
        const div = document.createElement('div');
        div.className = 'inventory-card';
        const entryLabel = hist.lastEntry ? formatDateLabel((hist.lastEntry || '').split('T')[0] || hist.lastEntry) : '—';
        const exitLabel = hist.lastExit ? formatDateLabel((hist.lastExit || '').split('T')[0] || hist.lastExit) : '—';
        const progress = pct != null ? `<div class="inventory-progress"><div class="fill" style="width:${Math.max(0, Math.min(100, pct))}%;${pct < 10 ? 'background:#d9534f;' : ''}"></div></div>` : '';
        const unitCost = category === 'geladeira' || category === 'manutencao'
          ? (item.custoCompra ? (item.custoCompra / Math.max(1, item.quantidade || 1)) : 0)
          : (item.custoPorUso || 0);
        const miniMeta = `
          <div class="inventory-mini-meta">
            <span>📦 ${category === 'esmaltes' ? `${item.volumeAtual_ml || 0} ml` : `${item.quantidade || 0} un.`}</span>
            <span>💰 Custo ${formatCurrency(unitCost)}</span>
            ${category === 'geladeira' ? `<span>🏷️ Venda ${formatCurrency(item.precoVenda || 0)}</span>` : ''}
            <span>📅 Entrada ${entryLabel}</span>
            ${category === 'esmaltes' ? `<span>⏳ Consumo ${item.consumoEstimadoPorUso || 0}ml</span>` : ''}
          </div>`;
        div.innerHTML = `
          <div class="line-top">
            <div class="title-stack">
              <div class="inventory-card-title">${item.nome || item.name || 'Item sem nome'}</div>
              <div class="inventory-meta">${category === 'esmaltes' ? (item.marca || 'Marca não informada') : (item.categoria || item.category)} ${item.dataCompra ? '• Comprado em ' + formatDateLabel(item.dataCompra) : ''}</div>
            </div>
            <span class="inventory-badge ${badgeClass}">${statusLabel}</span>
          </div>
          ${miniMeta}
          ${progress}
          <div class="history-row"><span>Última entrada: ${entryLabel}</span><span>Última saída: ${exitLabel}</span></div>
          <div class="inventory-foot">
            <div class="inventory-actions-icons">
              <button class="action-btn edit" title="Editar" aria-label="Editar" onclick="openInventoryModal('${item.id}')">✎</button>
              <button class="action-btn neutral" title="Detalhes" aria-label="Detalhes" onclick="openStockDetailModal('${item.id}')">👁</button>
              <button class="action-btn exit" title="Registrar saída" aria-label="Registrar saída" onclick="openStockExitModal('${item.id}')">➖</button>
              <button class="action-btn danger" title="Excluir" aria-label="Excluir" onclick="promptRemoveStockItem('${item.id}')">🗑</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      if (!scoped.length) container.innerHTML = '<div class="inventory-empty">Nenhum registro para exibir.</div>';
    });
    renderDashboardStockCard();
    syncKioskFromInventory();
  }

  async function saveStockHistory(itemId, entry) {
    if (!firestore || !itemId) return;
    await firestore.collection('stock').doc(itemId).collection('history').add({ ...entry, data: entry.data || new Date().toISOString(), usuario: currentUserDoc?.name || 'Administradora' });
  }

  async function submitInventoryForm() {
    initFirebaseApp();
    if (!firestore) return;
    const now = new Date().toISOString();
    const category = document.getElementById('inventory-category')?.value || currentInventoryCategory || 'esmaltes';
    const kioskFlag = document.getElementById('inventory-kiosk-flag')?.value || 'active';
    let payload = { categoria: category, updatedAt: now, paused: kioskFlag === 'paused' };
    if (category === 'esmaltes') {
      const nome = document.getElementById('stock-polish-name').value.trim();
      const marca = document.getElementById('stock-polish-brand').value.trim();
      const volumeTotal = parseFloat(document.getElementById('stock-polish-total').value) || 0;
      const volumeAtual = parseFloat(document.getElementById('stock-polish-current').value) || 0;
      const custoTotal = parseFloat(document.getElementById('stock-polish-cost').value) || 0;
      const consumo = parseFloat(document.getElementById('stock-polish-consumption').value) || 0;
      const dataCompra = document.getElementById('stock-polish-date').value;
      if (!nome || !marca || !volumeTotal) { alert('Preencha nome, marca e volume total.'); return; }
      const usesPerDay = 3;
      const previsao = consumo > 0 ? Math.round(volumeAtual / (consumo * usesPerDay)) : 0;
      const custoPorUso = volumeTotal ? ((custoTotal || 0) / volumeTotal) * (consumo || 0) : 0;
      payload = { ...payload, nome, marca, volumeTotal_ml: volumeTotal, volumeAtual_ml: volumeAtual, consumoEstimadoPorUso: consumo, dataCompra: dataCompra || null, previsaoDuracaoDias: previsao, custoTotal, custoPorUso, addedAt: payload.addedAt || now };
    } else if (category === 'geladeira') {
      const nome = document.getElementById('stock-fridge-name').value.trim();
      const quantidade = parseInt(document.getElementById('stock-fridge-qty').value, 10) || 0;
      const custoCompra = parseFloat(document.getElementById('stock-fridge-cost').value) || 0;
      const precoVenda = parseFloat(document.getElementById('stock-fridge-price').value) || 0;
      const dataCompra = document.getElementById('stock-fridge-date').value;
      if (!nome || !quantidade) { alert('Informe nome e quantidade.'); return; }
      payload = { ...payload, nome, quantidade, custoCompra, precoVenda, dataCompra: dataCompra || null, addedAt: payload.addedAt || now };
    } else {
      const nome = document.getElementById('stock-maint-name').value.trim();
      const quantidade = parseInt(document.getElementById('stock-maint-qty').value, 10) || 0;
      const custoCompra = parseFloat(document.getElementById('stock-maint-cost').value) || 0;
      const dataCompra = document.getElementById('stock-maint-date').value;
      if (!nome || !quantidade) { alert('Informe nome e quantidade.'); return; }
      payload = { ...payload, nome, quantidade, custoCompra, dataCompra: dataCompra || null, addedAt: payload.addedAt || now };
    }
    try {
      if (inventoryFormMode === 'edit' && inventoryEditingId) {
        await firestore.collection('stock').doc(inventoryEditingId).set(payload, { merge: true });
        await saveStockHistory(inventoryEditingId, { tipo: 'edicao', quantidade: payload.quantidade || payload.volumeAtual_ml || 0, volume: payload.volumeAtual_ml || null });
      } else {
        const ref = await firestore.collection('stock').add({ ...payload, createdAt: now });
        await saveStockHistory(ref.id, { tipo: 'entrada', quantidade: payload.quantidade || payload.volumeAtual_ml || 0, volume: payload.volumeAtual_ml || null });
      }
    } catch (err) {
      console.error('Erro ao salvar estoque', err);
    }
    closeInventoryModal();
  }

  async function toggleStockVisibility(itemId) {
    if (!firestore || !itemId) return;
    const item = stockItems.find(i => i.id === itemId);
    await firestore.collection('stock').doc(itemId).set({ paused: !item?.paused, updatedAt: new Date().toISOString() }, { merge: true });
  }

  async function removeStockItem(itemId) {
    if (!firestore || !itemId) return;
    await firestore.collection('stock').doc(itemId).delete();
  }

  function promptRemoveStockItem(itemId) {
    pendingRemoveStockId = itemId;
    openDialog('stock-remove-modal');
  }

  async function confirmRemoveStockItem() {
    if (!pendingRemoveStockId) return;
    await removeStockItem(pendingRemoveStockId);
    pendingRemoveStockId = null;
    closeDialog('stock-remove-modal');
  }

  function openStockDetailModal(itemId) {
    const item = stockItems.find(i => i.id === itemId);
    if (!item) return;
    const hist = buildStockHistoryInfo(itemId);
    document.getElementById('stock-detail-name').textContent = item.nome || item.name || 'Item';
    document.getElementById('stock-detail-cat').textContent = item.categoria || item.category || '—';
    document.getElementById('stock-detail-entry').textContent = hist.lastEntry ? formatDateLabel((hist.lastEntry || '').split('T')[0] || hist.lastEntry) : '—';
    document.getElementById('stock-detail-exit').textContent = hist.lastExit ? formatDateLabel((hist.lastExit || '').split('T')[0] || hist.lastExit) : '—';
    document.getElementById('stock-detail-forecast').textContent = item.previsaoDuracaoDias ? `${item.previsaoDuracaoDias} dias` : '—';
    document.getElementById('stock-detail-cost').textContent = item.custoPorUso ? formatCurrency(item.custoPorUso) : '—';
    openDialog('stock-detail-modal');
  }

  function openStockExitModal(itemId) {
    pendingExitStockId = itemId;
    const item = stockItems.find(i => i.id === itemId);
    const input = document.getElementById('stock-exit-qty');
    const nameEl = document.getElementById('stock-exit-name');
    if (nameEl) nameEl.textContent = item?.nome || item?.name || 'Item';
    if (input) input.value = item?.consumoEstimadoPorUso || 1;
    openDialog('stock-exit-modal');
  }

  async function confirmStockExit() {
    if (!pendingExitStockId || !firestore) return;
    const item = stockItems.find(i => i.id === pendingExitStockId);
    if (!item) return;
    const qty = parseFloat(document.getElementById('stock-exit-qty')?.value || '0');
    const now = new Date().toISOString();
    let payload = { updatedAt: now };
    if (item.categoria === 'esmaltes') {
      const remaining = Math.max(0, (item.volumeAtual_ml || 0) - qty);
      const usesPerDay = 3;
      const previsao = (item.consumoEstimadoPorUso || 0) > 0 ? Math.round(remaining / ((item.consumoEstimadoPorUso || 0) * usesPerDay)) : item.previsaoDuracaoDias || 0;
      payload = { volumeAtual_ml: remaining, previsaoDuracaoDias: previsao };
    } else {
      const remaining = Math.max(0, (item.quantidade || 0) - qty);
      payload = { quantidade: remaining };
    }
    await firestore.collection('stock').doc(pendingExitStockId).set(payload, { merge: true });
    await saveStockHistory(pendingExitStockId, { tipo: 'saida', quantidade: qty, volume: item.categoria === 'esmaltes' ? qty : null, data: now });
    closeDialog('stock-exit-modal');
    pendingExitStockId = null;
  }

  function openTemplateManager(id = null) {
    templateEditingId = id;
    const modal = document.getElementById('template-modal');
    const title = document.getElementById('template-modal-title');
    const tmpl = productTemplates.find(t => t.id === id);
    if (title) title.textContent = id ? 'Editar template' : 'Novo template';
    ['template-name','template-pack','template-volume','template-volume-pack','template-frequency'].forEach(fid => {
      const el = document.getElementById(fid);
      if (el) el.value = '';
    });
    const cat = document.getElementById('template-category');
    if (cat) cat.value = tmpl?.categoria || tmpl?.category || currentInventoryCategory;
    if (tmpl) {
      document.getElementById('template-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('template-pack').value = tmpl.unidadesPorPack || '';
      document.getElementById('template-volume').value = tmpl.volumeTotal || '';
      document.getElementById('template-volume-pack').value = tmpl.volumePorPack || '';
      document.getElementById('template-frequency').value = tmpl.frequenciaDeUso || '';
    }
    if (modal) modal.classList.remove('hidden');
  }

  async function saveTemplate() {
    initFirebaseApp();
    if (!firestore) return;
    const nome = document.getElementById('template-name').value.trim();
    const categoria = document.getElementById('template-category').value;
    if (!nome) { alert('Informe o nome do template.'); return; }
    const payload = {
      nome,
      categoria,
      unidadesPorPack: parseInt(document.getElementById('template-pack').value, 10) || null,
      volumeTotal: parseFloat(document.getElementById('template-volume').value) || null,
      volumePorPack: parseFloat(document.getElementById('template-volume-pack').value) || null,
      frequenciaDeUso: document.getElementById('template-frequency').value || ''
    };
    if (templateEditingId) {
      await firestore.collection('productTemplates').doc(templateEditingId).set(payload, { merge: true });
    } else {
      await firestore.collection('productTemplates').add(payload);
    }
    closeDialog('template-modal');
  }

  async function deleteTemplate(id) {
    if (!firestore || !id) return;
    await firestore.collection('productTemplates').doc(id).delete();
  }

  function renderCollaborators() {
    const container = document.getElementById('collaborators-list');
    if (!container) return;
    container.innerHTML = '';
    if (!collaborators.length) {
      container.innerHTML = '<div class="collab-meta">Nenhuma colaboradora cadastrada.</div>';
      return;
    }
    collaborators.forEach((col, index) => {
      const row = document.createElement('div');
      row.className = 'collab-row';
      const permLine = col.permissions ? col.permissions.split(',').map(p => p.trim()).slice(0, 2).join(' • ') : 'Ajuste no modal';
      row.innerHTML = `
        <div class="collab-id">
          <div class="collab-avatar" style="background:${col.color}">${col.name[0]}</div>
          <div class="collab-info">
            <strong>${col.name}</strong>
            <div class="collab-meta">${col.role} • ${col.commission}</div>
            <div class="collab-meta">${col.active ? 'Ativa' : 'Desativada'}</div>
          </div>
        </div>
        <div class="collab-permissions">
          <span class="collab-meta tagline">${permLine}</span>
          <span class="collab-meta">Login: <strong>${col.username || 'definir no modal'}</strong></span>
          <span class="collab-meta">Permissões detalhadas no modal</span>
        </div>
        <div class="collab-actions">
          <button class="ghost-btn secondary" onclick="openEditCollab(${index})" title="Editar">✏️</button>
          <button class="ghost-btn" onclick="openCommissionModal(${index})" title="Comissão">💰</button>
          <button class="ghost-btn secondary" onclick="openCollabStatusModal(${index})" title="Ativar/Desativar">🚫</button>
          <button class="ghost-btn secondary" onclick="openCollabStatusModal(${index}, true)" title="Remover">🗑</button>
          ${col.username ? `<button class="ghost-btn" onclick="openCollaboratorLogin('${col.username}')" title="Login dedicado">🔑</button>` : `<button class="ghost-btn" onclick="openDedicatedLoginModal('${col.name}')">🔑 Criar login</button>`}
        </div>
      `;
      container.appendChild(row);
    });
  }

  let investmentFilter = 'Todos';
  let investmentEditingId = null;

  function formatMonthSelectLabel(target) {
    if (!target) return '—';
    return `${String(target.monthIndex + 1).padStart(2, '0')}/${target.year}`;
  }

  function setInvestmentFilter(value) {
    investmentFilter = value;
    const ids = {
      Todos: 'invest-filter-all',
      Planejado: 'invest-filter-plan',
      'Em andamento': 'invest-filter-progress',
      Pago: 'invest-filter-paid'
    };
    Object.entries(ids).forEach(([status, btnId]) => {
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.toggle('active', value === status);
    });
    renderInvestments();
  }

  function getInvestmentFilterTarget() {
    if (selectedGlobalMonthKey && selectedGlobalMonthKey !== 'all') {
      const [year, month] = selectedGlobalMonthKey.split('-').map(v => parseInt(v, 10));
      if (Number.isNaN(year) || Number.isNaN(month)) return null;
      return { year, monthIndex: month - 1 };
    }
    return null;
  }

  function formatMonthRef(monthStr) {
    if (!monthStr) return '—';
    const [year, month] = monthStr.split('-');
    const idx = parseInt(month, 10) - 1;
    return `${monthNamesShort[idx] || month}/${year}`;
  }

  function parseMonthRef(monthStr) {
    if (!monthStr) return null;
    const [year, month] = monthStr.split('-').map(v => parseInt(v, 10));
    if (Number.isNaN(year) || Number.isNaN(month)) return null;
    return { year, monthIndex: month - 1 };
  }

  function formatMonthWithYear(target) {
    if (!target) return '—';
    return `${monthNamesFull[target.monthIndex]} ${target.year}`;
  }

  function initFirebaseApp() {
    if (firebaseApp || !window.firebase) return;
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firestore = firebase.firestore();
    firebaseAuth = firebase.auth();
  }

  function currentUserConfigDoc() {
    if (!firestore) return null;
    const userId = currentUserDoc?.id || 'anon';
    return firestore.collection('settings').doc('globalFilters').collection('users').doc(userId);
  }

  function monthKeyFromDate(dateStr) {
    if (!dateStr) return null;
    const dt = new Date(dateStr);
    if (Number.isNaN(dt.getTime())) return null;
    return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
  }

  function addMonthToMap(map, year, monthIndex) {
    if (year == null || monthIndex == null || Number.isNaN(year) || Number.isNaN(monthIndex)) return;
    let y = year;
    let m = monthIndex;
    while (m > 11) {
      m -= 12;
      y += 1;
    }
    while (m < 0) {
      m += 12;
      y -= 1;
    }
    const key = `${y}-${String(m + 1).padStart(2, '0')}`;
    if (!map.has(key)) map.set(key, { year: y, monthIndex: m });
  }

  function deriveMonthsFromInvestment(inv, map) {
    const ref = parseMonthRef(inv.mesReferencia);
    const total = inv.parcelasTotais || 1;
    if (ref) {
      if (inv.parcelado && total > 1) {
        for (let i = 0; i < total; i++) addMonthToMap(map, ref.year, ref.monthIndex + i);
      } else {
        addMonthToMap(map, ref.year, ref.monthIndex);
      }
    }
    if (inv.createdAt) {
      const key = monthKeyFromDate(inv.createdAt);
      if (key) {
        const [y, m] = key.split('-').map(v => parseInt(v, 10));
        addMonthToMap(map, y, m - 1);
      }
    }
  }

  async function buildGlobalMonthOptions() {
    const select = document.getElementById('global-month-filter');
    if (!select) return;
    initFirebaseApp();
    const map = new Map();

    investments.forEach(inv => deriveMonthsFromInvestment(inv, map));
    financialEntries.forEach(fin => {
      const key = monthKeyFromDate(fin.date);
      if (key) {
        const [y, m] = key.split('-').map(v => parseInt(v, 10));
        addMonthToMap(map, y, m - 1);
      }
    });
    stockItems.forEach(item => {
      const key = monthKeyFromDate(item.dataCompra || item.createdAt || item.addedAt);
      if (key) {
        const [y, m] = key.split('-').map(v => parseInt(v, 10));
        addMonthToMap(map, y, m - 1);
      }
    });

    if (firestore) {
      const snapInvest = await firestore.collection('investments').get().catch(() => null);
      snapInvest?.forEach(doc => deriveMonthsFromInvestment(doc.data() || {}, map));
      const snapFin = await firestore.collection('financial').get().catch(() => null);
      snapFin?.forEach(doc => {
        const key = monthKeyFromDate((doc.data() || {}).date);
        if (key) {
          const [y, m] = key.split('-').map(v => parseInt(v, 10));
          addMonthToMap(map, y, m - 1);
        }
      });
      const snapStock = await firestore.collection('stock').get().catch(() => null);
      snapStock?.forEach(doc => {
        const data = doc.data() || {};
        const key = monthKeyFromDate(data.dataCompra || data.createdAt || data.addedAt);
        if (key) {
          const [y, m] = key.split('-').map(v => parseInt(v, 10));
          addMonthToMap(map, y, m - 1);
        }
      });
    }

    const sorted = Array.from(map.entries()).sort((a, b) => (a[1].year - b[1].year) || (a[1].monthIndex - b[1].monthIndex));
    select.innerHTML = '<option value="all">Todos</option>' + sorted.map(([key, target]) => `<option value="${key}">${formatMonthSelectLabel(target)}</option>`).join('');
    select.value = selectedGlobalMonthKey;
    select.onchange = (e) => handleGlobalMonthSelect(e.target.value);
  }

  function handleGlobalMonthSelect(value) {
    selectedGlobalMonthKey = value || 'all';
    if (selectedGlobalMonthKey === 'all') {
      const now = new Date();
      selectedDashboardMonth = now.getMonth();
      selectedDashboardYear = now.getFullYear();
    } else {
      const [year, month] = selectedGlobalMonthKey.split('-').map(v => parseInt(v, 10));
      selectedDashboardMonth = month - 1;
      selectedDashboardYear = year;
    }
    persistGlobalMonth(selectedGlobalMonthKey);
    refreshMonthlyConsumers();
  }

  async function persistGlobalMonth(value) {
    selectedGlobalMonthKey = value || 'all';
    const docRef = currentUserConfigDoc();
    if (!docRef) return;
    await docRef.set({ value: selectedGlobalMonthKey, updatedAt: Date.now() }, { merge: true }).catch(() => {});
  }

  async function listenGlobalMonth() {
    initFirebaseApp();
    const docRef = currentUserConfigDoc();
    if (!docRef) return;
    if (globalMonthUnsub) globalMonthUnsub();
    globalMonthUnsub = docRef.onSnapshot(doc => {
      const data = doc.data() || {};
      selectedGlobalMonthKey = data.value || 'all';
      const target = getDashboardFilterTarget();
      selectedDashboardMonth = target.monthIndex;
      selectedDashboardYear = target.year;
      refreshMonthlyConsumers();
    });
  }

  function getDashboardFilterTarget() {
    if (selectedGlobalMonthKey && selectedGlobalMonthKey !== 'all') {
      const [year, month] = selectedGlobalMonthKey.split('-').map(v => parseInt(v, 10));
      return { year, monthIndex: month - 1 };
    }
    return { year: selectedDashboardYear, monthIndex: selectedDashboardMonth || 0 };
  }

  function monthsDiff(start, target) {
    if (!start || !target) return Infinity;
    return (target.year - start.year) * 12 + (target.monthIndex - start.monthIndex);
  }

  function matchesTargetMonth(dateStr, target) {
    if (!dateStr || !target) return false;
    const dt = new Date(dateStr);
    if (Number.isNaN(dt.getTime())) return false;
    return dt.getFullYear() === target.year && dt.getMonth() === target.monthIndex;
  }

  function isInvestmentActiveInMonth(inv, target) {
    const ref = parseMonthRef(inv.mesReferencia);
    if (!ref) return false;
    const diff = monthsDiff(ref, target);
    const total = inv.parcelasTotais || 1;
    if (inv.parcelado && total > 1) return diff >= 0 && diff < total;
    return diff === 0;
  }

  function getInvestmentMonthlyValue(inv) {
    const total = inv.valorTotal ?? inv.amount ?? 0;
    const parcels = inv.parcelasTotais || 1;
    if (inv.parcelado && parcels > 1) return inv.valorParcela || (total / parcels);
    return total;
  }

  function getInvestmentParcelLabel(inv, target) {
    const total = inv.parcelasTotais || 1;
    if (!inv.parcelado || total <= 1) return 'Única';
    const active = getActiveParcelNumber(inv, target);
    return `${active || '—'}/${total}`;
  }

  function getActiveParcelNumber(inv, target) {
    const ref = parseMonthRef(inv.mesReferencia);
    const total = inv.parcelasTotais || 1;
    if (!ref) return null;
    if (!inv.parcelado || total <= 1) return monthsDiff(ref, target) === 0 ? 1 : null;
    const diff = monthsDiff(ref, target);
    if (diff < 0) return null;
    if (diff >= total) return total;
    return diff + 1;
  }

  function recordInvestmentHistory(invId, action, description) {
    const entry = {
      timestamp: new Date().toISOString(),
      action,
      usuario: currentRole || 'ceo',
      descricao: description
    };
    if (!investmentHistoryStore[invId]) investmentHistoryStore[invId] = [];
    investmentHistoryStore[invId].push(entry);
    if (firestore) {
      firestore.collection('investments').doc(invId).collection('history').add(entry).catch(() => {});
    }
  }

  function syncInvestmentStatus(inv) {
    const total = inv.parcelasTotais || 1;
    const payments = inv.payments || [];
    const paidCount = payments.length;
    let status = inv.status || 'Planejado';
    if (paidCount >= total) status = 'Pago';
    else if (paidCount > 0) status = 'Em andamento';
    return { ...inv, status, parcelaAtual: Math.min(paidCount, total), payments };
  }

  function normalizeInvestments() {
    investments = investments.map(inv => {
      const created = inv.createdAt || new Date().toISOString();
      const history = inv.history && inv.history.length ? inv.history : [{ type: 'criado', date: created, detail: 'Investimento criado' }];
      const parcelado = inv.parcelado ?? ((inv.parcelasTotais || 1) > 1);
      const valorParcela = inv.valorParcela || (inv.valorTotal ? (inv.valorTotal / (inv.parcelasTotais || 1)) : 0);
      return syncInvestmentStatus({ ...inv, createdAt: created, history, parcelado, valorParcela, payments: inv.payments || [] });
    });
  }

  function investmentBadge(status) {
    const map = {
      Planejado: 'status-plan',
      'Em andamento': 'status-progress',
      Pago: 'status-paid'
    };
    return map[status] || '';
  }

  function openInvestmentModal(mode = 'add', id = null) {
    investmentEditingId = mode === 'edit' ? id : null;
    const modalTitle = document.getElementById('investment-modal-title');
    const saveBtn = document.getElementById('investment-modal-save');
    const inv = investments.find(i => i.id === id) || {};
    document.getElementById('investment-id').value = inv.id || '';
    document.getElementById('investment-title').value = inv.title || '';
    document.getElementById('investment-category').value = inv.category || inv.categoria || '';
    document.getElementById('investment-month').value = inv.mesReferencia || '';
    document.getElementById('investment-amount').value = inv.valorTotal || inv.amount || '';
    document.getElementById('investment-parceled').value = inv.parcelado ? 'sim' : 'nao';
    document.getElementById('investment-installments').value = inv.parcelasTotais || 1;
    document.getElementById('investment-installment-value').value = inv.valorParcela || '';
    document.getElementById('investment-status').value = inv.status || 'Planejado';
    document.getElementById('investment-notes').value = inv.observacoes || '';
    if (modalTitle) modalTitle.textContent = mode === 'edit' ? 'Editar investimento' : 'Adicionar investimento';
    if (saveBtn) saveBtn.textContent = mode === 'edit' ? 'Atualizar' : 'Salvar';
    toggleParcelFields();
    openDialog('investment-modal');
  }

  function toggleParcelFields() {
    const isParceled = document.getElementById('investment-parceled').value === 'sim';
    const installs = document.getElementById('investment-installments');
    const value = document.getElementById('investment-installment-value');
    [installs, value].forEach(el => {
      if (!el) return;
      el.disabled = !isParceled;
      el.classList.toggle('disabled', !isParceled);
    });
  }

  function saveInvestment() {
    const id = document.getElementById('investment-id').value || `inv-${Date.now()}`;
    const title = document.getElementById('investment-title').value.trim();
    const category = document.getElementById('investment-category').value.trim() || 'Geral';
    const mesReferencia = document.getElementById('investment-month').value;
    const valorTotal = parseFloat(document.getElementById('investment-amount').value) || 0;
    const parcelado = document.getElementById('investment-parceled').value === 'sim';
    const parcelasTotais = parcelado ? (parseInt(document.getElementById('investment-installments').value, 10) || 1) : 1;
    const valorParcelaInput = parseFloat(document.getElementById('investment-installment-value').value);
    const valorParcela = parcelado ? (valorParcelaInput || (valorTotal / parcelasTotais)) : valorTotal;
    const status = document.getElementById('investment-status').value || 'Planejado';
    const observacoes = document.getElementById('investment-notes').value || '';

    if (!title || !valorTotal) {
      alert('Preencha título e valor total');
      return;
    }

    const existing = investments.find(i => i.id === id);
    const now = new Date().toISOString();
    const payments = (existing?.payments || []).filter(p => p);
    const history = existing?.history ? [...existing.history] : [];

    const payload = {
      id,
      title,
      category,
      valorTotal,
      valorParcela,
      parcelasTotais,
      mesReferencia,
      parcelado,
      observacoes,
      status,
      createdAt: existing?.createdAt || now,
      updatedAt: now,
      lastPaymentAt: existing?.lastPaymentAt || null,
      payments,
      history
    };

    const merged = syncInvestmentStatus(payload);

    if (!existing) merged.history.push({ type: 'criado', date: now, detail: 'Investimento criado' });
    else merged.history.push({ type: 'edicao', date: now, detail: 'Investimento atualizado' });

    if (existing) {
      investments = investments.map(inv => inv.id === id ? merged : inv);
    } else {
      investments.push(merged);
    }

    closeDialog('investment-modal');
    renderInvestments();
    renderDashboardCards();
  }

  function renderInvestments() {
    const container = document.getElementById('investment-groups');
    if (!container) return;
    investments = investments.map(syncInvestmentStatus);
    container.innerHTML = '';

    const target = getInvestmentFilterTarget();
    const visibleByMonth = target ? investments.filter(inv => isInvestmentActiveInMonth(inv, target)) : investments;
    const filtered = investmentFilter === 'Todos' ? visibleByMonth : visibleByMonth.filter(inv => inv.status === investmentFilter);

    if (!filtered.length) {
      container.innerHTML = '<div class="subtext">Nenhum investimento para este filtro.</div>';
      return;
    }

    const sorted = filtered.slice().sort((a, b) => {
      const aRef = parseMonthRef(a.mesReferencia) || { year: 0, monthIndex: 0 };
      const bRef = parseMonthRef(b.mesReferencia) || { year: 0, monthIndex: 0 };
      return (aRef.year - bRef.year) || (aRef.monthIndex - bRef.monthIndex);
    });

    sorted.forEach(item => {
      const currentTarget = target || parseMonthRef(item.mesReferencia) || getDashboardFilterTarget();
      const parcelLabel = getInvestmentParcelLabel(item, currentTarget);
      const amountLabel = formatCurrency(getInvestmentMonthlyValue(item));
      const totalLabel = formatCurrency(item.valorTotal || item.amount || 0);
      const displayStatus = (() => {
        const activeParcel = getActiveParcelNumber(item, currentTarget);
        const total = item.parcelasTotais || 1;
        if (activeParcel && activeParcel >= total) return 'Pago';
        return item.status;
      })();
      const card = document.createElement('div');
      card.className = 'investment-card';
      card.dataset.id = item.id;
      card.innerHTML = `
        <div class="investment-card-head">
          <div class="investment-card-title">
            ${item.title}
            <span class="investment-tag">${item.category || item.categoria || 'Investimento'}</span>
            <span class="investment-tag">Ref.: ${formatMonthRef(item.mesReferencia)}</span>
          </div>
          <span class="investment-status ${investmentBadge(displayStatus)}">${displayStatus}</span>
        </div>
        <div class="investment-card-actions compact">
          <button class="action-btn neutral investment-toggle" onclick="toggleInvestmentDetails('${item.id}')">Ver detalhes</button>
        </div>
        <div class="investment-card-body">
          <div class="investment-card-left">
            <div class="investment-meta-line">
              <span>Parcela do mês: <strong>${parcelLabel}</strong></span>
              <span>Total: <strong>${totalLabel}</strong></span>
            </div>
            <div class="investment-meta-line">
              <span>Valor da parcela: <strong>${amountLabel}</strong></span>
              <span>Status: <strong>${item.status}</strong></span>
            </div>
            <div class="investment-note">${item.observacoes || 'Sem observações adicionais'}</div>
          </div>
          <div class="investment-card-actions">
              <div class="investment-actions">
                <button class="action-btn edit" title="Editar" onclick="openInvestmentModal('edit', '${item.id}')">✏️</button>
                <button class="action-btn exit" title="Marcar parcela paga" onclick="markInvestmentPaid('${item.id}')">✔️</button>
                <button class="action-btn danger" title="Remover" onclick="openInvestmentRemoveModal('${item.id}')">🗑</button>
              </div>
            </div>
          </div>
        `;
      container.appendChild(card);
    });
  }

    function getInvestmentActionTarget(inv = null) {
      const fallback = (() => {
        if (inv?.mesReferencia) return parseMonthRef(inv.mesReferencia);
        const now = new Date();
        return { year: now.getFullYear(), monthIndex: now.getMonth() };
      })();
      return getInvestmentFilterTarget() || getDashboardFilterTarget() || fallback;
    }

  function markInvestmentPaid(id) {
    const target = getInvestmentFilterTarget() || getDashboardFilterTarget();
    const nowISO = new Date().toISOString();
    let updatedInvestment = null;
    investments = investments.map(inv => {
      if (inv.id !== id) return inv;
      const total = inv.parcelasTotais || 1;
      const payments = inv.payments || [];
      const activeParcel = inv.parcelado && total > 1 ? getActiveParcelNumber(inv, target) || payments.length + 1 : 1;

      if (inv.parcelado && total > 1) {
        const duplicate = payments.some(p => p.year === target?.year && p.monthIndex === target?.monthIndex);
        if (duplicate) return inv;
        const updatedPayments = [...payments, { year: target?.year, monthIndex: target?.monthIndex, amount: inv.valorParcela || inv.valorTotal, date: nowISO }];
        const nextParcel = Math.min(activeParcel + 1, total);
        const status = nextParcel > total ? 'Pago' : nextParcel === total ? 'Em andamento' : 'Em andamento';
        const history = [...(inv.history || []), { type: 'pagamento', date: nowISO, detail: `Parcela ${activeParcel}/${total} paga em ${formatMonthWithYear(target)}` }];
        recordInvestmentHistory(inv.id, 'pagamento', `Parcela ${activeParcel}/${total} paga`);
        updatedInvestment = { ...inv, payments: updatedPayments, parcelaAtual: Math.min(updatedPayments.length, total), status: nextParcel > total ? 'Pago' : status, updatedAt: nowISO, lastPaymentAt: nowISO, history };
        return updatedInvestment;
      }

      recordInvestmentHistory(inv.id, 'pagamento', 'Investimento pago');
      updatedInvestment = { ...inv, status: 'Pago', updatedAt: nowISO, lastPaymentAt: nowISO, history: [...(inv.history || []), { type: 'pagamento', date: nowISO, detail: 'Pagamento único concluído' }] };
      return updatedInvestment;
    });
    if (firestore && updatedInvestment) {
      firestore.collection('investments').doc(updatedInvestment.id).set(updatedInvestment, { merge: true }).catch(() => {});
    }
    renderInvestments();
    renderDashboardCards();
  }

  function reopenInvestment(id) {
    const target = getInvestmentActionTarget();
    investments = investments.map(inv => {
      if (inv.id !== id) return inv;
      const payments = inv.payments || [];
      const now = new Date().toISOString();
      const updatedPayments = payments.filter(p => !(p.year === target.year && p.monthIndex === target.monthIndex));
      const history = [...(inv.history || []), { type: 'reaberto', date: now, detail: `Parcela reaberta para ${formatMonthWithYear(target)}` }];
      return syncInvestmentStatus({ ...inv, payments: updatedPayments, history, updatedAt: now, lastPaymentAt: updatedPayments.slice(-1)[0]?.date || null });
    });
    renderInvestments();
    renderDashboardCards();
  }

  function toggleInvestmentDetails(id) {
    const card = document.querySelector(`.investment-card[data-id="${id}"]`);
    if (!card) return;
    card.classList.toggle('expanded');
    const btn = card.querySelector('.investment-toggle');
    if (btn) btn.textContent = card.classList.contains('expanded') ? 'Ocultar detalhes' : 'Ver detalhes';
  }

  function openInvestmentHistory(id) {
    const inv = investments.find(i => i.id === id);
    const list = document.getElementById('investment-history-list');
    if (!inv || !list) return;
    list.innerHTML = '';
    const entries = (inv.history || []).slice().sort((a, b) => new Date(a.date) - new Date(b.date));
    if (!entries.length) {
      list.innerHTML = '<div class="subtext">Nenhum histórico registrado.</div>';
    } else {
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'investment-history-item';
        div.innerHTML = `
          <div>
            <strong>${entry.type || 'registro'}</strong>
            <div class="subtext">${entry.detail || ''}</div>
          </div>
          <span class="investment-chip">${formatDateLabel(entry.date?.split('T')[0] || '')}</span>
        `;
        list.appendChild(div);
      });
    }
    openDialog('investment-history-modal');
  }

  function openInvestmentRemoveModal(id) {
    investmentEditingId = id;
    const inv = investments.find(i => i.id === id);
    const text = document.getElementById('investment-remove-text');
    if (text) text.textContent = `Remover "${inv?.title || 'investimento'}"?`; 
    openDialog('investment-remove-modal');
  }

  async function confirmRemoveInvestment() {
    if (!investmentEditingId) return;
    const targetId = investmentEditingId;
    investments = investments.filter(inv => inv.id !== targetId);
    investmentEditingId = null;
    closeDialog('investment-remove-modal');
    if (firestore) {
      await firestore.collection('investments').doc(targetId).delete().catch(() => {});
    }
    renderInvestments();
    renderDashboardCards();
  }

  function renderServicesTable() {
    const tbody = document.getElementById('services-table');
    if (!tbody) return;
    tbody.innerHTML = '';
    kioskServices.forEach(service => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${service.name}</td>
        <td>${service.duration || '-'}</td>
        <td>${formatCurrency(service.price)}</td>
      `;
      tbody.appendChild(tr);
    });
    if (!kioskServices.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="3" class="subtext">Nenhum serviço cadastrado.</td>';
      tbody.appendChild(tr);
    }
  }

  function openServiceAddModal() {
    document.getElementById('add-service-name').value = '';
    document.getElementById('add-service-duration').value = '';
    document.getElementById('add-service-price').value = '';
    openDialog('service-add-modal');
  }

  function saveNewService() {
    const name = document.getElementById('add-service-name').value.trim();
    const duration = document.getElementById('add-service-duration').value.trim();
    const price = parseFloat(document.getElementById('add-service-price').value) || 0;
    if (!name || !duration || !price) {
      alert('Preencha nome, duração e preço do serviço.');
      return;
    }
    const id = `svc-${Date.now()}`;
    kioskServices.push({ id, name, duration, price, icon: '✨' });
    renderServicesTable();
    renderKiosk();
    closeDialog('service-add-modal');
  }

  function openServiceEditModal() {
    const select = document.getElementById('edit-service-select');
    select.innerHTML = '';
    if (!kioskServices.length) {
      select.innerHTML = '<option>Cadastre um serviço primeiro</option>';
      openDialog('service-edit-modal');
      return;
    }
    kioskServices.forEach(svc => {
      const opt = document.createElement('option');
      opt.value = svc.id;
      opt.textContent = svc.name;
      select.appendChild(opt);
    });
    currentEditingServiceId = kioskServices[0]?.id || null;
    select.value = currentEditingServiceId || '';
    prefillServiceFields();
    openDialog('service-edit-modal');
  }

  function prefillServiceFields() {
    const select = document.getElementById('edit-service-select');
    currentEditingServiceId = select.value;
    const svc = kioskServices.find(s => s.id === currentEditingServiceId);
    if (!svc) return;
    document.getElementById('edit-service-duration').value = svc.duration || '';
    document.getElementById('edit-service-price').value = svc.price || '';
  }

  function saveServiceEdit() {
    const svc = kioskServices.find(s => s.id === currentEditingServiceId);
    if (!svc) return;
    svc.duration = document.getElementById('edit-service-duration').value || svc.duration;
    svc.price = parseFloat(document.getElementById('edit-service-price').value) || svc.price;
    renderServicesTable();
    renderKiosk();
    closeDialog('service-edit-modal');
  }

  function syncKioskFromInventory() {
    const fridgeDrinks = stockItems
      .filter(item => (item.categoria || item.category) === 'geladeira' && !item.paused)
      .map(item => ({ id: item.id, name: item.nome || item.name, price: item.precoVenda || 0, icon: stockIconFor(item) }));
    const maintConsumables = stockItems
      .filter(item => (item.categoria || item.category) === 'manutencao' && !item.paused)
      .map(item => ({ id: item.id, name: item.nome || item.name, price: item.precoVenda || 0, icon: '🧾' }));
    kioskDrinks = fridgeDrinks.concat(maintConsumables);
    cart = cart.filter(entry => entry.type !== 'drink' || kioskDrinks.some(d => d.id === entry.id));
    renderKiosk();
  }

  // -----------------------------
  // KIOSK (CLIENTE) - CARRINHO
  // -----------------------------
  function renderKiosk() {
    const drinksEl = document.getElementById('kiosk-drinks');
    const servicesEl = document.getElementById('kiosk-services');
    if (drinksEl) {
      drinksEl.innerHTML = '';
      kioskDrinks.forEach(d => {
        const div = document.createElement('div');
        div.className = 'kiosk-card';
        div.innerHTML = `
          <div class="kiosk-icon">${d.icon || '🥤'}</div>
          <h3>${d.name}</h3>
          <div class="kiosk-price">R$ ${d.price}</div>
          <div class="kiosk-badge">Consumo imediato</div>
          <button style="margin-top:0.5rem;" onclick="addDrinkToCart('${d.id}')">Adicionar</button>
        `;
        drinksEl.appendChild(div);
      });
    }
    if (servicesEl) {
      servicesEl.innerHTML = '';
      kioskServices.forEach(s => {
        const div = document.createElement('div');
        div.className = 'kiosk-card';
        div.innerHTML = `
          <div class="kiosk-icon">${s.icon || '💅'}</div>
          <h3>${s.name}</h3>
          <div class="kiosk-price">R$ ${s.price}</div>
          <div class="kiosk-badge">Serviço principal</div>
          <button style="margin-top:0.5rem;" onclick="selectService('${s.id}')">Selecionar</button>
        `;
        servicesEl.appendChild(div);
      });
    }
    renderCart();
  }

  function addDrinkToCart(drinkId) {
    const drink = kioskDrinks.find(d => d.id === drinkId);
    if (!drink) return;
    cart.push({ type: 'drink', id: drink.id, name: drink.name, price: drink.price });
    renderCart();
  }

  function selectService(serviceId) {
    const service = kioskServices.find(s => s.id === serviceId);
    if (!service) return;
    // Remove serviços anteriores do carrinho
    cart = cart.filter(item => item.type !== 'service');
    cart.push({ type: 'service', id: service.id, name: service.name, price: service.price });
    renderCart();
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function clearCart() {
    cart = [];
    renderCart();
  }

  function calcTotalCart() {
    return cart.reduce((sum, item) => sum + item.price, 0);
  }

  function renderCart() {
    const listEl = document.getElementById('kiosk-cart-list');
    const totalEl = document.getElementById('kiosk-cart-total');
    if (!listEl || !totalEl) return;

    listEl.innerHTML = '';
    cart.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'kiosk-cart-item';
      const label = item.type === 'drink' ? 'Consumo' : 'Serviço';
      div.innerHTML = `
        <div>
          <strong>${item.name}</strong>
          <div class="subtext" style="margin-top:0.1rem;">${label}</div>
        </div>
        <div style="text-align:right;">
          <div>R$ ${item.price}</div>
          <button class="secondary" style="padding:0.15rem 0.5rem;font-size:0.7rem;margin-top:0.15rem;"
            onclick="removeFromCart(${index})">
            Remover
          </button>
        </div>
      `;
      listEl.appendChild(div);
    });

    totalEl.textContent = 'R$ ' + calcTotalCart().toFixed(2).replace('.', ',');
  }

  function sendOrder() {
    if (cart.length === 0) {
      alert('Adicione pelo menos um item ao carrinho.');
      return;
    }

    // TODO: aqui você envia o cart para o Firestore:
    // - criar documento em "orders" com items, horário, etc.
    // - atualizar estoque (via Cloud Function)
    // Exemplo (pseudo):
    // await addDoc(collection(db, "orders"), { items: cart, createdAt: serverTimestamp(), ... })

    alert('Pedido registrado! A profissional será avisada.');
    clearCart();
  }

  document.addEventListener('DOMContentLoaded', () => {
    normalizeButtons();
    buttonObserver.observe(document.body, { childList: true, subtree: true });
  });

  // Inicialização
  // (poderia detectar login real do Firebase aqui)
  normalizeAppointmentsData();
  normalizeInvestments();
  initFirebaseApp();
  buildGlobalMonthOptions();
  listenGlobalMonth();
  refreshAgendaFromAppointments();
  syncKioskFromInventory();

  document.addEventListener('DOMContentLoaded', attachAuthListener);
  refreshMonthlyConsumers();
  renderFinance();
</script>

</body>
</html>
