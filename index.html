<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Studio Nails - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --pastel-green: #E3F4E1;
      --pastel-green-dark: #AACFA3;
      --btn-primary: #9bbf92;
      --btn-primary-hover: #87ad80;
      --btn-secondary-bg: #ffffff;
      --btn-secondary-hover: #e9f6e5;
      --btn-neutral-bg: var(--gray-2);
      --btn-neutral-text: #3b3b3b;
      --btn-edit-bg: #a9c4e5;
      --btn-edit-hover: #96b4db;
      --btn-entry-bg: #e6f6e4;
      --btn-entry-text: #3f6a46;
      --btn-exit-bg: #f6e7d6;
      --btn-exit-text: #7a5a2c;
      --btn-danger-bg: #f7b7b7;
      --btn-danger-hover: #f39c9c;
      --pastel-beige: #FFF7F3;
      --pastel-peach: #FCE9DD;
      --text-dark: #2F2F2F;

      --pastel-rose: #F4D9D2;
      --pastel-blue: #E8EEF4;

      --wood-1: #EEDFCB;
      --wood-2: #E4D4BD;
      --wood-3: #D9C7AC;
      --wood-4: #CBB79A;
      --wood-5: #B7A06A;
      --wood-6: #9F8958;
      --wood-7: #897447;

      --gray-1: #F2F2F2;
      --gray-2: #EAEAEA;
      --gray-3: #DCDCDC;
      --gray-4: #CFCFCF;

      --bg-body: linear-gradient(180deg, #F6E4D6 0%, #E6EFE6 60%, #E8EEF4 100%);
      --bg-card: var(--pastel-peach);
      --bg-card-alt: var(--pastel-blue);
      --bg-sidebar: var(--wood-1);
      --accent-gold: var(--wood-5);
      --accent-gold-dark: var(--wood-6);
      --accent-gold-deep: var(--wood-7);
      --accent-gold-rgb: 183, 160, 106;
      --text-main: var(--text-dark);
      --text-muted: #6f5d4c;
      --border-soft: var(--gray-3);
      --danger: #d9534f;
      --chart-pink: #F4D9D2;
      --chart-gold: #B7A06A;
      --chart-green: #E6EFE6;

      --tab-polish: #f4d9d2;
      --tab-polish-text: #7a5a50;
      --tab-fridge: #e6efe6;
      --tab-fridge-text: #3f6a46;
      --tab-maint: #e8eef4;
      --tab-maint-text: #4b617f;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Sora', sans-serif;
    }

    body {
      background: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      font-family: 'Sora', sans-serif;
      overflow-x: hidden;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    button {
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.55rem 1.35rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 999px;
      background: var(--btn-primary);
      color: #fff;
      white-space: nowrap;
      transition: all 0.2s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .btn-primary,
    button:not(.secondary):not(.btn-secondary):not(.nav) {
      background: var(--btn-primary);
      color: #fff;
    }

    button:hover,
    .btn-primary:hover {
      background: var(--btn-primary-hover);
      color: #fff;
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }

    button.secondary,
    .btn-secondary {
      background: var(--btn-secondary-bg);
      border: 1px solid var(--btn-primary);
      color: var(--btn-primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    button.secondary:hover,
    .btn-secondary:hover {
      background: var(--btn-secondary-hover);
      color: var(--btn-primary-hover);
      transform: translateY(-1px) scale(1.01);
    }

    .segmented {
      display: inline-flex;
      background: rgba(var(--accent-gold-rgb), 0.1);
      border-radius: 999px;
      padding: 0.15rem;
      gap: 0.15rem;
    }

    .segmented button {
      background: transparent;
      color: var(--accent-gold-dark);
      box-shadow: none;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.85rem;
    }

    .segmented button.active {
      background: var(--bg-card);
      border-color: rgba(var(--accent-gold-rgb), 0.6);
      color: var(--text-main);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .segmented.compact button {
      padding: 0.3rem 0.65rem;
      font-size: 0.8rem;
    }

    .tag,
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--pastel-peach);
      color: var(--text-dark);
      white-space: nowrap;
    }

    .tag.attention,
    .badge.attention {
      background: #fecaca;
      color: #b91c1c;
    }

    /* FAB mobile */
    .fab-container {
      position: fixed;
      right: 1.1rem;
      bottom: calc(1.2rem + env(safe-area-inset-bottom, 0));
      z-index: 80;
      display: none;
      align-items: flex-end;
      gap: 0.6rem;
    }

    .fab-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.12);
      backdrop-filter: blur(2px);
      z-index: 70;
      display: none;
    }

    .fab-main {
      width: 58px;
      height: 58px;
      border-radius: 999px;
      background: linear-gradient(135deg, #d8b66a, #cbb79a);
      color: #fff;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    .fab-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.24);
    }

    .fab-hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(18px);
    }

    .fab-speed-dial {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-end;
      position: relative;
      transition: opacity 0.18s ease, transform 0.18s ease;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
    }

    .fab-speed-dial.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .fab-speed-btn {
      background: #fffaf3;
      border: 1px solid #d8b66a;
      color: #7a6030;
      padding: 0.55rem 0.9rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      white-space: nowrap;
      font-weight: 600;
      font-size: 0.9rem;
      min-width: 0;
    }

    .fab-speed-btn span {
      font-size: 1rem;
    }

    @media (max-width: 767px) {
      .fab-container {
        display: inline-flex;
        bottom: calc(20vh + env(safe-area-inset-bottom, 0)); /* move FAB ~30% above footer on mobile */
      }
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
    }

    .app-body {
      display: flex;
      flex: 1;
      min-height: 0;
      width: 100%;
    }

    .desktop-sidebar {
      width: 78px;
      background: linear-gradient(180deg, var(--bg-sidebar) 0%, var(--wood-3) 100%);
      border-right: 1px solid var(--border-soft);
      padding: 1rem 0.75rem;
      display: none;
      flex-direction: column;
      gap: 0.8rem;
      position: relative;
      transition: width 0.25s ease;
    }

    .desktop-sidebar.expanded {
      width: 250px;
    }

    .desktop-sidebar .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .sidebar-verse {
      font-size: 0.78rem;
      line-height: 1.25;
      color: var(--text-muted);
    }

    .desktop-sidebar .desktop-nav {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.25rem;
    }

    .desktop-toggle-btn {
      width: 100%;
      justify-content: flex-start;
      padding: 0.5rem 0.6rem;
      border-radius: 12px;
      background: rgba(var(--accent-gold-rgb), 0.15);
      color: var(--accent-gold-dark);
      box-shadow: none;
      border: 1px solid rgba(var(--accent-gold-rgb), 0.3);
      gap: 0.6rem;
    }

    .desktop-nav-btn {
      width: 100%;
      justify-content: flex-start;
      border-radius: 12px;
      padding: 0.55rem 0.65rem;
      font-size: 0.9rem;
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid transparent;
      gap: 0.55rem;
    }

    .desktop-nav-btn .nav-label {
      opacity: 0;
      width: 0;
      pointer-events: none;
      white-space: nowrap;
      transition: opacity 0.18s ease, width 0.18s ease;
    }

    .desktop-toggle-btn .nav-label {
      opacity: 0;
      width: 0;
      pointer-events: none;
      white-space: nowrap;
      transition: opacity 0.18s ease, width 0.18s ease;
    }

    .desktop-sidebar.expanded .desktop-nav-btn .nav-label,
    .desktop-sidebar.expanded .desktop-toggle-btn .nav-label {
      opacity: 1;
      width: auto;
      pointer-events: auto;
    }

    .desktop-sidebar:not(.expanded) .desktop-nav-btn,
    .desktop-sidebar:not(.expanded) .desktop-toggle-btn {
      justify-content: center;
    }

    .desktop-sidebar.expanded .desktop-nav-btn,
    .desktop-sidebar.expanded .desktop-toggle-btn {
      justify-content: flex-start;
    }

    .desktop-nav-btn .nav-icon,
    .desktop-toggle-btn .nav-icon {
      width: 20px;
      height: 20px;
      display: grid;
      place-items: center;
      color: var(--accent-gold-dark);
      flex-shrink: 0;
    }

    .desktop-nav-btn:hover {
      background: rgba(var(--accent-gold-rgb), 0.12);
    }

    .desktop-nav-btn.active {
      background: rgba(var(--accent-gold-rgb), 0.2);
      border-color: rgba(var(--accent-gold-rgb), 0.6);
      color: var(--accent-gold-dark);
    }

    .desktop-nav-btn.active .nav-icon {
      color: var(--accent-gold-dark);
    }

    .desktop-sidebar .sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0 0.2rem;
    }

    .desktop-sidebar:not(.expanded) .sidebar-header {
      justify-content: center;
    }

    .sidebar-header-text {
      display: flex;
      flex-direction: column;
      gap: 0.05rem;
    }

    .sidebar-role-label {
      display: none;
    }

    .desktop-sidebar:not(.expanded) .sidebar-header-text,
    .desktop-sidebar:not(.expanded) .sidebar-footer {
      display: none;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fffdf7, var(--accent-gold));
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      flex-shrink: 0;
    }

    .global-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      padding: 0.65rem 1rem;
      background: rgba(255,255,255,0.7);
      border-bottom: 1px solid rgba(0,0,0,0.04);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 45;
      flex-wrap: wrap;
    }

    .toolbar-filter {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.3rem 0.55rem;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.02);
    }

    .toolbar-filter label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin: 0;
      white-space: nowrap;
    }

    .toolbar-filter select {
      border: none;
      background: transparent;
      font-weight: 700;
      color: var(--text-main);
      outline: none;
      min-width: 120px;
    }

    .user-toolbar-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.7rem;
      border-radius: 12px;
      background: rgba(var(--accent-gold-rgb),0.16);
      color: var(--accent-gold-dark);
      font-weight: 700;
      border: 1px solid rgba(var(--accent-gold-rgb),0.3);
    }

    .user-avatar-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--accent-gold);
      color: #fff;
      font-weight: 800;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .user-dropdown {
      position: absolute;
      top: calc(100% + 0.35rem);
      right: 0;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      padding: 0.35rem;
      min-width: 140px;
      z-index: 60;
    }

    .user-dropdown.hidden {
      display: none;
    }

    .user-dropdown button {
      width: 100%;
      justify-content: flex-start;
      padding: 0.45rem 0.75rem;
      border-radius: 10px;
      background: #f8f8f8;
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .user-dropdown button:hover {
      background: rgba(var(--accent-gold-rgb),0.15);
    }

    .user-toolbar-chip .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: var(--accent-gold);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 800;
    }

    .user-toolbar-chip .logout-btn {
      padding: 0.25rem 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(var(--accent-gold-rgb),0.45);
      background: #fff;
      color: var(--accent-gold-dark);
      font-weight: 700;
      font-size: 0.8rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    }

    .mobile-toolbar {
      display: flex;
      width: 100%;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: nowrap;
      position: relative;
    }

    .mobile-toolbar .toolbar-filter {
      flex: 1 1 50%;
      min-width: 0;
    }

    .mobile-toolbar .toolbar-filter label {
      display: none;
    }

    .mobile-toolbar .toolbar-filter select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.9);
    }

    .mobile-toolbar .user-toolbar-chip {
      flex: 1 1 50%;
      justify-content: flex-end;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      position: relative;
    }

    .mobile-nav {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 0.8rem 1rem 0.4rem 1rem;
      background: linear-gradient(180deg, var(--bg-sidebar) 0%, var(--wood-3) 100%);
      border-bottom: 1px solid var(--border-soft);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .mobile-nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .mobile-login-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.65rem;
      border-radius: 999px;
      background: rgba(var(--accent-gold-rgb), 0.18);
      color: var(--accent-gold-dark);
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      white-space: nowrap;
    }

    .mobile-auth-actions {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .mobile-logout-btn {
      padding: 0.3rem 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(var(--accent-gold-rgb), 0.4);
      background: rgba(255,255,255,0.85);
      color: var(--accent-gold-dark);
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
    }

    .mobile-nav-toggle {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: rgba(var(--accent-gold-rgb), 0.15);
      color: var(--accent-gold-dark);
      box-shadow: none;
      border: 1px solid rgba(var(--accent-gold-rgb), 0.3);
    }

    .mobile-nav-menu {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.2s ease;
    }

    .mobile-nav-menu.open {
      max-height: 180px;
    }

    .mobile-nav-items {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      overflow-x: auto;
      padding: 0.45rem 0.1rem 0.3rem 0.1rem;
      scroll-behavior: smooth;
    }

    .mobile-nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(var(--accent-gold-rgb),0.35);
      color: var(--text-main);
      white-space: nowrap;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .mobile-nav-btn .nav-icon {
      display: grid;
      place-items: center;
      width: 18px;
      height: 18px;
      color: var(--accent-gold-dark);
    }

    .mobile-nav-btn.active {
      background: rgba(var(--accent-gold-rgb), 0.2);
      border-color: rgba(var(--accent-gold-rgb), 0.8);
      color: var(--accent-gold-dark);
    }

    /* Painel de comanda (profissional) */
    .comanda-panel {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      width: min(420px, 95vw);
      background: #fff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.14);
      padding: 0.9rem;
      z-index: 120;
      display: none;
      flex-direction: column;
      gap: 0.5rem;
    }

    .comanda-mini {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      z-index: 119;
      display: inline-flex;
    }

    .comanda-mini button {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      background: var(--accent-gold);
      color: #fff;
      border: none;
      box-shadow: 0 10px 24px rgba(0,0,0,0.2);
      font-weight: 700;
    }

    @media (max-width: 767px) {
      .comanda-panel {
        right: 0.5rem;
        left: 0.5rem;
        bottom: 5.5rem;
        width: auto;
      }
    }

    .comanda-panel header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .comanda-items {
      max-height: 240px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding: 0.2rem 0;
    }

    .comanda-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.6rem;
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: 10px;
      background: rgba(0,0,0,0.02);
      font-size: 0.9rem;
    }

    .comanda-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.4rem;
      align-items: end;
    }

    .agenda-table-wrapper {
      width: 100%;
    }

    .agenda-month-cards {
      display: none;
    }

    .comanda-form input,
    .comanda-form select {
      width: 100%;
      padding: 0.45rem 0.55rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
    }

    .content {
      flex: 1;
      padding: 1.5rem 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 0;
    }

    @media (max-width: 640px) {
      .table-action-row {
        flex-direction: column;
        width: 100%;
        align-items: stretch;
      }
      .table-action-row button {
        width: 100%;
        justify-content: center;
      }
      #agenda-month-summary td,
      #agenda-month-summary-colab td {
        display: block;
        width: 100%;
      }
      #agenda-month-summary tr,
      #agenda-month-summary-colab tr {
        display: block;
        padding: 0.35rem 0;
      }
      #agenda-month-summary td:last-child,
      #agenda-month-summary-colab td:last-child {
        margin-top: 0.25rem;
      }
      .agenda-table-wrapper {
        display: none;
      }
      .agenda-month-cards {
        display: flex;
        flex-direction: column;
        gap: 0.55rem;
        max-height: 520px;
        overflow-y: auto;
      }
    }

    @media (min-width: 1024px) {
      .desktop-sidebar {
        display: flex;
      }

      .mobile-nav {
        display: none !important;
      }

      .global-toolbar {
        display: flex;
      }
    }

    @media (max-width: 1023px) {
      .global-toolbar {
        display: none;
      }
    }

    .topbar {
      display: none;
    }

    .topbar h1 {
      font-size: 1.3rem;
    }

    .global-filter-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.8rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.06);
      flex-wrap: wrap;
    }

    .global-filter-bar .label {
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .global-filter-select {
      min-width: 180px;
      padding: 0.6rem 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-alt);
      color: var(--text-main);
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.04);
    }

    .global-filter-select:focus {
      outline: 1px solid rgba(var(--accent-gold-rgb),0.5);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 1rem 1.1rem;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.9);
    }

    .card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
      color: var(--accent-gold-deep);
    }

    .card .value {
      font-size: 1.3rem;
      font-weight: 600;
      margin-top: 0.1rem;
    }

    .subtext {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 0.75rem;
      background: rgba(255,255,255,0.8);
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .section-title h2 {
      font-size: 1rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.4rem;
      font-size: 0.85rem;
    }

    .table-action-row {
      display: flex;
      gap: 0.35rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .table th, .table td {
      text-align: left;
      padding: 0.5rem 0.4rem;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .table th {
      font-weight: 500;
      color: var(--text-muted);
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(0,0,0,0.04);
    }

    .badge.status-plan { background: rgba(var(--accent-gold-rgb), 0.1); color: var(--accent-gold-dark); }
    .badge.status-progress { background: rgba(46, 204, 113, 0.12); color: #1e824c; }
    .badge.status-paid { background: rgba(52, 152, 219, 0.12); color: #1f6fa5; }

    .investment-controls { display: flex; flex-direction: column; gap: 0.75rem; }
    .filter-line { display: flex; justify-content: space-between; align-items: center; gap: 0.8rem; flex-wrap: wrap; }
    .filter-label { font-weight: 600; color: var(--text-main); display: block; margin-top: 0.15rem; }
    .month-dropdown { padding: 0.45rem 0.6rem; border-radius: 10px; border: 1px solid var(--border-soft); background: #fffbf4; min-width: 160px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.04); }
    .control-actions { display: flex; justify-content: space-between; align-items: center; gap: 0.65rem; flex-wrap: wrap; }
    .investment-groups { display: flex; flex-direction: column; gap: 0.75rem; }
    .investment-card { border: 1px solid var(--border-soft); border-radius: 14px; padding: 0.9rem 1rem; background: linear-gradient(180deg,#fffefb,#ffffff); box-shadow: 0 8px 16px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 0.55rem; }
    .investment-card-head { display: flex; justify-content: space-between; gap: 0.6rem; align-items: flex-start; }
    .investment-card-title { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap; }
    .investment-tag { background: rgba(0,0,0,0.03); border-radius: 10px; padding: 0.15rem 0.55rem; font-size: 0.78rem; color: var(--text-muted); }
    .investment-status { padding: 0.25rem 0.6rem; border-radius: 999px; font-weight: 700; font-size: 0.78rem; }
    .status-plan { background: rgba(var(--accent-gold-rgb), 0.12); color: var(--accent-gold-deep); }
    .status-progress { background: rgba(46, 204, 113, 0.12); color: #1e824c; }
    .status-paid { background: rgba(52, 152, 219, 0.12); color: #1f6fa5; }
    .investment-meta-line { display: flex; flex-wrap: wrap; gap: 0.8rem; color: var(--text-muted); font-size: 0.9rem; align-items: center; }
    .investment-meta-line strong { color: var(--text-main); }
    .investment-card-actions { display: flex; gap: 0.35rem; flex-wrap: wrap; justify-content: flex-start; }
    .investment-card-actions.compact { justify-content: flex-start; padding: 0; }
    .investment-actions { display: inline-flex; gap: 0.3rem; flex-wrap: wrap; align-items: center; }
    .investment-actions button { height: 34px; }
    .investment-note { color: var(--text-muted); font-size: 0.86rem; }
    .investment-history-list { display: flex; flex-direction: column; gap: 0.45rem; margin-top: 0.6rem; }
    .investment-history-item { padding: 0.55rem 0.65rem; border-radius: 12px; background: var(--bg-card); border: 1px solid var(--border-soft); box-shadow: 0 4px 12px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .investment-history-item .subtext { margin: 0; }
    .investment-toggle { background: transparent; color: var(--text-main); font-weight: 700; box-shadow: none; padding: 0.25rem 0; }

    @media (min-width: 801px) {
      .investment-card { flex-direction: row; align-items: center; justify-content: space-between; }
      .investment-card-body { display: flex; flex: 1; align-items: center; gap: 1rem; flex-wrap: wrap; }
      .investment-card-actions { justify-content: flex-end; min-width: 260px; }
      .investment-card-left { display: flex; flex-direction: column; gap: 0.35rem; min-width: 260px; }
      .investment-card-actions.compact { display: none; }
    }

    @media (max-width: 800px) {
      .investment-card { gap: 0.35rem; }
      .investment-card-body { display: none; }
      .investment-card.expanded .investment-card-body { display: flex; flex-direction: column; gap: 0.3rem; align-items: flex-start; }
      .investment-card-actions { width: 100%; }
      .investment-card-actions:not(.compact) { display: none; }
      .investment-card.expanded .investment-card-actions:not(.compact) { display: flex; }
    }

    .calendar-year {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.9rem;
      margin-top: 0.5rem;
    }

    .month-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 0.7rem 0.8rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.9);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.2s ease;
    }

    .month-card.active {
      border-color: rgba(var(--accent-gold-rgb), 0.6);
      box-shadow: 0 4px 16px rgba(var(--accent-gold-rgb), 0.12);
    }

    .month-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.2rem;
    }

    .month-name {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .month-stat {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .month-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      overflow: hidden;
      margin-top: 0.3rem;
    }

    .month-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--wood-2), var(--accent-gold));
      width: 40%;
    }

      .mini-calendar {
        margin-top: 0.5rem;
        border: 1px dashed rgba(0,0,0,0.06);
        border-radius: 12px;
        padding: 0.5rem;
        background: rgba(255,255,255,0.6);
      }

    @media (max-width: 768px) {
      .kiosk-icon-btn { display: none; }
    }

    .full-month-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.35rem;
      margin-top: 0.65rem;
      background: var(--bg-card-alt);
      padding: 0.75rem;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 14px rgba(0,0,0,0.05);
    }

    .full-month-calendar .weekday {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
    }

    .full-month-calendar .month-day {
      height: 80px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(180deg, var(--bg-card) 0%, #fff 100%);
      padding: 0.4rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 0.9rem;
      position: relative;
    }

    .full-month-calendar .month-day.has-booking {
      box-shadow: 0 0 0 2px rgba(var(--accent-gold-rgb), 0.35);
    }

    .full-month-calendar .month-day .day-number {
      font-weight: 600;
    }

    .full-month-calendar .month-day .day-badge {
      align-self: flex-start;
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      background: rgba(var(--accent-gold-rgb), 0.12);
      color: var(--accent-gold-dark);
    }

    /* Agenda do dia (timeline) */
    .day-agenda-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 130;
      padding: 1rem;
    }

    .day-agenda-overlay.open {
      display: flex;
    }

    .day-agenda {
      background: #fff;
      width: min(1100px, 100%);
      max-width: 100%;
      max-height: 92vh;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 18px 44px rgba(0,0,0,0.18);
    }

    .day-agenda-header {
      padding: 0.9rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      background: linear-gradient(90deg, rgba(var(--accent-gold-rgb),0.12), #fff);
      flex-wrap: wrap;
    }

    .day-agenda-body {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 0.6rem;
      padding: 0.75rem 1rem 1rem;
      overflow: hidden;
      min-height: 60vh;
    }

    .day-hours {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.85rem;
      max-height: 70vh;
      overflow-y: auto;
    }

    .day-hour {
      height: 72px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding-top: 0.1rem;
    }

    .day-slots {
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: 75vh;
      padding-right: 0.3rem;
      background: rgba(0,0,0,0.02);
      border: 1px solid rgba(0,0,0,0.03);
      border-radius: 14px;
    }

    .day-slot {
      position: relative;
      height: 72px;
      border-bottom: 1px dashed rgba(0,0,0,0.06);
      padding: 0.25rem;
      transition: background 0.12s ease, border-color 0.12s ease;
    }

    .day-slot:last-child {
      border-bottom: none;
    }

    .day-slot.hover {
      background: rgba(var(--accent-gold-rgb),0.08);
      border-color: rgba(var(--accent-gold-rgb),0.3);
    }

    .day-slot-empty {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .appt-card {
      position: absolute;
      left: 0.4rem;
      right: 0.4rem;
      min-height: 46px;
      padding: 0.55rem 0.65rem;
      border-radius: 12px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      cursor: grab;
      touch-action: none;
      user-select: none;
    }

    .appt-card.dragging {
      opacity: 0.7;
      pointer-events: none;
    }

    .appt-card .title {
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      gap: 0.35rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .appt-card .meta {
      color: var(--text-muted);
      font-size: 0.85rem;
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
    }

    .appt-card .badge {
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(var(--accent-gold-rgb),0.15);
      color: var(--accent-gold-dark);
    }

    .appt-card.finalizado {
      background: #f8fafc;
      border-style: dashed;
      opacity: 0.7;
      cursor: not-allowed;
    }

    .day-agenda-foot {
      padding: 0.8rem 1rem;
      border-top: 1px solid rgba(0,0,0,0.06);
      display: flex;
      justify-content: flex-end;
    }

    @media (max-width: 900px) {
      .day-agenda-body {
        grid-template-columns: 64px 1fr;
      }
      .day-hour { height: 68px; font-size: 0.8rem; }
      .day-slot { height: 68px; }
      .appt-card { left: 0.2rem; right: 0.2rem; }
    }

    @media (max-width: 640px) {
      .day-agenda {
        width: 100%;
        height: 90vh;
        max-width: 100%;
      }
      .day-agenda-body {
        grid-template-columns: 58px 1fr;
        padding: 0.6rem;
      }
      .appt-card {
        width: 100%;
      }
    }

    .mini-weekdays,
    .mini-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.25rem;
      font-size: 0.7rem;
      text-align: center;
    }

    .mini-weekdays span {
      color: var(--text-muted);
      font-weight: 600;
    }

    .mini-day {
      padding: 0.35rem 0;
      border-radius: 10px;
      background: rgba(0,0,0,0.02);
      position: relative;
    }

    .mini-day.empty {
      background: transparent;
    }

    .mini-day.has-booking {
      border: 1px solid rgba(var(--accent-gold-rgb), 0.8);
      background: rgba(var(--accent-gold-rgb), 0.08);
      font-weight: 700;
      color: var(--accent-gold-dark);
      box-shadow: 0 0 0 2px rgba(var(--accent-gold-rgb), 0.15) inset;
    }

    .mini-day .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--appt-color, var(--accent-gold));
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
    }

    .month-footnote {
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .inventory-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      margin-bottom: 0.65rem;
      flex-wrap: wrap;
    }

    .inventory-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      width: 100%;
      margin-top: 0.25rem;
    }

    .inventory-actions button {
      padding: 0.4rem 1rem;
      font-size: 0.92rem;
    }

    .inventory-tabs {
      display: inline-flex;
      background: rgba(var(--accent-gold-rgb), 0.12);
      border-radius: 14px;
      padding: 0.2rem;
      gap: 0.2rem;
    }

    .inventory-tab {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 0.45rem 1rem;
      font-weight: 700;
      box-shadow: none;
      transition: all 0.18s ease;
    }

    .inventory-tab:hover {
      background: rgba(var(--accent-gold-rgb), 0.1);
    }

    .inventory-tab.active {
      color: var(--text-main);
      border-color: rgba(var(--accent-gold-rgb), 0.5);
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    }

    #inventory-tab-btn-polish {
      background: rgba(244, 217, 210, 0.4);
      color: var(--tab-polish-text);
    }

    #inventory-tab-btn-fridge {
      background: rgba(230, 239, 230, 0.45);
      color: var(--tab-fridge-text);
    }

    #inventory-tab-btn-maint {
      background: rgba(232, 238, 244, 0.5);
      color: var(--tab-maint-text);
    }

    #inventory-tab-btn-polish.active {
      background: rgba(244, 217, 210, 0.9);
      border-color: rgba(122, 90, 80, 0.45);
      box-shadow: 0 6px 14px rgba(122, 90, 80, 0.16);
    }

    #inventory-tab-btn-fridge.active {
      background: rgba(230, 239, 230, 0.95);
      border-color: rgba(63, 106, 70, 0.35);
      box-shadow: 0 6px 14px rgba(63, 106, 70, 0.14);
    }

    #inventory-tab-btn-maint.active {
      background: rgba(232, 238, 244, 0.95);
      border-color: rgba(75, 97, 127, 0.35);
      box-shadow: 0 6px 14px rgba(75, 97, 127, 0.14);
    }

    .inventory-list {
      margin-top: 0.6rem;
      display: grid;
      grid-template-columns: repeat(1, minmax(260px, 1fr));
      gap: 0.9rem;
    }

    @media (min-width: 900px) {
      .inventory-list { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    }

    @media (min-width: 1200px) {
      .inventory-list { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }

    .inventory-card {
      position: relative;
      background: var(--bg-card);
      border-radius: 14px;
      padding: 0.95rem 1rem 0.85rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.07);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      min-height: 140px;
    }

    .inventory-card .line-top {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .inventory-card .title-stack {
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
    }

    .inventory-badge {
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(var(--accent-gold-rgb), 0.08);
      color: var(--accent-gold-dark);
      border: 1px solid rgba(var(--accent-gold-rgb), 0.18);
    }

    .inventory-badge.low {
      background: rgba(217, 83, 79, 0.08);
      color: var(--danger);
      border-color: rgba(217, 83, 79, 0.2);
    }

    .inventory-badge.warn {
      background: rgba(255, 193, 7, 0.16);
      color: #8a5b00;
      border-color: rgba(255, 193, 7, 0.25);
    }

    .inventory-card-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: var(--text-main);
    }

    .inventory-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-top: 0.1rem;
    }

    .inventory-mini-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.4rem;
      font-size: 0.84rem;
      color: var(--text-muted);
    }

    .inventory-mini-meta span {
      display: inline-flex;
      align-items: center;
      gap: 0.32rem;
      padding: 0.35rem 0.5rem;
      background: rgba(0,0,0,0.02);
      border-radius: 10px;
      border: 1px solid var(--border-soft);
    }

    .inventory-progress {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      overflow: hidden;
    }

    .inventory-progress .fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--wood-2), var(--accent-gold));
      width: 70%;
    }

    .inventory-foot {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .inventory-actions-icons {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .inventory-actions-icons button {
      width: 36px;
      height: 32px;
      min-width: 32px;
      padding: 0.3rem;
      border-radius: 10px;
      background: var(--bg-soft);
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid var(--border-soft);
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0;
    }

    .inventory-tabpanel {
      margin-top: 0.4rem;
    }

    .inventory-empty {
      padding: 0.8rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .inventory-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 120;
    }

    .inventory-modal .card {
      max-width: 760px;
      width: 100%;
      padding: 1.25rem 1.35rem;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      overflow-y: auto;
      gap: 0.8rem;
    }

    .inventory-modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.4rem;
      border-top: 1px solid var(--border-soft);
      padding-top: 0.6rem;
    }

    .inventory-modal .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem 0.9rem;
      margin-top: 0.35rem;
    }

    .inventory-modal input,
    .inventory-modal select,
    .inventory-modal textarea {
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.9);
    }

    .modal-section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-main);
      margin-top: 0.1rem;
    }

    .modal-section {
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      background: var(--bg-soft);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .inventory-templates {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 14px;
      padding: 0.85rem 1rem;
      margin: 0.6rem 0 0.9rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-height: 220px;
      overflow: hidden;
    }

    .inventory-templates .pill-row {
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.35rem;
    }

    .template-chip-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.45rem;
      max-height: 8.5rem;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    @media (min-width: 768px) {
      .template-chip-row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (min-width: 1024px) {
      .template-chip-row {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
    }

    .template-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.55rem 0.65rem;
      border-radius: 12px;
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    .template-chip.esmaltes { border-color: rgba(122, 90, 80, 0.2); background: rgba(244, 217, 210, 0.35); }
    .template-chip.geladeira { border-color: rgba(63, 106, 70, 0.16); background: rgba(230, 239, 230, 0.4); }
    .template-chip.manutencao { border-color: rgba(75, 97, 127, 0.16); background: rgba(232, 238, 244, 0.45); }

    .template-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }

    .template-chip .icon {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: rgba(var(--accent-gold-rgb), 0.12);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      color: var(--accent-gold-dark);
    }

    .template-chip .meta {
      display: flex;
      flex-direction: column;
      gap: 0.08rem;
      font-size: 0.85rem;
      color: var(--text-main);
    }

    .template-chip .meta span {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      .inventory-list {
        grid-template-columns: 1fr;
      }
      .inventory-actions {
        justify-content: flex-start;
      }
      .inventory-actions button {
        padding: 0.38rem 0.85rem;
      }
      .inventory-card {
        padding: 0.85rem 0.9rem;
      }
      .inventory-actions-icons {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
    }

    .inventory-card .meta-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.3rem;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .inventory-card .history-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .inventory-card .pill-row {
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .chart-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
      margin-top: 0.4rem;
    }

    .chart-card canvas {
      width: 100%;
      max-width: 320px;
      height: 200px;
    }

    .stock-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.65rem;
      margin: 0.35rem 0 0.5rem;
    }

    .summary-chip {
      background: var(--bg-soft);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      color: var(--text-main);
      box-shadow: 0 6px 14px rgba(0,0,0,0.05);
    }

    .summary-chip span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    button.danger {
      background: rgba(217,83,79,0.1);
      color: var(--danger);
      border-color: rgba(217,83,79,0.35);
    }

    .dialog-layer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
    }

    .dialog-layer.hidden {
      display: none !important;
    }

    .dialog-card {
      background: var(--pastel-beige);
      border-radius: 16px;
      box-shadow: 0 14px 38px rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.9);
      padding: 1.05rem 1.2rem;
      max-width: 540px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      max-height: 90vh;
      overflow-y: auto;
    }

    .dialog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 0.6rem;
    }

    .dialog-card label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .dialog-card input,
    .dialog-card select,
    .dialog-card textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.95);
    }

    .dialog-card textarea {
      min-height: 60px;
      resize: vertical;
    }

    .dialog-card .disabled {
      opacity: 0.6;
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.2rem;
    }

    .section-caption {
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .settings-block {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1rem 1.1rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .block-header h3 {
      margin-bottom: 0.25rem;
    }

    .block-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .collab-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      border: 1px solid rgba(0,0,0,0.03);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,250,243,0.9));
    }

    .collab-row {
      display: grid;
      grid-template-columns: 1.3fr 1.6fr 1fr;
      gap: 0.8rem;
      padding: 0.7rem 0.9rem;
      align-items: center;
    }

    .collab-row + .collab-row {
      border-top: 1px solid var(--border-soft);
    }

    .collab-id {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      min-width: 0;
    }

    .collab-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      background: linear-gradient(135deg, var(--wood-2), var(--accent-gold-dark));
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      flex-shrink: 0;
    }

    .collab-info strong {
      font-size: 0.95rem;
    }

    .collab-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .collab-meta .tagline {
      color: var(--text-main);
      font-weight: 500;
    }

    .collab-permissions {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      color: var(--text-muted);
      font-size: 0.82rem;
    }

    .collab-actions {
      display: flex;
      gap: 0.3rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .ghost-btn {
      border-radius: 10px;
      padding: 0.35rem 0.55rem;
      background: rgba(var(--accent-gold-rgb),0.08);
      color: var(--text-main);
      box-shadow: none;
      border: 1px solid rgba(var(--accent-gold-rgb),0.18);
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      height: 32px;
    }

    .ghost-btn.secondary {
      background: rgba(0,0,0,0.02);
      border-color: rgba(0,0,0,0.06);
      color: var(--text-muted);
    }

    .ghost-btn:hover {
      transform: translateY(-1px);
      background: rgba(var(--accent-gold-rgb),0.14);
    }

    .ghost-btn.secondary:hover {
      background: rgba(0,0,0,0.05);
    }

    .action-btn {
      padding: 0.3rem 0.65rem;
      height: 30px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      border: 1px solid transparent;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      white-space: nowrap;
      background: var(--btn-neutral-bg) !important;
      color: var(--btn-neutral-text) !important;
    }

    .action-btn.neutral {
      background: var(--btn-neutral-bg) !important;
      color: var(--btn-neutral-text) !important;
      border-color: rgba(0,0,0,0.06);
    }

    .action-btn.edit {
      background: var(--btn-edit-bg) !important;
      color: #fff !important;
      border-color: rgba(0,0,0,0.05);
    }

    .action-btn.entry {
      background: var(--btn-entry-bg) !important;
      color: var(--btn-entry-text) !important;
      border-color: rgba(63,106,70,0.25);
    }

    .action-btn.exit {
      background: var(--btn-exit-bg) !important;
      color: var(--btn-exit-text) !important;
      border-color: rgba(122,90,44,0.18);
    }

    .action-btn.danger {
      background: var(--btn-danger-bg) !important;
      color: #fff !important;
      border-color: rgba(0,0,0,0.05);
    }

    .action-btn:hover {
      transform: translateY(-1px);
    }

    .action-btn.edit:hover { background: var(--btn-edit-hover) !important; }
    .action-btn.entry:hover { filter: brightness(0.98); }
    .action-btn.exit:hover { filter: brightness(0.98); }
    .action-btn.danger:hover { background: var(--btn-danger-hover) !important; }

    .clients-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .clients-actions {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .clients-search {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.55rem;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.92);
      min-width: 240px;
    }

    .clients-search input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .clients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
      margin-top: 0.4rem;
    }

    .client-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 0.85rem 0.95rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      position: relative;
    }

    .client-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .client-meta {
      color: var(--text-muted);
      font-size: 0.88rem;
      line-height: 1.3;
    }

    .client-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.35rem;
    }

    .client-actions .secondary {
      padding: 0.35rem 0.7rem;
      font-size: 0.8rem;
      border-radius: 10px;
    }

    .client-actions .icon-mini {
      padding: 0.3rem 0.6rem;
      font-size: 0.78rem;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }

    .client-pill {
      background: rgba(var(--accent-gold-rgb),0.12);
      color: var(--text-main);
      border-radius: 10px;
      padding: 0.2rem 0.55rem;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      width: fit-content;
    }

    .client-card a {
      color: var(--accent-gold-dark);
      text-decoration: none;
      font-weight: 600;
    }

    .client-card a:hover {
      text-decoration: underline;
    }

    .agenda-appointments {
      margin-top: 0.8rem;
      display: grid;
      gap: 0.6rem;
    }

    /* Carto compacto para lista mensal no mobile */
    .agenda-card-mobile {
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 12px;
      padding: 0.65rem 0.75rem;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: 0.5rem;
    }

    .agenda-card-mobile .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.45rem;
      font-size: 0.9rem;
      align-items: flex-start;
    }

    .agenda-card-mobile .row .pill {
      margin: 0;
    }

    .agenda-card-mobile .actions {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      width: 100%;
    }

    .agenda-card-mobile .actions button {
      flex: 1 1 120px;
      justify-content: center;
    }

    .appointment-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 0.85rem 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem 1rem;
      align-items: center;
      position: relative;
    }

    .appointment-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      bottom: 12px;
      width: 5px;
      border-radius: 12px;
      background: var(--accent-gold);
      opacity: 0.9;
    }

    .appointment-meta {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .appointment-title {
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .appointment-subtext {
      color: var(--text-muted);
      font-size: 0.88rem;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .appointment-actions {
      display: flex;
      gap: 0.35rem;
      align-items: center;
      justify-content: flex-end;
    }

    .appointment-pill {
      background: rgba(0,0,0,0.03);
      color: var(--text-main);
      padding: 0.2rem 0.55rem;
      border-radius: 10px;
      font-size: 0.82rem;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .client-detail-tabs {
      display: inline-flex;
      gap: 0.3rem;
      background: rgba(var(--accent-gold-rgb),0.1);
      padding: 0.2rem;
      border-radius: 12px;
      margin: 0.4rem 0;
    }

    .client-detail-tabs button {
      background: transparent;
      color: var(--text-main);
      box-shadow: none;
      border-radius: 10px;
      padding: 0.35rem 0.7rem;
      font-size: 0.85rem;
      border: 1px solid transparent;
    }

    .client-detail-tabs button.active {
      background: var(--bg-card);
      border-color: rgba(var(--accent-gold-rgb),0.5);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .client-detail-section {
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      margin-top: 0.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .client-detail-section h4 {
      margin: 0;
      font-size: 0.95rem;
    }

    .client-detail-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .badge-soft {
      display: inline-flex;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.04);
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .inline-actions {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .kiosk-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 1.25rem 1.5rem 1.5rem;
      background: radial-gradient(circle at 10% 20%, #fff7e6, #f0e7d8);
      border-radius: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }

    .kiosk-grid {
      display: grid;
      grid-template-columns: 1.8fr 1.1fr;
      gap: 1.1rem;
      margin-top: 1rem;
    }

    .kiosk-pairing {
      background: #fff;
      border: 1px dashed var(--border-soft);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 22px rgba(0,0,0,0.08);
    }

    .kiosk-pairing-row {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      margin-top: 0.6rem;
    }

    .kiosk-pairing-row input {
      flex: 1;
      padding: 0.55rem 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .kiosk-section-title {
      font-size: 1rem;
      margin-bottom: 0.3rem;
    }

    .kiosk-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.7rem;
    }

    .kiosk-card {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 0.85rem 0.9rem;
      text-align: left;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
      position: relative;
      overflow: hidden;
    }

    .kiosk-card h3 {
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .kiosk-price {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.35rem;
    }

    .kiosk-icon {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-size: 1.3rem;
      background: radial-gradient(circle at 30% 30%, #fff3d4, #f1d9a0);
      margin-bottom: 0.35rem;
    }

    .kiosk-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .kiosk-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.09), transparent 50%);
      pointer-events: none;
    }

    .kiosk-cart {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 1rem 1.1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      max-height: 520px;
    }

    .kiosk-cart-list {
      flex: 1;
      overflow-y: auto;
      margin-top: 0.3rem;
    }

    .kiosk-cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.45rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.03);
      font-size: 0.85rem;
    }

    .kiosk-cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      font-weight: 600;
    }

    .kiosk-hero {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .kiosk-steps {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.35rem;
    }

    .kiosk-pill {
      background: rgba(0,0,0,0.04);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .login-mode-toggle {
      display: flex;
      gap: 0.4rem;
      margin: 0.6rem 0;
      flex-wrap: wrap;
    }

    .login-tab {
      border-radius: 14px;
      padding: 0.5rem 0.9rem;
      background: rgba(0,0,0,0.03);
      border: 1px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
    }

    .login-tab.active {
      background: rgba(var(--accent-gold-rgb), 0.15);
      color: var(--accent-gold-dark);
      border-color: rgba(var(--accent-gold-rgb), 0.5);
      box-shadow: 0 2px 10px rgba(var(--accent-gold-rgb), 0.15);
    }

    .agenda-filter-select {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      padding: 0.35rem 0.6rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .agenda-filter-select label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0;
    }

    .agenda-filter-select select {
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--accent-gold-dark);
      outline: none;
    }

    .collab-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .collab-form input {
      width: 100%;
      padding: 0.55rem 0.6rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(255,255,255,0.8);
    }

    .collab-form small {
      grid-column: 1 / -1;
      color: var(--text-muted);
    }

    .login-screen {
      max-width: 420px;
      margin: 4rem auto;
      background: var(--bg-card);
      border-radius: 22px;
      padding: 1.5rem 1.7rem 1.3rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.95);
    }

    .login-screen h1 {
      font-size: 1.4rem;
      margin-bottom: 0.3rem;
    }

    .login-screen p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }

    .role-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      background: rgba(0,0,0,0.03);
      font-size: 0.75rem;
      margin-top: 0.2rem;
      color: var(--text-muted);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.9rem;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 900px) {
      .app-body {
        flex-direction: column;
      }
      .content {
        padding: 1rem;
      }
      .kiosk-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- LOGIN / AUTENTICAO FIREBASE -->
<section id="login-screen" class="login-screen">
  <h1 id="login-title">Studio Nails  Painel</h1>
  <p id="login-subtitle">Acesse com seu e-mail ou usurio. O sistema identifica automaticamente seu perfil.</p>

  <div class="card" id="login-universal" style="margin-top:0.4rem;">
    <div class="collab-form">
      <div>
        <label class="subtext">Email ou usurio</label>
        <input id="login-identifier" placeholder="ex: camila ou camila@email.com" />
      </div>
      <div>
        <label class="subtext">Senha</label>
        <input id="login-password" type="password" placeholder="" />
      </div>
    </div>
    <div style="display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:flex-start;margin-top:0.4rem;">
      <button onclick="handleEmailLogin()">Entrar</button>
      <button class="secondary" onclick="handleGoogleLogin()">Entrar com Google</button>
    </div>
  </div>

  <div class="card" style="margin-top:0.8rem;">
    <h3>Tablet do cliente (Kiosk)</h3>
    <p class="subtext">Tela fixa para o cliente registrar consumao e o servio.</p>
    <button style="margin-top:0.5rem;" class="secondary" onclick="openKioskDirect()">
      Acessar modo tablet
    </button>
    <div class="chip">Ideal para ficar aberto em tela cheia no Studio</div>
  </div>
</section>

<!-- SHELL PRINCIPAL (CEO / COLAB) -->
<div id="app-shell" class="app-shell hidden">
<div id="mobile-nav" class="mobile-nav flex lg:hidden">
    <div class="mobile-nav-header">
      <div class="mobile-toolbar">
        <div class="toolbar-filter">
          <select id="global-month-filter-mobile"></select>
        </div>
        <div class="user-toolbar-chip" id="user-toolbar-chip-mobile">
          <button class="user-avatar-btn" id="user-avatar-button-mobile" onclick="toggleUserDropdownMobile()">
            <span id="user-toolbar-avatar-mobile">SN</span>
          </button>
          <div class="user-dropdown hidden" id="user-dropdown-mobile">
            <button onclick="handleLogout()">Sair</button>
          </div>
        </div>
      </div>
    </div>
    <div id="mobile-nav-menu" class="mobile-nav-menu open">
      <div class="mobile-nav-items" id="mobile-nav-items">
        <!-- Botes injectados via JS conforme papel -->
      </div>
    </div>
  </div>
  <div class="global-toolbar">
    <div class="toolbar-filter">
      <label for="global-month-filter">Ms</label>
      <select id="global-month-filter" class="global-filter-select"></select>
    </div>
    <div class="user-toolbar-chip" id="user-toolbar-chip">
      <div class="avatar" id="user-toolbar-avatar">SN</div>
      <span id="user-toolbar-name">Login ativo</span>
      <button class="logout-btn" onclick="handleLogout()">Sair</button>
    </div>
  </div>
  <div class="app-body">
    <aside id="desktop-sidebar" class="desktop-sidebar" aria-label="Navegacao principal">
      <button id="desktop-sidebar-toggle" class="desktop-toggle-btn" aria-expanded="false" aria-controls="desktop-sidebar-nav">
        <span class="nav-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
            <path d="M4 7h16M4 12h16M4 17h16" />
          </svg>
        </span>
        <span class="nav-label text-sm font-semibold">Abrir navegacao</span>
      </button>
      <div class="sidebar-header">
        <div class="logo-circle"></div>
        <div class="sidebar-header-text">
          <div style="font-size:0.9rem;font-weight:600;">Studio Nails</div>
          <div id="sidebar-role-label-desktop" class="sidebar-role-label" style="font-size:0.75rem;color:var(--text-muted);"></div>
        </div>
      </div>

      <div class="desktop-nav" id="desktop-sidebar-nav">
        <!-- Botes injectados via JS conforme papel -->
      </div>

      <div class="sidebar-footer">
        <div id="sidebar-verse" class="sidebar-verse"></div>
        <div style="margin-top:0.35rem;">
          <button class="secondary" style="padding:0.3rem 0.7rem;font-size:0.7rem;" onclick="backToLogin()">
            Trocar acesso
          </button>
        </div>
      </div>
    </aside>
    <main class="content flex-1">
      <header class="topbar hidden flex flex-col gap-4 md:flex-row md:items-center md:justify-between bg-white/80 backdrop-blur rounded-2xl shadow-md p-5">
      <div class="flex items-start gap-3 w-full md:w-auto">
        <div class="space-y-1">
          <p class="text-sm text-slate-600">Viso rpida do Studio Nails</p>
          <h1 id="page-title" class="text-2xl font-semibold text-[color:var(--text-main)]">Dashboard  Viso Geral do Studio</h1>
          <div id="page-subtitle" class="text-sm text-slate-500">Viso geral do Studio Nails</div>
        </div>
      </div>
    </header>

    <!-- Pginas da CEO -->
    <section id="page-ceo-dashboard" class="page-ceo space-y-6">
      <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Faturamento do ms</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-green);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v12m-6-6h12" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-revenue">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-revenue-delta">--</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Comisso colaboradora</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-peach);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12l4-4m-4 4 4 4" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-commission">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-commission-delta">--</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Consumo vendido</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-blue);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12h16m0 0-4-4m4 4-4 4" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-consumption">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-consumption-delta">--</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Investimentos do ms</span>
            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full" style="background-color: var(--pastel-rose);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.5v15m-6-7.5h12" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-invest-month">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-invest-month-desc">Planejados para o ms selecionado</div>
        </div>
      </div>

      <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Parcelas pagas</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-green);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m5 13 4 4L19 7" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-invest-paid">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-invest-paid-desc">Pagamentos registrados no ms</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Planejado para prximos meses</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-peach);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l3 3" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-invest-future">R$ 0,00</div>
          <div class="text-sm text-slate-500" id="dashboard-invest-future-desc">Investimentos agendados para frente</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Itens em alerta</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-rose);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v4m0 4h.01M10.29 3.86 1.82 18a1 1 0 0 0 .86 1.5h18.64a1 1 0 0 0 .86-1.5L13.71 3.86a1 1 0 0 0-1.72 0Z" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-stock-alerts">0</div>
          <div class="text-sm text-slate-500" id="dashboard-stock-alerts-desc">Nenhum alerta</div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 hover:shadow-lg transition transform hover:-translate-y-0.5">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>Consumo no ms</span>
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-full" style="background-color: var(--pastel-blue);">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[color:var(--accent-gold-dark)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7h16M4 12h10m-6 5h12" />
              </svg>
            </span>
          </div>
          <div class="text-2xl font-semibold text-[color:var(--text-main)]" id="dashboard-stock-consumption-month">0</div>
          <div class="text-sm text-slate-500">Atualizado pelo ms filtrado</div>
        </div>
      </div>

      <div id="dashboard-stock-card" class="rounded-3xl shadow-md p-6" style="background-color: var(--pastel-beige);">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold text-[color:var(--text-main)]">Estoque e Custos Operacionais</h2>
            <p class="text-sm text-slate-600">Custos, lucro da geladeira e alertas por categoria</p>
          </div>
          <div id="dashboard-stock-tags" class="flex flex-wrap gap-2 text-sm"></div>
        </div>
        <div id="dashboard-stock-totals" class="mt-3 flex flex-wrap gap-3 text-sm text-slate-700"></div>
        <div class="mt-4 grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Custo esmaltes</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-rose); color: var(--accent-gold-dark);">Categoria</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-esmaltes">R$ 0,00</div>
            <p class="text-xs text-slate-500">No ms filtrado</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Custo geladeira</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-peach); color: var(--accent-gold-dark);">Categoria</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-geladeira">R$ 0,00</div>
            <p class="text-xs text-slate-500">No ms filtrado</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Custo manuteno</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-blue); color: var(--accent-gold-dark);">Categoria</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-manutencao">R$ 0,00</div>
            <p class="text-xs text-slate-500">No ms filtrado</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Itens em alerta</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium bg-rose-100 text-rose-700">Ateno</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-low">0</div>
            <p class="text-xs text-slate-500">Previso baixa ou pouca quantidade</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Lucro bruto geladeira</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-green); color: var(--accent-gold-dark);">Vendas</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-profit">R$ 0,00</div>
            <p class="text-xs text-slate-500">Com base no estoque atual</p>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-2">
            <div class="flex items-center justify-between text-sm text-slate-500">
              <span>Consumo no ms</span>
              <span class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: var(--pastel-peach); color: var(--accent-gold-dark);">Movimentao</span>
            </div>
            <div class="text-xl font-semibold" id="dashboard-stock-consumption-month">0</div>
            <p class="text-xs text-slate-500">Sadas registradas</p>
          </div>
        </div>

        <div class="mt-4 grid gap-4 lg:grid-cols-2">
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-base font-semibold text-[color:var(--text-main)]">Distribuio de gastos</h4>
                <p class="text-xs text-slate-500">Gastos por categoria</p>
              </div>
            </div>
            <div class="h-72">
              <canvas id="stock-pie"></canvas>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-4 flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-base font-semibold text-[color:var(--text-main)]">Evoluo mensal</h4>
                <p class="text-xs text-slate-500">ltimos meses filtrados</p>
              </div>
            </div>
            <div class="h-72">
              <canvas id="stock-bars"></canvas>
            </div>
          </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2" id="stock-indicators"></div>
      </div>

      <div class="bg-white rounded-2xl shadow-md p-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold text-[color:var(--text-main)]">Prximos horrios</h2>
            <p class="text-sm text-slate-500">Acompanhe rapidamente os atendimentos mais prximos.</p>
          </div>
          <button class="secondary" onclick="navigatePage('ceo', 'agenda')">Abrir agenda</button>
        </div>
        <div class="mt-4 overflow-hidden rounded-xl border border-slate-100">
          <table class="w-full text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-4 py-3 text-left">Horrio</th>
                <th class="px-4 py-3 text-left">Cliente</th>
                <th class="px-4 py-3 text-left">Profissional</th>
                <th class="px-4 py-3 text-left">Servio</th>
                <th class="px-4 py-3 text-left">Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <tr>
                <td colspan="5" class="px-4 py-4 text-center text-slate-500">Nenhum agendamento para exibir.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="page-ceo-agenda" class="page-ceo hidden">
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <h2 style="margin:0;">Agenda</h2>
          <div class="segmented">
            <button id="agenda-toggle-year" class="active" onclick="setAgendaView('year')">Viso anual</button>
            <button id="agenda-toggle-month" onclick="setAgendaView('month')">Ms a ms</button>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">2025</span>
            <span class="pill">CEO + Colab</span>
          </div>
          <div class="agenda-filter-select">
            <label>Profissional</label>
            <select id="agenda-prof-filter" onchange="setAgendaProfessionalFilter(this.value, 'ceo')"></select>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
      </div>
      <div id="agenda-view-year">
        <div class="calendar-year" id="year-calendar">
          <!-- Meses preenchidos via JS -->
        </div>
      </div>

      <div id="agenda-view-month" class="hidden">
        <div class="month-visual-toggle" style="margin-bottom:0.4rem;">
          <label class="subtext">Selecione o ms</label>
          <select id="agenda-month-selector" onchange="setSelectedMonth(parseInt(this.value))"></select>
          <div class="tag">Toque nos dias com atendimento para abrir detalhes</div>
        </div>
        <div class="full-month-calendar" id="agenda-month-calendar"></div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <div style="display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap;">
          <h2 id="selected-month-title" style="margin:0;">Agenda do ms</h2>
          <div class="segmented small">
            <button id="agenda-tab-month" class="active" onclick="setAgendaSummaryTab('month', 'ceo')">Resumo do ms</button>
            <button id="agenda-tab-day" onclick="setAgendaSummaryTab('day', 'ceo')">Agenda do dia</button>
          </div>
        </div>
        <div class="pill-row" id="selected-month-tags"></div>
      </div>
      <div id="agenda-month-card" class="card" style="margin-top:0.2rem;">
        <table class="table" style="margin:0;">
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servio</th>
              <th>Profissional</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="agenda-month-summary">
            <!-- Populado via JS mock -->
          </tbody>
        </table>
      </div>

      <div id="agenda-day-card" class="card hidden" style="margin-top:0.4rem;">
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
            <label class="subtext" for="agenda-day-picker">Escolha o dia</label>
            <input id="agenda-day-picker" type="date" onchange="renderAgendaDayList('ceo')" />
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">Arraste na linha do tempo para reagendar</span>
            <button class="secondary" onclick="openDayAgendaFromTab('ceo')">Ver timeline</button>
          </div>
        </div>
        <div id="agenda-day-list" class="agenda-appointments" style="margin:0;"></div>
      </div>

    </section>

    <section id="page-ceo-inventory" class="page-ceo hidden">
      <div class="section-title" style="margin-top:0; align-items:flex-start;">
        <div>
          <h2>Estoque inteligente</h2>
          <div class="subtext">Controle visual por categorias e templates recorrentes</div>
        </div>
        <div class="inventory-actions">
          <button class="secondary" onclick="openTemplateManager()">Catlogo de produtos</button>
          <button onclick="openInventoryModal()">+ Adicionar item</button>
        </div>
      </div>

      <div class="inventory-header">
        <div class="inventory-tabs">
          <button id="inventory-tab-btn-polish" class="inventory-tab active" onclick="switchInventoryTab('esmaltes')">Esmaltes</button>
          <button id="inventory-tab-btn-fridge" class="inventory-tab" onclick="switchInventoryTab('geladeira')">Geladeira</button>
          <button id="inventory-tab-btn-maint" class="inventory-tab" onclick="switchInventoryTab('manutencao')">Manuteno</button>
        </div>
      </div>

      <div class="inventory-templates">
        <div class="subtext">Catlogo rpido por categoria</div>
        <div class="template-chip-row" id="inventory-template-chips"></div>
      </div>

      <div id="inventory-panel-esmaltes" class="inventory-tabpanel">
        <div class="section-title">
          <h2>Esmaltes</h2>
          <div class="pill-row" id="inventory-polish-metrics"></div>
        </div>
        <div class="inventory-list" id="inventory-polish-list"></div>
      </div>

      <div id="inventory-panel-geladeira" class="inventory-tabpanel hidden">
        <div class="section-title">
          <h2>Geladeira</h2>
          <div class="pill-row" id="inventory-fridge-metrics"></div>
        </div>
        <div class="inventory-list" id="inventory-fridge-list"></div>
      </div>

      <div id="inventory-panel-manutencao" class="inventory-tabpanel hidden">
        <div class="section-title">
          <h2>Studio / Manuteno</h2>
          <div class="pill-row" id="inventory-maintenance-metrics"></div>
        </div>
        <div class="inventory-list" id="inventory-maintenance-list"></div>
      </div>
    </section>

    <div id="inventory-modal" class="inventory-modal hidden">
      <div class="card">
        <div class="section-title" style="margin-top:0;">
          <h2 id="inventory-modal-title">Adicionar item</h2>
          <button class="secondary" onclick="closeInventoryModal()">Fechar</button>
        </div>

        <div class="modal-grid">
          <div class="modal-section">
            <div class="modal-section-title">Categoria & visibilidade</div>
            <label class="subtext">Categoria</label>
            <select id="inventory-category" onchange="handleInventoryDestinationChange(this.value)">
              <option value="esmaltes">Esmaltes</option>
              <option value="geladeira">Geladeira</option>
              <option value="manutencao">Manuteno</option>
            </select>
            <label class="subtext">Visibilidade no tablet</label>
            <select id="inventory-kiosk-flag">
              <option value="active">Colocar no consumo</option>
              <option value="paused">Manter oculto</option>
            </select>
            <div class="subtext">Sugestes se adaptam  categoria escolhida.</div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">Produtos recorrentes</div>
            <div class="subtext">Use templates ou edite-os rapidamente.</div>
            <div class="template-chip-row" id="inventory-template-row"></div>
          </div>
        </div>

        <div id="inventory-fields-esmaltes" class="modal-section">
          <div class="modal-section-title">Dados do item</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Nome</label>
              <input id="stock-polish-name" placeholder="Ex: Nude clssico" />
            </div>
            <div>
              <label class="subtext">Marca</label>
              <input id="stock-polish-brand" placeholder="Marca" />
            </div>
            <div>
              <label class="subtext">Volume total (ml)</label>
              <input id="stock-polish-total" type="number" min="0" />
            </div>
            <div>
              <label class="subtext">Volume atual (ml)</label>
              <input id="stock-polish-current" type="number" min="0" />
            </div>
          </div>
          <div class="modal-section-title">Configuraes de consumo</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Custo total</label>
              <input id="stock-polish-cost" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Consumo estimado por uso (ml)</label>
              <input id="stock-polish-consumption" type="number" min="0" step="0.1" />
            </div>
            <div>
              <label class="subtext">Data da compra</label>
              <input id="stock-polish-date" type="date" />
            </div>
            <div>
              <label class="subtext">Previso automtica</label>
              <input id="stock-polish-forecast" disabled />
            </div>
          </div>
        </div>

        <div id="inventory-fields-geladeira" class="modal-section hidden">
          <div class="modal-section-title">Dados do item</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Nome</label>
              <input id="stock-fridge-name" placeholder="Ex: gua com gs" />
            </div>
            <div>
              <label class="subtext">Quantidade adicionada</label>
              <input id="stock-fridge-qty" type="number" min="0" />
            </div>
            <div>
              <label class="subtext">Custo total da compra</label>
              <input id="stock-fridge-cost" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Preo de venda</label>
              <input id="stock-fridge-price" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Data da compra</label>
              <input id="stock-fridge-date" type="date" />
            </div>
          </div>
        </div>

        <div id="inventory-fields-manutencao" class="modal-section hidden">
          <div class="modal-section-title">Dados do item</div>
          <div class="modal-grid">
            <div>
              <label class="subtext">Nome</label>
              <input id="stock-maint-name" placeholder="Ex: Papel higinico" />
            </div>
            <div>
              <label class="subtext">Quantidade</label>
              <input id="stock-maint-qty" type="number" min="0" />
            </div>
            <div>
              <label class="subtext">Custo total da compra</label>
              <input id="stock-maint-cost" type="number" min="0" step="0.01" />
            </div>
            <div>
              <label class="subtext">Data da compra</label>
              <input id="stock-maint-date" type="date" />
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="secondary" onclick="closeInventoryModal()">Cancelar</button>
          <button id="inventory-modal-save" onclick="submitInventoryForm()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="template-modal" class="inventory-modal hidden">
      <div class="card">
        <div class="section-title" style="margin-top:0;">
          <h2 id="template-modal-title">Template de produto</h2>
          <button class="secondary" onclick="closeDialog('template-modal')">Fechar</button>
        </div>
        <div class="modal-grid">
          <div>
            <label class="subtext">Nome</label>
            <input id="template-name" />
          </div>
          <div>
            <label class="subtext">Categoria</label>
            <select id="template-category">
              <option value="esmaltes">Esmaltes</option>
              <option value="geladeira">Geladeira</option>
              <option value="manutencao">Manuteno</option>
            </select>
          </div>
          <div>
            <label class="subtext">Unidades por pack</label>
            <input id="template-pack" type="number" min="0" />
          </div>
          <div>
            <label class="subtext">Volume total (ml)</label>
            <input id="template-volume" type="number" min="0" />
          </div>
          <div>
            <label class="subtext">Volume por pack</label>
            <input id="template-volume-pack" type="number" min="0" />
          </div>
          <div>
            <label class="subtext">Frequncia de uso</label>
            <input id="template-frequency" placeholder="Ex: dirio" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="secondary" onclick="closeDialog('template-modal')">Cancelar</button>
          <button onclick="saveTemplate()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="stock-detail-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Detalhes do item</h3>
          <button class="secondary" onclick="closeDialog('stock-detail-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div><label>Item</label><div id="stock-detail-name" class="value" style="font-size:1rem;"></div></div>
          <div><label>Categoria</label><div id="stock-detail-cat" class="subtext"></div></div>
          <div><label>ltima entrada</label><div id="stock-detail-entry" class="subtext"></div></div>
          <div><label>ltima sada</label><div id="stock-detail-exit" class="subtext"></div></div>
          <div><label>Previso</label><div id="stock-detail-forecast" class="subtext"></div></div>
          <div><label>Custo/uso</label><div id="stock-detail-cost" class="subtext"></div></div>
        </div>
      </div>
    </div>

    <div id="stock-exit-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Registrar sada</h3>
          <button class="secondary" onclick="closeDialog('stock-exit-modal')">Fechar</button>
        </div>
        <div>
          <label>Item</label>
          <div id="stock-exit-name" class="subtext"></div>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Quantidade/volume</label>
            <input id="stock-exit-qty" type="number" min="0" />
          </div>
          <div>
            <label>Observaes</label>
            <input id="stock-exit-notes" placeholder="Opcional" />
          </div>
        </div>
        <div class="dialog-actions" style="justify-content:flex-end;">
          <button class="secondary" onclick="closeDialog('stock-exit-modal')">Cancelar</button>
          <button onclick="confirmStockExit()">Registrar</button>
        </div>
      </div>
    </div>

    <div id="stock-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <h3>Remover item</h3>
        <p class="subtext">Essa ao remover o item do estoque.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('stock-remove-modal')">Cancelar</button>
          <button class="danger" onclick="confirmRemoveStockItem()">Excluir</button>
        </div>
      </div>
    </div>

      <section id="page-ceo-investments" class="page-ceo hidden">
      <div class="card investment-controls">
        <div class="control-actions" style="justify-content: space-between; gap:1rem;">
          <div>
            <div class="subtext">Filtrando pelo ms selecionado acima</div>
            <div class="segmented compact">
              <button id="invest-filter-all" class="active" onclick="setInvestmentFilter('Todos')">Todos</button>
              <button id="invest-filter-plan" onclick="setInvestmentFilter('Planejado')">Planejado</button>
              <button id="invest-filter-progress" onclick="setInvestmentFilter('Em andamento')">Em andamento</button>
              <button id="invest-filter-paid" onclick="setInvestmentFilter('Pago')">Pago</button>
            </div>
          </div>
          <button class="secondary" onclick="openInvestmentModal()">+ Adicionar investimento</button>
        </div>
      </div>

      <div id="investment-groups" class="investment-groups"></div>
    </section>

    <section id="page-ceo-finance" class="page-ceo hidden">
      <div class="section-title">
        <h2>Resumo financeiro</h2>
        <div class="pill-row">
          <span class="pill">Ms atual</span>
          <span class="pill">Servios + consumo</span>
        </div>
      </div>

      <div class="card-grid">
        <div class="card">
          <h3>Receita bruta</h3>
          <div class="value" id="finance-revenue">R$ 0,00</div>
          <div class="subtext">Inclui servios e bebidas</div>
        </div>
        <div class="card">
          <h3>Custos (produtos)</h3>
          <div class="value" id="finance-costs">R$ 0,00</div>
          <div class="subtext">Baseado no consumo estimado de esmaltes e itens</div>
        </div>
        <div class="card">
          <h3>Lucro estimado</h3>
          <div class="value" id="finance-profit">R$ 0,00</div>
          <div class="subtext">Antes de outras despesas fixas</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Vendas por tipo</h2>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Quantidade</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Servios</td>
            <td>120</td>
            <td>R$ 13.200</td>
          </tr>
          <tr>
            <td>Consumo (geladeira)</td>
            <td>64</td>
            <td>R$ 2.600</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-ceo-clients" class="page-ceo hidden">
      <div class="section-title">
        <h2>Clientes</h2>
        <div class="pill-row">
          <span class="pill">Viso geral</span>
          <span class="pill">CEO v todas</span>
        </div>
      </div>
      <div class="settings-block">
        <div class="clients-header">
          <div class="clients-actions">
            <button class="ghost-btn" onclick="openClientModal()">+ Adicionar cliente</button>
            <div class="clients-search">
              <span></span>
              <input id="client-search-ceo" placeholder="Buscar por nome ou telefone" oninput="renderClients('ceo')" />
            </div>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
        <div id="clients-grid-ceo" class="clients-grid"></div>
      </div>
    </section>

    <section id="page-ceo-settings" class="page-ceo hidden">
      <div class="section-title">
        <h2>Configuraes do Studio</h2>
      </div>
      <div class="settings-block">
        <div class="block-header">
          <div>
            <h3>Colaboradoras</h3>
            <div class="section-caption">Lista compacta para gerenciar permisses, comisso e logins dedicados.</div>
          </div>
          <div class="block-actions">
            <button class="ghost-btn secondary" onclick="openCollabAddModal()">+ Colaboradora</button>
            <button class="ghost-btn" onclick="openDedicatedLoginModal()"> Criar login dedicado</button>
          </div>
        </div>
        <div id="collaborators-list" class="collab-list"></div>
      </div>

      <div class="settings-block" style="margin-top:1rem;">
        <div class="block-header">
          <div>
            <h3>Servios</h3>
            <div class="section-caption">Valores utilizados no app e no tablet, com edio via modal.</div>
          </div>
          <div class="block-actions">
            <button class="ghost-btn" onclick="openServiceAddModal()"> Adicionar servio</button>
            <button class="ghost-btn secondary" onclick="openServiceEditModal()"> Editar valores</button>
          </div>
        </div>
        <table class="table" style="margin-top:0.2rem;">
          <thead>
            <tr>
              <th>Servio</th>
              <th>Durao</th>
              <th>Preo</th>
            </tr>
          </thead>
          <tbody id="services-table"></tbody>
        </table>
      </div>
    </section>

    <div id="login-dedicated-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Criar login dedicado</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('login-dedicated-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome da colaboradora</label>
            <input id="new-colab-name" placeholder="Ex: Camila" />
          </div>
          <div>
            <label>Usurio</label>
            <input id="new-colab-username" placeholder="Ex: camila" />
          </div>
          <div>
            <label>Senha inicial</label>
            <input id="new-colab-password" placeholder="Ex: 123" />
          </div>
          <div>
            <label>Permisses</label>
            <input id="new-colab-permissions" placeholder="Agenda compartilhada, comisses" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('login-dedicated-modal')">Cancelar</button>
          <button onclick="createCollaboratorAccount()">Gerar usurio e senha</button>
        </div>
        <div class="section-caption">A colaboradora ver apenas o prprio login e o acesso ao tablet.</div>
      </div>
    </div>

    <div id="add-collab-modal" class="dialog-layer hidden">
        <div class="dialog-card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Adicionar colaboradora</h3>
            <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('add-collab-modal')">Fechar</button>
          </div>
          <div class="dialog-grid">
            <div>
              <label>Nome</label>
              <input id="add-collab-name" placeholder="Ex: Camilia" />
            </div>
            <div>
              <label>Cargo</label>
              <input id="add-collab-role" placeholder="Ex: Colaboradora" />
            </div>
            <div>
              <label>Email</label>
              <input id="add-collab-email" placeholder="Email corporativo" />
            </div>
            <div>
              <label>Usurio</label>
              <input id="add-collab-login" placeholder="Usurio opcional" />
            </div>
            <div>
              <label>Comisso</label>
              <input id="add-collab-commission" placeholder="Ex: 40% servios" />
            </div>
            <div>
              <label>Senha inicial</label>
              <input id="add-collab-password" placeholder="Senha provisria" type="password" />
            </div>
            <div style="grid-column:1 / span 2; display:flex; gap:1rem; align-items:center;">
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="add-collab-perm-agenda" checked /> Agenda compartilhada
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="add-collab-perm-comissao" checked /> Comisses
              </label>
            </div>
          </div>
          <div class="dialog-actions">
            <button class="secondary" onclick="closeDialog('add-collab-modal')">Cancelar</button>
            <button onclick="saveNewCollaborator()">Salvar colaboradora</button>
        </div>
      </div>
    </div>

    <div id="edit-collab-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Editar colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('edit-collab-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Nome</label>
            <input id="edit-collab-name" />
          </div>
          <div>
            <label>Cargo</label>
            <input id="edit-collab-role" />
          </div>
          <div>
            <label>Login</label>
            <input id="edit-collab-login" placeholder="Usurio" />
          </div>
          <div>
            <label>Permisses</label>
            <div style="display:flex;flex-direction:column;gap:0.3rem;padding:0.4rem 0;">
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-agenda" /> Agenda
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-estoque" /> Estoque
              </label>
              <label style="display:flex;align-items:center;gap:0.4rem;">
                <input type="checkbox" id="perm-comissao" /> Comisso
              </label>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('edit-collab-modal')">Cancelar</button>
          <button onclick="saveCollaboratorProfile()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="commission-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Comisso</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('commission-modal')">Fechar</button>
        </div>
        <div>
          <label>Percentual de comisso</label>
          <input id="commission-value" type="number" min="0" max="100" step="1" placeholder="Ex: 40" />
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('commission-modal')">Cancelar</button>
          <button onclick="saveCommission()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="collab-status-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Status da colaboradora</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('collab-status-modal')">Fechar</button>
        </div>
        <p class="subtext" id="collab-status-text">Gerencie ativao ou remoo.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="removeCollaborator()" style="color:var(--danger);border-color:var(--danger);">Remover colaboradora</button>
          <div style="display:flex;gap:0.4rem;">
            <button class="secondary" onclick="closeDialog('collab-status-modal')">Cancelar</button>
            <button onclick="confirmDeactivateCollaborator()" id="collab-status-toggle">Desativar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="service-add-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Adicionar servio</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('service-add-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Servio</label>
            <input id="add-service-name" placeholder="Ex: Spa mos" />
          </div>
          <div>
            <label>Durao</label>
            <input id="add-service-duration" placeholder="Ex: 40min" />
          </div>
          <div>
            <label>Preo</label>
            <input id="add-service-price" type="number" placeholder="Ex: 80" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('service-add-modal')">Cancelar</button>
          <button onclick="saveNewService()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="service-edit-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>Editar valores</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('service-edit-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Servio</label>
            <select id="edit-service-select" onchange="prefillServiceFields()"></select>
          </div>
          <div>
            <label>Durao</label>
            <input id="edit-service-duration" placeholder="Ex: 1h30" />
          </div>
          <div>
            <label>Preo</label>
            <input id="edit-service-price" type="number" placeholder="Ex: 120" />
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('service-edit-modal')">Cancelar</button>
          <button onclick="saveServiceEdit()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="investment-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:720px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;">
          <div>
            <h3 id="investment-modal-title">Adicionar investimento</h3>
            <div class="subtext">Preencha valores, parcelas e ms de referncia</div>
          </div>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('investment-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <input type="hidden" id="investment-id" />
          <div>
            <label>Ttulo</label>
            <input id="investment-title" placeholder="Ex: Reforma recepo" />
          </div>
          <div>
            <label>Categoria</label>
            <input id="investment-category" placeholder="Equipamento, obra, melhoria" />
          </div>
          <div>
            <label>Ms de referncia</label>
            <input id="investment-month" type="month" />
          </div>
          <div>
            <label>Valor total</label>
            <input id="investment-amount" type="number" placeholder="500" />
          </div>
          <div>
            <label>Parcelado?</label>
            <select id="investment-parceled" onchange="toggleParcelFields()">
              <option value="nao">No</option>
              <option value="sim">Sim</option>
            </select>
          </div>
          <div>
            <label>Nmero de parcelas</label>
            <input id="investment-installments" type="number" min="1" placeholder="1" />
          </div>
          <div>
            <label>Valor de cada parcela</label>
            <input id="investment-installment-value" type="number" placeholder="0" />
          </div>
          <div>
            <label>Status</label>
            <select id="investment-status">
              <option value="Planejado">Planejado</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Pago">Pago</option>
            </select>
          </div>
          <div>
            <label>Observaes</label>
            <textarea id="investment-notes" placeholder="Materiais, cronograma ou fornecedor"></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('investment-modal')">Cancelar</button>
          <button id="investment-modal-save" onclick="saveInvestment()">Salvar</button>
        </div>
      </div>
    </div>

    <div id="investment-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover investimento</h3>
        <p class="subtext" id="investment-remove-text">Confirme para remover o investimento selecionado.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('investment-remove-modal')">Cancelar</button>
          <button onclick="confirmRemoveInvestment()" style="background:var(--danger);">Remover</button>
        </div>
      </div>
    </div>

    <div id="investment-history-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:680px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;">
          <div>
            <h3>Histrico do investimento</h3>
            <div class="subtext">Pagamentos, alteraes e observaes registradas</div>
          </div>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('investment-history-modal')">Fechar</button>
        </div>
        <div id="investment-history-list" class="investment-history-list"></div>
      </div>
    </div>

    <div id="client-form-modal" class="dialog-layer hidden">
      <div class="dialog-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 id="client-form-title">Adicionar cliente</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('client-form-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <input type="hidden" id="client-id" />
          <div>
            <label>Nome completo</label>
            <input id="client-name" placeholder="Ex: Maria Souza" />
          </div>
          <div>
            <label>Telefone</label>
            <input id="client-phone" placeholder="55999999999" />
          </div>
          <div>
            <label>Instagram</label>
            <input id="client-instagram" placeholder="@cliente" />
          </div>
          <div>
            <label>Data de aniversrio</label>
            <input id="client-birthday" type="date" />
          </div>
          <div>
            <label>Preferncia de cor</label>
            <input id="client-pref-color" placeholder="Nude, vermelho" />
          </div>
          <div>
            <label>Formato de unha</label>
            <input id="client-pref-shape" placeholder="Quadrada, amendoada" />
          </div>
          <div>
            <label>Tipo de alongamento</label>
            <input id="client-pref-extension" placeholder="Fibra, gel" />
          </div>
          <div>
            <label>Alergias</label>
            <input id="client-allergies" placeholder="Produtos ou materiais" />
          </div>
          <div>
            <label>Observaes</label>
            <textarea id="client-notes" placeholder="Preferncias, observaes gerais"></textarea>
          </div>
          <div>
            <label>Responsvel</label>
            <select id="client-responsible"></select>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('client-form-modal')">Cancelar</button>
          <button id="client-form-save" onclick="saveClient()">Salvar cliente</button>
        </div>
      </div>
    </div>

    <div id="client-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover cliente</h3>
        <p class="subtext" id="client-remove-text">Confirme para remover a cliente e cancelar seus agendamentos futuros.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('client-remove-modal')">Cancelar</button>
          <button onclick="confirmRemoveClient()" style="background:var(--danger);">Remover</button>
        </div>
      </div>
    </div>

    <div id="client-detail-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:720px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.6rem;flex-wrap:wrap;">
          <div>
            <h3 id="client-detail-name">Ficha da cliente</h3>
            <div class="subtext" id="client-detail-phone"></div>
          </div>
          <div class="inline-actions">
            <button class="secondary" onclick="openAppointmentModal(currentClientDetailId)">Agendar novamente</button>
            <button class="ghost-btn" onclick="closeDialog('client-detail-modal')">Fechar</button>
          </div>
        </div>
        <div class="client-detail-tabs">
          <button id="tab-detail-data" class="active" onclick="switchClientTab('data')">Dados pessoais</button>
          <button id="tab-detail-history" onclick="switchClientTab('history')">Histrico de servios</button>
          <button id="tab-detail-consume" onclick="switchClientTab('consume')">Consumos</button>
          <button id="tab-detail-future" onclick="switchClientTab('future')">Agendamentos futuros</button>
        </div>
        <div id="client-detail-content"></div>
      </div>
    </div>

    <div id="appointment-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:640px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 id="appointment-modal-title">Novo agendamento</h3>
          <button class="secondary" style="height:32px;padding:0.35rem 0.8rem;" onclick="closeDialog('appointment-modal')">Fechar</button>
        </div>
        <div class="dialog-grid">
          <div>
            <label>Cliente</label>
            <input id="appointment-client" list="clients-datalist" placeholder="Buscar ou digitar cliente" oninput="bindClientFromInput()" />
            <input type="hidden" id="appointment-client-id" />
            <datalist id="clients-datalist"></datalist>
          </div>
          <div>
            <label>Profissional</label>
            <select id="appointment-professional"></select>
          </div>
          <div>
            <label>Servio</label>
            <select id="appointment-service"></select>
          </div>
          <div>
            <label>Data</label>
            <input id="appointment-date" type="date" />
          </div>
          <div>
            <label>Horrio</label>
            <input id="appointment-time" type="time" />
          </div>
          <div>
            <label>Observaes</label>
            <textarea id="appointment-notes" placeholder="Preferncias, recados"></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="secondary" onclick="closeDialog('appointment-modal')">Cancelar</button>
          <button id="appointment-submit-btn" onclick="saveAppointment()">Salvar e gerar WhatsApp</button>
        </div>
      </div>
    </div>

<div id="modal-agendamentos" class="dialog-layer fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="dialog-card bg-[var(--pastel-beige)] p-6 rounded-2xl shadow-xl w-[90%] max-w-xl">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
      <div>
        <h3 id="day-appointments-title" style="margin:0;">Agendamentos do dia</h3>
            <div class="subtext" id="day-appointments-caption">Horrios e profissionais do dia selecionado</div>
          </div>
          <button class="secondary" onclick="closeDialog('modal-agendamentos')">Fechar</button>
        </div>

        <div id="day-appointments-list" class="agenda-appointments" style="margin:0.75rem 0 0.25rem 0;"></div>

        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('modal-agendamentos')">Voltar</button>
          <button onclick="openAppointmentModal(null, null, dayModalDate); fecharModalAgendamentos();">Novo agendamento para este dia</button>
        </div>
      </div>
    </div>

    <div id="appointment-remove-modal" class="dialog-layer hidden">
      <div class="dialog-card" style="max-width:420px;">
        <h3>Remover agendamento</h3>
        <p class="subtext">Confirme para remover este horrio e atualizar a agenda.</p>
        <div class="dialog-actions" style="justify-content:space-between;">
          <button class="secondary" onclick="closeDialog('appointment-remove-modal')">Cancelar</button>
          <button style="background:var(--danger);" onclick="confirmRemoveAppointment()">Remover</button>
        </div>
  </div>
</div>

<div id="move-appointment-modal" class="dialog-layer hidden">
  <div class="dialog-card" style="max-width:460px;">
    <h3>Confirmar novo horrio</h3>
    <div id="move-appointment-summary" class="subtext" style="margin:0.35rem 0 0.75rem 0;">Selecione um horrio.</div>
    <div class="dialog-actions" style="justify-content:space-between;">
      <button class="secondary" onclick="closeMoveAppointmentModal()">Cancelar</button>
      <button onclick="confirmMoveAppointment()">Salvar mudana</button>
    </div>
  </div>
</div>

<!-- Agenda do dia (timeline) -->
<div id="day-agenda-overlay" class="day-agenda-overlay">
  <div class="day-agenda">
    <div class="day-agenda-header">
      <div>
        <div class="text-sm text-slate-600">Agenda do dia</div>
        <div id="day-agenda-title" class="text-lg font-semibold text-[color:var(--text-main)]"></div>
      </div>
      <div class="flex gap-2">
        <button class="secondary" onclick="refreshDayAgenda()">Atualizar</button>
        <button class="secondary" onclick="closeDayAgenda()">Fechar</button>
      </div>
    </div>
    <div class="day-agenda-body">
      <div class="day-hours" id="day-agenda-hours"></div>
      <div class="day-slots" id="day-agenda-slots"></div>
    </div>
    <div class="day-agenda-foot">
      <div class="subtext">Arraste um card para outro hor&aacute;rio ou toque no slot para mover no mobile.</div>
    </div>
  </div>
</div>

<!-- Pginas da COLABORADORA -->
<section id="page-colab-dashboard" class="page-colab hidden">
  <div class="card-grid">
    <div class="card">
      <h3>Comisso no ms</h3>
          <div class="value">R$ 3.250</div>
          <div class="subtext">Baseada nos servios realizados</div>
        </div>
        <div class="card">
          <h3>Atendimentos hoje</h3>
          <div class="value">6</div>
          <div class="subtext">3 manh  3 tarde</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <h2>Prximos horrios</h2>
        <button class="secondary" onclick="navigatePage('colab', 'agenda')">Ver agenda completa</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Horrio</th>
            <th>Cliente</th>
            <th>Servio</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="subtext">Nenhum agendamento para exibir.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-colab-agenda" class="page-colab hidden">
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
          <h2 style="margin:0;">Agenda compartilhada</h2>
          <div class="segmented">
            <button id="agenda-toggle-year-colab" class="active" onclick="setAgendaView('year','colab')">Viso anual</button>
            <button id="agenda-toggle-month-colab" onclick="setAgendaView('month','colab')">Ms a ms</button>
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">2025</span>
            <span class="pill">CEO + Colab</span>
          </div>
          <div class="agenda-filter-select">
            <label>Profissional</label>
            <select id="agenda-prof-filter-colab" onchange="setAgendaProfessionalFilter(this.value, 'colab')"></select>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
      </div>
      <div id="agenda-view-year-colab">
        <div class="calendar-year" id="year-calendar-colab"></div>
      </div>

      <div id="agenda-view-month-colab" class="hidden">
      <div class="month-visual-toggle" style="margin-bottom:0.4rem;">
        <label class="subtext">Selecione o ms</label>
        <select id="agenda-month-selector-colab" onchange="setSelectedMonth(parseInt(this.value), 'colab')"></select>
        <div class="tag">Toque nos dias com atendimento para abrir detalhes</div>
      </div>
        <div class="full-month-calendar" id="agenda-month-calendar-colab"></div>
      </div>

      <div class="section-title" style="margin-top:1rem;">
        <div style="display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap;">
          <h2 id="selected-month-title-colab" style="margin:0;">Agenda do ms</h2>
          <div class="segmented small">
            <button id="agenda-tab-month-colab" class="active" onclick="setAgendaSummaryTab('month', 'colab')">Resumo do ms</button>
            <button id="agenda-tab-day-colab" onclick="setAgendaSummaryTab('day', 'colab')">Agenda do dia</button>
          </div>
        </div>
        <div class="pill-row" id="selected-month-tags-colab"></div>
      </div>
      <div id="agenda-month-card-colab" class="card" style="margin-top:0.2rem;">
        <div class="agenda-table-wrapper">
          <table class="table" style="margin:0;">
            <thead>
              <tr>
                <th>Data</th>
                <th>Hora</th>
                <th>Cliente</th>
                <th>Servio</th>
                <th>Profissional</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="agenda-month-summary-colab"></tbody>
          </table>
        </div>
        <div id="agenda-month-cards-colab" class="agenda-month-cards"></div>
      </div>

      <div id="agenda-day-card-colab" class="card hidden" style="margin-top:0.4rem;">
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
            <label class="subtext" for="agenda-day-picker-colab">Escolha o dia</label>
            <input id="agenda-day-picker-colab" type="date" onchange="renderAgendaDayList('colab')" />
          </div>
          <div class="pill-row" style="margin:0;">
            <span class="pill">Arraste na linha do tempo para reagendar</span>
            <button class="secondary" onclick="openDayAgendaFromTab('colab')">Ver timeline</button>
          </div>
        </div>
        <div id="agenda-day-list-colab" class="agenda-appointments" style="margin:0;"></div>
      </div>

    </section>

    <section id="page-colab-commission" class="page-colab hidden">
      <div class="section-title">
        <h2>Minhas comisses</h2>
        <div class="pill-row">
          <span class="pill">Ms atual</span>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Servio</th>
            <th>Valor servio</th>
            <th>Comisso</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>02/12</td>
            <td>Manuteno fibra</td>
            <td>R$ 120</td>
            <td>R$ 48</td>
          </tr>
          <tr>
            <td>03/12</td>
            <td>Alongamento</td>
            <td>R$ 180</td>
            <td>R$ 72</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="page-colab-clients" class="page-colab hidden">
      <div class="section-title">
        <h2>Clientes</h2>
        <div class="pill-row">
          <span class="pill">Voc v apenas seus contatos</span>
        </div>
      </div>
      <div class="settings-block">
        <div class="clients-header">
          <div class="clients-actions">
            <button class="ghost-btn" onclick="openClientModal()">+ Adicionar cliente</button>
            <div class="clients-search">
              <span></span>
              <input id="client-search-colab" placeholder="Buscar por nome ou telefone" oninput="renderClients('colab')" />
            </div>
          </div>
          <button class="secondary" onclick="openAppointmentModal()">Novo agendamento</button>
        </div>
        <div id="clients-grid-colab" class="clients-grid"></div>
      </div>
    </section>

    </main>
  </div>
</div>

<!-- TELA KIOSK (CLIENTE) -->
<section id="kiosk-screen" class="hidden">
  <div class="kiosk-wrapper">
    <div class="kiosk-hero">
      <div>
        <h1 style="font-size:1.4rem;">Consumo & Servio</h1>
        <div class="tag" style="margin-top:0.2rem;">Informe o cdigo que a profissional exibiu para voc</div>
        <div class="kiosk-steps" id="kiosk-steps">
          <span class="kiosk-pill">1 Digite o cdigo</span>
          <span class="kiosk-pill">2 Selecione os itens</span>
          <span class="kiosk-pill">3 Finalize e avise</span>
        </div>
      </div>
      <button class="secondary" onclick="backToLogin()">Sair do modo tablet</button>
    </div>

    <div class="kiosk-pairing" id="kiosk-pairing-box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;flex-wrap:wrap;">
        <div>
          <div style="font-weight:600;">Parear com seu atendimento</div>
          <div class="subtext">Digite o cdigo de 4 a 6 caracteres informado pela profissional.</div>
        </div>
        <div id="kiosk-session-status" class="badge" style="background:#fff0f0;color:#b91c1c;">Aguardando cdigo</div>
      </div>
      <div class="kiosk-pairing-row">
        <input id="kiosk-codigo-input" maxlength="6" autocomplete="off" placeholder="Ex: A1B2" />
        <button onclick="handleKioskPairing()">Conectar</button>
        <button class="secondary" onclick="resetKioskSession()">Limpar</button>
      </div>
      <div class="hint" id="kiosk-pairing-hint">O cdigo  criado quando a comanda  aberta.</div>
    </div>

    <div id="kiosk-content" class="kiosk-grid hidden">
      <div>
        <h2 class="kiosk-section-title">Bebidas e consumao</h2>
        <div class="kiosk-items" id="kiosk-drinks">
          <!-- Itens via JS -->
        </div>

        <h2 class="kiosk-section-title" style="margin-top:0.8rem;">Servio que estou fazendo</h2>
        <div class="kiosk-items" id="kiosk-services">
          <!-- Servios via JS -->
        </div>
      </div>

      <div class="kiosk-cart">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="font-size:1rem;">Seu carrinho</h2>
          <button class="secondary" style="font-size:0.75rem;padding:0.3rem 0.7rem;" onclick="clearCart()">
            Limpar
          </button>
        </div>
        <div class="kiosk-cart-list" id="kiosk-cart-list">
          <!-- itens carrinho -->
        </div>
        <div class="kiosk-cart-total">
          <span>Total estimado</span>
          <span id="kiosk-cart-total">R$ 0,00</span>
        </div>
        <button style="margin-top:0.5rem;width:100%;" onclick="sendOrder()">
          Finalizar e avisar a profissional
        </button>
        <div class="hint">
          Depois voc paga normalmente no caixa. Este registro ajuda o Studio a controlar estoque e comisso.
        </div>
      </div>
    </div>
  </div>
</section>

<div id="fab-backdrop" class="fab-backdrop hidden"></div>
<div id="fab-container" class="fab-container hidden" aria-live="polite">
  <div id="fab-speed-dial" class="fab-speed-dial"></div>
  <button id="fab-main" class="fab-main" aria-label="Aes rpidas">
    <span id="fab-icon"></span>
  </button>
</div>
<div id="comanda-mini" class="comanda-mini hidden">
  <button onclick="restoreComandaPanel()">
     Comanda em andamento
  </button>
</div>

<!-- Painel de Comanda (Profissional) -->
<div id="comanda-panel" class="comanda-panel">
  <header>
    <div>
      <strong>Comanda em atendimento</strong>
      <div class="subtext" id="comanda-panel-info">Cliente / Profissional</div>
      <div class="badge" id="comanda-panel-codigo" style="margin-top:0.25rem;">Cdigo do kiosk: --</div>
    </div>
    <div style="display:flex;gap:0.35rem;">
      <button class="secondary" style="padding:0.25rem 0.6rem;border-radius:10px;" onclick="minimizeComandaPanel()">Minimizar</button>
      <button class="secondary" style="padding:0.25rem 0.6rem;border-radius:10px;" onclick="closeComandaPanel()">Fechar</button>
    </div>
  </header>
  <div class="comanda-items" id="comanda-items"></div>
  <div class="comanda-form" id="comanda-form" style="display:none;">
    <div class="subtext">Os itens extras so adicionados pela cliente no kiosk.</div>
  </div>
</div>

<div id="finalizar-comanda-modal" class="dialog-layer hidden">
  <div class="dialog-card" style="max-width:540px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.75rem;">
      <div>
        <h3>Revisar comanda</h3>
        <div class="subtext" id="finalizar-comanda-caption">Confira os itens antes do pagamento.</div>
        <div class="subtext" id="finalizar-comanda-registro" style="margin-top:0.25rem;">Resumo ainda no carregado.</div>
      </div>
      <button class="secondary" onclick="closeFinalizarComandaModal()">Fechar</button>
    </div>

    <div id="finalizar-comanda-total" class="badge" style="margin:0.75rem 0; display:inline-flex;">Total estimado: --</div>

    <div id="finalizar-comanda-list" class="flex flex-col gap-2" style="margin-bottom:1rem;">
      <div class="subtext">Carregando itens da comanda...</div>
    </div>

    <div class="dialog-actions" style="justify-content:space-between;">
      <button class="secondary" onclick="closeFinalizarComandaModal()">Voltar</button>
      <button id="finalizar-comanda-confirm" onclick="confirmFinalizarComanda()">Finalizar e registrar pagamento</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script type="module">
  // Funo modular (v9) para iniciar atendimento e abrir comanda automaticamente
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, addDoc, collection, serverTimestamp, arrayUnion, onSnapshot, getDocs, query, where, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Reutiliza app existente ou cria um para este mdulo
  const firebaseConfigAtendimento = {
    apiKey: "AIzaSyBje0Zy_NKLc8tMOIuR4wEc-qHW-9UJsGw",
    authDomain: "gleicef-naildesigner.firebaseapp.com",
    projectId: "gleicef-naildesigner",
    storageBucket: "gleicef-naildesigner.firebasestorage.app",
    messagingSenderId: "670848534218",
    appId: "1:670848534218:web:6cfb3046c1d1e3d5809633",
    measurementId: "G-7M3WX6GK18"
  };
  const atendimentoApp = getApps().length ? getApp() : initializeApp(firebaseConfigAtendimento);
  const atendimentoAuth = getAuth(atendimentoApp);
  const atendimentoDb = getFirestore(atendimentoApp);

  const waitForAuthUser = () =>
    new Promise((resolve) => {
      const current = atendimentoAuth.currentUser;
      if (current) return resolve(current);
      const unsub = onAuthStateChanged(atendimentoAuth, (user) => {
        unsub();
        resolve(user);
      });
    });

  function generateCodigoPareamento() {
    const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    const size = 4 + Math.floor(Math.random() * 3); // 4 a 6 caracteres
    let code = '';
    for (let i = 0; i < size; i++) {
      code += alphabet.charAt(Math.floor(Math.random() * alphabet.length));
    }
    return code;
  }

  /**
   * Inicia um atendimento: cria comanda e atualiza o atendimento.
   * @param {string} atendimentoId
   * @returns {Promise<{atendimentoId:string, comandaId:string, status:string}>}
   */
  async function startAtendimento(atendimentoId, itemInicial = null) {
    if (!atendimentoId) throw new Error("atendimentoId  obrigatrio.");
    const user = await waitForAuthUser();
    if (!user) throw new Error("Usurio no autenticado.");

    // 1) Busca o atendimento
    const atendimentoRef = doc(atendimentoDb, "atendimentos", atendimentoId);
    const atendimentoSnap = await getDoc(atendimentoRef);
    if (!atendimentoSnap.exists()) {
      throw new Error("Atendimento no encontrado.");
    }
    const atendimentoData = atendimentoSnap.data();

    // 2) Prepara itens iniciais (servio agendado)
    const itensProf = [];
    if (itemInicial) {
      itensProf.push({
        itemId: (crypto?.randomUUID ? crypto.randomUUID() : `item-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`),
        origem: "profissional",
        criadoPor: user.uid,
        nome: itemInicial.nome,
        tipo: itemInicial.tipo || "servico",
        preco: Number(itemInicial.preco) || 0,
        quantidade: Number(itemInicial.quantidade) || 1,
        criadoEm: Timestamp.now()
      });
    }

    const codigoPareamento = generateCodigoPareamento();

    // 3) Cria comanda vinculada
    const comandaRef = await addDoc(collection(atendimentoDb, "comandas"), {
      atendimentoId,
      clienteId: atendimentoData.clienteId || null,
      profissionalId: atendimentoData.profissionalId || null,
      status: "aberta",
      itensProfissional: itensProf,
      itensCliente: [],
      codigoPareamento,
      codigoCriadoEm: serverTimestamp(),
      kioskFinalizado: false,
      criadoEm: Timestamp.now(),
      atualizadoEm: serverTimestamp()
    });

    // 4) Atualiza atendimento com status e comandaId
    await updateDoc(atendimentoRef, {
      status: "em_atendimento",
      comandaId: comandaRef.id,
      atualizadoEm: serverTimestamp()
    });

    // 5) Retorna dados para o fluxo continuar
    return {
      atendimentoId,
      comandaId: comandaRef.id,
      status: "em_atendimento",
      codigoPareamento
    };
  }

  const COMANDA_ERRORS = {
    notAuthenticated: 'Usurio no autenticado.',
    notFound: 'Comanda no encontrada.',
    notOpen: 'Comanda no est aberta.',
    invalidItem: 'Dados invlidos do item.'
  };

  /**
   * Adiciona item  comanda ativa pela profissional.
   * @param {string} comandaId
   * @param {{nome:string, tipo:"servico"|"consumo", preco:number, quantidade:number}} item
   * @returns {Promise<object>} comanda atualizada
   */
  async function addItemProfissional(comandaId, item) {
    if (!comandaId) throw new Error("comandaId  obrigatrio.");
    const user = await waitForAuthUser();
    if (!user) throw new Error(COMANDA_ERRORS.notAuthenticated);

    const comandaRef = doc(atendimentoDb, "comandas", comandaId);
    const snap = await getDoc(comandaRef);
    if (!snap.exists()) throw new Error(COMANDA_ERRORS.notFound);
    const data = snap.data();
    if (data.status !== "aberta") throw new Error(COMANDA_ERRORS.notOpen);

    // Validao do item
    if (!item?.nome || typeof item.nome !== 'string' || !item.nome.trim()) {
      throw new Error(COMANDA_ERRORS.invalidItem + ' (nome obrigatrio)');
    }
    if (item.tipo !== 'servico' && item.tipo !== 'consumo') {
      throw new Error(COMANDA_ERRORS.invalidItem + ' (tipo invlido)');
    }
    const qtd = Number(item.quantidade);
    if (!Number.isFinite(qtd) || qtd <= 0) {
      throw new Error(COMANDA_ERRORS.invalidItem + ' (quantidade > 0)');
    }
    const preco = Number(item.preco);
    if (!Number.isFinite(preco) || preco < 0) {
      throw new Error(COMANDA_ERRORS.invalidItem + ' (preo >= 0)');
    }

    const newItem = {
      itemId: (crypto?.randomUUID ? crypto.randomUUID() : `item-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`),
      origem: "profissional",
      criadoPor: user.uid,
      nome: item.nome,
      tipo: item.tipo,
      preco,
      quantidade: qtd,
      criadoEm: Timestamp.now()
    };

    await updateDoc(comandaRef, {
      itensProfissional: arrayUnion(newItem),
      atualizadoEm: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    // Retorno simples (UI deve ser snapshot-driven)
    return { ok: true, comandaId };
  }

  async function kioskFetchComandaByCodigo(codigoPareamento) {
    if (!codigoPareamento) return null;
    const sanitized = codigoPareamento.trim().toUpperCase();
    const q = query(
      collection(atendimentoDb, "comandas"),
      where("codigoPareamento", "==", sanitized),
      where("status", "==", "aberta"),
      limit(1)
    );
    const snap = await getDocs(q);
    if (snap.empty) return null;
    return snap.docs[0].id;
  }

  async function kioskAddItem(comandaId, item) {
    if (!comandaId) throw new Error("comandaId  obrigatrio.");
    const comandaRef = doc(atendimentoDb, "comandas", comandaId);
    const snap = await getDoc(comandaRef);
    if (!snap.exists()) throw new Error(COMANDA_ERRORS.notFound);
    const data = snap.data();
    if (data.status !== "aberta") throw new Error(COMANDA_ERRORS.notOpen);
    if (data.kioskFinalizado) throw new Error("Consumo j finalizado pelo kiosk.");

    if (!item?.nome || typeof item.nome !== 'string' || !item.nome.trim()) {
      throw new Error(COMANDA_ERRORS.invalidItem + ' (nome obrigatrio)');
    }
    const qtd = Number(item.quantidade || 1);
    const preco = Number(item.preco || 0);
    const tipo = item.tipo === 'consumo' ? 'consumo' : 'servico';
    if (!Number.isFinite(qtd) || qtd <= 0) throw new Error(COMANDA_ERRORS.invalidItem + ' (quantidade > 0)');
    if (!Number.isFinite(preco) || preco < 0) throw new Error(COMANDA_ERRORS.invalidItem + ' (preo >= 0)');

    const newItem = {
      itemId: (crypto?.randomUUID ? crypto.randomUUID() : `item-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`),
      origem: "cliente",
      nome: item.nome,
      tipo,
      preco,
      quantidade: qtd,
      criadoEm: Timestamp.now(),
      estoqueId: item.estoqueId || item.stockId || null,
      categoriaEstoque: item.categoriaEstoque || null
    };

    await updateDoc(comandaRef, {
      itensCliente: arrayUnion(newItem),
      atualizadoEm: serverTimestamp()
    });

    return { ok: true, comandaId };
  }

  async function kioskFinalizarConsumo(comandaId, itens = []) {
    if (!comandaId) throw new Error("comandaId  obrigatrio.");
    const comandaRef = doc(atendimentoDb, "comandas", comandaId);
    const snap = await getDoc(comandaRef);
    if (!snap.exists()) throw new Error(COMANDA_ERRORS.notFound);
    const data = snap.data();
    if (data.status !== "aberta") throw new Error(COMANDA_ERRORS.notOpen);
    if (data.kioskFinalizado) throw new Error("Consumo j finalizado pelo kiosk.");

    const parsedItems = (itens || [])
      .filter(Boolean)
      .map((item) => ({
        nome: item.nome,
        tipo: item.tipo === 'consumo' ? 'consumo' : 'servico',
        preco: Number(item.preco) || 0,
        quantidade: Number(item.quantidade) || 1,
        estoqueId: item.estoqueId || item.stockId || null,
        categoriaEstoque: item.categoriaEstoque || null
      }))
      .filter(it => it.nome && Number.isFinite(it.preco) && Number.isFinite(it.quantidade));

    if (parsedItems.length) {
      await updateDoc(comandaRef, {
        itensCliente: arrayUnion(
          ...parsedItems.map(it => ({
            itemId: (crypto?.randomUUID ? crypto.randomUUID() : `item-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`),
            origem: "cliente",
            nome: it.nome,
            tipo: it.tipo,
            preco: it.preco,
            quantidade: it.quantidade,
            criadoEm: Timestamp.now(),
            estoqueId: it.estoqueId || it.stockId || null,
            categoriaEstoque: it.categoriaEstoque || null
          }))
        ),
        kioskFinalizado: true,
        atualizadoEm: serverTimestamp()
      });
    } else {
      await updateDoc(comandaRef, { kioskFinalizado: true, atualizadoEm: serverTimestamp() });
    }

    return { ok: true, comandaId };
  }

  /**
   * Escuta comanda em tempo real e retorna unsubscribe.
   * @param {string} comandaId
   * @param {(data: object) => void} callback
   */
  function listenComanda(comandaId, callback) {
    const comandaRef = doc(atendimentoDb, "comandas", comandaId);
    return onSnapshot(comandaRef, (snap) => {
      if (snap.exists()) callback({ id: snap.id, ...snap.data() });
    });
  }

  // Disponibiliza no escopo global para uso no restante do app
  window.startAtendimento = startAtendimento;
  window.addItemProfissional = addItemProfissional;
  window.kioskFetchComandaByCodigo = kioskFetchComandaByCodigo;
  window.kioskAddItem = kioskAddItem;
  window.kioskFinalizarConsumo = kioskFinalizarConsumo;
  window.listenComanda = listenComanda;
</script>
<script>
  // -----------------------------
  // ESTADO GLOBAL (simples)
  // -----------------------------
  let currentRole = null; // 'ceo' | 'colab' | 'kiosk'
  let currentPageCEO = 'dashboard';
  let currentPageColab = 'dashboard';
  let appInitialized = false;
  let currentColabAccount = null;
  let currentInventoryTab = 'esmaltes';
  let currentEditingCollabIndex = null;
  let currentCommissionIndex = null;
  let currentCollabStatusIndex = null;
  let currentEditingServiceId = null;
  let currentClientDetailId = null;
  let activeClientTab = 'data';
  let appointmentPrefillClient = null;
  let appointmentPrefillDate = null;
  let appointmentPrefillTime = null;
  let appointmentOpenedFromDayModal = false;
  let appointmentFormMode = 'add';
  let appointmentEditingId = null;
  let pendingRemoveAppointmentId = null;
  let dayModalDate = null;
  let dayModalScope = 'ceo';
  let agendaProfessionalFilter = 'all';
  let agendaProfessionalFilterColab = 'all';
  let fabMenuOpen = false;
  let fabScrollLast = 0;

  const getCssVar = (key, fallback = '') => {
    const val = getComputedStyle(document.documentElement).getPropertyValue(key);
    return val ? val.trim() : fallback;
  };

  const firebaseConfig = {
    apiKey: "AIzaSyBje0Zy_NKLc8tMOIuR4wEc-qHW-9UJsGw",
    authDomain: "gleicef-naildesigner.firebaseapp.com",
    projectId: "gleicef-naildesigner",
    storageBucket: "gleicef-naildesigner.firebasestorage.app",
    messagingSenderId: "670848534218",
    appId: "1:670848534218:web:6cfb3046c1d1e3d5809633",
    measurementId: "G-7M3WX6GK18"
  };

  let firebaseApp = null;
  let firestore = null;
  let firebaseAuth = null;
  let currentUserDoc = null;
  let globalMonthUnsub = null;
  let authListenerAttached = false;

  const adminOverrides = {
    'mJ3hkcBr5kT83iTgJROR811X0WP2': {
      role: 'CEO',
      name: 'Gleice',
      permissions: { agenda: true, comissoes: true },
      status: 'active'
    }
  };

  const calendarYear = 2025;
  const monthNamesFull = ['Janeiro', 'Fevereiro', 'Maro', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  const monthNamesShort = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  const baseYearDetailed = monthNamesFull.map((fullName, idx) => ({
    monthIndex: idx,
    month: monthNamesShort[idx],
    fullName,
    tags: []
  }));
  let selectedMonthIndex = new Date().getMonth();
  let selectedMonthIndexColab = new Date().getMonth();
  let agendaViewMode = 'year';
  let agendaViewModeColab = 'year';
  const agendaSummaryTab = { ceo: 'month', colab: 'month' };
  const agendaDaySelectedDate = {
    ceo: new Date().toISOString().split('T')[0],
    colab: new Date().toISOString().split('T')[0]
  };
  let selectedDashboardMonth = new Date().getMonth();
  let selectedDashboardYear = new Date().getFullYear();
  let selectedGlobalMonthKey = 'all';

  let stockItems = [];
  let productTemplates = [];
  let stockHistories = {};
  const chartInstances = {};

  let inventoryFormMode = 'add';
  let inventoryEditingId = null;
  let currentInventoryCategory = 'esmaltes';
  let templateEditingId = null;
  let pendingRemoveStockId = null;
  let pendingExitStockId = null;

  const monthlyDashboardStats = [];

  const financialEntries = [];

  let investments = [];
  const investmentHistoryStore = {};

  let collaborators = [];

  let collaboratorAccounts = [];

  let clients = [];

  let currentClientEditingId = null;
  let pendingRemoveClientId = null;

  let appointments = [];

  function formatCurrency(value) {
    return 'R$ ' + Number(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }

  function formatDateLabel(dateStr) {
    if (!dateStr) return 'data a combinar';
    const [y, m, d] = dateStr.split('-');
    if (!y || !m || !d) return dateStr;
    return `${d}/${m}/${y}`;
  }

  function slugify(value = '') {
    return value
      .toString()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      || 'ref';
  }

  function findCollaboratorByIdOrName(value) {
    if (!value) return null;
    const lowered = value.toLowerCase();
    return collaborators.find(c => c.id === lowered || c.username === lowered || c.name.toLowerCase() === lowered) || null;
  }

  async function persistCollaborator(collab) {
    try {
      initFirebaseApp();
      if (!firestore || !collab) return;
      const docId = collab.id || slugify(collab.username || collab.name || `colab-${Date.now()}`);
      const payload = { ...collab, id: docId };
      await firestore.collection('collaborators').doc(docId).set(payload, { merge: true });
    } catch (err) {
      console.warn('Falha ao salvar colaboradora', err);
    }
  }

  async function persistCollaboratorAccount(account) {
    try {
      initFirebaseApp();
      if (!firestore || !account) return;
      const docId = account.id || slugify(account.username || account.name || `acc-${Date.now()}`);
      const payload = { ...account, id: docId };
      await firestore.collection('collaboratorAccounts').doc(docId).set(payload, { merge: true });
    } catch (err) {
      console.warn('Falha ao salvar login dedicado', err);
    }
  }

  function findServiceByIdOrName(value) {
    if (!value) return null;
    const lowered = value.toLowerCase();
    return kioskServices.find(s => s.id === lowered || s.name.toLowerCase() === lowered) || null;
  }

  function getProfessionalKey(appt) {
    return (appt.professionalId || slugify(appt.professionalName || appt.professional || ''))?.toLowerCase();
  }

  // -------- Persistncia bsica (Firestore compat) --------
  async function persistClient(client) {
    try {
      initFirebaseApp();
      if (!firestore || !client?.id) return;
      await firestore.collection('clients').doc(client.id).set(client, { merge: true });
    } catch (err) {
      console.warn('Falha ao salvar cliente', err);
    }
  }

  async function persistService(service) {
    try {
      initFirebaseApp();
      if (!firestore || !service?.id) return;
      await firestore.collection('services').doc(service.id).set(service, { merge: true });
    } catch (err) {
      console.warn('Falha ao salvar servio', err);
    }
  }

  async function persistAppointment(appt) {
    try {
      initFirebaseApp();
      if (!firestore || !appt?.id) return;
      await firestore.collection('atendimentos').doc(appt.id).set(appt, { merge: true });
    } catch (err) {
      console.warn('Falha ao salvar atendimento', err);
    }
  }

  function buildWhatsAppLink(client, payload = {}) {
    const number = (client.phone || '').replace(/\D/g, '') || '55';
    const appt = payload.appointment || client.nextAppointment || {};
    const service = payload.service || appt.serviceName || appt.service || client.lastService || 'seu atendimento';
    const dateLabel = payload.dateLabel || (appt.date ? formatDateLabel(appt.date) : (client.lastDate || 'data a combinar'));
    const time = payload.time || appt.time || 'horrio a combinar';
    const text = `Ol, tudo bem? Seu agendamento para ${service} est confirmado para o dia ${dateLabel} s ${time}. Qualquer ajuste necessrio, estou  disposio.`;
    return `https://wa.me/${number}?text=${encodeURIComponent(text)}`;
  }

  function setupMonthSelects() {
    const agendaSelect = document.getElementById('agenda-month-selector');
    const agendaSelectColab = document.getElementById('agenda-month-selector-colab');
    const fillSelect = (selectEl) => {
      if (selectEl && selectEl.options.length === 0) {
        baseYearDetailed.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.monthIndex;
          opt.textContent = m.fullName;
          selectEl.appendChild(opt);
        });
      }
    };
    fillSelect(agendaSelect);
    fillSelect(agendaSelectColab);
    if (agendaSelect) agendaSelect.value = selectedMonthIndex;
    if (agendaSelectColab) agendaSelectColab.value = selectedMonthIndexColab;
    updateGlobalMonthLabel();
  }

  let kioskDrinks = [];

  let kioskServices = [];

  function normalizeAppointmentsData() {
    appointments = appointments.map(appt => {
      const fallbackClientId = appt.clientId || (appt.clientName ? `cli-${slugify(appt.clientName)}` : `cli-${Date.now()}-${Math.random().toString(16).slice(2, 6)}`);
      let client = clients.find(c => c.id === fallbackClientId);
      if (!client) {
        client = {
          id: fallbackClientId,
          name: appt.clientName || appt.client || 'Cliente',
          phone: appt.phone || '55',
          owners: [],
          responsible: '',
          history: [],
          consume: [],
          future: [],
          nextAppointment: {}
        };
        clients.push(client);
      }

      const service = findServiceByIdOrName(appt.serviceId || appt.serviceName || appt.service);
      const professional = findCollaboratorByIdOrName(appt.professionalId || appt.professionalName || appt.professional);
      const professionalName = professional?.name || appt.professionalName || appt.professional || 'Equipe';
      const professionalId = professional?.id || slugify(professionalName);
      const serviceName = service?.name || appt.serviceName || appt.service || 'Servio';
      const serviceId = service?.id || slugify(serviceName);
      const status = appt.status || 'scheduled';
      const createdAt = appt.createdAt || new Date().toISOString();
      const updatedAt = appt.updatedAt || createdAt;
      const time = appt.time || '00:00';
      const normalizedId = appt.id || `appt-${Date.now()}-${Math.random().toString(16).slice(2, 7)}`;

      client.name = client.name || appt.clientName || 'Cliente';
      client.owners = client.owners || [];
      if (professionalName && !client.owners.includes(professionalName)) client.owners.push(professionalName);
      if (!client.responsible) client.responsible = professionalName;

      return {
        ...appt,
        id: normalizedId,
        clientId: client.id,
        clientName: client.name,
        professionalId,
        professionalName,
        professional: professionalName,
        serviceId,
        serviceName,
        service: serviceName,
        status,
        date: appt.date,
        time,
        notes: appt.notes || '',
        createdAt,
        updatedAt
      };
    });
  }

  let cart = [];
  let kioskComandaId = null;
  let kioskComandaStatus = 'desconectado';
  let kioskComandaUnsub = null;
  let kioskComandaData = null;

  // -----------------------------
  // AUTENTICAO E TROCA DE PAPEL
  // -----------------------------
  function openKioskDirect() {
    setRole('kiosk');
  }

  async function resolveLoginEmail(identifier) {
    if (!identifier) return null;
    if (identifier.includes('@')) return identifier;
    initFirebaseApp();
    if (!firestore) return null;
    const snap = await firestore
      .collection('users')
      .where('username', '==', identifier)
      .limit(1)
      .get()
      .catch(() => null);
    if (!snap || snap.empty) return null;
    const data = snap.docs[0].data();
    return data?.email || null;
  }

  async function fetchUserDoc(uid) {
    if (!uid || !firestore) return null;
    const docRef = firestore.collection('users').doc(uid);
    const doc = await docRef.get().catch(() => null);
    const override = adminOverrides[uid];

    if (doc?.exists) {
      const data = { id: uid, ...doc.data() };
      if (override && (data.role || '').toUpperCase() !== 'CEO') {
        const merged = { ...data, ...override };
        await docRef.set(merged, { merge: true });
        return merged;
      }
      return data;
    }

    if (override) {
      const defaultDoc = { ...override, createdAt: new Date().toISOString() };
      await docRef.set(defaultDoc, { merge: true });
      return { id: uid, ...defaultDoc };
    }

    return null;
  }

  function applyUserRole(userData) {
    currentUserDoc = userData;
    if (!appInitialized) {
      postLoginInit();
      appInitialized = true;
    }
    const role = (userData?.role || '').toUpperCase() === 'CEO' ? 'ceo' : 'colab';
    const account = role === 'colab' ? { id: userData.id, name: userData.name || userData.username } : null;
    setRole(role, account);
  }

  async function handleEmailLogin() {
    const identifier = document.getElementById('login-identifier').value.trim();
    const password = document.getElementById('login-password').value.trim();
    if (!identifier || !password) {
      alert('Informe usurio/email e senha.');
      return;
    }
    initFirebaseApp();
    const email = await resolveLoginEmail(identifier);
    if (!email) {
      alert('No encontramos esse usurio/email.');
      return;
    }
    try {
      const cred = await firebaseAuth.signInWithEmailAndPassword(email, password);
      const userData = await fetchUserDoc(cred.user.uid);
      if (!userData) {
        alert('Conta sem perfil configurado no Firestore.');
        return;
      }
      applyUserRole(userData);
    } catch (err) {
      alert('Falha no login. Confira as credenciais.');
    }
  }

  async function handleGoogleLogin() {
    initFirebaseApp();
    if (!firebaseAuth) return;
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const cred = await firebaseAuth.signInWithPopup(provider);
      const data = await fetchUserDoc(cred.user.uid);
      if (!data || (data.role || '').toUpperCase() !== 'CEO') {
        await firebaseAuth.signOut();
        alert('Apenas CEO pode usar login Google.');
        return;
      }
      applyUserRole(data);
    } catch (err) {
      alert('Login Google cancelado ou invlido.');
    }
  }

  function handleLogout() {
    initFirebaseApp();
    if (firebaseAuth) {
      firebaseAuth.signOut().catch(() => {});
    }
    backToLogin();
  }

  function postLoginInit() {
    initFirebaseApp();
    buildGlobalMonthOptions();
    listenGlobalMonth();
    subscribeCoreCollections();
    refreshMonthlyConsumers();
  }

  function attachAuthListener() {
    initFirebaseApp();
    if (!firebaseAuth || authListenerAttached) return;
    authListenerAttached = true;
    firebaseAuth.onAuthStateChanged(async (user) => {
      if (user) {
        const data = await fetchUserDoc(user.uid);
        if (data) {
          applyUserRole(data);
          document.getElementById('login-screen')?.classList.add('hidden');
          document.getElementById('app-shell')?.classList.remove('hidden');
        }
      }
    });
  }

  function subscribeCoreCollections() {
    if (!firestore) return;
    firestore.collection('collaborators').onSnapshot(snap => {
      collaborators = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderCollaborators();
    });
    firestore.collection('collaboratorAccounts').onSnapshot(snap => {
      collaboratorAccounts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    });
    // Atendimentos (agenda)
    firestore.collection('atendimentos').onSnapshot(snap => {
      appointments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      normalizeAppointmentsData();
      refreshAgendaFromAppointments();
    });
    // Clientes
    firestore.collection('clients').onSnapshot(snap => {
      clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderClients('ceo');
      renderClients('colab');
    });
    // Servios
    firestore.collection('services').onSnapshot(snap => {
      kioskServices = snap.docs.map(d => ({
        id: d.id,
        name: d.data().name || d.data().nome || 'Servio',
        price: d.data().price || d.data().valor || 0,
        duration: d.data().duration || d.data().duracao || '',
        icon: d.data().icon || ''
      }));
      renderServicesTable();
      renderKiosk();
    });
    firestore.collection('investments').onSnapshot(snap => {
      investments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInvestments();
      renderDashboardCards();
      buildGlobalMonthOptions();
    });
    firestore.collection('financial').onSnapshot(snap => {
      const mapped = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      financialEntries.splice(0, financialEntries.length, ...mapped);
      renderFinance();
      renderDashboardCards();
      buildGlobalMonthOptions();
    });
    firestore.collection('productTemplates').onSnapshot(snap => {
      productTemplates = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInventoryTemplates();
    });
    firestore.collection('stock').onSnapshot(snap => {
      stockItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      stockItems.forEach(item => attachStockHistoryListener(item.id));
      renderInventory();
      renderDashboardCards();
      buildGlobalMonthOptions();
    });
  }

  // -----------------------------
  // TROCA DE PAPEL / TELAS
  // -----------------------------
  function setRole(role, account = null) {
    currentRole = role;
    if (role === 'colab') {
      currentColabAccount = account;
      agendaProfessionalFilterColab = account?.id || slugify(account?.name || '') || 'all';
    } else {
      currentColabAccount = null;
      agendaProfessionalFilterColab = 'all';
    }
    if (role === 'ceo') agendaProfessionalFilter = 'all';

    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('kiosk-screen').classList.add('hidden');

    if (role === 'ceo' || role === 'colab') {
      document.getElementById('app-shell').classList.remove('hidden');
      setupSidebar(role);
      updateRoleLabel(role);
      updateVisiblePage();
      resetKioskSession();
    } else if (role === 'kiosk') {
      document.getElementById('kiosk-screen').classList.remove('hidden');
      resetKioskSession();
      renderKiosk();
    }

    refreshFab();
  }

  function backToLogin() {
    currentRole = null;
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('kiosk-screen').classList.add('hidden');
  }

  function openKioskFromDashboard() {
    setRole('kiosk');
  }

  function openCollaboratorLogin(username) {
    backToLogin();
    const account = collaboratorAccounts.find(acc => acc.username === username);
    const idInput = document.getElementById('login-identifier');
    const passInput = document.getElementById('login-password');
    if (account && idInput && passInput) {
      idInput.value = account.username || account.email || '';
      passInput.value = account.password || '';
    }
  }

  function createCollaboratorAccount() {
    const name = document.getElementById('new-colab-name').value.trim();
    const username = document.getElementById('new-colab-username').value.trim();
    const password = document.getElementById('new-colab-password').value.trim();
    const permissions = document.getElementById('new-colab-permissions').value.trim();

    if (!name || !username || !password) {
      alert('Preencha nome, usurio e senha para criar o acesso.');
      return;
    }

    collaboratorAccounts.push({ name, username, password, permissions, device: 'Tablet dedicado' });
    const collabObj = { name, username, role: 'Colaboradora', commission: '40% servios', permissions: permissions || 'Agenda compartilhada, comisses', color: getCssVar('--chart-gold', '#B7A06A') };
    collaborators.push(collabObj);
    persistCollaborator(collabObj);
    persistCollaboratorAccount({ name, username, password, permissions, device: 'Tablet dedicado' });

    renderCollaborators();
    document.getElementById('new-colab-name').value = '';
    document.getElementById('new-colab-username').value = '';
    document.getElementById('new-colab-password').value = '';
    document.getElementById('new-colab-permissions').value = '';
    closeDialog('login-dedicated-modal');
    alert(`Login criado para ${name}. Usurio: ${username} | Senha: ${password}`);
  }

  function openDedicatedLoginModal(name = '') {
    document.getElementById('new-colab-name').value = name || '';
    document.getElementById('new-colab-username').value = name ? name.toLowerCase() : '';
    document.getElementById('new-colab-password').value = '';
    document.getElementById('new-colab-permissions').value = '';
    openDialog('login-dedicated-modal');
  }

  function openCollabAddModal() {
    document.getElementById('add-collab-name').value = '';
    document.getElementById('add-collab-role').value = 'Colaboradora';
    document.getElementById('add-collab-commission').value = '40% servios';
    document.getElementById('add-collab-email').value = '';
    document.getElementById('add-collab-login').value = '';
    document.getElementById('add-collab-password').value = '';
    document.getElementById('add-collab-perm-agenda').checked = true;
    document.getElementById('add-collab-perm-comissao').checked = true;
    openDialog('add-collab-modal');
  }

  async function saveNewCollaborator() {
    const name = document.getElementById('add-collab-name').value.trim();
    const role = document.getElementById('add-collab-role').value.trim() || 'Colaboradora';
    const commission = document.getElementById('add-collab-commission').value.trim() || '40% servios';
    const email = document.getElementById('add-collab-email').value.trim();
    const username = document.getElementById('add-collab-login').value.trim();
    const password = document.getElementById('add-collab-password').value.trim();
    const permAgenda = document.getElementById('add-collab-perm-agenda').checked;
    const permComissao = document.getElementById('add-collab-perm-comissao').checked;
    if (!name || !email || !password) {
      alert('Preencha nome, email e senha para criar a colaboradora.');
      return;
    }
    const palette = [
      getCssVar('--pastel-rose', '#F4D9D2'),
      getCssVar('--pastel-peach', '#F6E4D6'),
      getCssVar('--pastel-green', '#E6EFE6'),
      getCssVar('--chart-gold', '#B7A06A')
    ];
    const color = palette[Math.floor(Math.random() * palette.length)];
    const permissions = {
      agenda: permAgenda,
      comissoes: permComissao
    };
    const collaboratorDoc = {
      name,
      role: 'COLAB',
      commission,
      permissions,
      username,
      email,
      status: 'active',
      createdBy: currentUserDoc?.id || 'ceo',
      createdAt: new Date().toISOString(),
    };

    try {
      initFirebaseApp();
      if (firebaseAuth && firestore) {
        const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
        await firestore.collection('users').doc(cred.user.uid).set(collaboratorDoc, { merge: true });
        const colId = cred.user.uid;
        collaboratorAccounts.push({ name, username: username || email, password, permissions: 'Agenda compartilhada, comisses', device: 'Tablet dedicado', email, id: colId });
        const collabObj = { id: colId, name, role, commission, permissions: 'Agenda compartilhada, comisses', username, color, active: true, email };
        collaborators.push(collabObj);
        await persistCollaborator(collabObj);
        await persistCollaboratorAccount({ name, username: username || email, password, permissions: 'Agenda compartilhada, comisses', device: 'Tablet dedicado', email, id: colId });
      }
    } catch (err) {
      const fallbackId = `colab-${Date.now()}`;
      const collabObj = { id: fallbackId, name, role, commission, permissions: 'Agenda compartilhada, comisses', username, color, active: true, email };
      collaborators.push(collabObj);
      collaboratorAccounts.push({ name, username: username || email, password, permissions: 'Agenda compartilhada, comisses', device: 'Tablet dedicado', email, id: fallbackId });
      await persistCollaborator(collabObj);
      await persistCollaboratorAccount({ name, username: username || email, password, permissions: 'Agenda compartilhada, comisses', device: 'Tablet dedicado', email, id: fallbackId });
    }

    renderCollaborators();
    closeDialog('add-collab-modal');
  }

  function openEditCollab(index) {
    currentEditingCollabIndex = index;
    const col = collaborators[index];
    document.getElementById('edit-collab-name').value = col.name;
    document.getElementById('edit-collab-role').value = col.role;
    document.getElementById('edit-collab-login').value = col.username || '';
    document.getElementById('perm-agenda').checked = col.permissions?.toLowerCase().includes('agenda');
    document.getElementById('perm-estoque').checked = col.permissions?.toLowerCase().includes('estoque');
    document.getElementById('perm-comissao').checked = col.permissions?.toLowerCase().includes('comisso') || col.permissions?.toLowerCase().includes('comissao');
    openDialog('edit-collab-modal');
  }

  function saveCollaboratorProfile() {
    if (currentEditingCollabIndex === null) return;
    const name = document.getElementById('edit-collab-name').value.trim();
    const role = document.getElementById('edit-collab-role').value.trim();
    const username = document.getElementById('edit-collab-login').value.trim();
    const permissions = [
      document.getElementById('perm-agenda').checked ? 'Agenda' : null,
      document.getElementById('perm-estoque').checked ? 'Estoque' : null,
      document.getElementById('perm-comissao').checked ? 'Comisso' : null,
    ].filter(Boolean).join(', ');
    const updated = { ...collaborators[currentEditingCollabIndex], name: name || collaborators[currentEditingCollabIndex].name, role: role || 'Colaboradora', username, permissions: permissions || 'Permisses ajustadas no perfil' };
    collaborators[currentEditingCollabIndex] = updated;
    const accountIdx = collaboratorAccounts.findIndex(acc => acc.name === updated.name || acc.username === updated.username);
    if (accountIdx >= 0) {
      collaboratorAccounts[accountIdx] = { ...collaboratorAccounts[accountIdx], name: updated.name, username: updated.username, permissions: updated.permissions };
      persistCollaboratorAccount(collaboratorAccounts[accountIdx]);
    }
    persistCollaborator(updated);
    renderCollaborators();
    closeDialog('edit-collab-modal');
  }

  function openCommissionModal(index) {
    currentCommissionIndex = index;
    const value = parseInt(collaborators[index].commission, 10) || 0;
    document.getElementById('commission-value').value = value;
    openDialog('commission-modal');
  }

  function saveCommission() {
    if (currentCommissionIndex === null) return;
    const value = parseInt(document.getElementById('commission-value').value, 10) || 0;
    collaborators[currentCommissionIndex].commission = `${value}% servios`;
    persistCollaborator(collaborators[currentCommissionIndex]);
    renderCollaborators();
    closeDialog('commission-modal');
  }

  function openCollabStatusModal(index, wantsRemove = false) {
    currentCollabStatusIndex = index;
    const col = collaborators[index];
    const toggleBtn = document.getElementById('collab-status-toggle');
    const textEl = document.getElementById('collab-status-text');
    if (toggleBtn) toggleBtn.textContent = col.active ? 'Desativar' : 'Reativar';
    if (textEl) textEl.textContent = `${col.name}  ${col.role}`;
    const removeBtn = document.querySelector('#collab-status-modal button[onclick="removeCollaborator()"]');
    if (removeBtn) removeBtn.dataset.triggerRemove = wantsRemove ? 'true' : 'false';
    openDialog('collab-status-modal');
    if (wantsRemove && removeBtn) removeBtn.focus();
  }

  function confirmDeactivateCollaborator() {
    if (currentCollabStatusIndex === null) return;
    collaborators[currentCollabStatusIndex].active = !collaborators[currentCollabStatusIndex].active;
    renderCollaborators();
    closeDialog('collab-status-modal');
    currentCollabStatusIndex = null;
  }

  function removeCollaborator() {
    if (currentCollabStatusIndex === null) return;
    const removed = collaborators.splice(currentCollabStatusIndex, 1)[0];
    collaboratorAccounts = collaboratorAccounts.filter(acc => acc.name !== removed.name && acc.username !== removed.username);
    renderCollaborators();
    closeDialog('collab-status-modal');
    currentCollabStatusIndex = null;
  }

  function openClientModal(mode = 'add', clientId = null) {
    const isEdit = mode === 'edit';
    currentClientEditingId = isEdit ? clientId : null;
    const client = isEdit ? clients.find(c => c.id === clientId) : null;
    const title = document.getElementById('client-form-title');
    const save = document.getElementById('client-form-save');
    const fields = {
      id: document.getElementById('client-id'),
      name: document.getElementById('client-name'),
      phone: document.getElementById('client-phone'),
      instagram: document.getElementById('client-instagram'),
      birthday: document.getElementById('client-birthday'),
      prefColor: document.getElementById('client-pref-color'),
      prefShape: document.getElementById('client-pref-shape'),
      prefExtension: document.getElementById('client-pref-extension'),
      allergies: document.getElementById('client-allergies'),
      notes: document.getElementById('client-notes'),
      responsible: document.getElementById('client-responsible')
    };

    if (fields.responsible) {
      fields.responsible.innerHTML = '';
      if (!collaborators.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Defina um responsvel';
        fields.responsible.appendChild(opt);
      } else {
        collaborators.forEach(col => {
          const opt = document.createElement('option');
          opt.value = col.name;
          opt.textContent = col.name;
          fields.responsible.appendChild(opt);
        });
      }
    }

    if (title) title.textContent = isEdit ? 'Editar cliente' : 'Adicionar cliente';
    if (save) save.textContent = isEdit ? 'Salvar alteraes' : 'Salvar cliente';

    if (fields.id) fields.id.value = client?.id || '';
    if (fields.name) fields.name.value = client?.name || '';
    if (fields.phone) fields.phone.value = client?.phone || '';
    if (fields.instagram) fields.instagram.value = client?.instagram || '';
    if (fields.birthday) fields.birthday.value = client?.birthday || '';
    if (fields.prefColor) fields.prefColor.value = client?.prefColor || '';
    if (fields.prefShape) fields.prefShape.value = client?.prefShape || '';
    if (fields.prefExtension) fields.prefExtension.value = client?.prefExtension || '';
    if (fields.allergies) fields.allergies.value = client?.allergies || '';
    if (fields.notes) fields.notes.value = client?.notes || '';
    const responsibleFallback = currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : (collaborators[0]?.name || '');
    if (fields.responsible) fields.responsible.value = client?.responsible || responsibleFallback;

    openDialog('client-form-modal');
  }

  async function saveClient() {
    const name = document.getElementById('client-name').value.trim();
    const phone = document.getElementById('client-phone').value.trim();
    if (!name || !phone) return;
    const instagram = document.getElementById('client-instagram').value.trim();
    const birthday = document.getElementById('client-birthday').value;
    const prefColor = document.getElementById('client-pref-color').value.trim();
    const prefShape = document.getElementById('client-pref-shape').value.trim();
    const prefExtension = document.getElementById('client-pref-extension').value.trim();
    const allergies = document.getElementById('client-allergies').value.trim();
    const notes = document.getElementById('client-notes').value.trim();
    const responsible = document.getElementById('client-responsible').value;
    const existingId = document.getElementById('client-id').value || currentClientEditingId;
    const owner = responsible || (currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : 'Glecie');

    if (existingId) {
      const target = clients.find(c => c.id === existingId);
      if (target) {
        Object.assign(target, {
          name,
          phone,
          instagram,
          birthday,
          prefColor,
          prefShape,
          prefExtension,
          allergies,
          notes,
          responsible: owner
        });
        if (!target.owners.includes(owner)) target.owners.push(owner);
        await persistClient(target);
      }
    } else {
      const newClient = {
        id: `cli-${Date.now()}`,
        name,
        phone,
        instagram,
        birthday,
        prefColor,
        prefShape,
        prefExtension,
        allergies,
        responsible: owner,
        lastService: 'Novo cadastro',
        lastDate: '',
        owners: [owner],
        notes,
        extra: '',
        history: [],
        consume: [],
        future: [],
        nextAppointment: {}
      };
      clients.push(newClient);
      await persistClient(newClient);
    }

    renderClients('ceo');
    renderClients('colab');
    closeDialog('client-form-modal');
    currentClientEditingId = null;
  }

  function openClientDetails(id) {
    currentClientDetailId = id;
    activeClientTab = 'data';
    const client = clients.find(c => c.id === id);
    const nameEl = document.getElementById('client-detail-name');
    const phoneEl = document.getElementById('client-detail-phone');
    if (nameEl) nameEl.textContent = client?.name || 'Cliente';
    if (phoneEl && client) phoneEl.innerHTML = `<a href="${buildWhatsAppLink(client)}" target="_blank" rel="noopener">${client.phone}</a>`;
    document.querySelectorAll('.client-detail-tabs button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-detail-data').classList.add('active');
    renderClientDetailTab();
    openDialog('client-detail-modal');
  }

  function switchClientTab(tab) {
    activeClientTab = tab;
    document.querySelectorAll('.client-detail-tabs button').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(`tab-detail-${tab}`);
    if (btn) btn.classList.add('active');
    renderClientDetailTab();
  }

  function renderClientDetailTab() {
    const container = document.getElementById('client-detail-content');
    if (!container) return;
    const client = clients.find(c => c.id === currentClientDetailId);
    if (!client) return;
    if (activeClientTab === 'data') {
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Informaes</h4>
          <div class="client-detail-list">
            <span>Telefone: <a href="${buildWhatsAppLink(client)}" target="_blank" rel="noopener">${client.phone}</a></span>
            <span>Instagram: ${client.instagram || ''}</span>
            <span>Aniversrio: ${client.birthday || ''}</span>
            <span>Preferncias: ${client.prefColor || ''}  ${client.prefShape || ''}  ${client.prefExtension || ''}</span>
            <span>Alergias: ${client.allergies || ''}</span>
            <span>Responsvel: ${client.responsible || (client.owners || ['Equipe'])[0]}</span>
            <span>Observaes: ${client.notes || ''}</span>
            <span>Extras: ${client.extra || ''}</span>
            <span>ltimo servio: ${client.lastService || ''} ${client.lastDate ? '(' + client.lastDate + ')' : ''}</span>
          </div>
        </div>
      `;
    }

    if (activeClientTab === 'history') {
      const hist = (client.history || []).map(h => `<li>${h}</li>`).join('') || '<li>Sem histrico</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Histrico de servios</h4>
          <ul class="client-detail-list">${hist}</ul>
        </div>
      `;
    }

    if (activeClientTab === 'consume') {
      const cons = (client.consume || []).map(h => `<li>${h}</li>`).join('') || '<li>Sem consumos</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Consumos no Studio</h4>
          <ul class="client-detail-list">${cons}</ul>
        </div>
      `;
    }

    if (activeClientTab === 'future') {
      const fut = (client.future || []).map(f => `<li>${formatDateLabel(f.date)}  ${f.time}  ${f.serviceName || f.service} (${f.professionalName || f.professional || 'Equipe'})</li>`).join('') || '<li>Nenhum agendamento futuro</li>';
      container.innerHTML = `
        <div class="client-detail-section">
          <h4>Prximos horrios</h4>
          <ul class="client-detail-list">${fut}</ul>
          <button class="secondary" style="align-self:flex-start;" onclick="openAppointmentModal('${client.id}')">Agendar novamente</button>
        </div>
      `;
    }
  }

  function openRemoveClientModal(id) {
    pendingRemoveClientId = id;
    const client = clients.find(c => c.id === id);
    const text = document.getElementById('client-remove-text');
    if (text && client) text.textContent = `Remover ${client.name} e cancelar agendamentos futuros?`;
    openDialog('client-remove-modal');
  }

  function isFutureDate(dateStr) {
    if (!dateStr) return false;
    const today = new Date();
    const d = new Date(`${dateStr}T00:00:00`);
    return d >= new Date(today.getFullYear(), today.getMonth(), today.getDate());
  }

  function confirmRemoveClient() {
    if (!pendingRemoveClientId) return;
    const index = clients.findIndex(c => c.id === pendingRemoveClientId);
    if (index >= 0) clients.splice(index, 1);
    appointments = appointments.filter(a => !(a.clientId === pendingRemoveClientId && isFutureDate(a.date)));
    refreshAgendaFromAppointments();
    closeDialog('client-detail-modal');
    closeDialog('client-remove-modal');
    renderClients('ceo');
    renderClients('colab');
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');
    pendingRemoveClientId = null;
  }

  function rebuildClientAppointments(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    const related = appointments
      .filter(a => a.clientId === clientId && a.status !== 'canceled')
      .sort((a, b) => new Date(`${a.date}T${a.time || '00:00'}`) - new Date(`${b.date}T${b.time || '00:00'}`));

    const today = new Date();
    const future = related.filter(r => new Date(`${r.date}T${r.time || '00:00'}`) >= today);
    const owners = new Set(client.owners || []);
    related.forEach(r => { if (r.professionalName) owners.add(r.professionalName); });
    client.owners = Array.from(owners);
    client.future = future.map(r => ({ date: r.date, time: r.time, service: r.serviceName || r.service, professional: r.professionalName || r.professional }));
    client.nextAppointment = future[0]
      ? { date: future[0].date, time: future[0].time, service: future[0].serviceName || future[0].service }
      : {};
    const lastDone = [...related].filter(r => new Date(`${r.date}T${r.time || '00:00'}`) <= today).pop();
    if (lastDone) {
      client.lastService = lastDone.serviceName || lastDone.service;
      client.lastDate = formatDateLabel(lastDone.date);
    }
    if (!lastDone && future[0]) {
      client.lastService = future[0].serviceName || future[0].service;
      client.lastDate = formatDateLabel(future[0].date);
    }
    client.responsible = future[0]?.professionalName || lastDone?.professionalName || client.responsible;
  }

  function bindClientFromInput() {
    const input = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const match = clients.find(c => c.name.toLowerCase() === (input.value || '').toLowerCase());
    hidden.value = match ? match.id : '';
  }

  function renderDayAppointmentsModal() {
    const list = document.getElementById('day-appointments-list');
    const caption = document.getElementById('day-appointments-caption');
    if (!list || !dayModalDate) return;
    list.innerHTML = '';
    const scope = dayModalScope || 'ceo';
    const items = getAppointmentsForScope(scope)
      .filter(a => a.date === dayModalDate && a.status !== 'canceled')
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (caption) caption.textContent = `Horrios do dia ${formatDateLabel(dayModalDate)}`;

    if (!items.length) {
      list.innerHTML = '<div class="subtext">Nenhum agendamento para este dia.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const row = document.createElement('div');
      row.className = 'appointment-card';
      row.style.setProperty('--appt-color', color);
      row.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title" style="font-size:1rem;">
            ${appt.time || '--:--'}  ${appt.serviceName || appt.service}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${client ? client.name : appt.clientName || 'Cliente'}</span>
            <span>${appt.status === 'done' ? 'Concludo' : 'Agendado'}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"> Editar</button>
          <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')"> Cancelar</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  function openDayAppointmentsModal(dateStr, scope = 'ceo') {
    dayModalDate = dateStr;
    dayModalScope = scope;
    const title = document.getElementById('day-appointments-title');
    if (title) title.textContent = `Agendamentos de ${formatDateLabel(dateStr)}`;
    openDayAgenda(dateStr, scope);
  }

  // ---------- Agenda do dia (timeline) ----------
  let dayAgendaScope = 'ceo';
  let dayAgendaDate = null;
  let draggedAppointmentId = null;
  let pendingMoveApptId = null;
  let pendingMoveData = null;
  let dayAgendaSlotHeight = 72; // px

  function openDayAgenda(dateStr, scope = 'ceo') {
    dayAgendaDate = dateStr;
    dayAgendaScope = scope;
    const overlay = document.getElementById('day-agenda-overlay');
    const title = document.getElementById('day-agenda-title');
    if (title) title.textContent = formatDateLabel(dateStr);
    if (overlay) overlay.classList.add('open');
    renderDayAgendaTimeline();
  }

  function closeDayAgenda() {
    const overlay = document.getElementById('day-agenda-overlay');
    if (overlay) overlay.classList.remove('open');
    draggedAppointmentId = null;
    pendingMoveApptId = null;
  }

  function refreshDayAgenda() {
    renderDayAgendaTimeline();
  }

  function hourRange() {
    const arr = [];
    for (let h = 7; h <= 23; h++) arr.push(h);
    return arr;
  }

  function renderDayAgendaTimeline() {
    const hoursCol = document.getElementById('day-agenda-hours');
    const slotsCol = document.getElementById('day-agenda-slots');
    if (!hoursCol || !slotsCol || !dayAgendaDate) return;
    hoursCol.innerHTML = '';
    slotsCol.innerHTML = '';
    const hours = hourRange();
    hours.forEach((h) => {
      const lbl = document.createElement('div');
      lbl.className = 'day-hour';
      lbl.textContent = `${String(h).padStart(2, '0')}:00`;
      hoursCol.appendChild(lbl);

      const slot = document.createElement('div');
      slot.className = 'day-slot';
      slot.dataset.time = `${String(h).padStart(2, '0')}:00`;
      slot.addEventListener('dragover', (e) => {
        e.preventDefault();
        slot.classList.add('hover');
      });
      slot.addEventListener('dragleave', () => slot.classList.remove('hover'));
      slot.addEventListener('drop', (e) => {
        e.preventDefault();
        slot.classList.remove('hover');
        if (draggedAppointmentId) handleSlotDrop(slot.dataset.time);
      });
      slot.addEventListener('click', () => {
        if (pendingMoveApptId) handleSlotDrop(slot.dataset.time, pendingMoveApptId);
      });
      slotsCol.appendChild(slot);
    });

    const items = getAppointmentsForScope(dayAgendaScope)
      .filter(a => a.date === dayAgendaDate && a.status !== 'canceled')
      .map(a => ({ ...a, dateObj: new Date(`${a.date}T${a.time || '00:00'}`) }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!items.length) {
      const empty = document.createElement('div');
      empty.className = 'day-slot-empty subtext';
      empty.textContent = 'Nenhum atendimento neste dia.';
      slotsCol.appendChild(empty);
      return;
    }

    items.forEach(appt => {
      const timeParts = (appt.time || '00:00').split(':');
      const hour = parseInt(timeParts[0], 10) || 0;
      const minutes = parseInt(timeParts[1], 10) || 0;
      const slot = slotsCol.querySelector(`[data-time="${String(hour).padStart(2, '0')}:00"]`);
      if (!slot) return;
      slot.style.position = 'relative';
      const card = document.createElement('div');
      card.className = 'appt-card';
      if (appt.status === 'finalizado') card.classList.add('finalizado');
      card.draggable = appt.status !== 'finalizado';
      card.dataset.id = appt.id;
      card.style.top = `${(minutes/60) * dayAgendaSlotHeight}px`;
      const client = clients.find(c => c.id === appt.clientId);
      card.innerHTML = `
        <div class="title">
          <span>${client ? client.name : (appt.clientName || 'Cliente')}</span>
          <span class="badge">${appt.time || '--:--'}</span>
        </div>
        <div class="meta">
          <span>${appt.serviceName || appt.service}</span>
          <span>${appt.professionalName || appt.professional || 'Equipe'}</span>
          <span class="badge-soft">${appt.status || 'agendado'}</span>
        </div>
      `;
      if (appt.status !== 'finalizado') {
        card.addEventListener('dragstart', () => {
          draggedAppointmentId = appt.id;
          card.classList.add('dragging');
        });
        card.addEventListener('dragend', () => {
          draggedAppointmentId = null;
          card.classList.remove('dragging');
        });
        // toque longo no mobile
        let touchTimer = null;
        card.addEventListener('touchstart', () => {
          touchTimer = setTimeout(() => {
            pendingMoveApptId = appt.id;
          }, 250);
        }, { passive: true });
        card.addEventListener('touchend', () => {
          if (touchTimer) clearTimeout(touchTimer);
        });
      }
      slot.appendChild(card);
    });
  }

  async function handleSlotDrop(timeTarget, forcedApptId = null) {
    const apptId = forcedApptId || draggedAppointmentId;
    if (!apptId) return;
    const appt = appointments.find(a => a.id === apptId);
    if (!appt || appt.status === 'finalizado') return;
    const targetDate = dayAgendaDate || appt.date;
    // conflito: outro atendimento no mesmo horrio
    const conflict = appointments.some(a =>
      a.id !== apptId &&
      a.date === targetDate &&
      a.time === timeTarget
    );
    if (conflict) {
      alert('Horrio j ocupado.');
      draggedAppointmentId = null;
      pendingMoveApptId = null;
      return;
    }
    openMoveAppointmentModal(appt, targetDate, timeTarget);
  }

  function openMoveAppointmentModal(appt, targetDate, targetTime) {
    pendingMoveData = {
      apptId: appt.id,
      targetDate,
      targetTime
    };
    const summary = document.getElementById('move-appointment-summary');
    if (summary) {
      const clientName = appt.clientName || appt.cliente || clients.find(c => c.id === appt.clientId)?.name || 'Cliente';
      const service = appt.serviceName || appt.service || 'Servio';
      const pro = appt.professionalName || appt.professional || 'Equipe';
      summary.textContent = `${clientName}  ${service}  ${formatDateLabel(targetDate)} s ${targetTime}  ${pro}`;
    }
    openDialog('move-appointment-modal');
  }

  async function confirmMoveAppointment() {
    if (!pendingMoveData) { closeMoveAppointmentModal(); return; }
    const appt = appointments.find(a => a.id === pendingMoveData.apptId);
    if (!appt) { closeMoveAppointmentModal(); return; }
    const conflict = appointments.some(a =>
      a.id !== appt.id &&
      a.date === pendingMoveData.targetDate &&
      a.time === pendingMoveData.targetTime
    );
    if (conflict) { alert('Horrio j ocupado.'); return; }
    const updated = {
      ...appt,
      time: pendingMoveData.targetTime,
      date: pendingMoveData.targetDate,
      updatedAt: new Date().toISOString(),
      atualizadoEm: new Date().toISOString()
    };
    await persistAppointment(updated);
    appointments = appointments.map(a => a.id === updated.id ? updated : a);
    refreshAgendaFromAppointments();
    renderDayAgendaTimeline();
    closeMoveAppointmentModal();
  }

  function closeMoveAppointmentModal() {
    closeDialog('move-appointment-modal');
    pendingMoveData = null;
    draggedAppointmentId = null;
    pendingMoveApptId = null;
  }
  // ---------- Painel de comanda ----------
  let comandaUnsub = null;
  let comandaAtualId = null;
  let comandaAtualStatus = null;
  let comandaMinimized = false;

  function openComandaPanel(comandaId, cliente = 'Cliente', profissional = 'Profissional') {
    if (!comandaId) {
      alert('Comanda no encontrada para este atendimento.');
      return;
    }
    closeComandaPanel();
    comandaAtualId = comandaId;
    comandaMinimized = false;
    const panel = document.getElementById('comanda-panel');
    const info = document.getElementById('comanda-panel-info');
    if (info) info.textContent = `${cliente}  ${profissional}`;
    if (panel) {
      panel.style.display = 'flex';
      panel.classList.remove('hidden');
    }
    const mini = document.getElementById('comanda-mini');
    if (mini) mini.classList.add('hidden');
    populateComandaSelect();

    if (window.listenComanda) {
      comandaUnsub = window.listenComanda(comandaId, (data) => {
        comandaAtualStatus = data?.status || 'aberta';
        toggleComandaFormAvailability(comandaAtualStatus);
        renderComandaItems(data || {}, comandaAtualStatus);
        const codigo = document.getElementById('comanda-panel-codigo');
        if (codigo) codigo.textContent = `Cdigo do kiosk: ${data?.codigoPareamento || '--'}`;
      });
    }
  }

  function closeComandaPanel() {
    if (comandaUnsub) comandaUnsub();
    comandaUnsub = null;
    comandaAtualId = null;
    comandaAtualStatus = null;
    const panel = document.getElementById('comanda-panel');
    if (panel) {
      panel.style.display = 'none';
      panel.classList.add('hidden');
    }
    const mini = document.getElementById('comanda-mini');
    if (mini) mini.classList.add('hidden');
    const codigo = document.getElementById('comanda-panel-codigo');
    if (codigo) codigo.textContent = 'Cdigo do kiosk: --';
    renderComandaItems({});
  }

  function renderComandaItems(comanda = {}, status = 'aberta') {
    const list = document.getElementById('comanda-items');
    if (!list) return;
    list.innerHTML = '';
    if (status !== 'aberta') {
      const locked = document.createElement('div');
      locked.className = 'badge-soft';
      locked.textContent = `Comanda ${status}`;
      list.appendChild(locked);
    }
    const itensProf = comanda.itensProfissional || [];
    const itensCliente = comanda.itensCliente || [];
    const items = itensProf.concat(itensCliente);
    if (!items.length) {
      const empty = document.createElement('div');
      empty.className = 'subtext';
      empty.textContent = 'Nenhum item adicionado.';
      list.appendChild(empty);
      return;
    }
    // ordena por criadoEm
    const ordered = [...items].sort((a, b) => {
      const ta = a.criadoEm?.toMillis ? a.criadoEm.toMillis() : 0;
      const tb = b.criadoEm?.toMillis ? b.criadoEm.toMillis() : 0;
      return ta - tb;
    });
    const servicos = ordered.filter(it => it.tipo === 'servico');
    const consumos = ordered.filter(it => it.tipo === 'consumo');
    const renderGroup = (groupItems, label) => {
      const heading = document.createElement('div');
      heading.className = 'subtext';
      heading.textContent = label;
      list.appendChild(heading);
      groupItems.forEach(it => {
        const li = document.createElement('div');
        li.className = 'comanda-item';
        const total = (it.preco || 0) * (it.quantidade || 1);
        li.innerHTML = `
          <div>
            <strong>${it.nome || 'Item'}</strong>
            <div class="subtext">${it.tipo === 'servico' ? 'Servio' : 'Consumo'}  Qtd: ${it.quantidade || 1}  Origem: ${it.origem === 'cliente' ? 'Kiosk' : 'Profissional'}</div>
          </div>
          <div style="text-align:right;">
            <div>${formatCurrency(total)}</div>
            <div class="subtext">(${formatCurrency(it.preco || 0)})</div>
          </div>
        `;
        if (it.origem === 'cliente' && status === 'aberta') {
          const actions = document.createElement('div');
          actions.className = 'flex gap-2 text-xs';
          const editBtn = document.createElement('button');
          editBtn.className = 'secondary';
          editBtn.textContent = 'Editar';
          editBtn.onclick = () => editClienteItem(it.itemId);
          const removeBtn = document.createElement('button');
          removeBtn.className = 'secondary';
          removeBtn.textContent = 'Remover';
          removeBtn.onclick = () => removeClienteItem(it.itemId);
          actions.appendChild(editBtn);
          actions.appendChild(removeBtn);
          li.appendChild(actions);
        }
        list.appendChild(li);
      });
    };
    if (servicos.length) renderGroup(servicos, 'Servios');
    if (consumos.length) renderGroup(consumos, 'Consumos');
    if (!servicos.length && !consumos.length) {
      list.innerHTML = '<div class="subtext">Nenhum item adicionado.</div>';
    }
  }

  async function editClienteItem(itemId) {
    if (!itemId || !comandaAtualId || comandaAtualStatus !== 'aberta') return;
    if (!firestore) { alert('Firestore indisponvel.'); return; }
    const ref = firestore.collection('comandas').doc(comandaAtualId);
    const snap = await ref.get();
    if (!snap.exists) return;
    const data = snap.data() || {};
    const itens = Array.isArray(data.itensCliente) ? [...data.itensCliente] : [];
    const idx = itens.findIndex(it => it.itemId === itemId);
    if (idx < 0) return;
    const current = itens[idx];
    const nome = prompt('Nome do item', current.nome || '') ?? current.nome;
    if (!nome || !nome.trim()) return;
    const quantidade = parseFloat(prompt('Quantidade', current.quantidade || 1));
    if (!Number.isFinite(quantidade) || quantidade <= 0) return;
    const preco = parseFloat(prompt('Preo unitrio', current.preco || 0));
    if (!Number.isFinite(preco) || preco < 0) return;
    itens[idx] = { ...current, nome: nome.trim(), quantidade, preco };
    await ref.set({ itensCliente: itens, atualizadoEm: new Date().toISOString() }, { merge: true });
  }

  async function removeClienteItem(itemId) {
    if (!itemId || !comandaAtualId || comandaAtualStatus !== 'aberta') return;
    if (!confirm('Remover este item adicionado no kiosk?')) return;
    if (!firestore) { alert('Firestore indisponvel.'); return; }
    const ref = firestore.collection('comandas').doc(comandaAtualId);
    const snap = await ref.get();
    if (!snap.exists) return;
    const data = snap.data() || {};
    const itens = Array.isArray(data.itensCliente) ? data.itensCliente.filter(it => it.itemId !== itemId) : [];
    await ref.set({ itensCliente: itens, atualizadoEm: new Date().toISOString() }, { merge: true });
  }

  async function submitComandaItem(event) {
    event.preventDefault();
    if (!comandaAtualId) {
      alert('Nenhuma comanda aberta.');
      return;
    }
    const nome = document.getElementById('comanda-item-nome')?.value || '';
    const tipo = document.getElementById('comanda-item-tipo')?.value || 'servico';
    const preco = parseFloat(document.getElementById('comanda-item-preco')?.value || '0');
    const quantidade = parseInt(document.getElementById('comanda-item-quantidade')?.value || '1', 10);

    const submitBtn = document.querySelector('#comanda-form button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;
    try {
      await window.addItemProfissional(comandaAtualId, { nome, tipo, preco, quantidade });
      if (document.getElementById('comanda-item-nome')) document.getElementById('comanda-item-nome').value = '';
      if (document.getElementById('comanda-item-preco')) document.getElementById('comanda-item-preco').value = '';
      if (document.getElementById('comanda-item-quantidade')) document.getElementById('comanda-item-quantidade').value = 1;
    } catch (err) {
      alert('No foi possvel adicionar o item.');
      console.error(err);
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  }

  function populateComandaSelect() {
    const select = document.getElementById('comanda-item-select');
    if (!select) return;
    select.innerHTML = '';
    const optDefault = document.createElement('option');
    optDefault.value = '';
    optDefault.textContent = 'Selecione um item';
    select.appendChild(optDefault);

    const services = kioskServices || [];
    const consumos = kioskDrinks || [];

    const appendGroup = (label, items, kind) => {
      if (!items.length) return;
      const groupLabel = document.createElement('option');
      groupLabel.disabled = true;
      groupLabel.textContent = ` ${label} `;
      select.appendChild(groupLabel);
      items.forEach(it => {
        const opt = document.createElement('option');
        opt.value = `${kind}:${it.id}`;
        opt.dataset.type = kind === 'svc' ? 'servico' : 'consumo';
        opt.dataset.price = it.price || it.preco || 0;
        opt.textContent = it.name || it.nome || 'Item';
        select.appendChild(opt);
      });
    };

    appendGroup('Servios', services, 'svc');
    appendGroup('Consumos', consumos, 'csm');

    select.onchange = () => {
      const val = select.value;
      if (!val) return;
      const [kind, id] = val.split(':');
      let item = null;
      if (kind === 'svc') item = services.find(s => s.id === id);
      if (kind === 'csm') item = consumos.find(c => c.id === id);
      if (!item) return;
      const nomeInput = document.getElementById('comanda-item-nome');
      const tipoSelect = document.getElementById('comanda-item-tipo');
      const precoInput = document.getElementById('comanda-item-preco');
      if (nomeInput) nomeInput.value = item.name || item.nome || '';
      if (tipoSelect) tipoSelect.value = kind === 'svc' ? 'servico' : 'consumo';
      if (precoInput) precoInput.value = item.price || item.preco || 0;
    };
  }

  function toggleComandaFormAvailability(status = 'aberta') {
    const disabled = status !== 'aberta';
    const form = document.getElementById('comanda-form');
    if (!form) return;
    form.querySelectorAll('input, select, button[type="submit"]').forEach(el => {
      el.disabled = disabled;
    });
    const info = document.getElementById('comanda-panel-info');
    if (info) {
      const base = (info.dataset.base || info.textContent || '').replace(/  Comanda bloqueada$/, '');
      info.dataset.base = base;
      info.textContent = disabled ? `${base}  Comanda bloqueada` : base;
    }
  }

  function minimizeComandaPanel() {
    const panel = document.getElementById('comanda-panel');
    const mini = document.getElementById('comanda-mini');
    comandaMinimized = true;
    if (panel) panel.classList.add('hidden');
    if (mini) mini.classList.remove('hidden');
  }

  function restoreComandaPanel() {
    if (!comandaAtualId) return;
    const panel = document.getElementById('comanda-panel');
    const mini = document.getElementById('comanda-mini');
    comandaMinimized = false;
    if (panel) panel.classList.remove('hidden');
    if (mini) mini.classList.add('hidden');
  }

  // Utilitrio: totalizao de comanda
  function calculateComandaTotal(comanda = {}) {
    const prof = comanda.itensProfissional || [];
    const cliente = comanda.itensCliente || [];
    const livres = comanda.itens || comanda.items || [];
    const items = prof.concat(cliente).concat(livres);
    const totals = items.reduce(
      (acc, it) => {
        const val = (it.preco || 0) * (it.quantidade || 1);
        if (it.tipo === 'servico') acc.totalServicos += val;
        else acc.totalConsumos += val;
        return acc;
      },
      { totalServicos: 0, totalConsumos: 0 }
    );
    return { ...totals, totalGeral: totals.totalServicos + totals.totalConsumos };
  }

  const finalizeModalState = {
    atendimentoId: null,
    comandaId: null,
    itens: [],
    total: 0,
    cliente: '',
    profissional: '',
    resumoGeradoEm: null
  };

  function resetFinalizarComandaModal() {
    finalizeModalState.atendimentoId = null;
    finalizeModalState.comandaId = null;
    finalizeModalState.itens = [];
    finalizeModalState.total = 0;
    finalizeModalState.cliente = '';
    finalizeModalState.profissional = '';
    finalizeModalState.resumoGeradoEm = null;
    const list = document.getElementById('finalizar-comanda-list');
    if (list) list.innerHTML = '<div class="subtext">Selecione um atendimento para finalizar.</div>';
    const caption = document.getElementById('finalizar-comanda-caption');
    if (caption) caption.textContent = 'Confira os itens antes do pagamento.';
    const registro = document.getElementById('finalizar-comanda-registro');
    if (registro) registro.textContent = 'Resumo ainda no carregado.';
    const total = document.getElementById('finalizar-comanda-total');
    if (total) total.textContent = 'Total estimado: --';
    const confirmBtn = document.getElementById('finalizar-comanda-confirm');
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Finalizar e registrar pagamento';
    }
  }

  function computeResumoTotals(itens = []) {
    return itens.reduce(
      (acc, it) => {
        const totalItem = (Number(it.preco || it.valor || 0)) * (Number(it.quantidade || it.qtd || 1));
        if (it.tipo === 'consumo') acc.consumos += totalItem;
        else acc.servicos += totalItem;
        acc.total += totalItem;
        return acc;
      },
      { servicos: 0, consumos: 0, total: 0 }
    );
  }

  function renderFinalizarComandaResumo() {
    const list = document.getElementById('finalizar-comanda-list');
    const caption = document.getElementById('finalizar-comanda-caption');
    const registro = document.getElementById('finalizar-comanda-registro');
    const totalEl = document.getElementById('finalizar-comanda-total');
    if (caption) caption.textContent = `${finalizeModalState.cliente || 'Cliente'}  ${finalizeModalState.profissional || 'Profissional'}`;
    if (registro && finalizeModalState.resumoGeradoEm) {
      registro.textContent = `Resumo gerado s ${finalizeModalState.resumoGeradoEm.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })}`;
    }

    const totals = computeResumoTotals(finalizeModalState.itens);
    finalizeModalState.total = totals.total || (totals.servicos + totals.consumos);
    if (totalEl) totalEl.textContent = `Total estimado: ${formatCurrency(finalizeModalState.total)}`;

    if (!list) return;
    list.innerHTML = '';
    if (!finalizeModalState.itens.length) {
      list.innerHTML = '<div class="subtext">Nenhum item registrado nesta comanda.</div>';
      return;
    }

    finalizeModalState.itens.forEach((it) => {
      const row = document.createElement('div');
      row.className = 'flex items-start justify-between gap-3 rounded-2xl bg-white px-4 py-3 shadow-sm';
      const quantidade = Number(it.quantidade || it.qtd || 1);
      const unit = Number(it.preco || it.valor || 0);
      const totalItem = unit * quantidade;
      const origem = it.origem === 'cliente' ? 'Kiosk' : (it.origem === 'profissional' ? 'Profissional' : (it.origem || 'Agenda'));
      row.innerHTML = `
        <div>
          <strong>${it.nome || 'Item'}</strong>
          <div class="subtext">${it.tipo === 'consumo' ? 'Consumo' : 'Servio'}  ${quantidade}x ${formatCurrency(unit)}  Origem: ${origem}</div>
        </div>
        <div class="text-right font-semibold">${formatCurrency(totalItem)}</div>
      `;
      list.appendChild(row);
    });
  }

  async function openFinalizarComandaModal(atendimentoId) {
    try {
      if (!atendimentoId) throw new Error('Atendimento invlido para finalizar.');
      finalizeModalState.atendimentoId = atendimentoId;
      const list = document.getElementById('finalizar-comanda-list');
      if (list) list.innerHTML = '<div class="subtext">Carregando itens da comanda...</div>';
      const confirmBtn = document.getElementById('finalizar-comanda-confirm');
      if (confirmBtn) confirmBtn.disabled = false;
      openDialog('finalizar-comanda-modal');
      if (!firestore) throw new Error('Firestore indisponvel');

      const atendSnap = await firestore.collection('atendimentos').doc(atendimentoId).get();
      const appt = atendSnap.exists ? { id: atendimentoId, ...atendSnap.data() } : (appointments.find(a => a.id === atendimentoId) || {});

      const comandaId = appt.comandaId || null;
      let comandaData = null;
      if (comandaId) {
        const comandaSnap = await firestore.collection('comandas').doc(comandaId).get();
        comandaData = comandaSnap.exists ? comandaSnap.data() : null;
      }

      const itensComanda = comandaData
        ? (comandaData.itensProfissional || [])
          .concat(comandaData.itensCliente || [])
          .concat(comandaData.itens || comandaData.items || [])
        : [];
      const comandaJaTemServico = itensComanda.some(it => it.tipo === 'servico');
      const itensServico = comandaJaTemServico ? [] : [{
        nome: appt.serviceName || appt.service || 'Servio',
        tipo: 'servico',
        preco: getServicePriceByAppointment(appt),
        quantidade: 1,
        origem: 'Servio agendado'
      }];

      finalizeModalState.comandaId = comandaId;
      finalizeModalState.itens = itensServico.concat(itensComanda);
      finalizeModalState.cliente = appt.clientName || appt.cliente || 'Cliente';
      finalizeModalState.profissional = appt.professionalName || appt.professional || 'Profissional';
      finalizeModalState.resumoGeradoEm = new Date();
      renderFinalizarComandaResumo();
    } catch (err) {
      alert('No foi possvel carregar o resumo da comanda.');
      console.error(err);
      closeFinalizarComandaModal();
    }
  }

  function closeFinalizarComandaModal() {
    closeDialog('finalizar-comanda-modal');
    resetFinalizarComandaModal();
  }

  async function confirmFinalizarComanda() {
    const confirmBtn = document.getElementById('finalizar-comanda-confirm');
    if (!finalizeModalState.atendimentoId) {
      alert('Atendimento no encontrado.');
      return;
    }
    if (confirmBtn) {
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Finalizando...';
    }
    try {
      const result = await finalizeAtendimento(finalizeModalState.atendimentoId);
      appointments = appointments.map(a => a.id === finalizeModalState.atendimentoId ? { ...a, status: 'finalizado' } : a);
      refreshAgendaFromAppointments();
      closeFinalizarComandaModal();
      alert(`Atendimento finalizado. Total para pagamento: ${formatCurrency(result?.total || finalizeModalState.total || 0)}.`);
    } catch (err) {
      alert('No foi possvel finalizar o atendimento.');
      console.error(err);
    } finally {
      if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Finalizar e registrar pagamento';
      }
    }
  }

  function openAppointmentModal(clientId = null, appointmentId = null, presetDate = null, presetTime = null) {
    appointmentFormMode = appointmentId ? 'edit' : 'add';
    appointmentEditingId = appointmentId;
    appointmentPrefillClient = clientId;
    appointmentPrefillDate = presetDate;
    appointmentPrefillTime = presetTime;
    appointmentOpenedFromDayModal = Boolean(!appointmentId && presetDate && presetDate === dayModalDate);
    const client = clients.find(c => c.id === clientId);
    const editing = appointmentId ? appointments.find(a => a.id === appointmentId) : null;
    const modalTitle = document.getElementById('appointment-modal-title');
    const submitBtn = document.getElementById('appointment-submit-btn');
    const clientInput = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const profSelect = document.getElementById('appointment-professional');
    const serviceSelect = document.getElementById('appointment-service');
    const dateInput = document.getElementById('appointment-date');
    const timeInput = document.getElementById('appointment-time');
    const notes = document.getElementById('appointment-notes');

    if (modalTitle) modalTitle.textContent = appointmentFormMode === 'edit' ? 'Editar agendamento' : 'Novo agendamento';
    if (submitBtn) submitBtn.textContent = appointmentFormMode === 'edit' ? 'Atualizar e gerar WhatsApp' : 'Salvar e gerar WhatsApp';

    const baseClient = editing ? clients.find(c => c.id === editing.clientId) : client;

    if (clientInput) clientInput.value = baseClient ? baseClient.name : '';
    if (hidden) hidden.value = baseClient ? baseClient.id : '';
    if (notes) notes.value = editing ? (editing.notes || '') : '';
    const defaultDate = editing ? editing.date : (appointmentPrefillDate || baseClient?.nextAppointment?.date || '');
    const defaultTime = editing ? editing.time : (appointmentPrefillTime || baseClient?.nextAppointment?.time || '');
    if (dateInput) dateInput.value = defaultDate;
    if (timeInput) timeInput.value = defaultTime;

    if (profSelect) {
      profSelect.innerHTML = '';
      collaborators.forEach(col => {
        const opt = document.createElement('option');
        opt.value = col.id || slugify(col.name);
        opt.textContent = col.name;
        profSelect.appendChild(opt);
      });
      if (baseClient?.responsible) profSelect.value = baseClient.responsible.toLowerCase();
      if (currentRole === 'colab' && currentColabAccount) {
        profSelect.value = currentColabAccount.id || slugify(currentColabAccount.name);
      }
      if (editing && (editing.professionalId || editing.professional)) {
        profSelect.value = editing.professionalId || slugify(editing.professional);
      }
    }

    if (serviceSelect) {
      serviceSelect.innerHTML = '';
      const services = [...kioskServices];
      const editingServiceId = editing?.serviceId || editing?.service;
      if (editingServiceId && !services.some(s => s.id === editingServiceId || s.name === editing.service)) {
        services.push({ id: editingServiceId, name: editing?.serviceName || editing?.service || 'Servio' });
      }
      services.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.name}${s.price ? '  R$ ' + s.price : ''}`;
        serviceSelect.appendChild(opt);
      });
      serviceSelect.value = editing?.serviceId || editing?.service || services[0]?.id || '';
    }

    renderClientsDatalist();
    openDialog('appointment-modal');
    appointmentPrefillDate = null;
    appointmentPrefillTime = null;
  }

  async function saveAppointment() {
    const clientInput = document.getElementById('appointment-client');
    const hidden = document.getElementById('appointment-client-id');
    const professionalValue = document.getElementById('appointment-professional').value;
    const serviceValue = document.getElementById('appointment-service').value;
    const date = document.getElementById('appointment-date').value;
    const time = document.getElementById('appointment-time').value;
    const notes = document.getElementById('appointment-notes').value;

    const isEditing = appointmentFormMode === 'edit';
    const editingAppt = isEditing ? appointments.find(a => a.id === appointmentEditingId) : null;
    const professional = findCollaboratorByIdOrName(professionalValue) || { name: professionalValue, id: slugify(professionalValue) };
    const service = findServiceByIdOrName(serviceValue) || { name: serviceValue, id: slugify(serviceValue) };
    let client = clients.find(c => c.id === hidden.value) || clients.find(c => c.name.toLowerCase() === (clientInput.value || '').toLowerCase());
    if (!client) {
      client = {
        id: `cli-${Date.now()}`,
        name: clientInput.value,
        phone: '55',
        lastService: service.name,
        lastDate: formatDateLabel(date),
        instagram: '',
        birthday: '',
        prefColor: '',
        prefShape: '',
        prefExtension: '',
        allergies: '',
        responsible: professional.name,
        owners: [currentRole === 'colab' && currentColabAccount ? currentColabAccount.name : professional.name || 'Glecie'],
        notes: '',
        extra: '',
        history: [],
        consume: [],
        future: [],
        nextAppointment: {}
      };
      clients.push(client);
    }

    client.owners = client.owners || [];
    if (professional.name && !client.owners.includes(professional.name)) client.owners.push(professional.name);
    client.responsible = professional.name || client.responsible;

    const status = isEditing ? (editingAppt?.status || 'scheduled') : 'scheduled';
    const baseCreatedAt = isEditing ? (editingAppt?.createdAt || new Date().toISOString()) : new Date().toISOString();
    const appointmentPayload = {
      clientId: client.id,
      clientName: client.name,
      professionalId: professional.id,
      professionalName: professional.name,
      professional: professional.name,
      serviceId: service.id,
      serviceName: service.name,
      service: service.name,
      date,
      time,
      notes,
      status
    };

    if (appointmentFormMode === 'edit' && appointmentEditingId) {
      const appt = appointments.find(a => a.id === appointmentEditingId);
      if (appt) {
        const previousClientId = appt.clientId;
        Object.assign(appt, appointmentPayload, {
          status,
          updatedAt: new Date().toISOString(),
          createdAt: appt.createdAt || baseCreatedAt
        });
        if (previousClientId && previousClientId !== client.id) rebuildClientAppointments(previousClientId);
        await persistAppointment(appt);
      }
    } else {
      const newAppt = {
        id: `appt-${Date.now()}-${Math.random().toString(16).slice(2, 7)}`,
        createdAt: baseCreatedAt,
        updatedAt: baseCreatedAt,
        ...appointmentPayload,
        status
      };
      appointments.push(newAppt);
      await persistAppointment(newAppt);
    }

    rebuildClientAppointments(client.id);
    refreshAgendaFromAppointments();

    renderClients('ceo');
    renderClients('colab');
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    if (currentClientDetailId === client.id) renderClientDetailTab();
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');

    closeDialog('appointment-modal');
    if (appointmentOpenedFromDayModal) {
      closeDialog('modal-agendamentos');
    }
    const link = buildWhatsAppLink(client, { appointment: { date, time, serviceName: service.name, service: service.name } });
    if (!isEditing) window.open(link, '_blank');

    appointmentFormMode = 'add';
    appointmentEditingId = null;
    appointmentOpenedFromDayModal = false;
  }

  function openDialog(id) {
    const modal = document.getElementById(id);
    closeFabMenu();
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    }
  }

  function closeDialog(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }
  }

  function fecharModalAgendamentos() {
    const modal = document.getElementById('modal-agendamentos');
    if (modal) {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }
  }

  const primaryButtonClasses = ['px-5', 'py-2', 'rounded-full', 'bg-[var(--btn-primary)]', 'text-white', 'font-semibold', 'flex', 'items-center', 'justify-center', 'whitespace-nowrap', 'hover:bg-[var(--btn-primary-hover)]', 'hover:scale-[1.02]', 'transition-all', 'shadow-sm'];
  const secondaryButtonClasses = ['px-5', 'py-2', 'rounded-full', 'border', 'border-[var(--btn-primary)]', 'bg-[var(--btn-secondary-bg)]', 'text-[var(--btn-primary)]', 'font-medium', 'flex', 'items-center', 'justify-center', 'whitespace-nowrap', 'hover:bg-[var(--btn-secondary-hover)]', 'hover:text-[var(--btn-primary-hover)]', 'transition-all', 'shadow-sm'];

  function normalizeButtons() {
    document.querySelectorAll('button').forEach(btn => {
      const isNavControl = btn.classList.contains('desktop-nav-btn') || btn.classList.contains('mobile-nav-btn') || btn.classList.contains('desktop-toggle-btn') || btn.classList.contains('mobile-nav-toggle') || btn.classList.contains('logout-btn') || btn.classList.contains('user-avatar-btn');
      if (isNavControl) return;
      const isSecondary = btn.classList.contains('secondary') || btn.dataset.variant === 'secondary' || btn.classList.contains('ghost-btn') || btn.classList.contains('nav');
      const classes = isSecondary ? secondaryButtonClasses : primaryButtonClasses;
      classes.forEach(cls => btn.classList.add(cls));
    });
  }

  const buttonObserver = new MutationObserver(() => normalizeButtons());

  let desktopSidebarExpanded = false;
  let mobileNavOpen = true;
  const sidebarVerses = [
    'Provrbios 16:3  Confia ao Senhor as tuas obras, e os teus planos sero estabelecidos.',
    'Provrbios 21:5  Os planos bem elaborados levam  fartura.',
    'Colossenses 3:23  Tudo o que fizerem, faam de todo o corao, como para o Senhor.',
    'Provrbios 22:29  Viste o homem diligente na sua obra? Perante reis ser posto.',
    'Eclesiastes 3:1  Para tudo h uma ocasio certa e um tempo para cada propsito debaixo do cu.',
    'Provrbios 3:5-6  Confia no Senhor de todo o teu corao [...] Ele endireitar as tuas veredas.'
  ];

  function applyDesktopSidebarState() {
    const sidebar = document.getElementById('desktop-sidebar');
    const toggle = document.getElementById('desktop-sidebar-toggle');
    if (!sidebar || !toggle) return;
    sidebar.classList.toggle('expanded', desktopSidebarExpanded);
    toggle.setAttribute('aria-expanded', desktopSidebarExpanded);
    const label = toggle.querySelector('.nav-label');
    if (label) label.textContent = desktopSidebarExpanded ? 'Recolher navegacao' : 'Abrir navegacao';
  }

  function toggleDesktopSidebar() {
    desktopSidebarExpanded = !desktopSidebarExpanded;
    applyDesktopSidebarState();
  }

  function applyMobileNavState() {
    const menu = document.getElementById('mobile-nav-menu');
    if (menu) menu.classList.add('open');
    mobileNavOpen = true;
  }

  function toggleMobileNav() {
    applyMobileNavState();
  }

  function updateRoleLabel(role) {
    const desktopLabel = document.getElementById('sidebar-role-label-desktop');
    const mobileChip = document.getElementById('mobile-login-chip');
    const userChip = document.getElementById('user-toolbar-chip');
    const userNameEl = document.getElementById('user-toolbar-name');
    const userAvatar = document.getElementById('user-toolbar-avatar');
    const userChipMobile = document.getElementById('user-toolbar-chip-mobile');
    const userAvatarMobile = document.getElementById('user-toolbar-avatar-mobile');
    const text = (() => {
      if (role === 'ceo') return 'Administradora Gleice';
      if (role === 'colab') return currentColabAccount ? `${currentColabAccount.name} (profissional)` : 'Profissional';
      return '';
    })();
    if (desktopLabel) desktopLabel.textContent = text || '';
    if (mobileChip) {
      mobileChip.textContent = '';
    }
    if (userChip) {
      const name = text || 'Login ativo';
      if (userNameEl) userNameEl.textContent = name;
      if (userAvatar) {
        const initials = name.split(' ').map(p => p[0]).join('').slice(0, 2).toUpperCase() || 'SN';
        userAvatar.textContent = initials;
      }
    }
    if (userChipMobile) {
      const name = text || 'Login ativo';
      if (userAvatarMobile) {
        const initials = name.split(' ').map(p => p[0]).join('').slice(0, 2).toUpperCase() || 'SN';
        userAvatarMobile.textContent = initials;
      }
    }
  }

  function setupSidebar(role) {
    const desktopNav = document.getElementById('desktop-sidebar-nav');
    const mobileNav = document.getElementById('mobile-nav-items');
    if (desktopNav) desktopNav.innerHTML = '';
    if (mobileNav) mobileNav.innerHTML = '';

    const navIcons = {
      dashboard: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M11.5 3.5 4 9v11h16V9l-7.5-5.5Z"/><path d="M9 21V12h6v9"/></svg>',
      agenda: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/></svg>',
      clients: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="9" cy="7" r="4"/><path d="M17 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/><path d="M3 21v-1a6 6 0 0 1 12 0v1"/><path d="M17 17.5a4.5 4.5 0 0 0-3 4.24V22h8v-.26A4.5 4.5 0 0 0 17 17.5Z"/></svg>',
      inventory: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 7.5 12 3l9 4.5v9L12 21 3 16.5z"/><path d="M12 12v9"/><path d="m3 7.5 9 4.5 9-4.5"/></svg>',
      investments: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 3v18h18"/><path d="m7 14 4-4 3 3 4-6"/></svg>',
      commission: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="8"/><path d="M9 9h3.5a1.75 1.75 0 0 1 0 3.5H11"/><path d="M12 16h.01"/></svg>',
      finance: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M15 9h4v6h-4"/><path d="M3 10h12"/></svg>',
      settings: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.01.01a2 2 0 1 1-2.83 2.83l-.01-.01a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.17a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.01.01a2 2 0 1 1-2.83-2.83l.01-.01a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.17a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.01-.01a2 2 0 1 1 2.83-2.83l.01.01a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.17a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.01-.01a2 2 0 1 1 2.83 2.83l-.01.01a1.65 1.65 0 0 0-.33 1.82V9c0 .69.4 1.31 1.02 1.6.62.29 1.35.17 1.86-.3"/></svg>',
      kiosk: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="4" y="3" width="16" height="14" rx="2"/><path d="M9 21h6"/><path d="M12 17v4"/></svg>'
    };

    const navItems = role === 'ceo'
      ? [
          { id: 'dashboard', label: 'Dashboard' },
          { id: 'agenda', label: 'Agenda' },
          { id: 'clients', label: 'Clientes' },
          { id: 'inventory', label: 'Estoque' },
          { id: 'investments', label: 'Investimentos' },
          { id: 'finance', label: 'Financeiro' },
          { id: 'settings', label: 'Configuraes' },
        ]
      : [
          { id: 'dashboard', label: 'Dashboard' },
          { id: 'agenda', label: 'Agenda' },
          { id: 'clients', label: 'Clientes' },
          { id: 'commission', label: 'Minhas comisses' },
        ];

    const buildButton = (item, navRole, variant) => {
      const btn = document.createElement('button');
      btn.className = variant === 'desktop' ? 'desktop-nav-btn nav' : 'mobile-nav-btn nav';
      btn.dataset.page = item.id;
      btn.dataset.navRole = navRole;
      btn.innerHTML = `<span class="nav-icon" aria-hidden="true">${navIcons[item.id] || navIcons.dashboard}</span><span class="nav-label">${item.label}</span>`;
      btn.onclick = () => navigatePage(navRole, item.id);
      return btn;
    };

    navItems.forEach(item => {
      if (desktopNav) desktopNav.appendChild(buildButton(item, role, 'desktop'));
      if (mobileNav) mobileNav.appendChild(buildButton(item, role, 'mobile'));
    });

    const kioskBtnDesktop = buildButton({ id: 'kiosk', label: 'Modo Tablet' }, role, 'desktop');
    kioskBtnDesktop.onclick = () => setRole('kiosk');
    const kioskBtnMobile = buildButton({ id: 'kiosk', label: 'Modo Tablet' }, role, 'mobile');
    kioskBtnMobile.onclick = () => setRole('kiosk');
    if (desktopNav) desktopNav.appendChild(kioskBtnDesktop);
    if (mobileNav) mobileNav.appendChild(kioskBtnMobile);

    const desktopToggle = document.getElementById('desktop-sidebar-toggle');
    if (desktopToggle) desktopToggle.onclick = toggleDesktopSidebar;

    desktopSidebarExpanded = false;
    mobileNavOpen = true;
    applyDesktopSidebarState();
    applyMobileNavState();

    const verseEl = document.getElementById('sidebar-verse');
    if (verseEl && sidebarVerses.length) {
      const randomVerse = sidebarVerses[Math.floor(Math.random() * sidebarVerses.length)];
      verseEl.textContent = randomVerse;
    }

    if (role === 'ceo') {
      highlightSidebarActive('ceo', currentPageCEO);
    }
    if (role === 'colab') {
      highlightSidebarActive('colab', currentPageColab);
    }
  }

  function highlightSidebarActive(role, pageId) {
    const buttons = document.querySelectorAll(`[data-nav-role="${role}"]`);
    buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));

    const titleMapCEO = {
      dashboard: ['Dashboard', 'Viso geral do Studio Nails'],
      agenda: ['Agenda', 'Viso anual e mensal'],
      inventory: ['Estoque', 'Esmaltes e geladeira'],
      investments: ['Investimentos', 'Compras, reformas e melhorias'],
      finance: ['Financeiro', 'Resumo de receitas e custos'],
      clients: ['Clientes', 'Busca, fichas e agendamentos'],
      settings: ['Configuraes', 'Servios, comisso, etc.']
    };

    const titleMapColab = {
      dashboard: ['Dashboard', 'Resumo do seu dia'],
      agenda: ['Agenda', 'Sua agenda + CEO'],
      clients: ['Clientes', 'Somente os seus contatos'],
      commission: ['Minhas comisses', 'Detalhamento por servio']
    };

    const titleEl = document.getElementById('page-title');
    const subtitleEl = document.getElementById('page-subtitle');

    if (role === 'ceo') {
      const arr = titleMapCEO[pageId] || ['Dashboard', 'Viso geral do Studio Nails'];
      titleEl.textContent = arr[0];
      subtitleEl.textContent = arr[1];
    } else if (role === 'colab') {
      const arr = titleMapColab[pageId] || ['Dashboard', 'Resumo do seu dia'];
      titleEl.textContent = arr[0];
      subtitleEl.textContent = arr[1];
    }
  }

  function navigatePage(role, pageId) {
    closeFabMenu();
    if (role === 'ceo') currentPageCEO = pageId;
    if (role === 'colab') currentPageColab = pageId;
    updateVisiblePage();
    highlightSidebarActive(role, pageId);
  }

  function updateVisiblePage() {
    const ceoPages = document.querySelectorAll('.page-ceo');
    const colabPages = document.querySelectorAll('.page-colab');

    ceoPages.forEach(p => p.classList.add('hidden'));
    colabPages.forEach(p => p.classList.add('hidden'));

    if (currentRole === 'ceo') {
      const id = `page-ceo-${currentPageCEO}`;
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      renderCeoContent();
    }

    if (currentRole === 'colab') {
      const id = `page-colab-${currentPageColab}`;
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      renderColabContent();
    }

    refreshFab();
  }

  function shouldShowFab() {
    const isMobile = window.innerWidth < 768;
    const roleAllowed = currentRole === 'ceo' || currentRole === 'colab';
    return isMobile && roleAllowed;
  }

  function refreshFab() {
    const fab = document.getElementById('fab-container');
    const backdrop = document.getElementById('fab-backdrop');
    const kioskVisible = !(document.getElementById('kiosk-screen')?.classList.contains('hidden') ?? true);
    const show = shouldShowFab() && !kioskVisible;
    if (fab) fab.classList.toggle('hidden', !show);
    if (backdrop) backdrop.classList.add('hidden');
    if (!show) {
      fabMenuOpen = false;
      closeFabMenu();
      return;
    }
    renderFabActions();
  }

  function closeFabMenu() {
    const menu = document.getElementById('fab-speed-dial');
    const backdrop = document.getElementById('fab-backdrop');
    if (menu) menu.classList.remove('open');
    if (backdrop) backdrop.style.display = 'none';
    if (backdrop) backdrop.classList.add('hidden');
    fabMenuOpen = false;
  }

  function toggleFabMenu() {
    const menu = document.getElementById('fab-speed-dial');
    const backdrop = document.getElementById('fab-backdrop');
    if (!menu) return;
    fabMenuOpen = !fabMenuOpen;
    menu.classList.toggle('open', fabMenuOpen);
    if (backdrop) {
      backdrop.style.display = fabMenuOpen ? 'block' : 'none';
      backdrop.classList.toggle('hidden', !fabMenuOpen);
    }
  }

  function toggleUserDropdownMobile() {
    const dd = document.getElementById('user-dropdown-mobile');
    if (!dd) return;
    dd.classList.toggle('hidden');
  }

  function fabActionsForRole() {
    const actions = [];
    if (currentRole === 'ceo') {
      actions.push({ label: 'Novo agendamento', icon: '', handler: () => openAppointmentModal() });
      actions.push({ label: 'Adicionar cliente', icon: '', handler: () => openClientModal() });
      actions.push({ label: 'Adicionar item ao estoque', icon: '', handler: () => openInventoryModalFromFab() });
      actions.push({ label: 'Registrar investimento', icon: '', handler: () => openInvestmentModal() });
      actions.push({ label: 'Registrar consumo/venda', icon: '', handler: () => openFabFridgeExit() });
    }
    if (currentRole === 'colab') {
      actions.push({ label: 'Novo agendamento', icon: '', handler: () => openAppointmentModal() });
      actions.push({ label: 'Registrar servio realizado', icon: '', handler: () => openAppointmentModal() });
      actions.push({ label: 'Registrar consumo do cliente', icon: '', handler: () => openFabFridgeExit() });
    }
    return actions;
  }

  function renderFabActions() {
    const menu = document.getElementById('fab-speed-dial');
    const fab = document.getElementById('fab-container');
    if (!menu || !fab) return;
    menu.innerHTML = '';
    const actions = fabActionsForRole();
    if (!shouldShowFab() || actions.length === 0) {
      fab.classList.add('hidden');
      closeFabMenu();
      return;
    }
    fab.classList.remove('hidden');
    actions.forEach(action => {
      const btn = document.createElement('button');
      btn.className = 'fab-speed-btn';
      btn.innerHTML = `<span>${action.icon}</span> ${action.label}`;
      btn.onclick = () => {
        action.handler?.();
        closeFabMenu();
      };
      menu.appendChild(btn);
    });
  }

  function openInventoryModalFromFab() {
    openInventoryModal();
  }

  function openFabFridgeExit() {
    const fridgeItem = stockItems.find(i => (i.categoria || i.category) === 'geladeira');
    if (!fridgeItem) {
      alert('Adicione um item da geladeira para registrar consumo.');
      return;
    }
    openStockExitModal(fridgeItem.id);
  }

  function handleFabScroll() {
    const fab = document.getElementById('fab-container');
    if (!fab || fab.classList.contains('hidden')) return;
    const current = window.scrollY;
    const goingDown = current > fabScrollLast + 6;
    const goingUp = current < fabScrollLast - 6;
    if (goingDown) fab.classList.add('fab-hidden');
    if (goingUp) fab.classList.remove('fab-hidden');
    fabScrollLast = current;
  }

  // -----------------------------
  // RENDERIZAO DE CONTEDO CEO
  // -----------------------------

  function updateGlobalMonthLabel() {
    const label = document.getElementById('global-month-label');
    if (label) label.textContent = formatMonthWithYear(getDashboardFilterTarget());
  }

  function refreshMonthlyConsumers() {
    updateGlobalMonthLabel();
    renderDashboardCards();
    renderInvestments();
    renderFinance();
    renderInventory();
  }

  function changeGlobalMonth(delta) {
    const pivot = new Date(selectedDashboardYear, selectedDashboardMonth + delta, 1);
    selectedDashboardMonth = pivot.getMonth();
    selectedDashboardYear = pivot.getFullYear();
    selectedGlobalMonthKey = `${selectedDashboardYear}-${String(selectedDashboardMonth + 1).padStart(2, '0')}`;
    persistGlobalMonth(selectedGlobalMonthKey);
    const select = document.getElementById('global-month-filter');
    if (select) select.value = selectedGlobalMonthKey;
    refreshMonthlyConsumers();
  }

  function setDashboardMonth(value, year = selectedDashboardYear) {
    selectedDashboardMonth = parseInt(value, 10) || 0;
    selectedDashboardYear = year || selectedDashboardYear;
    selectedGlobalMonthKey = `${selectedDashboardYear}-${String(selectedDashboardMonth + 1).padStart(2, '0')}`;
    persistGlobalMonth(selectedGlobalMonthKey);
    const select = document.getElementById('global-month-filter');
    if (select) select.value = selectedGlobalMonthKey;
    refreshMonthlyConsumers();
  }

  function computeInvestmentDashboardStats(target = getDashboardFilterTarget()) {
    const currentTarget = target || getDashboardFilterTarget();
    let totalMes = 0;
    let parcelasPagasMes = 0;
    let futurosPlanejados = 0;
    let futurosQuantidade = 0;

    investments.forEach(inv => {
      const ref = parseMonthRef(inv.mesReferencia);
      const active = isInvestmentActiveInMonth(inv, currentTarget);
      const monthlyValue = getInvestmentMonthlyValue(inv);

      if (active) {
        totalMes += monthlyValue;
        const payments = inv.payments || [];
        const paidThisMonth = payments.filter(p => p.monthIndex === currentTarget.monthIndex && p.year === currentTarget.year);
        parcelasPagasMes += paidThisMonth.reduce((acc, pay) => acc + (pay.amount || monthlyValue), 0);
      }

      if (ref && monthsDiff(ref, currentTarget) < 0) {
        futurosPlanejados += inv.valorTotal ?? inv.amount ?? 0;
        futurosQuantidade += 1;
      }
    });

    return { totalMes, parcelasPagasMes, futurosPlanejados, futurosQuantidade };
  }

  function computeStockTotals(target = getDashboardFilterTarget()) {
    const totals = { esmaltes: 0, geladeira: 0, manutencao: 0 };
    const filtered = selectedGlobalMonthKey === 'all'
      ? stockItems
      : stockItems.filter(item => matchesTargetMonth(item.dataCompra || item.addedAt || item.createdAt, target));
    filtered.forEach(item => {
      const cat = item.categoria || item.category;
      const cost = item.custoTotal || item.custoCompra || 0;
      if (totals[cat] != null) totals[cat] += cost;
    });
    return totals;
  }

  function drawPieChart(canvasId, dataMap) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const labels = Object.keys(dataMap);
    const data = Object.values(dataMap);
    const colors = [
      getCssVar('--chart-green', '#E6EFE6'),
      getCssVar('--chart-gold', '#B7A06A'),
      getCssVar('--chart-pink', '#F4D9D2')
    ];

    if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

    chartInstances[canvasId] = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [
          {
            data,
            backgroundColor: colors,
            borderWidth: 1,
            borderColor: '#fff',
            hoverOffset: 8
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'right',
            labels: { color: getCssVar('--text-main', '#2F2F2F') }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.75)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderWidth: 0
          }
        }
      }
    });
  }

  function drawBarChart(canvasId, series) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const labels = series.map(s => s.label);
    const data = series.map(s => s.value);

    if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

    chartInstances[canvasId] = new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Custo',
            data,
            fill: true,
            tension: 0.35,
            borderColor: 'rgba(170, 207, 163, 1)',
            backgroundColor: 'rgba(227, 244, 225, 0.35)',
            pointBackgroundColor: 'rgba(170, 207, 163, 1)',
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: getCssVar('--text-main', '#2F2F2F') },
            grid: { display: false }
          },
          y: {
            ticks: { color: getCssVar('--text-main', '#2F2F2F') },
            grid: { color: 'rgba(0,0,0,0.05)' },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.75)',
            titleColor: '#fff',
            bodyColor: '#fff'
          }
        }
      }
    });
  }

  function renderDashboardCards() {
    const target = getDashboardFilterTarget();
    const revenueEl = document.getElementById('dashboard-revenue');
    const revenueDelta = document.getElementById('dashboard-revenue-delta');
    const commEl = document.getElementById('dashboard-commission');
    const commDelta = document.getElementById('dashboard-commission-delta');
    const consEl = document.getElementById('dashboard-consumption');
    const consDelta = document.getElementById('dashboard-consumption-delta');
    const alertEl = document.getElementById('dashboard-stock-alerts');
    const alertDesc = document.getElementById('dashboard-stock-alerts-desc');
    const targetLabel = target ? `${monthNamesFull[target.monthIndex]} ${target.year}` : '';
    const filteredFin = selectedGlobalMonthKey === 'all'
      ? financialEntries
      : financialEntries.filter(e => matchesTargetMonth(e.date, target));
    const revenue = filteredFin.filter(f => f.type === 'receita').reduce((acc, cur) => acc + (cur.amount || 0), 0);
    const commission = filteredFin.filter(f => f.type === 'comissao').reduce((acc, cur) => acc + (cur.amount || 0), 0);
    const historyEntries = Object.values(stockHistories).flat();
    const consumption = selectedGlobalMonthKey === 'all'
      ? 0
      : historyEntries
          .filter(m => (m.tipo === 'saida' || m.tipo === 'baixa') && matchesTargetMonth(m.data, target))
          .reduce((acc, cur) => acc + (cur.quantity || cur.quantidade || cur.volume || 0), 0);
    const alertsCount = stockItems.filter(item => {
      const pct = item.volumeTotal_ml ? (item.volumeAtual_ml / item.volumeTotal_ml) : null;
      const low = (item.previsaoDuracaoDias && item.previsaoDuracaoDias < 15) || (pct != null && pct < 0.3) || (item.quantidade && item.quantidade <= (item.unidadesPorPack || item.quantidade) * 0.2);
      return low;
    }).length;
    const alertText = alertsCount > 0 ? 'Itens com estoque baixo' : 'Nenhum alerta de estoque';

    if (revenueEl) revenueEl.textContent = formatCurrency(revenue);
    if (revenueDelta) revenueDelta.textContent = targetLabel;
    if (commEl) commEl.textContent = formatCurrency(commission);
    if (commDelta) commDelta.textContent = commission ? `Comisses registradas em ${targetLabel}` : 'Sem comisses registradas';
    if (consEl) consEl.textContent = formatCurrency(consumption);
    if (consDelta) consDelta.textContent = 'Consumo filtrado pelo ms selecionado';
    if (alertEl) alertEl.textContent = `${alertsCount} itens`;
    if (alertDesc) alertDesc.textContent = alertText;

    const invStats = computeInvestmentDashboardStats(target);
    const invMonth = document.getElementById('dashboard-invest-month');
    const invMonthDesc = document.getElementById('dashboard-invest-month-desc');
    const invPaid = document.getElementById('dashboard-invest-paid');
    const invPaidDesc = document.getElementById('dashboard-invest-paid-desc');
    const invFuture = document.getElementById('dashboard-invest-future');
    const invFutureDesc = document.getElementById('dashboard-invest-future-desc');

    if (invMonth) invMonth.textContent = formatCurrency(invStats.totalMes);
    if (invMonthDesc) invMonthDesc.textContent = `Investimentos com referncia em ${formatMonthWithYear(target)}`;
    if (invPaid) invPaid.textContent = formatCurrency(invStats.parcelasPagasMes);
    if (invPaidDesc) invPaidDesc.textContent = `Pagamentos registrados em ${formatMonthWithYear(target)}`;
    if (invFuture) invFuture.textContent = formatCurrency(invStats.futurosPlanejados);
    if (invFutureDesc) invFutureDesc.textContent = `${invStats.futurosQuantidade} planejado(s) para os prximos meses`;

    renderDashboardStockCard(target);
  }

  function renderDashboardStockCard(target = getDashboardFilterTarget()) {
    const card = document.getElementById('dashboard-stock-card');
    if (!card) return;
    const totals = computeStockTotals(target);
    const totalsEl = document.getElementById('dashboard-stock-totals');
    if (totalsEl) {
      totalsEl.innerHTML = `
        <span>Esmaltes: <strong>${formatCurrency(totals.esmaltes)}</strong></span>
        <span>Geladeira: <strong>${formatCurrency(totals.geladeira)}</strong></span>
        <span>Manuteno: <strong>${formatCurrency(totals.manutencao)}</strong></span>
      `;
    }
    const esmalteVal = document.getElementById('dashboard-stock-esmaltes');
    const gelVal = document.getElementById('dashboard-stock-geladeira');
    const manVal = document.getElementById('dashboard-stock-manutencao');
    if (esmalteVal) esmalteVal.textContent = formatCurrency(totals.esmaltes);
    if (gelVal) gelVal.textContent = formatCurrency(totals.geladeira);
    if (manVal) manVal.textContent = formatCurrency(totals.manutencao);
    const tags = document.getElementById('dashboard-stock-tags');
    if (tags) {
      tags.innerHTML = '';
      const lbl = document.createElement('span');
      lbl.className = 'pill';
      lbl.textContent = selectedGlobalMonthKey === 'all' ? 'Todos os meses' : formatMonthWithYear(target);
      tags.appendChild(lbl);
    }
    const pieData = { esmaltes: totals.esmaltes, geladeira: totals.geladeira, manutencao: totals.manutencao };
    drawPieChart('stock-pie', pieData);

    const monthMap = {};
    stockItems.forEach(item => {
      const key = monthKeyFromDate(item.dataCompra || item.addedAt || item.createdAt);
      if (!key) return;
      monthMap[key] = (monthMap[key] || 0) + (item.custoTotal || item.custoCompra || 0);
    });
    const sorted = Object.keys(monthMap).sort();
    const recent = sorted.slice(-6);
    const series = recent.map(key => {
      const [y, m] = key.split('-').map(v => parseInt(v, 10));
      return { label: `${String(m).padStart(2, '0')}/${y}`, value: monthMap[key] };
    });
    drawBarChart('stock-bars', series);

    const lowCount = stockItems.filter(item => {
      const pct = item.volumeTotal_ml ? (item.volumeAtual_ml / item.volumeTotal_ml) : null;
      return (item.previsaoDuracaoDias && item.previsaoDuracaoDias < 15) || (pct != null && pct < 0.3);
    }).length;
    const lowEl = document.getElementById('dashboard-stock-low');
    if (lowEl) lowEl.textContent = `${lowCount}`;
    const profitEl = document.getElementById('dashboard-stock-profit');
    const fridgeProfit = stockItems
      .filter(i => (i.categoria || i.category) === 'geladeira')
      .reduce((acc, cur) => acc + ((cur.precoVenda || 0) * (cur.quantidade || 0) - (cur.custoCompra || 0)), 0);
    if (profitEl) profitEl.textContent = formatCurrency(fridgeProfit);
    const historyEntries = Object.values(stockHistories).flat();
    const monthConsumption = selectedGlobalMonthKey === 'all'
      ? 0
      : historyEntries.filter(m => (m.tipo === 'saida' || m.tipo === 'baixa') && matchesTargetMonth(m.data, target))
          .reduce((acc, cur) => acc + (cur.quantity || cur.quantidade || cur.volume || 0), 0);
    const consEl = document.getElementById('dashboard-stock-consumption-month');
    if (consEl) consEl.textContent = `${monthConsumption}`;
    const fridgeLow = stockItems.filter(item => (item.categoria || item.category) === 'geladeira' && item.quantidade && item.quantidade <= (item.unidadesPorPack || item.quantidade) * 0.2).length;
    const indicators = document.getElementById('stock-indicators');
    if (indicators) {
      indicators.innerHTML = '';
      indicators.innerHTML = `
        <span class="pill">Baixo estoque: ${lowCount}</span>
        <span class="pill">Geladeira em alerta: ${fridgeLow}</span>
      `;
    }
  }

  function renderFinance() {
    const revenueEl = document.getElementById('finance-revenue');
    const costEl = document.getElementById('finance-costs');
    const profitEl = document.getElementById('finance-profit');
    const target = getDashboardFilterTarget();
    const filtered = selectedGlobalMonthKey === 'all' ? financialEntries : financialEntries.filter(e => matchesTargetMonth(e.date, target));
    const revenue = filtered.filter(f => f.type === 'receita').reduce((acc, cur) => acc + cur.amount, 0);
    const cost = filtered.filter(f => f.type === 'despesa').reduce((acc, cur) => acc + cur.amount, 0);
    if (revenueEl) revenueEl.textContent = formatCurrency(revenue);
    if (costEl) costEl.textContent = formatCurrency(cost);
    if (profitEl) profitEl.textContent = formatCurrency(revenue - cost);
  }

  function filterClientsByRole(scope) {
    if (scope === 'ceo') return clients;
    const colabName = currentColabAccount?.name || 'colab';
    const colabId = currentColabAccount?.id || '';
    const owned = c => (c.owners || []).some(o => o.toLowerCase() === colabName.toLowerCase());
    const responsible = c => (c.responsible || '').toLowerCase() === colabName.toLowerCase() || (c.responsible || '').toLowerCase() === colabId.toLowerCase();
    const viaAppointments = c => appointments.some(a => a.clientId === c.id && ((a.professionalName || '').toLowerCase() === colabName.toLowerCase() || (a.professionalId || '').toLowerCase() === colabId.toLowerCase()));
    const viaFuture = c => (c.future || []).some(f => (f.professionalName || f.professional || '').toLowerCase() === colabName.toLowerCase());
    return clients.filter(c => owned(c) || responsible(c) || viaAppointments(c) || viaFuture(c));
  }

  function renderClients(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'clients-grid-ceo' : 'clients-grid-colab');
    const searchEl = document.getElementById(scope === 'ceo' ? 'client-search-ceo' : 'client-search-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const search = (searchEl?.value || '').toLowerCase();
    const filtered = filterClientsByRole(scope)
      .filter(c => c.name.toLowerCase().includes(search) || (c.phone || '').includes(search));

    filtered.forEach(c => {
      const card = document.createElement('div');
      card.className = 'client-card';
      const badge = `<span class="badge-soft">${c.lastService || ''}${c.lastDate ? '  ' + c.lastDate : ''}</span>`;
      const whatsapp = buildWhatsAppLink(c);
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.4rem;">
          <div>
            <div class="client-name">${c.name}</div>
            <div class="client-meta">${badge}</div>
            <div class="client-meta">${c.prefColor ? 'Cor: ' + c.prefColor + '  ' : ''}${c.prefShape ? 'Formato: ' + c.prefShape : ''}</div>
            <div class="client-meta">${c.notes || 'Sem observaes'}</div>
          </div>
          <div class="client-pill">${c.nextAppointment?.time || '--:--'}  ${c.nextAppointment?.date ? formatDateLabel(c.nextAppointment.date) : 'agenda'}</div>
        </div>
        <div class="client-meta" style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
          <a href="${whatsapp}" target="_blank" rel="noopener">${c.phone}</a>
          ${c.instagram ? `<span class="badge-soft">${c.instagram}</span>` : ''}
          <span class="badge-soft">ltimo: ${c.lastService || ''}</span>
        </div>
        <div class="client-actions">
          <div class="inline-actions">
            <button class="secondary" onclick="openClientDetails('${c.id}')">Ver ficha</button>
            <button class="secondary" onclick="openAppointmentModal('${c.id}')">Agendar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openClientModal('edit','${c.id}')"> Editar</button>
            <button class="ghost-btn secondary icon-mini" onclick="openRemoveClientModal('${c.id}')"> Remover</button>
          </div>
          <span class="client-pill">${c.responsible || (c.owners || ['Responsvel'])[0]}</span>
        </div>
      `;
      listEl.appendChild(card);
    });

    if (!filtered.length) {
      listEl.innerHTML = '<div class="client-meta">Nenhuma cliente encontrada.</div>';
    }

    renderClientsDatalist();
  }

  function renderClientsDatalist() {
    const datalist = document.getElementById('clients-datalist');
    if (!datalist) return;
    datalist.innerHTML = '';
    clients.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.dataset.id = c.id;
      datalist.appendChild(opt);
    });
  }

  function setAgendaView(mode, scope = 'ceo') {
    if (scope === 'ceo') {
      agendaViewMode = mode;
    } else {
      agendaViewModeColab = mode;
    }
    const yearView = document.getElementById(scope === 'ceo' ? 'agenda-view-year' : 'agenda-view-year-colab');
    const monthView = document.getElementById(scope === 'ceo' ? 'agenda-view-month' : 'agenda-view-month-colab');
    const btnYear = document.getElementById(scope === 'ceo' ? 'agenda-toggle-year' : 'agenda-toggle-year-colab');
    const btnMonth = document.getElementById(scope === 'ceo' ? 'agenda-toggle-month' : 'agenda-toggle-month-colab');
    if (yearView && monthView) {
      yearView.classList.toggle('hidden', mode !== 'year');
      monthView.classList.toggle('hidden', mode !== 'month');
    }
    if (btnYear && btnMonth) {
      btnYear.classList.toggle('active', mode === 'year');
      btnMonth.classList.toggle('active', mode === 'month');
    }
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
    renderAgendaAppointments(scope);
    renderYearCalendar(scope);
  }

  function getProfessionalColor(name) {
    const match = collaborators.find(c => c.name.toLowerCase() === (name || '').toLowerCase());
    return match?.color || getCssVar('--chart-gold', '#B7A06A');
  }

  function getAppointmentsForScope(scope = 'ceo') {
    let list = appointments.filter(a => a.status !== 'canceled');
    if (scope === 'colab') {
      const colabName = (currentColabAccount?.name || '').toLowerCase();
      const colabId = (currentColabAccount?.id || '').toLowerCase();
      list = list.filter(a => (a.professionalName || '').toLowerCase() === colabName || (a.professionalId || '').toLowerCase() === colabId);
    }
    const activeFilter = scope === 'ceo' ? agendaProfessionalFilter : agendaProfessionalFilterColab;
    if (activeFilter && activeFilter !== 'all') {
      list = list.filter(a => getProfessionalKey(a) === activeFilter.toLowerCase() || (a.professionalName || '').toLowerCase() === activeFilter.toLowerCase());
    }
    return list;
  }

  function filterAppointmentsByScope(scope = 'ceo') {
    return getAppointmentsForScope(scope);
  }

  // -------- Atendimento: iniciar/finalizar --------
  function renderAtendimentoAction(appt) {
    if (!appt?.id) return '';
    if (appt.status === 'em_atendimento') {
      return `
        <button class="ghost-btn secondary icon-mini" aria-label="Itens da comanda" onclick="openComandaPanel('${appt.comandaId || ''}', '${appt.clientName || appt.cliente || 'Cliente'}', '${appt.professionalName || appt.professional || 'Profissional'}')"></button>
        <button class="ghost-btn secondary icon-mini" aria-label="Finalizar atendimento" onclick="handleFinalizarAtendimento('${appt.id}')"></button>
      `;
    }
    if (appt.status === 'finalizado') {
      return `<span class="badge-soft">Finalizado</span>`;
    }
    return `<button class="ghost-btn secondary icon-mini" aria-label="Iniciar atendimento" onclick="handleStartAtendimento('${appt.id}')"></button>`;
  }

  function getServicePriceByAppointment(appt) {
    if (!appt) return 0;
    const svc = kioskServices.find(s => s.id === appt.serviceId) || kioskServices.find(s => (s.name || '').toLowerCase() === (appt.serviceName || appt.service || '').toLowerCase());
    const fallback = Number(appt.price || appt.valor || 0);
    return svc?.price || fallback || 0;
  }

  async function handleStartAtendimento(atendimentoId) {
    try {
      if (!window.startAtendimento) throw new Error('Funo startAtendimento no disponvel');
      const appt = appointments.find(a => a.id === atendimentoId);
      const res = await window.startAtendimento(atendimentoId, {
        nome: appt?.serviceName || appt?.service || 'Servio',
        preco: getServicePriceByAppointment(appt),
        tipo: 'servico',
        quantidade: 1
      });
      // Atualiza lista local
      appointments = appointments.map(a => a.id === atendimentoId ? { ...a, status: 'em_atendimento', comandaId: res.comandaId } : a);
      refreshAgendaFromAppointments();
      openComandaPanel(res.comandaId, appt?.clientName || 'Cliente', appt?.professionalName || appt?.professional || 'Profissional');
    } catch (err) {
      alert('No foi possvel iniciar o atendimento.');
      console.error(err);
    }
  }

  async function handleFinalizarAtendimento(atendimentoId) {
    try {
      await openFinalizarComandaModal(atendimentoId);
    } catch (err) {
      alert('No foi possvel finalizar o atendimento.');
      console.error(err);
    }
  }

  async function applyStockConsumptionFromComanda(itens = []) {
    if (!firestore || !Array.isArray(itens) || !itens.length) return;
    const nowISO = new Date().toISOString();
    for (const item of itens) {
      const stockId = item.estoqueId || item.stockId;
      if (!stockId) continue;
      try {
        const ref = firestore.collection('stock').doc(stockId);
        const snap = await ref.get();
        if (!snap.exists) continue;
        const data = snap.data() || {};
        const categoria = data.categoria || data.category || item.categoriaEstoque;
        const quantidade = Number(item.quantidade || 1);
        if (categoria === 'esmaltes') {
          const consumo = data.consumoEstimadoPorUso || quantidade;
          const remaining = Math.max(0, (data.volumeAtual_ml || data.volumeTotal_ml || 0) - consumo);
          const usesPerDay = 3;
          const previsao = (data.consumoEstimadoPorUso || 0) > 0
            ? Math.round(remaining / ((data.consumoEstimadoPorUso || 0) * usesPerDay))
            : data.previsaoDuracaoDias || 0;
          await ref.set({ volumeAtual_ml: remaining, previsaoDuracaoDias: previsao, updatedAt: nowISO }, { merge: true });
          await saveStockHistory(stockId, {
            tipo: 'baixa',
            volume: consumo,
            quantidade: consumo,
            data: nowISO,
            origem: 'comanda',
            ref: item.itemId || item.nome || 'consumo'
          });
        } else {
          const remaining = Math.max(0, (data.quantidade || 0) - quantidade);
          await ref.set({ quantidade: remaining, updatedAt: nowISO }, { merge: true });
          await saveStockHistory(stockId, {
            tipo: 'saida',
            quantidade,
            data: nowISO,
            origem: 'comanda',
            ref: item.itemId || item.nome || 'consumo'
          });
        }
      } catch (err) {
        console.error('Falha ao baixar estoque pelo atendimento', err);
      }
    }
  }

  function buildClientHistoryEntries(appt, itens, total) {
    const now = new Date();
    const dateLabel = now.toLocaleDateString('pt-BR');
    const timeLabel = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    const serviceName = appt?.serviceName || appt?.service || 'Servio';
    const totalConsumos = itens
      .filter(it => it.tipo === 'consumo')
      .reduce((acc, it) => acc + (Number(it.preco || 0) * Number(it.quantidade || 1)), 0);
    const historyEntry = `${dateLabel} ${timeLabel}  ${serviceName} (${formatCurrency(total - totalConsumos)})  Consumos: ${formatCurrency(totalConsumos)}  Total: ${formatCurrency(total)}`;
    const consumeEntry = `${dateLabel} ${timeLabel}  ${itens.length} item(ns)  ${formatCurrency(total)}`;
    return { historyEntry, consumeEntry };
  }

  async function finalizeAtendimento(atendimentoId) {
    if (!firestore) throw new Error('Firestore indisponvel');
    const atendRef = firestore.collection('atendimentos').doc(atendimentoId);
    const atendSnap = await atendRef.get();
    if (!atendSnap.exists) throw new Error('Atendimento no encontrado');
    const appt = atendSnap.data();

    const nowISO = new Date().toISOString();
    let itensRegistrados = [];
    let consumoTotal = 0;
    let servicoTotal = getServicePriceByAppointment(appt);

    if (appt.comandaId) {
      const comandaSnap = await firestore.collection('comandas').doc(appt.comandaId).get();
      if (comandaSnap.exists) {
        const comanda = comandaSnap.data() || {};
        itensRegistrados = (comanda.itensProfissional || [])
          .concat(comanda.itensCliente || [])
          .concat(comanda.itens || comanda.items || []);
        consumoTotal = itensRegistrados.reduce((acc, item) => {
          const preco = Number(item.preco || item.valor || 0);
          const qtd = Number(item.quantidade || item.qtd || 1);
          return acc + (preco * qtd);
        }, 0);
        if (itensRegistrados.some(it => it.tipo === 'servico')) {
          servicoTotal = 0;
        }

        const pagamentos = Array.isArray(comanda.pagamentos) ? [...comanda.pagamentos] : [];
        pagamentos.push({
          valor: consumoTotal + servicoTotal,
          data: nowISO,
          metodo: 'registrado',
          profissional: appt.professionalName || appt.professional || 'Equipe'
        });
        await firestore.collection('comandas').doc(appt.comandaId).set({
          status: 'fechada',
          total: consumoTotal + servicoTotal,
          pagamentoRegistradoEm: nowISO,
          pagamentoTotal: consumoTotal + servicoTotal,
          pagamentos,
          atualizadoEm: nowISO
        }, { merge: true });
      }
    }

    const total = (servicoTotal || 0) + consumoTotal;

    await atendRef.set({
      status: 'finalizado',
      total,
      atualizadoEm: nowISO
    }, { merge: true });

    if (appt.clientId) {
      try {
        const cliRef = firestore.collection('clients').doc(appt.clientId);
        const cliSnap = await cliRef.get();
        const cliData = cliSnap.exists ? cliSnap.data() || {} : {};
        const itensParaHistorico = itensRegistrados.length
          ? itensRegistrados
          : [{ tipo: 'servico', preco: servicoTotal, quantidade: 1 }];
        const { historyEntry, consumeEntry } = buildClientHistoryEntries(appt, itensParaHistorico, total);
        const history = Array.isArray(cliData.history) ? [...cliData.history, historyEntry] : [historyEntry];
        const consume = Array.isArray(cliData.consume) ? [...cliData.consume, consumeEntry] : [consumeEntry];
        await cliRef.set({
          history,
          consume,
          lastService: appt.serviceName || appt.service || 'Servio',
          lastDate: nowISO.split('T')[0],
          updatedAt: nowISO
        }, { merge: true });
      } catch (err) {
        console.error('Falha ao registrar histrico da cliente', err);
      }
    }

    try {
      await firestore.collection('financial').add({
        type: 'receita',
        amount: total,
        date: nowISO,
        description: `Pagamento atendimento ${appt.clientName || appt.cliente || ''}`.trim(),
        atendimentoId,
        comandaId: appt.comandaId || null,
        clientId: appt.clientId || appt.clienteId || null,
        professionalId: appt.professionalId || appt.professional || null,
        serviceName: appt.serviceName || appt.service || 'Servio'
      });
    } catch (err) {
      console.error('Falha ao registrar financeiro do atendimento', err);
    }

    if (itensRegistrados.length) {
      await applyStockConsumptionFromComanda(itensRegistrados);
    }

    return { atendimentoId, status: 'finalizado', total };
  }

  function setAgendaProfessionalFilter(value, scope = 'ceo') {
    if (scope === 'ceo') {
      agendaProfessionalFilter = value || 'all';
    } else {
      agendaProfessionalFilterColab = value || (currentColabAccount?.id || 'all');
    }
    renderYearCalendar(scope);
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
    renderAgendaAppointments(scope);
    renderDayAppointmentsModal();
  }

  function renderAgendaAppointments(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'agenda-appointments-list' : 'agenda-appointments-list-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const now = new Date();
    const items = filterAppointmentsByScope(scope)
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .filter(a => a.dateObj.toString() !== 'Invalid Date' && a.dateObj >= now)
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!items.length) {
      listEl.innerHTML = '<div class="subtext">Nenhum agendamento futuro.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const card = document.createElement('div');
      card.className = 'appointment-card';
      card.style.setProperty('--appt-color', color);
      card.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title">
            ${client ? client.name : (appt.clientName || 'Cliente')}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${formatDateLabel(appt.date)}  ${appt.time}</span>
            <span>Servio: ${appt.serviceName || appt.service}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" aria-label="Editar" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"></button>
          <button class="ghost-btn secondary icon-mini" aria-label="Remover" onclick="openRemoveAppointmentModal('${appt.id}')"></button>
          ${renderAtendimentoAction(appt)}
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  function openRemoveAppointmentModal(id) {
    pendingRemoveAppointmentId = id;
    openDialog('appointment-remove-modal');
  }

  async function confirmRemoveAppointment() {
    if (!pendingRemoveAppointmentId) return;
    const apptIndex = appointments.findIndex(a => a.id === pendingRemoveAppointmentId);
    if (apptIndex >= 0) {
      const appt = appointments[apptIndex];
      appointments.splice(apptIndex, 1);
      rebuildClientAppointments(appt.clientId);
    }
    if (firestore) {
      try {
        await firestore.collection('atendimentos').doc(pendingRemoveAppointmentId).delete();
      } catch (err) {
        console.error('Falha ao remover agendamento no servidor', err);
      }
    }
    pendingRemoveAppointmentId = null;
    refreshAgendaFromAppointments();
    renderClients('ceo');
    renderClients('colab');
    if (currentClientDetailId) renderClientDetailTab();
    renderAgendaAppointments('ceo');
    renderAgendaAppointments('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('colab');
    closeDialog('appointment-remove-modal');
  }

  function populateProfessionalFilters() {
    const ceoSelect = document.getElementById('agenda-prof-filter');
    const colabSelect = document.getElementById('agenda-prof-filter-colab');
    const optionList = [{ id: 'all', name: 'Todos' }, ...collaborators.map(c => ({ id: c.id || slugify(c.name), name: c.name }))];

    if (ceoSelect) {
      ceoSelect.innerHTML = '';
      optionList.forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.id;
        opt.textContent = optData.name;
        ceoSelect.appendChild(opt);
      });
      ceoSelect.value = agendaProfessionalFilter;
    }

    if (colabSelect) {
      colabSelect.innerHTML = '';
      const colabOptions = currentColabAccount ? [{ id: currentColabAccount.id || slugify(currentColabAccount.name), name: currentColabAccount.name }] : collaborators.map(c => ({ id: c.id || slugify(c.name), name: c.name }));
      colabOptions.forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.id;
        opt.textContent = optData.name;
        colabSelect.appendChild(opt);
      });
      colabSelect.value = agendaProfessionalFilterColab;
      if (!colabSelect.value && colabOptions[0]) colabSelect.value = colabOptions[0].id;
      colabSelect.disabled = true;
    }
  }

  function renderCeoContent() {
    setupMonthSelects();
    populateProfessionalFilters();
    renderDashboardCards();
    renderYearCalendar('ceo');
    setAgendaView(agendaViewMode, 'ceo');
    renderAgendaMonthSummary('ceo');
    renderAgendaAppointments('ceo');
    switchInventoryTab(currentInventoryTab);
    renderInventory();
    renderCollaborators();
    renderServicesTable();
    renderInvestments();
    renderClients('ceo');
  }

  function renderColabContent() {
    setupMonthSelects();
    populateProfessionalFilters();
    renderYearCalendar('colab');
    setAgendaView(agendaViewModeColab, 'colab');
    renderAgendaMonthSummary('colab');
    renderAgendaAppointments('colab');
    renderClients('colab');
  }

  function renderYearCalendar(scope = 'ceo') {
    const container = document.getElementById(scope === 'ceo' ? 'year-calendar' : 'year-calendar-colab');
    if (!container) return;
    container.innerHTML = '';
    baseYearDetailed.forEach(m => {
      const monthData = buildMonthSnapshot(m.monthIndex, scope);
      const div = document.createElement('div');
      const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
      div.className = 'month-card' + (m.monthIndex === selected ? ' active' : '');

      const header = document.createElement('div');
      header.className = 'month-header';
      header.innerHTML = `
        <div class="month-name">${m.fullName}</div>
        <div class="month-stat">${monthData.bookings} atend.</div>
      `;

      const bar = document.createElement('div');
      bar.className = 'month-bar';
      bar.innerHTML = `<div class="month-bar-fill" style="width:${monthData.occupancy}%;"></div>`;

      const mini = document.createElement('div');
      mini.className = 'mini-calendar';
      mini.innerHTML = `
        <div class="mini-weekdays">
          <span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span><span>D</span>
        </div>
      `;

      const daysGrid = document.createElement('div');
      daysGrid.className = 'mini-days';
      const days = buildMonthDays(calendarYear, m.monthIndex, monthData.highlightDays);
      days.forEach(d => {
        const span = document.createElement('span');
        span.className = 'mini-day' + (d.hasBooking ? ' has-booking' : '') + (d.empty ? ' empty' : '');
        span.textContent = d.label;
        if (!d.empty) {
          span.onclick = () => openDayAppointmentsModal(`${calendarYear}-${String(m.monthIndex + 1).padStart(2, '0')}-${String(d.label).padStart(2, '0')}`, scope);
        }
        if (d.hasBooking) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          span.appendChild(dot);
        }
        daysGrid.appendChild(span);
      });
      mini.appendChild(daysGrid);

      const footnote = document.createElement('div');
      footnote.className = 'month-footnote';
      footnote.innerHTML = `
        <span>Ocupao: ${monthData.occupancy}%</span>
        <span class="tag">ver ms</span>
      `;

      div.appendChild(header);
      div.appendChild(bar);
      div.appendChild(mini);
      div.appendChild(footnote);
      div.onclick = () => setSelectedMonth(m.monthIndex, scope);
      container.appendChild(div);
    });
  }

  function renderAgendaMonthCalendar(scope = 'ceo') {
    const calendarEl = document.getElementById(scope === 'ceo' ? 'agenda-month-calendar' : 'agenda-month-calendar-colab');
    const selector = document.getElementById(scope === 'ceo' ? 'agenda-month-selector' : 'agenda-month-selector-colab');
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    if (selector) selector.value = selected;
    if (!calendarEl) return;
    calendarEl.innerHTML = '';
    const weekdays = ['S', 'T', 'Q', 'Q', 'S', 'S', 'D'];
    weekdays.forEach(day => {
      const w = document.createElement('div');
      w.className = 'weekday';
      w.textContent = day;
      calendarEl.appendChild(w);
    });
    const month = buildMonthSnapshot(selected, scope);
    const days = buildMonthDays(calendarYear, month.monthIndex, month.highlightDays);
    days.forEach(d => {
      const cell = document.createElement('div');
      if (d.empty) {
        cell.style.background = 'transparent';
        calendarEl.appendChild(cell);
        return;
      }
      const match = month.daysSummary.find(day => day.day.startsWith(String(d.label).padStart(2, '0')));
      const hasBooking = Boolean(match);
      cell.className = 'month-day' + (hasBooking ? ' has-booking' : '');
      const badgeText = hasBooking ? `${match.count} ag.` : 'Livre';
      cell.innerHTML = `
        <div class="day-number">${d.label}</div>
        <span class="day-badge" style="${hasBooking ? '' : 'background:transparent;color:var(--text-muted);'}">${badgeText}</span>
      `;
      cell.onclick = () => {
        openDayAppointmentsModal(`${calendarYear}-${String(month.monthIndex + 1).padStart(2, '0')}-${String(d.label).padStart(2, '0')}`, scope);
      };
      calendarEl.appendChild(cell);
    });
  }

  function renderAgendaMonthSummary(scope = 'ceo') {
    const tbody = document.getElementById(scope === 'ceo' ? 'agenda-month-summary' : 'agenda-month-summary-colab');
    const cardsDiv = document.getElementById(scope === 'ceo' ? 'agenda-month-cards' : 'agenda-month-cards-colab');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (cardsDiv) cardsDiv.innerHTML = '';
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    const month = buildMonthSnapshot(selected, scope);
    const monthTitle = document.getElementById(scope === 'ceo' ? 'selected-month-title' : 'selected-month-title-colab');
    const tagContainer = document.getElementById(scope === 'ceo' ? 'selected-month-tags' : 'selected-month-tags-colab');
    if (monthTitle) monthTitle.textContent = `Agenda de ${month.fullName}`;
    if (tagContainer) {
      tagContainer.innerHTML = '';
      month.tags.forEach(t => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = t;
        tagContainer.appendChild(span);
      });
      if (!month.tags.length) {
        const total = document.createElement('span');
        total.className = 'pill';
        total.textContent = `${month.bookings} atend.`;
        tagContainer.appendChild(total);
      }
      const ocup = document.createElement('span');
      ocup.className = 'pill';
      ocup.textContent = `${month.occupancy}% ocupao`;
      tagContainer.appendChild(ocup);
    }
    const scopedAppointments = getAppointmentsForScope(scope)
      .filter(a => {
        if (!a.date) return false;
        const [year, month] = a.date.split('-').map(Number);
        if (!month) return false;
        if (!year) return month - 1 === selected;
        return month - 1 === selected && year === calendarYear;
      })
      .map(a => ({
        ...a,
        dateObj: new Date(`${a.date}T${a.time || '00:00'}`)
      }))
      .sort((a, b) => a.dateObj - b.dateObj);

    const isMobile = window.innerWidth <= 800;

    if (!scopedAppointments.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="subtext">Nenhum agendamento neste ms.</td>`;
      tbody.appendChild(tr);
      if (cardsDiv) cardsDiv.innerHTML = '<div class="subtext">Nenhum agendamento neste ms.</div>';
      return;
    }

    const tableEl = tbody.closest('table');
    const container = tableEl?.parentElement;
    if (container && isMobile) {
      container.style.maxHeight = '520px';
      container.style.overflowY = 'auto';
    } else if (container) {
      container.style.maxHeight = '';
      container.style.overflowY = '';
    }
    if (tableEl && tableEl.querySelector('thead')) {
      tableEl.querySelector('thead').style.display = isMobile ? 'none' : '';
    }

    if (isMobile) {
      let cardsHtml = '';
      scopedAppointments.forEach(appt => {
        const client = clients.find(c => c.id === appt.clientId);
        const clientName = client ? client.name : (appt.clientName || 'Cliente');
        const color = getProfessionalColor(appt.professionalName || appt.professional);
        cardsHtml += `
          <div class="agenda-card-mobile">
            <div class="row" style="justify-content:space-between;">
              <span class="badge-soft">${formatDateLabel(appt.date)}</span>
              <span class="badge-soft">${appt.time || '--:--'}</span>
            </div>
            <div class="row">
              <span class="pill">${clientName}</span>
              <span class="pill">${appt.serviceName || appt.service}</span>
              <span class="pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
            </div>
            <div class="actions">
              <button class="ghost-btn secondary icon-mini" aria-label="Editar" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"></button>
              <button class="ghost-btn secondary icon-mini" aria-label="Remover" onclick="openRemoveAppointmentModal('${appt.id}')"></button>
              ${renderAtendimentoAction(appt)}
            </div>
          </div>
        `;
      });
      if (cardsDiv) {
        cardsDiv.innerHTML = cardsHtml;
        cardsDiv.classList.remove('hidden');
      }
      if (tableEl) tableEl.parentElement.style.display = 'none';
      return;
    }
    if (cardsDiv) cardsDiv.classList.add('hidden');
    if (tableEl) tableEl.parentElement.style.display = '';

    scopedAppointments.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const clientName = client ? client.name : (appt.clientName || 'Cliente');
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDateLabel(appt.date)}</td>
        <td>${appt.time || '--:--'}</td>
        <td>${clientName}</td>
        <td>${appt.serviceName || appt.service}</td>
        <td><span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span></td>
        <td>
          <div class="table-action-row">
            <button class="ghost-btn secondary icon-mini" aria-label="Editar" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"></button>
            <button class="ghost-btn secondary icon-mini" aria-label="Remover" onclick="openRemoveAppointmentModal('${appt.id}')"></button>
            ${renderAtendimentoAction(appt)}
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function ensureAgendaDayPicker(scope = 'ceo') {
    const picker = document.getElementById(scope === 'ceo' ? 'agenda-day-picker' : 'agenda-day-picker-colab');
    const fallback = new Date().toISOString().split('T')[0];
    if (picker && !picker.value) picker.value = agendaDaySelectedDate[scope] || fallback;
    agendaDaySelectedDate[scope] = picker?.value || agendaDaySelectedDate[scope] || fallback;
    return agendaDaySelectedDate[scope];
  }

  function setAgendaSummaryTab(tab, scope = 'ceo') {
    agendaSummaryTab[scope] = tab;
    const monthCard = document.getElementById(scope === 'ceo' ? 'agenda-month-card' : 'agenda-month-card-colab');
    const dayCard = document.getElementById(scope === 'ceo' ? 'agenda-day-card' : 'agenda-day-card-colab');
    const monthBtn = document.getElementById(scope === 'ceo' ? 'agenda-tab-month' : 'agenda-tab-month-colab');
    const dayBtn = document.getElementById(scope === 'ceo' ? 'agenda-tab-day' : 'agenda-tab-day-colab');
    if (monthCard) monthCard.classList.toggle('hidden', tab !== 'month');
    if (dayCard) dayCard.classList.toggle('hidden', tab !== 'day');
    if (monthBtn) monthBtn.classList.toggle('active', tab === 'month');
    if (dayBtn) dayBtn.classList.toggle('active', tab === 'day');
    if (tab === 'day') renderAgendaDayList(scope);
  }

  function renderAgendaDayList(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'agenda-day-list' : 'agenda-day-list-colab');
    if (!listEl) return;
    const dateStr = ensureAgendaDayPicker(scope);
    listEl.innerHTML = '';
    const items = getAppointmentsForScope(scope)
      .filter(a => a.date === dateStr && a.status !== 'canceled')
      .map(a => ({ ...a, dateObj: new Date(`${a.date}T${a.time || '00:00'}`) }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!items.length) {
      listEl.innerHTML = '<div class="subtext">Nenhum agendamento para este dia.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const card = document.createElement('div');
      card.className = 'appointment-card';
      card.style.setProperty('--appt-color', color);
      card.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title" style="font-size:1rem;">
            ${appt.time || '--:--'}  ${appt.serviceName || appt.service}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${client ? client.name : appt.clientName || 'Cliente'}</span>
            <span>${appt.status === 'done' ? 'Concludo' : 'Agendado'}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}', '${appt.date}', '${appt.time || ''}')"> Editar</button>
          <button class="ghost-btn secondary icon-mini" onclick="openRemoveAppointmentModal('${appt.id}')"> Cancelar</button>
          ${renderAtendimentoAction(appt)}
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  function openDayAgendaFromTab(scope = 'ceo') {
    const dateStr = ensureAgendaDayPicker(scope);
    openDayAgenda(dateStr, scope);
  }

  function setSelectedMonth(index, scope = 'ceo') {
    if (scope === 'ceo') {
      selectedMonthIndex = index;
    } else {
      selectedMonthIndexColab = index;
    }
    renderYearCalendar(scope);
    renderAgendaMonthCalendar(scope);
    renderAgendaMonthSummary(scope);
  }

  function buildMonthSnapshot(monthIndex, scope = 'ceo') {
    const base = baseYearDetailed[monthIndex] || { monthIndex, fullName: monthNamesFull[monthIndex] || '', month: monthNamesShort[monthIndex] || '', tags: [] };
    const scopedAppointments = getAppointmentsForScope(scope).filter(a => {
      if (!a.date) return false;
      const [year, month] = a.date.split('-').map(Number);
      if (!month) return false;
      if (!year) return month - 1 === monthIndex;
      return month - 1 === monthIndex && year === calendarYear;
    });

    const dayMap = {};
    scopedAppointments.forEach(appt => {
      const [, month, day] = (appt.date || '').split('-');
      const dayNum = parseInt(day, 10);
      if (!dayNum) return;
      if (!dayMap[dayNum]) dayMap[dayNum] = { count: 0, pros: '', highlight: '' };
      dayMap[dayNum].count += 1;
      dayMap[dayNum].pros = mergePros(dayMap[dayNum].pros, appt.professionalName || appt.professional || 'Equipe');
      dayMap[dayNum].highlight = appt.serviceName || appt.service || dayMap[dayNum].highlight || 'Agendado';
    });

    const highlightDays = Object.keys(dayMap).map(Number).sort((a, b) => a - b);
    const daysSummary = highlightDays.map(day => ({
      day: `${String(day).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')}`,
      count: dayMap[day].count,
      pros: dayMap[day].pros || 'Equipe',
      highlight: dayMap[day].highlight || 'Agendado'
    }));

    const daysInMonth = new Date(calendarYear, monthIndex + 1, 0).getDate();
    const occupancy = Math.round((highlightDays.length / daysInMonth) * 100) || 0;

    return { ...base, bookings: scopedAppointments.length, highlightDays, daysSummary, occupancy };
  }

  function buildMonthDays(year, monthIndex, highlightDays = []) {
    const result = [];
    const firstWeekday = new Date(year, monthIndex, 1).getDay(); // 0=domingo
    const offset = (firstWeekday + 6) % 7; // fora a semana a comear na segunda
    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
    for (let i = 0; i < offset; i++) {
      result.push({ empty: true, label: '' });
    }
    for (let d = 1; d <= daysInMonth; d++) {
      result.push({
        label: d,
        hasBooking: highlightDays.includes(d)
      });
    }
    return result;
  }

  function mergePros(existing, professional) {
    if (!existing) return professional || 'Equipe';
    if (!professional) return existing;
    const parts = existing.split('+').map(p => p.trim());
    if (parts.includes(professional)) return existing;
    return `${existing} + ${professional}`;
  }

  function refreshAgendaFromAppointments() {
    clients.forEach(c => rebuildClientAppointments(c.id));
    renderYearCalendar('ceo');
    renderYearCalendar('colab');
    renderAgendaMonthCalendar('ceo');
    renderAgendaMonthCalendar('colab');
    renderAgendaMonthSummary('ceo');
    renderAgendaMonthSummary('colab');
    renderAgendaDayList('ceo');
    renderAgendaDayList('colab');
    renderDayAppointmentsModal();
  }

  function switchInventoryTab(category) {
    currentInventoryCategory = category;
    currentInventoryTab = category;
    const panels = {
      esmaltes: 'inventory-panel-esmaltes',
      geladeira: 'inventory-panel-geladeira',
      manutencao: 'inventory-panel-manutencao'
    };
    const buttons = {
      esmaltes: 'inventory-tab-btn-polish',
      geladeira: 'inventory-tab-btn-fridge',
      manutencao: 'inventory-tab-btn-maint'
    };
    Object.entries(panels).forEach(([cat, id]) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden', cat !== category);
    });
    Object.entries(buttons).forEach(([cat, id]) => {
      const btn = document.getElementById(id);
      if (btn) btn.classList.toggle('active', cat === category);
    });
    const select = document.getElementById('inventory-category');
    if (select) select.value = category;
    renderInventoryTemplates();
    renderInventory();
    renderFabActions();
  }

  function resetInventoryFields() {
    ['stock-polish-name','stock-polish-brand','stock-polish-total','stock-polish-current','stock-polish-cost','stock-polish-consumption','stock-polish-date','stock-polish-forecast','stock-fridge-name','stock-fridge-qty','stock-fridge-cost','stock-fridge-price','stock-fridge-date','stock-maint-name','stock-maint-qty','stock-maint-cost','stock-maint-date']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    const kiosk = document.getElementById('inventory-kiosk-flag');
    if (kiosk) kiosk.value = 'active';
  }

  function closeInventoryModal() {
    const modal = document.getElementById('inventory-modal');
    inventoryFormMode = 'add';
    inventoryEditingId = null;
    resetInventoryFields();
    if (modal) modal.classList.add('hidden');
  }

  function handleInventoryDestinationChange(value) {
    currentInventoryCategory = value;
    const select = document.getElementById('inventory-category');
    if (select) select.value = value;
    ['inventory-fields-esmaltes', 'inventory-fields-geladeira', 'inventory-fields-manutencao'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden', !id.includes(value));
    });
    renderInventoryTemplates();
    updatePolishForecast();
  }

  function updatePolishForecast() {
    const current = parseFloat(document.getElementById('stock-polish-current')?.value || '0');
    const consumption = parseFloat(document.getElementById('stock-polish-consumption')?.value || '0');
    const usesPerDay = 3;
    const forecast = consumption > 0 ? Math.round(current / (consumption * usesPerDay)) : 0;
    const forecastEl = document.getElementById('stock-polish-forecast');
    if (forecastEl) forecastEl.value = forecast ? `${forecast} dias` : '';
  }

  function applyInventoryTemplate(templateId) {
    const tmpl = productTemplates.find(t => t.id === templateId);
    if (!tmpl) return;
    currentInventoryCategory = tmpl.categoria || tmpl.category || currentInventoryCategory;
    handleInventoryDestinationChange(currentInventoryCategory);
    if (currentInventoryCategory === 'esmaltes') {
      document.getElementById('stock-polish-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('stock-polish-brand').value = tmpl.marca || 'Studio Nails';
      document.getElementById('stock-polish-total').value = tmpl.volumeTotal || tmpl.volumePorPack || '';
      document.getElementById('stock-polish-current').value = tmpl.volumeTotal || tmpl.volumePorPack || '';
    } else if (currentInventoryCategory === 'geladeira') {
      document.getElementById('stock-fridge-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('stock-fridge-qty').value = tmpl.unidadesPorPack || tmpl.volumePorPack || '';
    } else {
      document.getElementById('stock-maint-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('stock-maint-qty').value = tmpl.unidadesPorPack || '';
    }
    updatePolishForecast();
  }

  function stockIconFor(item) {
    const lower = (item?.nome || item?.name || '').toLowerCase();
    if (lower.includes('gua') || lower.includes('agua')) return '';
    if (lower.includes('caf') || lower.includes('cafe')) return '';
    if (lower.includes('energy') || lower.includes('ener')) return '';
    if (lower.includes('suco')) return '';
    return '';
  }

  function openInventoryModal(itemId = null) {
    closeFabMenu();
    inventoryFormMode = itemId ? 'edit' : 'add';
    inventoryEditingId = itemId;
    resetInventoryFields();
    const item = stockItems.find(i => i.id === itemId);
    const modal = document.getElementById('inventory-modal');
    const title = document.getElementById('inventory-modal-title');
    const kioskFlag = document.getElementById('inventory-kiosk-flag');
    const category = item?.categoria || item?.category || currentInventoryCategory;
    handleInventoryDestinationChange(category || 'esmaltes');
    if (title) title.textContent = item ? 'Editar item' : 'Adicionar item';
    if (kioskFlag) kioskFlag.value = item?.paused ? 'paused' : 'active';
    if (item && category === 'esmaltes') {
      document.getElementById('stock-polish-name').value = item.nome || '';
      document.getElementById('stock-polish-brand').value = item.marca || '';
      document.getElementById('stock-polish-total').value = item.volumeTotal_ml || '';
      document.getElementById('stock-polish-current').value = item.volumeAtual_ml || '';
      document.getElementById('stock-polish-cost').value = item.custoTotal || '';
      document.getElementById('stock-polish-consumption').value = item.consumoEstimadoPorUso || '';
      document.getElementById('stock-polish-date').value = item.dataCompra || '';
    }
    if (item && category === 'geladeira') {
      document.getElementById('stock-fridge-name').value = item.nome || '';
      document.getElementById('stock-fridge-qty').value = item.quantidade || '';
      document.getElementById('stock-fridge-cost').value = item.custoCompra || '';
      document.getElementById('stock-fridge-price').value = item.precoVenda || '';
      document.getElementById('stock-fridge-date').value = item.dataCompra || '';
    }
    if (item && category === 'manutencao') {
      document.getElementById('stock-maint-name').value = item.nome || '';
      document.getElementById('stock-maint-qty').value = item.quantidade || '';
      document.getElementById('stock-maint-cost').value = item.custoCompra || '';
      document.getElementById('stock-maint-date').value = item.dataCompra || '';
    }
    updatePolishForecast();
    ['stock-polish-current','stock-polish-consumption'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.oninput = updatePolishForecast;
    });
    if (modal) modal.classList.remove('hidden');
  }

  function renderInventoryTemplates() {
    const chips = document.getElementById('inventory-template-chips');
    const modalRow = document.getElementById('inventory-template-row');
    const filtered = productTemplates.filter(t => (t.categoria || t.category) === currentInventoryCategory);
    if (chips) {
      chips.innerHTML = '';
      if (!filtered.length) {
        chips.innerHTML = '<span class="subtext">Nenhum template salvo.</span>';
      } else {
        filtered.forEach(t => {
          const chip = document.createElement('div');
          chip.className = `template-chip ${currentInventoryCategory}`;
          chip.onclick = () => openTemplateManager(t.id);
          const icon = document.createElement('div');
          icon.className = 'icon';
          icon.textContent = currentInventoryCategory === 'geladeira' ? '' : currentInventoryCategory === 'manutencao' ? '' : '';
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.innerHTML = `<strong>${t.nome || t.name}</strong><span>${t.unidadesPorPack ? `${t.unidadesPorPack} por pack` : 'Template rpido'}</span>`;
          const quick = document.createElement('button');
          quick.className = 'secondary';
          quick.style.padding = '0.35rem 0.6rem';
          quick.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M12.5 3.5 16.5 7.5 8 16H4v-4z"/><path d="M11.3 2.3 13 0.5l4.5 4.5-1.8 1.7"/></svg>';
          quick.title = 'Editar template';
          quick.onclick = (ev) => { ev.stopPropagation(); openTemplateManager(t.id); };
          chip.append(icon, meta, quick);
          chips.appendChild(chip);
        });
      }
    }
    if (modalRow) {
      modalRow.innerHTML = '';
      filtered.forEach(t => {
        const btn = document.createElement('div');
        btn.className = `template-chip ${currentInventoryCategory}`;
        btn.innerHTML = `<div class="icon"></div><div class="meta"><strong>${t.nome || t.name}</strong><span>${t.unidadesPorPack ? t.unidadesPorPack + ' por pack' : 'Sugesto'}</span></div>`;
        btn.onclick = () => applyInventoryTemplate(t.id);
        modalRow.appendChild(btn);
      });
      if (!filtered.length) modalRow.innerHTML = '<span class="subtext">Nenhum produto recorrente.</span>';
    }
  }

  function buildStockHistoryInfo(itemId) {
    const list = stockHistories[itemId] || [];
    const lastEntry = list.find(h => h.tipo === 'entrada');
    const lastExit = list.find(h => h.tipo === 'saida' || h.tipo === 'baixa');
    return {
      lastEntry: lastEntry?.data || null,
      lastExit: lastExit?.data || null
    };
  }

  function attachStockHistoryListener(itemId) {
    if (!firestore || !itemId) return;
    firestore.collection('stock').doc(itemId).collection('history').orderBy('data', 'desc').limit(20).onSnapshot(snap => {
      stockHistories[itemId] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInventory();
    });
  }

  function renderInventory() {
    const target = getDashboardFilterTarget();
    const groups = {
      esmaltes: document.getElementById('inventory-polish-list'),
      geladeira: document.getElementById('inventory-fridge-list'),
      manutencao: document.getElementById('inventory-maintenance-list')
    };
    const metrics = {
      esmaltes: document.getElementById('inventory-polish-metrics'),
      geladeira: document.getElementById('inventory-fridge-metrics'),
      manutencao: document.getElementById('inventory-maintenance-metrics')
    };
    Object.entries(groups).forEach(([category, container]) => {
      if (!container) return;
      container.innerHTML = '';
      const scoped = stockItems.filter(i => (i.categoria || i.category) === category)
        .filter(i => selectedGlobalMonthKey === 'all' || !(i.dataCompra || i.addedAt) || matchesTargetMonth(i.dataCompra || i.addedAt, target));
      if (metrics[category]) {
        metrics[category].innerHTML = scoped.length ? `<span class="pill">${scoped.length} itens</span>` : '';
      }
      scoped.forEach(item => {
        const hist = buildStockHistoryInfo(item.id);
        const pct = item.volumeTotal_ml ? Math.round((item.volumeAtual_ml / item.volumeTotal_ml) * 100) : null;
        const badgeLow = item.previsaoDuracaoDias && item.previsaoDuracaoDias < 15;
        const warnFlag = item.previsaoDuracaoDias && item.previsaoDuracaoDias < 7;
        const lowFlag = badgeLow || (pct != null && pct < 30) || (item.quantidade && item.quantidade <= (item.unidadesPorPack || item.quantidade) * 0.2);
        const statusLabel = lowFlag ? 'Baixo' : warnFlag ? 'Expirando' : 'OK';
        const badgeClass = lowFlag ? 'low' : warnFlag ? 'warn' : '';
        const div = document.createElement('div');
        div.className = 'inventory-card';
        const entryLabel = hist.lastEntry ? formatDateLabel((hist.lastEntry || '').split('T')[0] || hist.lastEntry) : '';
        const exitLabel = hist.lastExit ? formatDateLabel((hist.lastExit || '').split('T')[0] || hist.lastExit) : '';
        const progress = pct != null ? `<div class="inventory-progress"><div class="fill" style="width:${Math.max(0, Math.min(100, pct))}%;${pct < 10 ? 'background:#d9534f;' : ''}"></div></div>` : '';
        const unitCost = category === 'geladeira' || category === 'manutencao'
          ? (item.custoCompra ? (item.custoCompra / Math.max(1, item.quantidade || 1)) : 0)
          : (item.custoPorUso || 0);
        const miniMeta = `
          <div class="inventory-mini-meta">
            <span> ${category === 'esmaltes' ? `${item.volumeAtual_ml || 0} ml` : `${item.quantidade || 0} un.`}</span>
            <span> Custo ${formatCurrency(unitCost)}</span>
            ${category === 'geladeira' ? `<span> Venda ${formatCurrency(item.precoVenda || 0)}</span>` : ''}
            <span> Entrada ${entryLabel}</span>
            ${category === 'esmaltes' ? `<span> Consumo ${item.consumoEstimadoPorUso || 0}ml</span>` : ''}
          </div>`;
        div.innerHTML = `
          <div class="line-top">
            <div class="title-stack">
              <div class="inventory-card-title">${item.nome || item.name || 'Item sem nome'}</div>
              <div class="inventory-meta">${category === 'esmaltes' ? (item.marca || 'Marca no informada') : (item.categoria || item.category)} ${item.dataCompra ? ' Comprado em ' + formatDateLabel(item.dataCompra) : ''}</div>
            </div>
            <span class="inventory-badge ${badgeClass}">${statusLabel}</span>
          </div>
          ${miniMeta}
          ${progress}
          <div class="history-row"><span>ltima entrada: ${entryLabel}</span><span>ltima sada: ${exitLabel}</span></div>
          <div class="inventory-foot">
            <div class="inventory-actions-icons">
              <button class="action-btn edit" title="Editar" aria-label="Editar" onclick="openInventoryModal('${item.id}')"></button>
              <button class="action-btn neutral" title="Detalhes" aria-label="Detalhes" onclick="openStockDetailModal('${item.id}')"></button>
              <button class="action-btn exit" title="Registrar sada" aria-label="Registrar sada" onclick="openStockExitModal('${item.id}')"></button>
              <button class="action-btn danger" title="Excluir" aria-label="Excluir" onclick="promptRemoveStockItem('${item.id}')"></button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      if (!scoped.length) container.innerHTML = '<div class="inventory-empty">Nenhum registro para exibir.</div>';
    });
    renderDashboardStockCard();
    syncKioskFromInventory();
  }

  async function saveStockHistory(itemId, entry) {
    if (!firestore || !itemId) return;
    await firestore.collection('stock').doc(itemId).collection('history').add({ ...entry, data: entry.data || new Date().toISOString(), usuario: currentUserDoc?.name || 'Administradora' });
  }

  async function submitInventoryForm() {
    initFirebaseApp();
    if (!firestore) return;
    const now = new Date().toISOString();
    const category = document.getElementById('inventory-category')?.value || currentInventoryCategory || 'esmaltes';
    const kioskFlag = document.getElementById('inventory-kiosk-flag')?.value || 'active';
    let payload = { categoria: category, updatedAt: now, paused: kioskFlag === 'paused' };
    if (category === 'esmaltes') {
      const nome = document.getElementById('stock-polish-name').value.trim();
      const marca = document.getElementById('stock-polish-brand').value.trim();
      const volumeTotal = parseFloat(document.getElementById('stock-polish-total').value) || 0;
      const volumeAtual = parseFloat(document.getElementById('stock-polish-current').value) || 0;
      const custoTotal = parseFloat(document.getElementById('stock-polish-cost').value) || 0;
      const consumo = parseFloat(document.getElementById('stock-polish-consumption').value) || 0;
      const dataCompra = document.getElementById('stock-polish-date').value;
      if (!nome || !marca || !volumeTotal) { alert('Preencha nome, marca e volume total.'); return; }
      const usesPerDay = 3;
      const previsao = consumo > 0 ? Math.round(volumeAtual / (consumo * usesPerDay)) : 0;
      const custoPorUso = volumeTotal ? ((custoTotal || 0) / volumeTotal) * (consumo || 0) : 0;
      payload = { ...payload, nome, marca, volumeTotal_ml: volumeTotal, volumeAtual_ml: volumeAtual, consumoEstimadoPorUso: consumo, dataCompra: dataCompra || null, previsaoDuracaoDias: previsao, custoTotal, custoPorUso, addedAt: payload.addedAt || now };
    } else if (category === 'geladeira') {
      const nome = document.getElementById('stock-fridge-name').value.trim();
      const quantidade = parseInt(document.getElementById('stock-fridge-qty').value, 10) || 0;
      const custoCompra = parseFloat(document.getElementById('stock-fridge-cost').value) || 0;
      const precoVenda = parseFloat(document.getElementById('stock-fridge-price').value) || 0;
      const dataCompra = document.getElementById('stock-fridge-date').value;
      if (!nome || !quantidade) { alert('Informe nome e quantidade.'); return; }
      payload = { ...payload, nome, quantidade, custoCompra, precoVenda, dataCompra: dataCompra || null, addedAt: payload.addedAt || now };
    } else {
      const nome = document.getElementById('stock-maint-name').value.trim();
      const quantidade = parseInt(document.getElementById('stock-maint-qty').value, 10) || 0;
      const custoCompra = parseFloat(document.getElementById('stock-maint-cost').value) || 0;
      const dataCompra = document.getElementById('stock-maint-date').value;
      if (!nome || !quantidade) { alert('Informe nome e quantidade.'); return; }
      payload = { ...payload, nome, quantidade, custoCompra, dataCompra: dataCompra || null, addedAt: payload.addedAt || now };
    }
    try {
      if (inventoryFormMode === 'edit' && inventoryEditingId) {
        await firestore.collection('stock').doc(inventoryEditingId).set(payload, { merge: true });
        await saveStockHistory(inventoryEditingId, { tipo: 'edicao', quantidade: payload.quantidade || payload.volumeAtual_ml || 0, volume: payload.volumeAtual_ml || null });
      } else {
        const ref = await firestore.collection('stock').add({ ...payload, createdAt: now });
        await saveStockHistory(ref.id, { tipo: 'entrada', quantidade: payload.quantidade || payload.volumeAtual_ml || 0, volume: payload.volumeAtual_ml || null });
      }
    } catch (err) {
      console.error('Erro ao salvar estoque', err);
    }
    closeInventoryModal();
  }

  async function toggleStockVisibility(itemId) {
    if (!firestore || !itemId) return;
    const item = stockItems.find(i => i.id === itemId);
    await firestore.collection('stock').doc(itemId).set({ paused: !item?.paused, updatedAt: new Date().toISOString() }, { merge: true });
  }

  async function removeStockItem(itemId) {
    if (!firestore || !itemId) return;
    await firestore.collection('stock').doc(itemId).delete();
  }

  function promptRemoveStockItem(itemId) {
    pendingRemoveStockId = itemId;
    openDialog('stock-remove-modal');
  }

  async function confirmRemoveStockItem() {
    if (!pendingRemoveStockId) return;
    await removeStockItem(pendingRemoveStockId);
    pendingRemoveStockId = null;
    closeDialog('stock-remove-modal');
  }

  function openStockDetailModal(itemId) {
    const item = stockItems.find(i => i.id === itemId);
    if (!item) return;
    const hist = buildStockHistoryInfo(itemId);
    document.getElementById('stock-detail-name').textContent = item.nome || item.name || 'Item';
    document.getElementById('stock-detail-cat').textContent = item.categoria || item.category || '';
    document.getElementById('stock-detail-entry').textContent = hist.lastEntry ? formatDateLabel((hist.lastEntry || '').split('T')[0] || hist.lastEntry) : '';
    document.getElementById('stock-detail-exit').textContent = hist.lastExit ? formatDateLabel((hist.lastExit || '').split('T')[0] || hist.lastExit) : '';
    document.getElementById('stock-detail-forecast').textContent = item.previsaoDuracaoDias ? `${item.previsaoDuracaoDias} dias` : '';
    document.getElementById('stock-detail-cost').textContent = item.custoPorUso ? formatCurrency(item.custoPorUso) : '';
    openDialog('stock-detail-modal');
  }

  function openStockExitModal(itemId) {
    pendingExitStockId = itemId;
    const item = stockItems.find(i => i.id === itemId);
    const input = document.getElementById('stock-exit-qty');
    const nameEl = document.getElementById('stock-exit-name');
    if (nameEl) nameEl.textContent = item?.nome || item?.name || 'Item';
    if (input) input.value = item?.consumoEstimadoPorUso || 1;
    openDialog('stock-exit-modal');
  }

  async function confirmStockExit() {
    if (!pendingExitStockId || !firestore) return;
    const item = stockItems.find(i => i.id === pendingExitStockId);
    if (!item) return;
    const qty = parseFloat(document.getElementById('stock-exit-qty')?.value || '0');
    const now = new Date().toISOString();
    let payload = { updatedAt: now };
    if (item.categoria === 'esmaltes') {
      const remaining = Math.max(0, (item.volumeAtual_ml || 0) - qty);
      const usesPerDay = 3;
      const previsao = (item.consumoEstimadoPorUso || 0) > 0 ? Math.round(remaining / ((item.consumoEstimadoPorUso || 0) * usesPerDay)) : item.previsaoDuracaoDias || 0;
      payload = { volumeAtual_ml: remaining, previsaoDuracaoDias: previsao };
    } else {
      const remaining = Math.max(0, (item.quantidade || 0) - qty);
      payload = { quantidade: remaining };
    }
    await firestore.collection('stock').doc(pendingExitStockId).set(payload, { merge: true });
    await saveStockHistory(pendingExitStockId, { tipo: 'saida', quantidade: qty, volume: item.categoria === 'esmaltes' ? qty : null, data: now });
    closeDialog('stock-exit-modal');
    pendingExitStockId = null;
  }

  function openTemplateManager(id = null) {
    templateEditingId = id;
    const title = document.getElementById('template-modal-title');
    const tmpl = productTemplates.find(t => t.id === id);
    if (title) title.textContent = id ? 'Editar template' : 'Novo template';
    ['template-name','template-pack','template-volume','template-volume-pack','template-frequency'].forEach(fid => {
      const el = document.getElementById(fid);
      if (el) el.value = '';
    });
    const cat = document.getElementById('template-category');
    if (cat) cat.value = tmpl?.categoria || tmpl?.category || currentInventoryCategory;
    if (tmpl) {
      document.getElementById('template-name').value = tmpl.nome || tmpl.name || '';
      document.getElementById('template-pack').value = tmpl.unidadesPorPack || '';
      document.getElementById('template-volume').value = tmpl.volumeTotal || '';
      document.getElementById('template-volume-pack').value = tmpl.volumePorPack || '';
      document.getElementById('template-frequency').value = tmpl.frequenciaDeUso || '';
    }
    openDialog('template-modal');
  }

  async function saveTemplate() {
    initFirebaseApp();
    const nome = document.getElementById('template-name').value.trim();
    const categoria = document.getElementById('template-category').value;
    if (!nome) { alert('Informe o nome do template.'); return; }
    const payload = {
      nome,
      categoria,
      unidadesPorPack: parseInt(document.getElementById('template-pack').value, 10) || null,
      volumeTotal: parseFloat(document.getElementById('template-volume').value) || null,
      volumePorPack: parseFloat(document.getElementById('template-volume-pack').value) || null,
      frequenciaDeUso: document.getElementById('template-frequency').value || ''
    };
    try {
      if (firestore) {
        if (templateEditingId) {
          await firestore.collection('productTemplates').doc(templateEditingId).set(payload, { merge: true });
        } else {
          const doc = await firestore.collection('productTemplates').add(payload);
          payload.id = doc.id;
        }
      } else {
        payload.id = templateEditingId || `tmpl-${Date.now()}`;
      }
      if (templateEditingId) {
        productTemplates = productTemplates.map(t => t.id === templateEditingId ? { ...t, ...payload } : t);
      } else {
        productTemplates.push({ id: payload.id || `tmpl-${Date.now()}`, ...payload });
      }
      renderInventoryTemplates();
    } catch (err) {
      console.warn('Falha ao salvar template', err);
      alert('No foi possvel salvar o template agora.');
    }
    closeDialog('template-modal');
  }

  async function deleteTemplate(id) {
    if (!id) return;
    if (firestore) {
      await firestore.collection('productTemplates').doc(id).delete();
    }
    productTemplates = productTemplates.filter(t => t.id !== id);
    renderInventoryTemplates();
  }

  function renderCollaborators() {
    const container = document.getElementById('collaborators-list');
    if (!container) return;
    container.innerHTML = '';
    if (!collaborators.length) {
      container.innerHTML = '<div class="collab-meta">Nenhuma colaboradora cadastrada.</div>';
      return;
    }
    collaborators.forEach((col, index) => {
      const row = document.createElement('div');
      row.className = 'collab-row';
      const permLine = col.permissions ? col.permissions.split(',').map(p => p.trim()).slice(0, 2).join('  ') : 'Ajuste no modal';
      row.innerHTML = `
        <div class="collab-id">
          <div class="collab-avatar" style="background:${col.color}">${col.name[0]}</div>
          <div class="collab-info">
            <strong>${col.name}</strong>
            <div class="collab-meta">${col.role}  ${col.commission}</div>
            <div class="collab-meta">${col.active ? 'Ativa' : 'Desativada'}</div>
          </div>
        </div>
        <div class="collab-permissions">
          <span class="collab-meta tagline">${permLine}</span>
          <span class="collab-meta">Login: <strong>${col.username || 'definir no modal'}</strong></span>
          <span class="collab-meta">Permisses detalhadas no modal</span>
        </div>
        <div class="collab-actions">
          <button class="ghost-btn secondary" onclick="openEditCollab(${index})" title="Editar"></button>
          <button class="ghost-btn" onclick="openCommissionModal(${index})" title="Comisso"></button>
          <button class="ghost-btn secondary" onclick="openCollabStatusModal(${index})" title="Ativar/Desativar"></button>
          <button class="ghost-btn secondary" onclick="openCollabStatusModal(${index}, true)" title="Remover"></button>
          ${col.username ? `<button class="ghost-btn" onclick="openCollaboratorLogin('${col.username}')" title="Login dedicado"></button>` : `<button class="ghost-btn" onclick="openDedicatedLoginModal('${col.name}')"> Criar login</button>`}
        </div>
      `;
      container.appendChild(row);
    });
  }

  let investmentFilter = 'Todos';
  let investmentEditingId = null;

  function formatMonthSelectLabel(target) {
    if (!target) return '';
    return `${String(target.monthIndex + 1).padStart(2, '0')}/${target.year}`;
  }

  function setInvestmentFilter(value) {
    investmentFilter = value;
    const ids = {
      Todos: 'invest-filter-all',
      Planejado: 'invest-filter-plan',
      'Em andamento': 'invest-filter-progress',
      Pago: 'invest-filter-paid'
    };
    Object.entries(ids).forEach(([status, btnId]) => {
      const btn = document.getElementById(btnId);
      if (btn) btn.classList.toggle('active', value === status);
    });
    renderInvestments();
  }

  function getInvestmentFilterTarget() {
    if (selectedGlobalMonthKey && selectedGlobalMonthKey !== 'all') {
      const [year, month] = selectedGlobalMonthKey.split('-').map(v => parseInt(v, 10));
      if (Number.isNaN(year) || Number.isNaN(month)) return null;
      return { year, monthIndex: month - 1 };
    }
    return null;
  }

  function formatMonthRef(monthStr) {
    if (!monthStr) return '';
    const [year, month] = monthStr.split('-');
    const idx = parseInt(month, 10) - 1;
    return `${monthNamesShort[idx] || month}/${year}`;
  }

  function parseMonthRef(monthStr) {
    if (!monthStr) return null;
    const [year, month] = monthStr.split('-').map(v => parseInt(v, 10));
    if (Number.isNaN(year) || Number.isNaN(month)) return null;
    return { year, monthIndex: month - 1 };
  }

  function formatMonthWithYear(target) {
    if (!target) return '';
    return `${monthNamesFull[target.monthIndex]} ${target.year}`;
  }

  function initFirebaseApp() {
    if (firebaseApp || !window.firebase) return;
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firestore = firebase.firestore();
    firebaseAuth = firebase.auth();
  }

  function currentUserConfigDoc() {
    if (!firestore) return null;
    const userId = currentUserDoc?.id || 'anon';
    return firestore.collection('settings').doc('globalFilters').collection('users').doc(userId);
  }

  function monthKeyFromDate(dateStr) {
    if (!dateStr) return null;
    const dt = new Date(dateStr);
    if (Number.isNaN(dt.getTime())) return null;
    return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
  }

  function addMonthToMap(map, year, monthIndex) {
    if (year == null || monthIndex == null || Number.isNaN(year) || Number.isNaN(monthIndex)) return;
    let y = year;
    let m = monthIndex;
    while (m > 11) {
      m -= 12;
      y += 1;
    }
    while (m < 0) {
      m += 12;
      y -= 1;
    }
    const key = `${y}-${String(m + 1).padStart(2, '0')}`;
    if (!map.has(key)) map.set(key, { year: y, monthIndex: m });
  }

  function deriveMonthsFromInvestment(inv, map) {
    const ref = parseMonthRef(inv.mesReferencia);
    const total = inv.parcelasTotais || 1;
    if (ref) {
      if (inv.parcelado && total > 1) {
        for (let i = 0; i < total; i++) addMonthToMap(map, ref.year, ref.monthIndex + i);
      } else {
        addMonthToMap(map, ref.year, ref.monthIndex);
      }
    }
    if (inv.createdAt) {
      const key = monthKeyFromDate(inv.createdAt);
      if (key) {
        const [y, m] = key.split('-').map(v => parseInt(v, 10));
        addMonthToMap(map, y, m - 1);
      }
    }
  }

  async function buildGlobalMonthOptions() {
    const select = document.getElementById('global-month-filter');
    const mobileSelect = document.getElementById('global-month-filter-mobile');
    if (!select && !mobileSelect) return;
    initFirebaseApp();
    const map = new Map();

    investments.forEach(inv => deriveMonthsFromInvestment(inv, map));
    financialEntries.forEach(fin => {
      const key = monthKeyFromDate(fin.date);
      if (key) {
        const [y, m] = key.split('-').map(v => parseInt(v, 10));
        addMonthToMap(map, y, m - 1);
      }
    });
    stockItems.forEach(item => {
      const key = monthKeyFromDate(item.dataCompra || item.createdAt || item.addedAt);
      if (key) {
        const [y, m] = key.split('-').map(v => parseInt(v, 10));
        addMonthToMap(map, y, m - 1);
      }
    });

    if (firestore) {
      const snapInvest = await firestore.collection('investments').get().catch(() => null);
      snapInvest?.forEach(doc => deriveMonthsFromInvestment(doc.data() || {}, map));
      const snapFin = await firestore.collection('financial').get().catch(() => null);
      snapFin?.forEach(doc => {
        const key = monthKeyFromDate((doc.data() || {}).date);
        if (key) {
          const [y, m] = key.split('-').map(v => parseInt(v, 10));
          addMonthToMap(map, y, m - 1);
        }
      });
      const snapStock = await firestore.collection('stock').get().catch(() => null);
      snapStock?.forEach(doc => {
        const data = doc.data() || {};
        const key = monthKeyFromDate(data.dataCompra || data.createdAt || data.addedAt);
        if (key) {
          const [y, m] = key.split('-').map(v => parseInt(v, 10));
          addMonthToMap(map, y, m - 1);
        }
      });
    }

    const sorted = Array.from(map.entries()).sort((a, b) => (a[1].year - b[1].year) || (a[1].monthIndex - b[1].monthIndex));
    const options = '<option value="all">Todos</option>' + sorted.map(([key, target]) => `<option value="${key}">${formatMonthSelectLabel(target)}</option>`).join('');
    if (select) {
      select.innerHTML = options;
      select.value = selectedGlobalMonthKey;
      select.onchange = (e) => handleGlobalMonthSelect(e.target.value);
    }
    if (mobileSelect) {
      mobileSelect.innerHTML = options;
      mobileSelect.value = selectedGlobalMonthKey;
      mobileSelect.onchange = (e) => handleGlobalMonthSelect(e.target.value);
    }
  }

  function handleGlobalMonthSelect(value) {
    selectedGlobalMonthKey = value || 'all';
    if (selectedGlobalMonthKey === 'all') {
      const now = new Date();
      selectedDashboardMonth = now.getMonth();
      selectedDashboardYear = now.getFullYear();
    } else {
      const [year, month] = selectedGlobalMonthKey.split('-').map(v => parseInt(v, 10));
      selectedDashboardMonth = month - 1;
      selectedDashboardYear = year;
    }
    persistGlobalMonth(selectedGlobalMonthKey);
    const mobileSelect = document.getElementById('global-month-filter-mobile');
    const desktopSelect = document.getElementById('global-month-filter');
    if (mobileSelect && mobileSelect.value !== selectedGlobalMonthKey) mobileSelect.value = selectedGlobalMonthKey;
    if (desktopSelect && desktopSelect.value !== selectedGlobalMonthKey) desktopSelect.value = selectedGlobalMonthKey;
    refreshMonthlyConsumers();
  }

  async function persistGlobalMonth(value) {
    selectedGlobalMonthKey = value || 'all';
    const docRef = currentUserConfigDoc();
    if (!docRef) return;
    await docRef.set({ value: selectedGlobalMonthKey, updatedAt: Date.now() }, { merge: true }).catch(() => {});
  }

  async function listenGlobalMonth() {
    initFirebaseApp();
    const docRef = currentUserConfigDoc();
    if (!docRef) return;
    if (globalMonthUnsub) globalMonthUnsub();
    globalMonthUnsub = docRef.onSnapshot(doc => {
      const data = doc.data() || {};
      selectedGlobalMonthKey = data.value || 'all';
      const target = getDashboardFilterTarget();
      selectedDashboardMonth = target.monthIndex;
      selectedDashboardYear = target.year;
      refreshMonthlyConsumers();
    });
  }

  function getDashboardFilterTarget() {
    if (selectedGlobalMonthKey && selectedGlobalMonthKey !== 'all') {
      const [year, month] = selectedGlobalMonthKey.split('-').map(v => parseInt(v, 10));
      return { year, monthIndex: month - 1 };
    }
    return { year: selectedDashboardYear, monthIndex: selectedDashboardMonth || 0 };
  }

  function monthsDiff(start, target) {
    if (!start || !target) return Infinity;
    return (target.year - start.year) * 12 + (target.monthIndex - start.monthIndex);
  }

  function matchesTargetMonth(dateStr, target) {
    if (!dateStr || !target) return false;
    const dt = new Date(dateStr);
    if (Number.isNaN(dt.getTime())) return false;
    return dt.getFullYear() === target.year && dt.getMonth() === target.monthIndex;
  }

  function isInvestmentActiveInMonth(inv, target) {
    const ref = parseMonthRef(inv.mesReferencia);
    if (!ref) return false;
    const diff = monthsDiff(ref, target);
    const total = inv.parcelasTotais || 1;
    if (inv.parcelado && total > 1) return diff >= 0 && diff < total;
    return diff === 0;
  }

  function getInvestmentMonthlyValue(inv) {
    const total = inv.valorTotal ?? inv.amount ?? 0;
    const parcels = inv.parcelasTotais || 1;
    if (inv.parcelado && parcels > 1) return inv.valorParcela || (total / parcels);
    return total;
  }

  function getInvestmentParcelLabel(inv, target) {
    const total = inv.parcelasTotais || 1;
    if (!inv.parcelado || total <= 1) return 'nica';
    const active = getActiveParcelNumber(inv, target);
    return `${active || ''}/${total}`;
  }

  function getActiveParcelNumber(inv, target) {
    const ref = parseMonthRef(inv.mesReferencia);
    const total = inv.parcelasTotais || 1;
    if (!ref) return null;
    if (!inv.parcelado || total <= 1) return monthsDiff(ref, target) === 0 ? 1 : null;
    const diff = monthsDiff(ref, target);
    if (diff < 0) return null;
    if (diff >= total) return total;
    return diff + 1;
  }

  function recordInvestmentHistory(invId, action, description) {
    const entry = {
      timestamp: new Date().toISOString(),
      action,
      usuario: currentRole || 'ceo',
      descricao: description
    };
    if (!investmentHistoryStore[invId]) investmentHistoryStore[invId] = [];
    investmentHistoryStore[invId].push(entry);
    if (firestore) {
      firestore.collection('investments').doc(invId).collection('history').add(entry).catch(() => {});
    }
  }

  function syncInvestmentStatus(inv) {
    const total = inv.parcelasTotais || 1;
    const payments = inv.payments || [];
    const paidCount = payments.length;
    let status = inv.status || 'Planejado';
    if (paidCount >= total) status = 'Pago';
    else if (paidCount > 0) status = 'Em andamento';
    return { ...inv, status, parcelaAtual: Math.min(paidCount, total), payments };
  }

  function normalizeInvestments() {
    investments = investments.map(inv => {
      const created = inv.createdAt || new Date().toISOString();
      const history = inv.history && inv.history.length ? inv.history : [{ type: 'criado', date: created, detail: 'Investimento criado' }];
      const parcelado = inv.parcelado ?? ((inv.parcelasTotais || 1) > 1);
      const valorParcela = inv.valorParcela || (inv.valorTotal ? (inv.valorTotal / (inv.parcelasTotais || 1)) : 0);
      return syncInvestmentStatus({ ...inv, createdAt: created, history, parcelado, valorParcela, payments: inv.payments || [] });
    });
  }

  function investmentBadge(status) {
    const map = {
      Planejado: 'status-plan',
      'Em andamento': 'status-progress',
      Pago: 'status-paid'
    };
    return map[status] || '';
  }

  function openInvestmentModal(mode = 'add', id = null) {
    investmentEditingId = mode === 'edit' ? id : null;
    const modalTitle = document.getElementById('investment-modal-title');
    const saveBtn = document.getElementById('investment-modal-save');
    const inv = investments.find(i => i.id === id) || {};
    document.getElementById('investment-id').value = inv.id || '';
    document.getElementById('investment-title').value = inv.title || '';
    document.getElementById('investment-category').value = inv.category || inv.categoria || '';
    document.getElementById('investment-month').value = inv.mesReferencia || '';
    document.getElementById('investment-amount').value = inv.valorTotal || inv.amount || '';
    document.getElementById('investment-parceled').value = inv.parcelado ? 'sim' : 'nao';
    document.getElementById('investment-installments').value = inv.parcelasTotais || 1;
    document.getElementById('investment-installment-value').value = inv.valorParcela || '';
    document.getElementById('investment-status').value = inv.status || 'Planejado';
    document.getElementById('investment-notes').value = inv.observacoes || '';
    if (modalTitle) modalTitle.textContent = mode === 'edit' ? 'Editar investimento' : 'Adicionar investimento';
    if (saveBtn) saveBtn.textContent = mode === 'edit' ? 'Atualizar' : 'Salvar';
    toggleParcelFields();
    openDialog('investment-modal');
  }

  function toggleParcelFields() {
    const isParceled = document.getElementById('investment-parceled').value === 'sim';
    const installs = document.getElementById('investment-installments');
    const value = document.getElementById('investment-installment-value');
    [installs, value].forEach(el => {
      if (!el) return;
      el.disabled = !isParceled;
      el.classList.toggle('disabled', !isParceled);
    });
  }

  function saveInvestment() {
    const id = document.getElementById('investment-id').value || `inv-${Date.now()}`;
    const title = document.getElementById('investment-title').value.trim();
    const category = document.getElementById('investment-category').value.trim() || 'Geral';
    const mesReferencia = document.getElementById('investment-month').value;
    const valorTotal = parseFloat(document.getElementById('investment-amount').value) || 0;
    const parcelado = document.getElementById('investment-parceled').value === 'sim';
    const parcelasTotais = parcelado ? (parseInt(document.getElementById('investment-installments').value, 10) || 1) : 1;
    const valorParcelaInput = parseFloat(document.getElementById('investment-installment-value').value);
    const valorParcela = parcelado ? (valorParcelaInput || (valorTotal / parcelasTotais)) : valorTotal;
    const status = document.getElementById('investment-status').value || 'Planejado';
    const observacoes = document.getElementById('investment-notes').value || '';

    if (!title || !valorTotal) {
      alert('Preencha ttulo e valor total');
      return;
    }

    const existing = investments.find(i => i.id === id);
    const now = new Date().toISOString();
    const payments = (existing?.payments || []).filter(p => p);
    const history = existing?.history ? [...existing.history] : [];

    const payload = {
      id,
      title,
      category,
      valorTotal,
      valorParcela,
      parcelasTotais,
      mesReferencia,
      parcelado,
      observacoes,
      status,
      createdAt: existing?.createdAt || now,
      updatedAt: now,
      lastPaymentAt: existing?.lastPaymentAt || null,
      payments,
      history
    };

    const merged = syncInvestmentStatus(payload);

    if (!existing) merged.history.push({ type: 'criado', date: now, detail: 'Investimento criado' });
    else merged.history.push({ type: 'edicao', date: now, detail: 'Investimento atualizado' });

    if (existing) {
      investments = investments.map(inv => inv.id === id ? merged : inv);
    } else {
      investments.push(merged);
    }

    closeDialog('investment-modal');
    renderInvestments();
    renderDashboardCards();
  }

  function renderInvestments() {
    const container = document.getElementById('investment-groups');
    if (!container) return;
    investments = investments.map(syncInvestmentStatus);
    container.innerHTML = '';

    const target = getInvestmentFilterTarget();
    const visibleByMonth = target ? investments.filter(inv => isInvestmentActiveInMonth(inv, target)) : investments;
    const filtered = investmentFilter === 'Todos' ? visibleByMonth : visibleByMonth.filter(inv => inv.status === investmentFilter);

    if (!filtered.length) {
      container.innerHTML = '<div class="subtext">Nenhum investimento para este filtro.</div>';
      return;
    }

    const sorted = filtered.slice().sort((a, b) => {
      const aRef = parseMonthRef(a.mesReferencia) || { year: 0, monthIndex: 0 };
      const bRef = parseMonthRef(b.mesReferencia) || { year: 0, monthIndex: 0 };
      return (aRef.year - bRef.year) || (aRef.monthIndex - bRef.monthIndex);
    });

    sorted.forEach(item => {
      const currentTarget = target || parseMonthRef(item.mesReferencia) || getDashboardFilterTarget();
      const parcelLabel = getInvestmentParcelLabel(item, currentTarget);
      const amountLabel = formatCurrency(getInvestmentMonthlyValue(item));
      const totalLabel = formatCurrency(item.valorTotal || item.amount || 0);
      const displayStatus = (() => {
        const activeParcel = getActiveParcelNumber(item, currentTarget);
        const total = item.parcelasTotais || 1;
        if (activeParcel && activeParcel >= total) return 'Pago';
        return item.status;
      })();
      const card = document.createElement('div');
      card.className = 'investment-card';
      card.dataset.id = item.id;
      card.innerHTML = `
        <div class="investment-card-head">
          <div class="investment-card-title">
            ${item.title}
            <span class="investment-tag">${item.category || item.categoria || 'Investimento'}</span>
            <span class="investment-tag">Ref.: ${formatMonthRef(item.mesReferencia)}</span>
          </div>
          <span class="investment-status ${investmentBadge(displayStatus)}">${displayStatus}</span>
        </div>
        <div class="investment-card-actions compact">
          <button class="action-btn neutral investment-toggle" onclick="toggleInvestmentDetails('${item.id}')">Ver detalhes</button>
        </div>
        <div class="investment-card-body">
          <div class="investment-card-left">
            <div class="investment-meta-line">
              <span>Parcela do ms: <strong>${parcelLabel}</strong></span>
              <span>Total: <strong>${totalLabel}</strong></span>
            </div>
            <div class="investment-meta-line">
              <span>Valor da parcela: <strong>${amountLabel}</strong></span>
              <span>Status: <strong>${item.status}</strong></span>
            </div>
            <div class="investment-note">${item.observacoes || 'Sem observaes adicionais'}</div>
          </div>
          <div class="investment-card-actions">
              <div class="investment-actions">
                <button class="action-btn edit" title="Editar" onclick="openInvestmentModal('edit', '${item.id}')"></button>
                <button class="action-btn exit" title="Marcar parcela paga" onclick="markInvestmentPaid('${item.id}')"></button>
                <button class="action-btn danger" title="Remover" onclick="openInvestmentRemoveModal('${item.id}')"></button>
              </div>
            </div>
          </div>
        `;
      container.appendChild(card);
    });
  }

    function getInvestmentActionTarget(inv = null) {
      const fallback = (() => {
        if (inv?.mesReferencia) return parseMonthRef(inv.mesReferencia);
        const now = new Date();
        return { year: now.getFullYear(), monthIndex: now.getMonth() };
      })();
      return getInvestmentFilterTarget() || getDashboardFilterTarget() || fallback;
    }

  function markInvestmentPaid(id) {
    const target = getInvestmentFilterTarget() || getDashboardFilterTarget();
    const nowISO = new Date().toISOString();
    let updatedInvestment = null;
    investments = investments.map(inv => {
      if (inv.id !== id) return inv;
      const total = inv.parcelasTotais || 1;
      const payments = inv.payments || [];
      const activeParcel = inv.parcelado && total > 1 ? getActiveParcelNumber(inv, target) || payments.length + 1 : 1;

      if (inv.parcelado && total > 1) {
        const duplicate = payments.some(p => p.year === target?.year && p.monthIndex === target?.monthIndex);
        if (duplicate) return inv;
        const updatedPayments = [...payments, { year: target?.year, monthIndex: target?.monthIndex, amount: inv.valorParcela || inv.valorTotal, date: nowISO }];
        const nextParcel = Math.min(activeParcel + 1, total);
        const status = nextParcel > total ? 'Pago' : nextParcel === total ? 'Em andamento' : 'Em andamento';
        const history = [...(inv.history || []), { type: 'pagamento', date: nowISO, detail: `Parcela ${activeParcel}/${total} paga em ${formatMonthWithYear(target)}` }];
        recordInvestmentHistory(inv.id, 'pagamento', `Parcela ${activeParcel}/${total} paga`);
        updatedInvestment = { ...inv, payments: updatedPayments, parcelaAtual: Math.min(updatedPayments.length, total), status: nextParcel > total ? 'Pago' : status, updatedAt: nowISO, lastPaymentAt: nowISO, history };
        return updatedInvestment;
      }

      recordInvestmentHistory(inv.id, 'pagamento', 'Investimento pago');
      updatedInvestment = { ...inv, status: 'Pago', updatedAt: nowISO, lastPaymentAt: nowISO, history: [...(inv.history || []), { type: 'pagamento', date: nowISO, detail: 'Pagamento nico concludo' }] };
      return updatedInvestment;
    });
    if (firestore && updatedInvestment) {
      firestore.collection('investments').doc(updatedInvestment.id).set(updatedInvestment, { merge: true }).catch(() => {});
    }
    renderInvestments();
    renderDashboardCards();
  }

  function reopenInvestment(id) {
    const target = getInvestmentActionTarget();
    investments = investments.map(inv => {
      if (inv.id !== id) return inv;
      const payments = inv.payments || [];
      const now = new Date().toISOString();
      const updatedPayments = payments.filter(p => !(p.year === target.year && p.monthIndex === target.monthIndex));
      const history = [...(inv.history || []), { type: 'reaberto', date: now, detail: `Parcela reaberta para ${formatMonthWithYear(target)}` }];
      return syncInvestmentStatus({ ...inv, payments: updatedPayments, history, updatedAt: now, lastPaymentAt: updatedPayments.slice(-1)[0]?.date || null });
    });
    renderInvestments();
    renderDashboardCards();
  }

  function toggleInvestmentDetails(id) {
    const card = document.querySelector(`.investment-card[data-id="${id}"]`);
    if (!card) return;
    card.classList.toggle('expanded');
    const btn = card.querySelector('.investment-toggle');
    if (btn) btn.textContent = card.classList.contains('expanded') ? 'Ocultar detalhes' : 'Ver detalhes';
  }

  function openInvestmentHistory(id) {
    const inv = investments.find(i => i.id === id);
    const list = document.getElementById('investment-history-list');
    if (!inv || !list) return;
    list.innerHTML = '';
    const entries = (inv.history || []).slice().sort((a, b) => new Date(a.date) - new Date(b.date));
    if (!entries.length) {
      list.innerHTML = '<div class="subtext">Nenhum histrico registrado.</div>';
    } else {
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'investment-history-item';
        div.innerHTML = `
          <div>
            <strong>${entry.type || 'registro'}</strong>
            <div class="subtext">${entry.detail || ''}</div>
          </div>
          <span class="investment-chip">${formatDateLabel(entry.date?.split('T')[0] || '')}</span>
        `;
        list.appendChild(div);
      });
    }
    openDialog('investment-history-modal');
  }

  function openInvestmentRemoveModal(id) {
    investmentEditingId = id;
    const inv = investments.find(i => i.id === id);
    const text = document.getElementById('investment-remove-text');
    if (text) text.textContent = `Remover "${inv?.title || 'investimento'}"?`; 
    openDialog('investment-remove-modal');
  }

  async function confirmRemoveInvestment() {
    if (!investmentEditingId) return;
    const targetId = investmentEditingId;
    investments = investments.filter(inv => inv.id !== targetId);
    investmentEditingId = null;
    closeDialog('investment-remove-modal');
    if (firestore) {
      await firestore.collection('investments').doc(targetId).delete().catch(() => {});
    }
    renderInvestments();
    renderDashboardCards();
  }

  function renderServicesTable() {
    const tbody = document.getElementById('services-table');
    if (!tbody) return;
    tbody.innerHTML = '';
    kioskServices.forEach(service => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${service.name}</td>
        <td>${service.duration || '-'}</td>
        <td>${formatCurrency(service.price)}</td>
      `;
      tbody.appendChild(tr);
    });
    if (!kioskServices.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="3" class="subtext">Nenhum servio cadastrado.</td>';
      tbody.appendChild(tr);
    }
    populateComandaSelect();
  }

  function openServiceAddModal() {
    document.getElementById('add-service-name').value = '';
    document.getElementById('add-service-duration').value = '';
    document.getElementById('add-service-price').value = '';
    openDialog('service-add-modal');
  }

  async function saveNewService() {
    const name = document.getElementById('add-service-name').value.trim();
    const duration = document.getElementById('add-service-duration').value.trim();
    const price = parseFloat(document.getElementById('add-service-price').value) || 0;
    if (!name || !duration || !price) {
      alert('Preencha nome, durao e preo do servio.');
      return;
    }
    const id = `svc-${Date.now()}`;
    const service = { id, name, duration, price, icon: '' };
    kioskServices.push(service);
    await persistService(service);
    renderServicesTable();
    renderKiosk();
    closeDialog('service-add-modal');
  }

  function openServiceEditModal() {
    const select = document.getElementById('edit-service-select');
    select.innerHTML = '';
    if (!kioskServices.length) {
      select.innerHTML = '<option>Cadastre um servio primeiro</option>';
      openDialog('service-edit-modal');
      return;
    }
    kioskServices.forEach(svc => {
      const opt = document.createElement('option');
      opt.value = svc.id;
      opt.textContent = svc.name;
      select.appendChild(opt);
    });
    currentEditingServiceId = kioskServices[0]?.id || null;
    select.value = currentEditingServiceId || '';
    prefillServiceFields();
    openDialog('service-edit-modal');
  }

  function prefillServiceFields() {
    const select = document.getElementById('edit-service-select');
    currentEditingServiceId = select.value;
    const svc = kioskServices.find(s => s.id === currentEditingServiceId);
    if (!svc) return;
    document.getElementById('edit-service-duration').value = svc.duration || '';
    document.getElementById('edit-service-price').value = svc.price || '';
  }

  function saveServiceEdit() {
    const svc = kioskServices.find(s => s.id === currentEditingServiceId);
    if (!svc) return;
    svc.duration = document.getElementById('edit-service-duration').value || svc.duration;
    svc.price = parseFloat(document.getElementById('edit-service-price').value) || svc.price;
    persistService(svc);
    renderServicesTable();
    renderKiosk();
    closeDialog('service-edit-modal');
  }

  function syncKioskFromInventory() {
    const fridgeDrinks = stockItems
      .filter(item => (item.categoria || item.category) === 'geladeira' && !item.paused)
      .map(item => ({
        id: item.id,
        stockId: item.id,
        categoria: item.categoria || item.category,
        name: item.nome || item.name,
        price: item.precoVenda || 0,
        icon: stockIconFor(item)
      }));
    const maintConsumables = stockItems
      .filter(item => (item.categoria || item.category) === 'manutencao' && !item.paused)
      .map(item => ({
        id: item.id,
        stockId: item.id,
        categoria: item.categoria || item.category,
        name: item.nome || item.name,
        price: item.precoVenda || 0,
        icon: ''
      }));
    kioskDrinks = fridgeDrinks.concat(maintConsumables);
    cart = cart.filter(entry => entry.type !== 'drink' || kioskDrinks.some(d => d.id === entry.id));
    renderKiosk();
    populateComandaSelect();
  }

  function updateKioskSessionStatus(text, tone = 'waiting') {
    const el = document.getElementById('kiosk-session-status');
    if (!el) return;
    el.textContent = text;
    if (tone === 'success') {
      el.style.background = '#e6f6e4';
      el.style.color = '#256029';
    } else if (tone === 'locked') {
      el.style.background = '#fff3cd';
      el.style.color = '#92400e';
    } else {
      el.style.background = '#fff0f0';
      el.style.color = '#b91c1c';
    }
  }

  function setKioskHint(text) {
    const hint = document.getElementById('kiosk-pairing-hint');
    if (hint) hint.textContent = text;
  }

  function kioskActionsLocked() {
    return !kioskComandaId || kioskComandaStatus !== 'aberta' || Boolean(kioskComandaData?.kioskFinalizado);
  }

  function resetKioskSession() {
    kioskComandaId = null;
    kioskComandaStatus = 'desconectado';
    kioskComandaData = null;
    if (kioskComandaUnsub) kioskComandaUnsub();
    kioskComandaUnsub = null;
    cart = [];
    renderCart();
    const content = document.getElementById('kiosk-content');
    if (content) content.classList.add('hidden');
    updateKioskSessionStatus('Aguardando cdigo', 'waiting');
    setKioskHint('O cdigo  criado quando a comanda  aberta.');
  }

  function handleKioskSnapshot(data) {
    kioskComandaData = data;
    kioskComandaStatus = data?.status || 'aberta';
    const content = document.getElementById('kiosk-content');
    if (content) content.classList.toggle('hidden', !kioskComandaId);
    const steps = document.getElementById('kiosk-steps');
    if (steps) steps.classList.toggle('hidden', !kioskComandaId);

    if (!kioskComandaId) {
      updateKioskSessionStatus('Aguardando cdigo', 'waiting');
      return;
    }

    if (kioskComandaStatus !== 'aberta') {
      updateKioskSessionStatus('Comanda no est mais aberta', 'locked');
      setKioskHint('Pea  profissional para abrir uma nova comanda.');
      return;
    }

    if (data?.kioskFinalizado) {
      updateKioskSessionStatus('Consumo finalizado no kiosk', 'locked');
      setKioskHint('A profissional foi avisada. Aguarde o atendimento.');
      return;
    }

    updateKioskSessionStatus(`Pareado (${data?.codigoPareamento || ''})`, 'success');
    setKioskHint('Adicione os itens e finalize para avisar a profissional.');
  }

  async function handleKioskPairing() {
    const input = document.getElementById('kiosk-codigo-input');
    const codigo = input?.value?.trim().toUpperCase();
    if (!codigo) {
      setKioskHint('Digite o cdigo informado pela profissional.');
      return;
    }
    updateKioskSessionStatus('Conferindo cdigo...', 'waiting');
    try {
      const comandaId = await window.kioskFetchComandaByCodigo(codigo);
      if (!comandaId) {
        updateKioskSessionStatus('Cdigo invlido ou atendimento no iniciado', 'locked');
        setKioskHint('Pea para a profissional iniciar o atendimento e gerar um novo cdigo.');
        return;
      }
      kioskComandaId = comandaId;
      kioskComandaStatus = 'aberta';
      if (kioskComandaUnsub) kioskComandaUnsub();
      kioskComandaUnsub = window.listenComanda(comandaId, handleKioskSnapshot);
      handleKioskSnapshot({ status: 'aberta', codigoPareamento: codigo });
      setKioskHint('Pareado com sucesso. Adicione os itens e finalize.');
    } catch (err) {
      console.error(err);
      updateKioskSessionStatus('Erro ao buscar comanda', 'locked');
      setKioskHint('Tente novamente em instantes.');
    }
  }

  function ensureKioskReady() {
    if (kioskActionsLocked()) {
      setKioskHint('Conecte-se a um atendimento aberto para lanar itens.');
      alert('Digite o cdigo informado pela profissional para liberar o carrinho.');
      return false;
    }
    return true;
  }

  // -----------------------------
  // KIOSK (CLIENTE) - CARRINHO
  // -----------------------------
  function renderKiosk() {
    const drinksEl = document.getElementById('kiosk-drinks');
    const servicesEl = document.getElementById('kiosk-services');
    if (drinksEl) {
      drinksEl.innerHTML = '';
      kioskDrinks.forEach(d => {
        const div = document.createElement('div');
        div.className = 'kiosk-card';
        div.innerHTML = `
          <div class="kiosk-icon">${d.icon || ''}</div>
          <h3>${d.name}</h3>
          <div class="kiosk-price">R$ ${d.price}</div>
          <div class="kiosk-badge">Consumo imediato</div>
          <button style="margin-top:0.5rem;" onclick="addDrinkToCart('${d.id}')">Adicionar</button>
        `;
        drinksEl.appendChild(div);
      });
    }
    if (servicesEl) {
      servicesEl.innerHTML = '';
      kioskServices.forEach(s => {
        const div = document.createElement('div');
        div.className = 'kiosk-card';
        div.innerHTML = `
          <div class="kiosk-icon">${s.icon || ''}</div>
          <h3>${s.name}</h3>
          <div class="kiosk-price">R$ ${s.price}</div>
          <div class="kiosk-badge">Servio principal</div>
          <button style="margin-top:0.5rem;" onclick="selectService('${s.id}')">Selecionar</button>
        `;
        servicesEl.appendChild(div);
      });
    }
    renderCart();
  }

  function addDrinkToCart(drinkId) {
    if (!ensureKioskReady()) return;
    const drink = kioskDrinks.find(d => d.id === drinkId);
    if (!drink) return;
    cart.push({ type: 'drink', id: drink.id, name: drink.name, price: drink.price });
    renderCart();
  }

  function selectService(serviceId) {
    if (!ensureKioskReady()) return;
    const service = kioskServices.find(s => s.id === serviceId);
    if (!service) return;
    // Remove servios anteriores do carrinho
    cart = cart.filter(item => item.type !== 'service');
    cart.push({ type: 'service', id: service.id, name: service.name, price: service.price });
    renderCart();
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function clearCart() {
    cart = [];
    renderCart();
  }

  function calcTotalCart() {
    return cart.reduce((sum, item) => sum + item.price, 0);
  }

  function renderCart() {
    const listEl = document.getElementById('kiosk-cart-list');
    const totalEl = document.getElementById('kiosk-cart-total');
    if (!listEl || !totalEl) return;

    listEl.innerHTML = '';
    if (kioskActionsLocked()) {
      const warn = document.createElement('div');
      warn.className = 'subtext';
      warn.textContent = kioskComandaId ? 'Comanda fechada para lanamentos.' : 'Informe o cdigo para liberar o carrinho.';
      listEl.appendChild(warn);
    }
    cart.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'kiosk-cart-item';
      const label = item.type === 'drink' ? 'Consumo' : 'Servio';
      div.innerHTML = `
        <div>
          <strong>${item.name}</strong>
          <div class="subtext" style="margin-top:0.1rem;">${label}</div>
        </div>
        <div style="text-align:right;">
          <div>R$ ${item.price}</div>
          <button class="secondary" style="padding:0.15rem 0.5rem;font-size:0.7rem;margin-top:0.15rem;"
            onclick="removeFromCart(${index})">
            Remover
          </button>
        </div>
      `;
      listEl.appendChild(div);
    });

    totalEl.textContent = 'R$ ' + calcTotalCart().toFixed(2).replace('.', ',');
  }

  async function sendOrder() {
    if (!ensureKioskReady()) return;
    if (cart.length === 0) {
      alert('Adicione pelo menos um item ao carrinho.');
      return;
    }

    const itens = cart.map(item => {
      const drinkMeta = item.type === 'drink'
        ? kioskDrinks.find(d => d.id === item.id)
        : null;
      return {
        nome: item.name,
        tipo: item.type === 'drink' ? 'consumo' : 'servico',
        preco: Number(item.price) || 0,
        quantidade: 1,
        estoqueId: drinkMeta?.stockId,
        categoriaEstoque: drinkMeta?.categoria || null
      };
    });

    try {
      await window.kioskFinalizarConsumo(kioskComandaId, itens);
      alert('Pedido registrado! A profissional ser avisada.');
      clearCart();
      updateKioskSessionStatus('Consumo finalizado no kiosk', 'locked');
    } catch (err) {
      console.error(err);
      alert('No foi possvel registrar o consumo. Tente novamente.');
    }
  }

  // ---------- Overrides de renderizao para incluir botes de atendimento ----------
  function renderAgendaAppointments(scope = 'ceo') {
    const listEl = document.getElementById(scope === 'ceo' ? 'agenda-appointments-list' : 'agenda-appointments-list-colab');
    if (!listEl) return;
    listEl.innerHTML = '';
    const now = new Date();
    const items = filterAppointmentsByScope(scope)
      .map(a => ({ ...a, dateObj: new Date(`${a.date}T${a.time || '00:00'}`) }))
      .filter(a => a.dateObj.toString() !== 'Invalid Date' && a.dateObj >= now)
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!items.length) {
      listEl.innerHTML = '<div class="subtext">Nenhum agendamento futuro.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const card = document.createElement('div');
      card.className = 'appointment-card';
      card.style.setProperty('--appt-color', color);
      card.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title">
            ${client ? client.name : (appt.clientName || 'Cliente')}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${formatDateLabel(appt.date)}  ${appt.time}</span>
            <span>Servio: ${appt.serviceName || appt.service}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" aria-label="Editar" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"></button>
          <button class="ghost-btn secondary icon-mini" aria-label="Remover" onclick="openRemoveAppointmentModal('${appt.id}')"></button>
          ${renderAtendimentoAction(appt)}
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  function renderAgendaMonthSummary(scope = 'ceo') {
    const tbody = document.getElementById(scope === 'ceo' ? 'agenda-month-summary' : 'agenda-month-summary-colab');
    if (!tbody) return;
    tbody.innerHTML = '';
    const selected = scope === 'ceo' ? selectedMonthIndex : selectedMonthIndexColab;
    const month = buildMonthSnapshot(selected, scope);
    const monthTitle = document.getElementById(scope === 'ceo' ? 'selected-month-title' : 'selected-month-title-colab');
    const tagContainer = document.getElementById(scope === 'ceo' ? 'selected-month-tags' : 'selected-month-tags-colab');
    if (monthTitle) monthTitle.textContent = `Agenda de ${month.fullName}`;
    if (tagContainer) {
      tagContainer.innerHTML = '';
      month.tags.forEach(t => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = t;
        tagContainer.appendChild(span);
      });
      if (!month.tags.length) {
        const total = document.createElement('span');
        total.className = 'pill';
        total.textContent = `${month.bookings} atend.`;
        tagContainer.appendChild(total);
      }
      const ocup = document.createElement('span');
      ocup.className = 'pill';
      ocup.textContent = `${month.occupancy}% ocupao`;
      tagContainer.appendChild(ocup);
    }
    const scopedAppointments = getAppointmentsForScope(scope)
      .filter(a => {
        if (!a.date) return false;
        const [year, monthPart] = a.date.split('-').map(Number);
        if (!monthPart) return false;
        if (!year) return monthPart - 1 === selected;
        return monthPart - 1 === selected && year === calendarYear;
      })
      .map(a => ({ ...a, dateObj: new Date(`${a.date}T${a.time || '00:00'}`) }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (!scopedAppointments.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" class="subtext">Nenhum agendamento neste ms.</td>`;
      tbody.appendChild(tr);
      return;
    }

    scopedAppointments.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const clientName = client ? client.name : (appt.clientName || 'Cliente');
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDateLabel(appt.date)}</td>
        <td>${appt.time || '--:--'}</td>
        <td>${clientName}</td>
        <td>${appt.serviceName || appt.service}</td>
        <td><span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span></td>
        <td>
          <div class="table-action-row">
            <button class="ghost-btn secondary icon-mini" aria-label="Editar" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"></button>
            <button class="ghost-btn secondary icon-mini" aria-label="Remover" onclick="openRemoveAppointmentModal('${appt.id}')"></button>
            ${renderAtendimentoAction(appt)}
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDayAppointmentsModal() {
    const list = document.getElementById('day-appointments-list');
    const caption = document.getElementById('day-appointments-caption');
    if (!list || !dayModalDate) return;
    list.innerHTML = '';
    const scope = dayModalScope || 'ceo';
    const items = getAppointmentsForScope(scope)
      .filter(a => a.date === dayModalDate && a.status !== 'canceled')
      .map(a => ({ ...a, dateObj: new Date(`${a.date}T${a.time || '00:00'}`) }))
      .sort((a, b) => a.dateObj - b.dateObj);

    if (caption) caption.textContent = `Horrios do dia ${formatDateLabel(dayModalDate)}`;

    if (!items.length) {
      list.innerHTML = '<div class="subtext">Nenhum agendamento para este dia.</div>';
      return;
    }

    items.forEach(appt => {
      const client = clients.find(c => c.id === appt.clientId);
      const color = getProfessionalColor(appt.professionalName || appt.professional);
      const row = document.createElement('div');
      row.className = 'appointment-card';
      row.style.setProperty('--appt-color', color);
      row.innerHTML = `
        <div class="appointment-meta">
          <div class="appointment-title" style="font-size:1rem;">
            ${appt.time || '--:--'}  ${appt.serviceName || appt.service}
            <span class="appointment-pill" style="background:${color}1a;border-color:${color}33;">${appt.professionalName || appt.professional || 'Equipe'}</span>
          </div>
          <div class="appointment-subtext">
            <span>${client ? client.name : appt.clientName || 'Cliente'}</span>
            <span>${appt.status === 'done' ? 'Concludo' : 'Agendado'}</span>
          </div>
        </div>
        <div class="appointment-actions">
          <button class="ghost-btn secondary icon-mini" aria-label="Editar" onclick="openAppointmentModal('${client?.id || ''}','${appt.id}')"></button>
          <button class="ghost-btn secondary icon-mini" aria-label="Remover" onclick="openRemoveAppointmentModal('${appt.id}')"></button>
          ${renderAtendimentoAction(appt)}
        </div>
      `;
      list.appendChild(row);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    normalizeButtons();
    buttonObserver.observe(document.body, { childList: true, subtree: true });
    const fabMain = document.getElementById('fab-main');
    const fabBackdrop = document.getElementById('fab-backdrop');
    if (fabMain) fabMain.addEventListener('click', toggleFabMenu);
    if (fabBackdrop) fabBackdrop.addEventListener('click', closeFabMenu);
    window.addEventListener('resize', refreshFab);
    window.addEventListener('scroll', handleFabScroll, { passive: true });
    refreshFab();
    document.addEventListener('click', (e) => {
      const dd = document.getElementById('user-dropdown-mobile');
      const btn = document.getElementById('user-avatar-button-mobile');
      if (!dd || !btn) return;
      if (btn.contains(e.target)) return;
      if (!dd.contains(e.target)) dd.classList.add('hidden');
    });
  });

  // Inicializao
  // (poderia detectar login real do Firebase aqui)
  normalizeAppointmentsData();
  normalizeInvestments();
  initFirebaseApp();
  buildGlobalMonthOptions();
  listenGlobalMonth();
  refreshAgendaFromAppointments();
  syncKioskFromInventory();
  resetKioskSession();

  document.addEventListener('DOMContentLoaded', attachAuthListener);
  refreshMonthlyConsumers();
  renderFinance();

  // Override legado: modal de agendamentos em lista no  mais usado.
  function renderDayAppointmentsModal() { return; }
</script>

</body>
</html>
